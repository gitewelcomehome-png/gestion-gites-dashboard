<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validation Planning M√©nage</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f6f8; padding: 20px; max-width: 1200px; margin: 0 auto; }
        h1 { color: #2C3E50; text-align: center; margin-bottom: 30px; font-size: 1.8rem; }
        
        /* Layout 2 colonnes */
        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        @media(max-width: 768px) { .main-grid { grid-template-columns: 1fr; } }
        
        .col-header { 
            padding: 15px; border-radius: 12px; color: white; margin-bottom: 20px; 
            text-align: center; font-size: 1.5rem; font-weight: bold; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .header-trevoux { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .header-couzon { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }

        .week-group { margin-bottom: 25px; }
        .week-title { 
            background: #e9ecef; padding: 8px 15px; border-radius: 6px; 
            font-weight: bold; color: #495057; margin-bottom: 10px; font-size: 0.95rem;
        }

        .task-card { 
            background: white; padding: 15px; margin-bottom: 15px; border-radius: 10px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid #ddd; 
            transition: all 0.3s ease;
        }
        
        /* √âtats visuels */
        .task-card.validated { border-left-color: #2ecc71; background: #f0fff4; }
        .task-card.pending { border-left-color: #f1c40f; }
        
        .task-date { font-size: 1.1rem; font-weight: bold; color: #2C3E50; display: flex; justify-content: space-between; align-items: center; }
        .task-client { font-size: 0.9rem; color: #666; margin: 5px 0 10px 0; }
        
        .actions { display: flex; gap: 10px; margin-top: 10px; }
        .btn { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: bold; font-size: 0.9rem; flex: 1; display: flex; align-items: center; justify-content: center; gap: 5px;}
        .btn-validate { background: #2ecc71; }
        .btn-validate:hover { background: #27ae60; }
        
        .badge-ok { background: #2ecc71; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; }
    </style>
</head>
<body>
    <h1>üßπ Validation M√©nages</h1>
    
    <div style="text-align: center; margin-bottom: 30px;">
        <input type="month" id="monthFilter" style="padding: 10px; font-size: 1rem; border-radius: 8px; border: 1px solid #ccc;">
    </div>

    <div class="main-grid">
        <div id="col-trevoux">
            <div class="col-header header-trevoux">üè∞ Tr√©voux</div>
            <div id="list-trevoux">Chargement...</div>
        </div>

        <div id="col-couzon">
            <div class="col-header header-couzon">‚õ∞Ô∏è Couzon</div>
            <div id="list-couzon">Chargement...</div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://ivqiisnudabxemcxxyru.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2cWlpc251ZGFieGVtY3h4eXJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzOTk0NjMsImV4cCI6MjA4MDk3NTQ2M30.9FwJPgR8bbaP7bAemuaVbAN019EO5ql7uciQO9FeHK4';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        document.addEventListener('DOMContentLoaded', () => {
            const now = new Date();
            const monthStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
            document.getElementById('monthFilter').value = monthStr;
            loadTasks(monthStr);
            document.getElementById('monthFilter').addEventListener('change', (e) => loadTasks(e.target.value));
        });

        async function loadTasks(monthStr) {
            document.getElementById('list-trevoux').innerHTML = '<p style="text-align:center">Chargement...</p>';
            document.getElementById('list-couzon').innerHTML = '<p style="text-align:center">Chargement...</p>';

            const start = `${monthStr}-01`;
            const [y, m] = monthStr.split('-');
            const lastDay = new Date(y, m, 0).getDate();
            const end = `${monthStr}-${lastDay}`;

            // 1. R√©cup√©rer r√©servations
            const { data: resas } = await supabase.from('reservations').select('*').gte('date_fin', start).lte('date_fin', end).order('date_fin');
            // 2. R√©cup√©rer validations
            const { data: validations } = await supabase.from('cleaning_validation').select('*');
            const validMap = {};
            if(validations) validations.forEach(v => validMap[v.reservation_id] = v.status);

            const groups = { 'Tr√©voux': {}, 'Couzon': {} };

            if(resas) {
                resas.forEach(r => {
                    const depart = new Date(r.date_fin);
                    let menageDate = new Date(depart);
                    // R√®gle simple Dimanche->Lundi pour l'affichage
                    if(depart.getDay() === 0) menageDate.setDate(depart.getDate()+1);
                    
                    // R√©cup√©rer Num√©ro Semaine
                    const weekNum = getWeekNumber(menageDate);
                    
                    if(!groups[r.gite][weekNum]) groups[r.gite][weekNum] = [];
                    groups[r.gite][weekNum].push({ r, menageDate });
                });
            }

            renderColumn('list-trevoux', groups['Tr√©voux'], validMap);
            renderColumn('list-couzon', groups['Couzon'], validMap);
        }

        function renderColumn(elementId, weeksData, validMap) {
            const container = document.getElementById(elementId);
            if(Object.keys(weeksData).length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#999;">Aucun m√©nage ce mois-ci.</p>';
                return;
            }

            let html = '';
            // Trier par num√©ro de semaine
            Object.keys(weeksData).sort().forEach(week => {
                html += `<div class="week-group"><div class="week-title">üìÖ Semaine ${week}</div>`;
                
                weeksData[week].forEach(item => {
                    const status = validMap[item.r.id] || 'pending';
                    const isVal = status === 'validated';
                    const dateStr = item.menageDate.toLocaleDateString('fr-FR', {weekday:'long', day:'numeric', month:'long'});
                    const isoDate = item.menageDate.toISOString().split('T')[0];

                    html += `
                    <div class="task-card ${isVal ? 'validated' : 'pending'}">
                        <div class="task-date">
                            <span>${dateStr}</span>
                            ${isVal ? '<span class="badge-ok">Valid√©</span>' : ''}
                        </div>
                        <div class="task-client">Client : ${item.r.nom_client || 'Inconnu'} (D√©part : ${new Date(item.r.date_fin).toLocaleDateString()})</div>
                        
                        <div class="actions">
                            ${!isVal ? 
                                `<button class="btn btn-validate" onclick="validerM√©nage(${item.r.id}, '${item.r.gite}', '${isoDate}')">
                                    <i class="fas fa-check"></i> Confirmer
                                </button>` 
                                : 
                                `<button class="btn" style="background:#ddd; color:#555;" onclick="validerM√©nage(${item.r.id}, '${item.r.gite}', '${isoDate}', 'pending')">
                                    Annuler
                                </button>`
                            }
                        </div>
                    </div>`;
                });
                html += '</div>';
            });
            container.innerHTML = html;
        }

        async function validerM√©nage(id, gite, date, status = 'validated') {
            const { error } = await supabase.from('cleaning_validation').upsert({
                reservation_id: id, gite: gite, original_date: date, status: status
            }, { onConflict: 'reservation_id' });

            if(!error) {
                const month = document.getElementById('monthFilter').value;
                loadTasks(month);
            } else {
                alert('Erreur connexion');
            }
        }

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            var weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
            return weekNo;
        }
    </script>
</body>
</html>
