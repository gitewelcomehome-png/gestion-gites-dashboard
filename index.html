<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion G√Ætes PRO</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ical.js@1.5.0/build/ical.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style> 
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Work+Sans:wght@300;400;600;700&display=swap');
    *{margin:0;padding:0;box-sizing:border-box;}
    :root{--primary:#2C5F7D;--bg-light:#F8F9FA;--text-dark:#2C3E50;--trevoux:#667eea;--couzon:#f093fb;--border:#E0E4E8;}
    body{font-family:'Work Sans',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;color:var(--text-dark);}
    .container{max-width:1600px;margin:0 auto;}
    header{text-align:center;margin-bottom:40px;color:white;}
    .nav-tabs{display:flex;gap:10px;margin-bottom:30px;flex-wrap:wrap;justify-content:center;}
    .nav-tab{padding:15px 30px;background:rgba(255,255,255,0.2);border:none;border-radius:12px;color:white;font-weight:600;cursor:pointer;transition:all 0.3s ease;}
    .nav-tab.active{background:white;color:var(--primary);}
    .tab-content{display:none;}
    .tab-content.active{display:block;}
    .card{background:white;border-radius:20px;padding:35px;box-shadow:0 10px 40px rgba(0,0,0,0.15);}
    .card-header{display:flex;align-items:center;gap:15px;margin-bottom:25px;padding-bottom:20px;border-bottom:2px solid var(--border);}
    .btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:600;color:white;transition:0.2s;}
    .btn-primary{background:var(--primary);}
    .btn-email{background:#8e44ad;} 
    
    /* STATS */
    .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
    .stat-card { padding: 20px; border-radius: 12px; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .bg-airbnb { background: #FF5A5F; }
    .bg-abritel { background: #3498DB; }
    .bg-gites { background: #27AE60; }
    .bg-autres { background: #9B59B6; }
    .stat-number { font-size: 2.5rem; font-weight: 700; margin-top: 10px; }
    .kpi-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 30px; }
    .kpi-card { background: #f8f9fa; padding: 15px; border-radius: 12px; border-left: 4px solid #ccc; }
    .kpi-value { font-size: 1.8rem; font-weight: 700; color: #2C3E50; }
    
    /* RESERVATIONS & MENAGE */
    .planning-weeks { display: flex; flex-direction: column; gap: 30px; }
    .week-block { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .week-header-unique { background: linear-gradient(135deg,var(--primary) 0%,#1A3A4D 100%); padding: 12px; text-align: center; color: white; font-weight: bold; }
    .week-content-grid { display: grid; grid-template-columns: 1fr 1fr; border-top: 3px solid var(--primary); }
    .gite-column-inline { padding: 0; border-right: 2px solid var(--border); }
    .week-reservation { padding: 15px; border-bottom: 1px solid var(--border); }
    .week-reservation.trevoux { background: rgba(102,126,234,0.05); }
    .week-reservation.couzon { background: rgba(240,147,251,0.05); }
    
    /* MENAGE SPECIFIQUE */
    .menage-grid {display: grid; grid-template-columns: 1fr 1fr; gap: 30px;}
    .menage-col-header {padding: 15px; border-radius: 12px; color: white; margin-bottom: 20px; text-align: center; font-size: 1.5rem;}
    .menage-col-header.trevoux {background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);}
    .menage-col-header.couzon {background: linear-gradient(135deg,#f093fb 0%,#f5576c 100%);}
    .menage-item {background:#f0f8ff; padding:15px; margin-bottom:10px; border-radius:8px; display:flex; justify-content:space-between; align-items:center;}
    .btn-validation { padding:5px 10px; border-radius:20px; border:none; cursor:pointer; font-size:0.8rem; }
    .validated { background:#d4edda; color:green; } .pending { background:#fff3cd; color:orange; }

    /* LOGIN */
    #loginOverlay {position: fixed; inset: 0; background: #0f172a; z-index: 10000; display: flex; justify-content: center; align-items: center;}
    .login-box {background: white; padding: 40px; border-radius: 20px; width: 400px;}
    .login-input {width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px;}
    
    /* UTILS */
    .alert-info { background: #d1ecf1; color: #0c5460; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
    .form-control { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <h2 style="text-align:center; margin-bottom:20px;">üîí Connexion</h2>
            <form onsubmit="event.preventDefault(); handleLogin();">
                <input type="email" id="loginEmail" class="login-input" placeholder="Email" value="calvignac.gites@gmail.com" required autocomplete="username">
                <input type="password" id="loginPassword" class="login-input" placeholder="Mot de passe" required autocomplete="current-password">
                <button type="submit" class="btn btn-primary" style="width:100%">Se connecter</button>
            </form>
            <p id="loginError" style="color:red; display:none; text-align:center; margin-top:10px;"></p>
        </div>
    </div>

    <div class="container" id="appContainer" style="display: none;">
        <header>
            <div style="position: absolute; top: 20px; right: 20px;">
                <button onclick="handleLogout()" class="btn" style="background:rgba(255,255,255,0.2);">D√©connexion</button>
            </div>
            <h1>üèòÔ∏è Gestion G√Ætes PRO</h1>
        </header>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('reservations')">üìù R√©servations</button>
            <button class="nav-tab" onclick="switchTab('statistiques')">üìä Statistiques</button>
            <button class="nav-tab" onclick="switchTab('menage')">üßπ Planning M√©nage</button>
            <button class="nav-tab" onclick="switchTab('infos-gites')">üìù Infos</button>
            <button class="nav-tab" onclick="switchTab('decouvrir')">üó∫Ô∏è √Ä D√©couvrir</button>
        </div>

        <div id="tab-reservations" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <span>üìÖ</span> <h2>Planning</h2>
                    <button class="btn btn-primary" onclick="syncAllCalendars()" style="margin-left:auto;">Sync Calendriers</button>
                </div>
                <div id="planning-container">Chargement...</div>
            </div>
        </div>

        <div id="tab-statistiques" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <span>üìä</span> <h2>Tableau de Bord</h2>
                    <select id="yearFilterStats" onchange="updateStats()" style="margin-left:auto; padding:8px;">
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                    </select>
                </div>
                <div class="dashboard-grid">
                    <div class="stat-card bg-airbnb"><div>Airbnb</div><div class="stat-number" id="countAirbnb">0</div></div>
                    <div class="stat-card bg-abritel"><div>Abritel</div><div class="stat-number" id="countAbritel">0</div></div>
                    <div class="stat-card bg-gites"><div>G√Ætes de France</div><div class="stat-number" id="countGites">0</div></div>
                    <div class="stat-card bg-autres"><div>Autres</div><div class="stat-number" id="countAutres">0</div></div>
                </div>
                <div class="kpi-grid">
                    <div class="kpi-card"><div class="kpi-title">Taux Tr√©voux</div><div class="kpi-value" id="tauxTrevoux">0%</div></div>
                    <div class="kpi-card"><div class="kpi-title">Taux Couzon</div><div class="kpi-value" id="tauxCouzon">0%</div></div>
                    <div class="kpi-card"><div class="kpi-title">Prix Moyen</div><div class="kpi-value" id="prixMoyen">0‚Ç¨</div></div>
                    <div class="kpi-card"><div class="kpi-title">CA Total</div><div class="kpi-value" id="statCA">0‚Ç¨</div></div>
                    <div class="kpi-card"><div class="kpi-title">Total R√©sas</div><div class="kpi-value" id="statTotal">0</div></div>
                </div>
                <div style="height:350px"><canvas id="caChart"></canvas></div>
            </div>
        </div>

        <div id="tab-menage" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <span>üßπ</span> <h2>Planning M√©nage</h2>
                    <div style="margin-left:auto; display:flex; gap:10px;">
                        <button class="btn btn-primary" onclick="genererPlanningMenage()">Rafra√Æchir</button>
                        <button class="btn btn-email" onclick="envoyerPlanningEmail()">üìß Envoyer</button>
                    </div>
                </div>
                <div id="menagePlanning">Chargement...</div>
            </div>
        </div>

        <div id="tab-infos-gites" class="tab-content">
            <div class="card">
                <div class="card-header"><span>üìù</span> <h2>Infos Pratiques</h2></div>
                <div style="margin-bottom:20px;">
                    <button class="btn btn-primary" onclick="selectGiteInfos('Tr√©voux')">Tr√©voux</button>
                    <button class="btn btn-primary" onclick="selectGiteInfos('Couzon')">Couzon</button>
                </div>
                <form id="infosGiteForm" onsubmit="sauvegarderInfosGiteComplet(event)">
                    <div class="form-group"><label>Wifi SSID</label><input type="text" id="infos_wifiSSID" class="form-control"></div>
                    <div class="form-group"><label>Wifi MDP</label><input type="text" id="infos_wifiPassword" class="form-control"></div>
                    <div class="form-group"><label>Code Bo√Æte √† Cl√©s</label><input type="text" id="infos_codeAcces" class="form-control"></div>
                    <button type="submit" class="btn btn-primary">Sauvegarder</button>
                </form>
            </div>
        </div>

        <div id="tab-decouvrir" class="tab-content">
            <div class="card">
                <div class="card-header"><span>üó∫Ô∏è</span> <h2>√Ä D√©couvrir</h2></div>
                <div style="margin-bottom:20px;">
                    <button class="btn btn-primary" onclick="selectGiteDecouvrir('Tr√©voux')">Tr√©voux</button>
                    <button class="btn btn-primary" onclick="selectGiteDecouvrir('Couzon')">Couzon</button>
                </div>
                <div id="activitesParCategorie">S√©lectionnez un g√Æte pour voir les activit√©s.</div>
            </div>
        </div>

        <div id="tab-charges" class="tab-content"></div>

    </div>

    <script>
        const SUPABASE_URL = 'https://ivqiisnudabxemcxxyru.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2cWlpc251ZGFieGVtY3h4eXJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzOTk0NjMsImV4cCI6MjA4MDk3NTQ2M30.9FwJPgR8bbaP7bAemuaVbAN019EO5ql7uciQO9FeHK4';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let caChartInstance; window.DB_VALIDATIONS={}; window.activitesParGite={ 'Tr√©voux':[], 'Couzon':[] };

        // INIT
        async function initApp() {
            const { data: { session } } = await supabase.auth.getSession();
            if(!session) { document.getElementById('loginOverlay').style.display='flex'; }
            else { 
                document.getElementById('loginOverlay').style.display='none'; 
                document.getElementById('appContainer').style.display='block';
                
                // On charge les donn√©es en mode "s√©curis√©" : si l'un √©choue, √ßa ne plante pas tout
                try { await loadCleaningValidations(); } catch(e) { console.error("Err menage", e); }
                try { await updateReservationsList(); } catch(e) { console.error("Err resas", e); }
                try { await updateStats(); } catch(e) { console.error("Err stats", e); }
                try { chargerUrlsIcal(); } catch(e) {}
            }
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const { error } = await supabase.auth.signInWithPassword({ email, password });
            if(error) document.getElementById('loginError').innerText = error.message;
            else { 
                document.getElementById('loginError').style.display='none';
                initApp(); 
            }
        }
        async function handleLogout() { await supabase.auth.signOut(); location.reload(); }

        // --- RESERVATIONS ---
        async function updateReservationsList() {
            const { data: resas, error } = await supabase.from('reservations').select('*').order('date_debut');
            if(error) return console.error(error);
            if(!resas || resas.length === 0) {
                document.getElementById('planning-container').innerHTML = '<p>Aucune r√©servation.</p>';
                return;
            }

            // Filtrer dates pass√©es
            const active = resas.filter(r => new Date(r.date_fin) >= new Date()).sort((a,b)=>new Date(a.date_debut)-new Date(b.date_debut));
            
            // Grouper par semaine
            const weeks = {};
            active.forEach(r => {
                const d = new Date(r.date_debut);
                const weekNum = getWeekNumber(d);
                if(!weeks[weekNum]) weeks[weekNum] = [];
                weeks[weekNum].push(r);
            });

            let html = '<div class="planning-weeks">';
            // En-t√™te colonnes
            html += `<div style="display:grid; grid-template-columns:1fr 1fr; margin-bottom:10px;">
                <div style="text-align:center; font-weight:bold; color:#667eea;">Tr√©voux</div>
                <div style="text-align:center; font-weight:bold; color:#f093fb;">Couzon</div>
            </div>`;

            Object.keys(weeks).sort().forEach(week => {
                html += `<div class="week-block"><div class="week-header-unique">${week}</div>
                <div class="week-content-grid">
                    <div class="gite-column-inline">
                        ${weeks[week].filter(r=>r.gite==='Tr√©voux').map(r => renderResaCard(r)).join('')}
                    </div>
                    <div class="gite-column-inline">
                        ${weeks[week].filter(r=>r.gite==='Couzon').map(r => renderResaCard(r)).join('')}
                    </div>
                </div></div>`;
            });
            html += '</div>';
            document.getElementById('planning-container').innerHTML = html;
        }

        function renderResaCard(r) {
            return `<div class="week-reservation ${r.gite==='Tr√©voux'?'trevoux':'couzon'}">
                <div style="font-weight:bold;">${r.nom_client || 'Client'}</div>
                <div style="font-size:0.9rem;">${new Date(r.date_debut).toLocaleDateString()} -> ${new Date(r.date_fin).toLocaleDateString()}</div>
                <div style="font-size:0.8rem;color:#666;">${r.plateforme} - ${r.montant}‚Ç¨</div>
            </div>`;
        }

        // --- STATS ---
        async function updateStats() {
            const year = document.getElementById('yearFilterStats').value;
            const { data: resas } = await supabase.from('reservations').select('*');
            if(!resas) return;

            const filtered = resas.filter(r => r.date_debut && r.date_debut.startsWith(year));
            
            let airbnb=0, abritel=0, gites=0, autres=0, ca=0;
            const chartData = Array(12).fill(0);

            filtered.forEach(r => {
                const site = (r.plateforme||'').toLowerCase();
                if(site.includes('airbnb')) airbnb++;
                else if(site.includes('abritel')) abritel++;
                else if(site.includes('gites')) gites++;
                else autres++;
                
                ca += (parseFloat(r.montant)||0);
                
                if(r.date_debut) {
                    const m = new Date(r.date_debut).getMonth();
                    chartData[m] += (parseFloat(r.montant)||0);
                }
            });

            document.getElementById('countAirbnb').innerText = airbnb;
            document.getElementById('countAbritel').innerText = abritel;
            document.getElementById('countGites').innerText = gites;
            document.getElementById('countAutres').innerText = autres;
            document.getElementById('statCA').innerText = ca.toFixed(0) + ' ‚Ç¨';
            document.getElementById('statTotal').innerText = filtered.length;

            const ctx = document.getElementById('caChart');
            if(caChartInstance) caChartInstance.destroy();
            caChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['J','F','M','A','M','J','J','A','S','O','N','D'],
                    datasets: [{ label:'CA '+year, data:chartData, borderColor:'#2C5F7D', tension:0.3 }]
                }
            });
        }

        // --- MENAGE ---
        async function loadCleaningValidations() {
            const { data } = await supabase.from('cleaning_validation').select('*');
            window.DB_VALIDATIONS = {};
            if(data) data.forEach(v => window.DB_VALIDATIONS[v.reservation_id] = v.status);
        }

        async function genererPlanningMenage() {
            await loadCleaningValidations();
            const { data: resas } = await supabase.from('reservations').select('*');
            const now = new Date(); now.setHours(0,0,0,0);
            
            // Filtre futur
            const future = resas.filter(r => new Date(r.date_fin) >= now).sort((a,b)=>new Date(a.date_fin)-new Date(b.date_fin));
            
            const trevoux = future.filter(r => r.gite === 'Tr√©voux');
            const couzon = future.filter(r => r.gite === 'Couzon');

            function renderCol(list) {
                return list.map(r => {
                    const dateFin = new Date(r.date_fin);
                    // Dimanche -> Lundi
                    let menageDate = new Date(dateFin);
                    if(dateFin.getDay()===0) menageDate.setDate(dateFin.getDate()+1);
                    
                    const status = window.DB_VALIDATIONS[r.id] || 'pending';
                    const btnClass = status==='validated' ? 'validated' : 'pending';
                    const btnText = status==='validated' ? 'FAIT' : '√Ä FAIRE';
                    
                    return `<div class="menage-item">
                        <div>
                            <strong>${menageDate.toLocaleDateString()}</strong> <br>
                            ${r.nom_client||'Client'}
                        </div>
                        <button class="btn-validation ${btnClass}" onclick="toggleStatus(${r.id}, '${status}', '${menageDate.toISOString()}', '${r.gite}')">${btnText}</button>
                    </div>`;
                }).join('');
            }

            document.getElementById('menagePlanning').innerHTML = `
                <div class="menage-grid">
                    <div><div class="menage-col-header trevoux">Tr√©voux</div>${renderCol(trevoux)}</div>
                    <div><div class="menage-col-header couzon">Couzon</div>${renderCol(couzon)}</div>
                </div>
            `;
        }

        async function toggleStatus(id, current, date, gite) {
            const next = current==='validated'?'pending':'validated';
            const { error } = await supabase.from('cleaning_validation').upsert({
                reservation_id: id, gite, original_date: date, status: next
            }, {onConflict:'reservation_id'});
            
            if(!error) {
                window.DB_VALIDATIONS[id] = next;
                genererPlanningMenage();
            } else {
                console.error(error); // Voir console si erreur 403 (SQL n√©cessaire)
                alert("Erreur de sauvegarde. Avez-vous lanc√© le SQL ?");
            }
        }

        function envoyerPlanningEmail() {
            const url = window.location.href.replace('index.html', 'validation.html');
            window.location.href = `mailto:?subject=Planning M√©nage&body=Merci de valider ici: ${url}`;
        }

        // --- INFOS & DECOUVRIR ---
        async function selectGiteInfos(gite) {
            const { data } = await supabase.from('infos_gites').select('data').eq('gite_nom', gite).maybeSingle();
            if(data && data.data) {
                document.getElementById('infos_wifiSSID').value = data.data.wifiSSID || '';
                document.getElementById('infos_wifiPassword').value = data.data.wifiPassword || '';
                document.getElementById('infos_codeAcces').value = data.data.codeAcces || '';
            } else {
                document.getElementById('infosGiteForm').reset();
            }
            window.currentGiteInfos = gite;
        }
        async function sauvegarderInfosGiteComplet(e) {
            e.preventDefault();
            const d = {
                wifiSSID: document.getElementById('infos_wifiSSID').value,
                wifiPassword: document.getElementById('infos_wifiPassword').value,
                codeAcces: document.getElementById('infos_codeAcces').value
            };
            await supabase.from('infos_gites').upsert({gite_nom: window.currentGiteInfos, data: d}, {onConflict:'gite_nom'});
            alert('Sauvegard√©');
        }

        async function selectGiteDecouvrir(gite) {
            const { data } = await supabase.from('activites_gites').select('*').eq('gite', gite);
            const div = document.getElementById('activitesParCategorie');
            if(!data || data.length===0) div.innerHTML='Aucune activit√©.';
            else div.innerHTML = data.map(a => `<div style="padding:10px; border-bottom:1px solid #ddd;"><b>${a.nom}</b> (${a.categorie})</div>`).join('');
        }

        // --- UTILS ---
        function getWeekNumber(d) { d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7)); var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1)); var weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7); return d.getUTCFullYear()+"-W"+weekNo; }
        
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(b=>b.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
            event.target.classList.add('active');
            if(id==='statistiques') updateStats();
            if(id==='menage') genererPlanningMenage();
        }
        
        // Placeholders
        function chargerUrlsIcal() {} 
        async function syncAllCalendars() {}

        initApp();
    </script>
</body>
</html>
