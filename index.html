<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion G√Ætes PRO - Tr√©voux & Couzon</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ical.js@1.5.0/build/ical.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style> 
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Work+Sans:wght@300;400;600;700&display=swap');
    *{margin:0;padding:0;box-sizing:border-box;}
    :root{--primary:#2C5F7D;--primary-dark:#1A3A4D;--accent:#E8A87C;--bg-light:#F8F9FA;--text-dark:#2C3E50;--success:#27AE60;--trevoux:#667eea;--couzon:#f093fb;--border:#E0E4E8;--warning:#F39C12;--danger:#E74C3C;--airbnb:#FF5A5F;--abritel:#3498DB;--gites:#27AE60;}
    body{font-family:'Work Sans',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;color:var(--text-dark);}
    .container{max-width:1600px;margin:0 auto;}
    header{text-align:center;margin-bottom:40px;color:white;}
    h1{font-family:'Playfair Display',serif;font-size:3rem;margin-bottom:10px;text-shadow:2px 2px 4px rgba(0,0,0,0.2);}
    .subtitle{font-size:1.1rem;opacity:0.95;font-weight:300;}
    .nav-tabs{display:flex;gap:10px;margin-bottom:30px;flex-wrap:wrap;justify-content:center;}
    .nav-tab{padding:15px 30px;background:rgba(255,255,255,0.2);border:none;border-radius:12px;color:white;font-weight:600;cursor:pointer;transition:all 0.3s ease;font-family:'Work Sans',sans-serif;font-size:1rem;}
    .nav-tab:hover{background:rgba(255,255,255,0.3);}
    .nav-tab.active{background:white;color:var(--primary);}
    .tab-content{display:none;}
    .tab-content.active{display:block;}
    .main-grid{display:grid;grid-template-columns:400px 1fr;gap:30px;margin-bottom:30px;}
    @media (max-width:1200px){.main-grid{grid-template-columns:1fr;}}
    .card{background:white;border-radius:20px;padding:35px;box-shadow:0 10px 40px rgba(0,0,0,0.15);}
    .card-header{display:flex;align-items:center;gap:15px;margin-bottom:25px;padding-bottom:20px;border-bottom:2px solid var(--border);}
    .card-icon{font-size:2.5rem;}
    .card-title{font-family:'Playfair Display',serif;font-size:1.8rem;color:var(--primary);}
    .form-group{margin-bottom:20px;}
    label{display:block;margin-bottom:8px;font-weight:600;color:var(--text-dark);font-size:0.95rem;}
    input,select,textarea{width:100%;padding:12px 15px;border:2px solid var(--border);border-radius:10px;font-size:1rem;font-family:'Work Sans',sans-serif;transition:all 0.3s ease;background:white;}
    input:disabled{background:#f0f0f0;cursor:not-allowed;}
    .btn{width:100%;padding:15px;border:none;border-radius:12px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:all 0.3s ease;display:flex;align-items:center;justify-content:center;gap:10px;}
    .btn-primary{background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);color:white;}
    .btn-secondary{background:linear-gradient(135deg,var(--accent) 0%,#D89968 100%);color:white;margin-top:10px;}
    .btn-sync{background:linear-gradient(135deg,#3498DB 0%,#2874A6 100%);color:white;margin-top:10px;}
    .btn-menage{background:linear-gradient(135deg,#27AE60 0%,#229954 100%);color:white;margin-top:10px;}
    .btn-danger{background:linear-gradient(135deg,var(--danger) 0%,#C0392B 100%);color:white;}
    .menage-item{background:#f0f8ff;padding:15px;margin-bottom:10px;border-radius:8px;border-left:4px solid #27AE60; display: flex; justify-content: space-between; align-items: center;}
    .menage-date{font-weight:700;color:var(--primary);margin-bottom:5px;}
    .menage-detail{font-size:0.95rem;color:#666;}
    .charge-item{background:var(--bg-light);padding:15px;border-radius:10px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;}
    .charge-amount{font-size:1.2rem;font-weight:700;color:var(--danger);}
    .btn-small{padding:8px 15px;font-size:0.9rem;width:auto;}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px;}
    .stat-item{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:25px;border-radius:15px;text-align:center;color:white;}
    .stat-value{font-size:2.5rem;font-weight:700;margin-bottom:5px;}
    .stat-label{font-size:0.9rem;opacity:0.95;}
    .chart-container{margin-top:30px;height:350px;}
    .week-block{background:white;border-radius:15px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,0.1); margin-bottom: 30px;}
    .week-header-unique{background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);padding:12px;text-align:center;color:white;}
    .week-content-grid{display:grid;grid-template-columns:1fr 1fr;gap:0;border-top:3px solid var(--primary);}
    .gite-column-inline{padding:0;border-right:2px solid var(--border);}
    .week-reservation{padding:15px;border-bottom:1px solid var(--border);}
    .week-reservation.trevoux{background:rgba(102,126,234,0.05);}
    .week-reservation.couzon{background:rgba(240,147,251,0.05);}
    .alert{padding:15px 20px;border-radius:10px;margin-bottom:20px;font-weight:500;}
    .alert-info{background:#D6EAF8;color:#1F618D;border-left:4px solid #3498DB;}
    .alert-warning{background:#FCF3CF;color:#7D6608;border-left:4px solid var(--warning);}
    .toast{position:fixed;top:30px;right:30px;background:var(--success);color:white;padding:20px 30px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.3);display:none;align-items:center;gap:15px;z-index:1000;animation:slideIn 0.3s ease;max-width:400px;}
    .toast.show{display:flex;}
    @keyframes slideIn{from{transform:translateX(400px);opacity:0;}to{transform:translateX(0);opacity:1;}}
    .modal{display:none;position:fixed;z-index:2000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5);animation:fadeIn 0.3s ease;}
    .modal.show{display:flex;align-items:center;justify-content:center;}
    .modal-content{background:white;padding:30px;border-radius:20px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;animation:slideUp 0.3s ease;}
    @keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
    @keyframes slideUp{from{transform:translateY(50px);opacity:0;}to{transform:translateY(0);opacity:1;}}
    
    /* Login Modal Styles */
    #loginOverlay {position: fixed; inset: 0; background: #0f172a; z-index: 10000; display: flex; justify-content: center; align-items: center;}
    .login-box {background: white; padding: 40px; border-radius: 20px; width: 100%; max-width: 400px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);}
    .login-input {width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #e2e8f0; border-radius: 8px;}
    .btn-validation {padding: 6px 12px; border-radius: 999px; font-weight: 600; font-size: 0.85rem; cursor: pointer; border: none; transition: all 0.2s;}
    .btn-validation.pending {background: #FFF3E0; color: #F57C00; border: 1px solid #F57C00;}
    .btn-validation.validated {background: #E8F5E9; color: #2E7D32; border: 1px solid #2E7D32;}
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <h2 style="text-align: center; color: #0f172a; margin-bottom: 20px;">üîí Connexion G√Ætes PRO</h2>
            <input type="email" id="loginEmail" class="login-input" placeholder="Email" value="calvignac.gites@gmail.com">
            <input type="password" id="loginPassword" class="login-input" placeholder="Mot de passe">
            <button onclick="handleLogin()" class="btn btn-primary" style="width: 100%;">Se connecter</button>
            <p id="loginError" style="color: #ef4444; text-align: center; margin-top: 10px; display: none;"></p>
        </div>
    </div>

    <div class="container" id="appContainer" style="display: none;">
        <header style="position: relative;">
            <div style="position: absolute; top: 0; right: 0;">
                <button onclick="handleLogout()" style="padding: 8px 16px; border-radius: 10px; background: rgba(239, 68, 68, 0.2); color: white; border: 1px solid rgba(239, 68, 68, 0.4); cursor: pointer; margin-right: 10px;">D√©connexion</button>
            </div>
            <h1>üèòÔ∏è Gestion G√Ætes PRO</h1>
            <p class="subtitle">Tr√©voux & Couzon - Synchronisation & Donn√©es Temps R√©el</p>
        </header>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('reservations')">üìù R√©servations</button>
            <button class="nav-tab" onclick="switchTab('statistiques')">üìä Statistiques</button>
            <button class="nav-tab" onclick="switchTab('charges')">üí∂ Charges</button>
            <button class="nav-tab" onclick="switchTab('menage')">üßπ Planning M√©nage</button>
            <button class="nav-tab" onclick="switchTab('infos-gites')">üìù Infos Pratiques</button>
            <button class="nav-tab" onclick="switchTab('decouvrir')">üó∫Ô∏è √Ä D√©couvrir</button>
        </div>
        
        <div id="tab-gestion" class="tab-content">
            <div class="card">
                <div class="card-header"><span class="card-icon">‚öôÔ∏è</span><h2 class="card-title">Gestion URLs iCal</h2></div>
                <div class="alert alert-info"><strong>üîÑ Sync auto</strong><br>Les calendriers sont synchronis√©s automatiquement au d√©marrage.</div>
                <h3 style="margin: 30px 0 15px; color: var(--trevoux);">üè∞ Tr√©voux</h3>
                <div class="form-group"><label>Airbnb iCal URL</label><textarea id="icalAirbnbTrevoux" rows="2" style="font-size:0.85rem"></textarea></div>
                <div class="form-group"><label>Abritel iCal URL</label><textarea id="icalAbritelTrevoux" rows="2" style="font-size:0.85rem"></textarea></div>
                <div class="form-group"><label>G√Ætes de France iCal URL</label><textarea id="icalGitesTrevoux" rows="2" style="font-size:0.85rem"></textarea></div>
                <h3 style="margin: 30px 0 15px; color: var(--couzon);">‚õ∞Ô∏è Couzon</h3>
                <div class="form-group"><label>Airbnb iCal URL</label><textarea id="icalAirbnbCouzon" rows="2" style="font-size:0.85rem"></textarea></div>
                <div class="form-group"><label>Abritel iCal URL</label><textarea id="icalAbritelCouzon" rows="2" style="font-size:0.85rem"></textarea></div>
                <div class="form-group"><label>G√Ætes de France iCal URL</label><textarea id="icalGitesCouzon" rows="2" style="font-size:0.85rem"></textarea></div>
                <button class="btn btn-primary" onclick="sauvegarderUrlsIcal()"><span>üíæ</span> Sauvegarder</button>
                <button class="btn btn-sync" onclick="syncAllCalendars()" style="margin-top:10px"><span>üîÑ</span> Sync Manuelle</button>
                <div id="syncProgress" class="sync-progress" style="display:none;margin-top:20px"><strong>En cours...</strong><div id="syncMessages"></div></div>
            </div>
        </div>
        
        <div id="tab-reservations" class="tab-content active">
            <div class="card">
                <div class="card-header"><span class="card-icon">üìÖ</span><h2 class="card-title">Planning</h2></div>
                <div id="planning-container" class="planning-container"></div>
            </div>
        </div>
        
        <div id="tab-statistiques" class="tab-content">
            <div class="stats-section">
                 <div class="card-header"><span class="card-icon">üìä</span><h2 class="card-title">Statistiques</h2></div>
                <div class="stats-grid">
                    <div class="stat-item"><div class="stat-value" id="statTotal">0</div><div class="stat-label">R√©servations</div></div>
                    <div class="stat-item"><div class="stat-value" id="statCA">0 ‚Ç¨</div><div class="stat-label">CA Total</div></div>
                </div>
                <div class="chart-container"><canvas id="caChart"></canvas></div>
            </div>
        </div>
        
        <div id="tab-charges" class="tab-content">
            <div class="main-grid">
                <div class="card">
                    <div class="card-header"><span class="card-icon">üí∂</span><h2 class="card-title">Ajouter Charge</h2></div>
                    <form id="chargeForm">
                        <div class="form-group"><label>G√Æte</label><select id="chargeGite"><option value="Tr√©voux">Tr√©voux</option><option value="Couzon">Couzon</option><option value="Commun">Commun</option></select></div>
                        <div class="form-group"><label>Nom</label><input type="text" id="chargeNom" required></div>
                        <div class="form-group"><label>Montant (‚Ç¨)</label><input type="number" id="chargeMontant" step="0.01" required></div>
                        <div class="form-group"><label>Type</label><select id="chargeType"><option value="mensuelle">Mensuelle</option><option value="annuelle">Annuelle</option><option value="ponctuelle">Ponctuelle</option></select></div>
                        <div class="form-group"><label>Date</label><input type="date" id="chargeDate"></div>
                        <button type="submit" class="btn btn-primary"><span>‚ûï</span> Ajouter</button>
                    </form>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-icon">üìã</span><h2 class="card-title">Liste</h2></div>
                    <div class="charges-list" id="chargesList"></div>
                </div>
            </div>
        </div>
        
        <div id="tab-menage" class="tab-content">
            <div class="card">
                <div class="card-header"><span class="card-icon">üßπ</span><h2 class="card-title">Planning M√©nage</h2></div>
                <button class="btn btn-menage" onclick="genererPlanningMenage()"><span>üßπ</span> Rafra√Æchir Planning</button>
                <div id="menagePlanning" style="margin-top: 30px;"></div>
            </div>
        </div>
        
        <div id="tab-infos-gites" class="tab-content">
            <div class="card">
                <div class="card-header"><span class="card-icon">üìã</span><h2 class="card-title">Infos Pratiques</h2></div>
                <div style="margin-bottom:20px; display:flex; gap:10px;">
                    <button class="btn" style="flex:1" onclick="selectGiteInfos('Tr√©voux')">Tr√©voux</button>
                    <button class="btn" style="flex:1" onclick="selectGiteInfos('Couzon')">Couzon</button>
                </div>
                <form id="infosGiteForm" onsubmit="sauvegarderInfosGiteComplet(event)">
                    <div class="form-group"><label>Adresse</label><input type="text" id="infos_adresse" class="form-control"></div>
                    <div class="form-group"><label>Wifi SSID</label><input type="text" id="infos_wifiSSID" class="form-control"></div>
                    <div class="form-group"><label>Wifi MDP</label><input type="text" id="infos_wifiPassword" class="form-control"></div>
                    <div class="form-group"><label>Code Bo√Æte √† Cl√©s</label><input type="text" id="infos_codeAcces" class="form-control"></div>
                    <button type="submit" class="btn btn-primary">üíæ Enregistrer</button>
                </form>
            </div>
        </div>
        
        <div id="tab-decouvrir" class="tab-content">
            <div class="card" style="background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%); color: white;">
                <div class="card-header" style="border-bottom: 2px solid rgba(255,255,255,0.3);">
                    <span class="card-icon">üó∫Ô∏è</span>
                    <h2 class="card-title">√Ä D√©couvrir</h2>
                </div>
                <div style="padding: 20px; display:flex; gap:15px;">
                    <button class="btn" style="background:white; color:#FF6B6B; flex:1" onclick="selectGiteDecouvrir('Tr√©voux')">üè∞ Tr√©voux</button>
                    <button class="btn" style="background:white; color:#FF6B6B; flex:1" onclick="selectGiteDecouvrir('Couzon')">‚õ∞Ô∏è Couzon</button>
                </div>
            </div>

            <form id="formDecouvrir" style="display: none;">
                <input type="hidden" id="decouvrir_gite">
                <div class="alert alert-info"><strong>üìç G√Æte :</strong> <span id="selectedGiteDecouvrir" style="font-weight: 700;"></span></div>

                <div class="card">
                     <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 15px;"><span class="card-icon">üìã</span><h2 class="card-title">Activit√©s</h2></div>
                        <button type="button" onclick="toggleFormAjout()" style="background: #27AE60; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.5rem; cursor: pointer;">‚ûï</button>
                    </div>

                    <div id="formAjoutActivite" style="display: none; margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 12px; border: 2px dashed #27AE60;">
                        <div style="display: grid; gap: 15px;">
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                                <div><label>Nom *</label><input type="text" id="activite_nom" class="form-control"></div>
                                <div><label>Cat√©gorie *</label>
                                    <select id="activite_categorie" class="form-control">
                                        <option value="üçΩÔ∏è Restaurant">üçΩÔ∏è Restaurant</option>
                                        <option value="üèõÔ∏è Site Touristique">üèõÔ∏è Site Touristique</option>
                                        <option value="üõçÔ∏è Commerce">üõçÔ∏è Commerce</option>
                                        <option value="üå≥ Nature & Randonn√©e">üå≥ Nature & Randonn√©e</option>
                                        <option value="‚öΩ Sport & Loisirs">‚öΩ Sport & Loisirs</option>
                                    </select>
                                </div>
                            </div>
                            <div><label>Description</label><textarea id="activite_description" rows="2"></textarea></div>
                            <div><label>Adresse</label><input type="text" id="activite_adresse"></div>
                            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;">
                                <div><label>Distance (km)</label><input type="number" id="activite_distance" step="0.1"></div>
                                <div><label>Prix</label><select id="activite_prix"><option value="‚Ç¨">‚Ç¨</option><option value="‚Ç¨‚Ç¨">‚Ç¨‚Ç¨</option><option value="‚Ç¨‚Ç¨‚Ç¨">‚Ç¨‚Ç¨‚Ç¨</option></select></div>
                                <div><label>Note (0-5)</label><input type="number" id="activite_note" step="0.1" max="5"></div>
                            </div>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                                <div><label>Site Web</label><input type="url" id="activite_website"></div>
                                <div><label>T√©l√©phone</label><input type="tel" id="activite_telephone"></div>
                            </div>
                             <button type="button" class="btn btn-primary" onclick="ajouterActivite()">‚ûï Ajouter (Cloud)</button>
                        </div>
                    </div>

                    <div id="activitesParCategorie"></div>
                </div>
            </form>
        </div>
    </div>
    
    <div class="toast" id="toast"><span style="font-size: 1.5rem;">‚úì</span><span id="toastMessage"></span></div>
    
    <script>
        // CONFIG SUPABASE
        const SUPABASE_URL = 'https://ivqiisnudabxemcxxyru.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2cWlpc251ZGFieGVtY3h4eXJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzOTk0NjMsImV4cCI6MjA4MDk3NTQ2M30.9FwJPgR8bbaP7bAemuaVbAN019EO5ql7uciQO9FeHK4';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let caChartInstance;
        window.DB_VALIDATIONS = {}; 
        window.activitesParGite = { 'Tr√©voux': [], 'Couzon': [] };
        window.currentGiteInfos = null;

        // INIT
        async function initApp() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                document.getElementById('loginOverlay').style.display = 'flex';
                document.getElementById('appContainer').style.display = 'none';
            } else {
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                await loadCleaningValidations();
                await updateReservationsList();
                await updateStats();
                chargerUrlsIcal();
                setTimeout(() => syncAllCalendars(), 1000);
            }
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            try {
                const { error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
                initApp();
            } catch (err) {
                document.getElementById('loginError').style.display = 'block';
                document.getElementById('loginError').innerText = err.message;
            }
        }
        async function handleLogout() { await supabase.auth.signOut(); location.reload(); }

        // --- GESTION ACTIVITES (DB RELIEE) ---
        async function chargerActivites() {
             const { data, error } = await supabase.from('activites_gites').select('*');
             if(!error && data) {
                 window.activitesParGite = { 'Tr√©voux': [], 'Couzon': [] };
                 data.forEach(act => {
                     if(window.activitesParGite[act.gite]) window.activitesParGite[act.gite].push(act);
                 });
                 const currentGite = document.getElementById('decouvrir_gite').value;
                 if(currentGite) afficherActivites(currentGite);
             }
        }

        function afficherActivites(gite) {
            const activites = window.activitesParGite[gite] || [];
            const container = document.getElementById('activitesParCategorie');
            if (activites.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">Aucune activit√©.</p>';
                return;
            }
            const parCategorie = {};
            activites.forEach(act => {
                if (!parCategorie[act.categorie]) parCategorie[act.categorie] = [];
                parCategorie[act.categorie].push(act);
            });
            let html = '';
            Object.keys(parCategorie).sort().forEach(cat => {
                html += `<h3 style="color:var(--primary);margin-top:20px;border-bottom:2px solid #ddd;">${cat}</h3>`;
                parCategorie[cat].forEach(act => {
                     const stars = act.note ? '‚≠ê'.repeat(Math.round(act.note)) : '';
                     html += `
                        <div style="background:#f9f9f9; padding:15px; margin-top:10px; border-left:4px solid var(--primary); border-radius:5px;">
                            <div style="display:flex; justify-content:space-between;">
                                <strong style="font-size:1.1rem; color:#2C5F7D;">${act.nom}</strong>
                                <button onclick="supprimerActivite(${act.id})" style="border:none;background:none;cursor:pointer;">üóëÔ∏è</button>
                            </div>
                            <div style="color:#666; font-size:0.9rem; margin:5px 0;">${act.description || ''}</div>
                            <div style="display:flex; gap:10px; font-size:0.85rem; color:#555; margin-top:5px;">
                                ${act.distance ? `<span>üìç ${act.distance} km</span>` : ''}
                                ${act.prix ? `<span>üí∞ ${act.prix}</span>` : ''}
                                ${stars ? `<span>${stars}</span>` : ''}
                            </div>
                            <div style="margin-top:10px; display:flex; gap:10px;">
                                ${act.google_maps_link ? `<a href="${act.google_maps_link}" target="_blank" style="text-decoration:none;">üó∫Ô∏è Itin√©raire</a>` : ''}
                                ${act.website ? `<a href="${act.website}" target="_blank" style="text-decoration:none;">üåê Site Web</a>` : ''}
                                ${act.telephone ? `<a href="tel:${act.telephone}" style="text-decoration:none;">üìû Appeler</a>` : ''}
                            </div>
                        </div>`;
                });
            });
            container.innerHTML = html;
        }

        async function ajouterActivite() {
            const gite = document.getElementById('decouvrir_gite').value;
            const nom = document.getElementById('activite_nom').value;
            if(!gite || !nom) return showToast('Nom obligatoire', 'error');
            
            // Cr√©ation de l'objet complet correspondant √† la DB
            const newAct = {
                gite,
                nom,
                categorie: document.getElementById('activite_categorie').value,
                description: document.getElementById('activite_description').value,
                adresse: document.getElementById('activite_adresse').value,
                distance: document.getElementById('activite_distance').value || null,
                prix: document.getElementById('activite_prix').value,
                note: document.getElementById('activite_note').value || null,
                website: document.getElementById('activite_website').value,
                telephone: document.getElementById('activite_telephone').value,
                // G√©n√©ration lien GMaps auto si adresse pr√©sente
                google_maps_link: document.getElementById('activite_adresse').value ? 
                    `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(document.getElementById('activite_adresse').value)}` : null
            };

            const { error } = await supabase.from('activites_gites').insert(newAct);
            if(!error) {
                showToast('Activit√© ajout√©e', 'success');
                chargerActivites();
                document.getElementById('formAjoutActivite').style.display = 'none';
            } else {
                showToast('Erreur ajout: ' + error.message, 'error');
            }
        }
        
        async function supprimerActivite(id) {
            if(!confirm("Supprimer ?")) return;
            await supabase.from('activites_gites').delete().eq('id', id);
            chargerActivites();
        }

        // --- GESTION MENAGE ---
        async function loadCleaningValidations() {
            const { data } = await supabase.from('cleaning_validation').select('*');
            window.DB_VALIDATIONS = {};
            if (data) data.forEach(item => window.DB_VALIDATIONS[`${item.gite_nom}_${item.date_menage}`] = item.status);
        }
        async function toggleMenageStatus(gite, dateIso, currentStatus) {
            const newStatus = currentStatus === 'validated' ? 'pending' : 'validated';
            await supabase.from('cleaning_validation').upsert({ gite_nom: gite, date_menage: dateIso, status: newStatus }, { onConflict: 'gite_nom,date_menage' });
            window.DB_VALIDATIONS[`${gite}_${dateIso}`] = newStatus;
            genererPlanningMenage();
        }
        async function genererPlanningMenage() {
            await loadCleaningValidations();
            const resas = await getAllReservations();
            const now = new Date();
            const relevant = resas.filter(r => parseLocalDate(r.dateFin) >= new Date(now.getFullYear(), now.getMonth()-1, 1));
            relevant.sort((a,b) => parseLocalDate(a.dateFin) - parseLocalDate(b.dateFin));
            let html = '';
            relevant.forEach(r => {
                const depart = parseLocalDate(r.dateFin);
                let menageDate = new Date(depart);
                let heure = '12h00';
                if(depart.getDay() === 0) menageDate.setDate(menageDate.getDate()+1);
                const dateIso = dateToLocalString(menageDate);
                const status = window.DB_VALIDATIONS[`${r.gite}_${dateIso}`] || 'pending';
                const btnClass = status === 'validated' ? 'btn-validation validated' : 'btn-validation pending';
                const btnText = status === 'validated' ? '‚úÖ FAIT' : '‚è≥ √Ä FAIRE';
                html += `<div class="menage-item">
                    <div><div class="menage-date">üìÖ ${menageDate.toLocaleDateString('fr-FR')} ${heure}</div>
                    <div class="menage-detail">üè† ${r.gite} - ${r.nom}</div></div>
                    <button class="${btnClass}" onclick="toggleMenageStatus('${r.gite}', '${dateIso}', '${status}')">${btnText}</button>
                </div>`;
            });
            document.getElementById('menagePlanning').innerHTML = html;
        }

        // --- GESTION RESERVATIONS ---
        async function getAllReservations() {
            const { data } = await supabase.from('reservations').select('*').order('date_debut');
            return (data || []).map(r => ({
                id: r.id, gite: r.gite, dateDebut: r.date_debut, dateFin: r.date_fin, site: r.plateforme,
                montant: r.montant, nom: r.nom_client, telephone: r.telephone, montant: r.montant,
                nuits: Math.ceil((new Date(r.date_fin)-new Date(r.date_debut))/(1000*60*60*24))
            }));
        }
        async function updateReservationsList() {
            const resas = await getAllReservations();
            const container = document.getElementById('planning-container');
            const active = resas.filter(r => new Date(r.dateFin) >= new Date()).sort((a,b) => new Date(a.dateDebut) - new Date(b.dateDebut));
            if(active.length===0) { container.innerHTML='<p style="text-align:center;color:#999">Aucune r√©servation</p>'; return; }
            let html = '<div class="planning-weeks">';
            // Group logic simplified
            active.forEach(r => {
                html += `<div class="week-reservation ${r.gite==='Tr√©voux'?'trevoux':'couzon'}">
                    <div style="font-weight:bold">${r.nom} (${r.gite})</div>
                    <div>${new Date(r.dateDebut).toLocaleDateString()} - ${new Date(r.dateFin).toLocaleDateString()}</div>
                    <div>${r.site} - ${r.montant}‚Ç¨</div>
                </div>`; 
            });
            html += '</div>';
            container.innerHTML = html;
        }

        // --- AUTRES ---
        async function updateStats() {
            const resas = await getAllReservations();
            let total = 0; resas.forEach(r => total+=r.montant);
            document.getElementById('statCA').innerText = total.toFixed(0) + ' ‚Ç¨';
            document.getElementById('statTotal').innerText = resas.length;
            
            // Chart
            const ctx = document.getElementById('caChart');
            if(caChartInstance) caChartInstance.destroy();
            caChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Total'],
                    datasets: [{ label: 'CA', data: [total], backgroundColor: '#3498DB' }]
                }
            });
        }

        // --- UTILITAIRES ---
        function parseLocalDate(s) { const [y,m,d] = s.split('-'); return new Date(y, m-1, d); }
        function dateToLocalString(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
        function showToast(msg, type='success') {
            const t = document.getElementById('toast');
            t.style.background = type==='error'?'#E74C3C':'#27AE60';
            document.getElementById('toastMessage').innerText = msg;
            t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 3000);
        }
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
            event.target.classList.add('active');
        }
        function selectGiteDecouvrir(gite) {
            document.getElementById('decouvrir_gite').value = gite;
            document.getElementById('selectedGiteDecouvrir').innerText = gite;
            document.getElementById('formDecouvrir').style.display = 'block';
            chargerActivites();
        }
        function toggleFormAjout() {
            const f = document.getElementById('formAjoutActivite');
            f.style.display = f.style.display === 'none' ? 'block' : 'none';
        }
        
        // Functions placeholder
        function chargerUrlsIcal() {}
        async function syncAllCalendars() {}
        async function sauvegarderUrlsIcal() {}
        function filterReservations() {}
        async function sauvegarderInfosGiteComplet(e) { e.preventDefault(); showToast('Sauvegard√©'); }
        async function selectGiteInfos(gite) { showToast('G√Æte '+gite+' s√©lectionn√©'); }

        initApp();
    </script>
</body>
</html>
