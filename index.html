<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion G√Ætes - Tableau de Bord Complet</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ical.js@1.5.0/build/ical.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style> 
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Work+Sans:wght@300;400;600;700&display=swap');
        
        /* --- VARIABLES & DESIGN SYSTEM --- */
        :root {
            --primary: #2C3E50;
            --secondary: #34495E;
            --accent: #E67E22;
            --bg-body: #F4F6F8;
            --card-bg: #FFFFFF;
            
            /* Couleurs Plateformes */
            --airbnb: #FF5A5F; 
            --abritel: #3498DB; 
            --gites: #27AE60; 
            --other: #9B59B6; 

            /* Couleurs G√Ætes */
            --trevoux: #667eea; 
            --couzon: #f093fb; 

            /* Interface */
            --success: #2ecc71;
            --warning: #f1c40f;
            --danger: #e74c3c;
            --text-main: #2c3e50;
            --text-light: #7f8c8d;
            --border-radius: 12px;

            /* Couleurs Charts Comparaison */
            --color-current-year: #27ae60;  
            --color-prev-year: #e67e22;     
            --color-prev2-year: #3498db;    
            --color-prev3-year: #9b59b6;    
            
            /* COULEURS DES KPI (Fonds clairs) */
            --kpi-trevoux: #eaf1ff;
            --kpi-couzon: #fde8ff;
            --kpi-pm: #fff8eb;
            --kpi-duree: #ebf5ff;
            --kpi-top-month: #e8fff1;
        }
        
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: 'Work Sans', sans-serif; background: var(--bg-body); color: var(--text-main); padding-bottom: 50px; }
        
        /* --- LOGIN SCREEN --- */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2C3E50; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; color: white; }
        .login-box { background: white; padding: 40px; border-radius: 20px; width: 350px; text-align: center; color: #333; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .login-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; }
        .login-btn { width: 100%; padding: 12px; background: var(--trevoux); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; } 

        /* --- LAYOUT PRINCIPAL --- */
        #app-content { display: none; max-width: 1400px; margin: 0 auto; padding: 20px; }

        /* HEADER & NAV */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #2C3E50; color: white; padding: 15px 30px; border-radius: 50px; }
        .nav-buttons { display: flex; gap: 10px; }
        .nav-btn { background: transparent; border: none; color: #bdc3c7; padding: 10px 15px; cursor: pointer; font-weight: 600; font-size: 0.95rem; display: flex; align-items: center; gap: 8px; transition: 0.3s; border-radius: 20px; }
        .nav-btn:hover, .nav-btn.active { background: linear-gradient(90deg, #3498db, #8e44ad); color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        
        /* ALERT BANNER */
        .alert-banner { background: #FFF3CD; color: #856404; padding: 15px; border-radius: 8px; border: 1px solid #FFEEBA; margin-bottom: 20px; display: none; align-items: center; gap: 10px; }

        /* SECTIONS & CARDS */
        .section-content { display: none; animation: fadeIn 0.4s ease-in-out; }
        .section-content.active { display: block; }
        
        .card { background: white; border-radius: var(--border-radius); padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .card-header { font-family: 'Playfair Display', serif; font-size: 1.5rem; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; color: var(--primary); }

        /* --- STATISTIQUES --- */
        .stats-grid-top { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card-colored { padding: 20px; border-radius: 12px; color: white; position: relative; overflow: hidden; height: 100px; }
        .stat-card-colored h3 { font-size: 0.9rem; opacity: 0.9; margin-bottom: 5px; }
        .stat-card-colored .value { font-size: 2.2rem; font-weight: bold; }
        .stat-card-colored .icon { position: absolute; right: 15px; bottom: 15px; font-size: 2.5rem; opacity: 0.2; }
        
        .stats-grid-kpi { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 20px; }
        .kpi-card { 
            background: white; 
            padding: 15px; border-radius: 12px; border-left: 4px solid #ddd; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
            transition: background-color 0.3s;
        }
        .kpi-card .label { font-size: 0.8rem; color: #7f8c8d; text-transform: uppercase; }
        .kpi-card .val { font-size: 1.4rem; font-weight: bold; color: #2c3e50; margin-top: 5px; }

        .stats-grid-blue { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; }
        .blue-card { background: #2C3E50; color: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 10px rgba(44, 62, 80, 0.4); }
        .blue-card .val { font-size: 2rem; font-weight: bold; }
        .blue-card .lbl { font-size: 0.8rem; opacity: 0.8; text-transform: uppercase; letter-spacing: 1px; margin-top: 5px; }

        .charts-container { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px; }
        
        /* --- PLANNING SEMAINE --- */
        .planning-controls { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .search-bar { padding: 10px 15px; border: 1px solid #ddd; border-radius: 20px; width: 300px; }
        
        .gite-headers { display: flex; margin-bottom: 0; }
        .gite-header { flex: 1; text-align: center; padding: 12px; color: white; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        
        .week-container { background: white; border-radius: var(--border-radius); overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 25px; }
        .week-title { background: #1a252f; color: white; text-align: center; padding: 10px; font-weight: 600; font-size: 0.95rem; border-bottom: 1px solid #34495e; }
        .week-grid { display: grid; grid-template-columns: 1fr 1fr; }
        .day-column { padding: 15px; min-height: 100px; border-right: 1px dashed #eee; }
        .day-column:last-child { border-right: none; }
        
        .res-card { background: white; border: 1px solid #eee; border-radius: 8px; padding: 12px; margin-bottom: 10px; position: relative; transition: transform 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .res-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .res-card.blocked { border-left: 4px solid var(--danger); background: #fff5f5; }
        .res-card .actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; opacity: 0.5; transition: opacity 0.2s; }
        .res-card:hover .actions { opacity: 1; }
        .res-card .client { font-weight: 700; color: #2c3e50; font-size: 1rem; margin-bottom: 4px; }
        .res-card .dates { font-size: 0.85rem; color: #555; display: flex; align-items: center; gap: 5px; margin-bottom: 4px; }
        .res-card .price { font-weight: 600; color: #e67e22; font-size: 0.9rem; }
        .res-card .phone { font-size: 0.85rem; color: #3498db; margin-top: 4px; display: flex; align-items: center; gap: 5px; }
        .res-card .menage-info { font-size: 0.75rem; color: #95a5a6; margin-top: 8px; border-top: 1px solid #f0f0f0; padding-top: 5px; display: flex; align-items: center; gap: 5px; }
        
        .platform-badge { position: absolute; bottom: 10px; right: 10px; padding: 3px 8px; border-radius: 4px; color: white; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; }

        /* --- STYLES M√âNAGE (Int√©gr√©s) --- */
        .status-indicator { padding: 5px 10px; border-radius: 4px; font-weight: bold; font-size: 0.9em; display: inline-block; }
        .status-attente { background-color: #e74c3c; color: white; }
        .status-valide { background-color: #2ecc71; color: white; }
        .status-propose { background-color: #f1c40f; color: #333; }
        .week-planning-container { border: 1px solid #ddd; border-radius: 12px; overflow: hidden; margin-bottom: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        .week-title-bar { background: var(--secondary); color: white; padding: 10px 15px; font-weight: 600; }
        .week-grid { display: grid; grid-template-columns: 1fr 1fr; }
        .gite-column { padding: 15px; }
        .gite-column:first-child { border-right: 1px solid #eee; background: var(--kpi-trevoux); }
        .gite-column:last-child { background: var(--kpi-couzon); }

        /* --- FORMULAIRES --- */
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: var(--secondary); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }

        /* UTILITAIRES */
        .hidden { display: none; }
        .toast { position: fixed; bottom: 30px; right: 30px; background: #333; color: white; padding: 15px 25px; border-radius: 8px; display: none; z-index: 10000; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--trevoux); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 5000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 500px; max-width: 90%; }

        /* Historical CA Modal */
        .ca-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px 20px; margin-top: 15px; }
        .ca-grid-item { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px dotted #eee; }
        .ca-grid-item label { font-weight: 600; font-size: 0.9rem; }
        .ca-grid-item input { width: 100px; padding: 5px; text-align: right; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h1 style="font-family:'Playfair Display'; margin-bottom:20px;">Gestion G√Ætes</h1>
            <input type="email" id="email" class="login-input" placeholder="Email" value="gite@admin.com">
            <input type="password" id="password" class="login-input" placeholder="Mot de passe">
            <div id="login-msg" style="color:red; font-size:0.8rem; display:none; margin-bottom:10px;">Erreur de connexion</div>
            <button onclick="window.handleLogin()" class="login-btn">Se connecter</button>
        </div>
    </div>

    <div id="app-content">
        <header>
            <div class="nav-buttons">
                <button class="nav-btn active" onclick="showTab('reservations', this)"><i class="fas fa-calendar-alt"></i> R√âSERVATIONS</button>
                <button class="nav-btn" onclick="showTab('statistiques', this)"><i class="fas fa-chart-pie"></i> STATISTIQUES</button>
                <button class="nav-btn" onclick="showTab('charges', this)"><i class="fas fa-euro-sign"></i> CHARGES & RENTABILIT√â</button>
                <button class="nav-btn" onclick="showTab('menage', this)"><i class="fas fa-broom"></i> PLANNING M√âNAGE</button>
                <button class="nav-btn" onclick="showTab('infos', this)"><i class="fas fa-info-circle"></i> INFOS PRATIQUES</button>
                <button class="nav-btn" onclick="showTab('communication', this)"><i class="fas fa-comment-dots"></i> √Ä D√âCOUVRIR</button>
            </div>
            <div>
                <button class="btn btn-primary" onclick="window.handleLogout()" style="padding: 5px 15px; font-size: 0.8rem;">D√©connexion</button>
            </div>
        </header>

        <div id="sync-alert" class="alert-banner" style="display:flex;">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="sync-msg">Synchronisation effectu√©e avec 1 erreur(s) - 14 d√©c. 2025 √† 22:08</span>
        </div>

        <div id="tab-reservations" class="section-content active">
            <div class="planning-controls">
                <h2 style="font-family:'Playfair Display'; font-size:1.8rem;">Planning des r√©servations</h2>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-primary" onclick="syncAllCalendars()" id="btn-sync"><i class="fas fa-sync"></i> Sync iCal</button>
                    <input type="text" class="search-bar" placeholder="üîç Rechercher client..." onkeyup="renderPlanning(this.value)">
                </div>
            </div>
            
            <div class="gite-headers">
                <div class="gite-header" style="background:var(--trevoux); border-top-left-radius: 12px;">üè† Tr√©voux</div>
                <div class="gite-header" style="background:var(--couzon); border-top-right-radius: 12px;">üè† Couzon</div>
            </div>
            
            <div id="planning-container">
                <div style="text-align:center; padding:40px; color:#999;">Chargement du planning...</div>
            </div>
        </div>

        <div id="tab-statistiques" class="section-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="font-family:'Playfair Display'; font-size:2rem;">Statistiques</h2>
                <div style="display:flex; gap:10px; align-items:center;">
                    <button class="btn btn-primary" onclick="openHistoricalCaModal()" style="padding: 5px 15px; font-size: 0.8rem;"><i class="fas fa-edit"></i> Saisir CA Histo</button>
                    
                    <div style="background:white; padding:5px 15px; border-radius:20px; border:1px solid #ddd;">
                        üìÖ Ann√©e : <select id="stats-year" onchange="updateDashboard()" style="border:none; font-weight:bold; font-size:1rem; outline:none;"></select>
                    </div>
                </div>
            </div>

            <div class="stats-grid-top">
                <div class="stat-card-colored" style="background:var(--airbnb);">
                    <h3>Airbnb</h3>
                    <div class="value" id="count-airbnb">0</div>
                    <div style="font-size:0.8rem;">r√©servations</div>
                    <i class="fab fa-airbnb icon"></i>
                </div>
                <div class="stat-card-colored" style="background:var(--abritel);">
                    <h3>Abritel</h3>
                    <div class="value" id="count-abritel">0</div>
                    <div style="font-size:0.8rem;">r√©servations</div>
                    <i class="fas fa-home icon"></i>
                </div>
                <div class="stat-card-colored" style="background:var(--gites);">
                    <h3>G√Ætes de France</h3>
                    <div class="value" id="count-gites">0</div>
                    <div style="font-size:0.8rem;">r√©servations</div>
                    <i class="fas fa-leaf icon"></i>
                </div>
            </div>

            <div class="stats-grid-kpi">
                <div class="kpi-card" style="border-left-color: var(--trevoux); background: var(--kpi-trevoux);">
                    <div class="label">üìä Taux Tr√©voux</div>
                    <div class="val" id="kpi-taux-trevoux">0%</div>
                </div>
                <div class="kpi-card" style="border-left-color: var(--couzon); background: var(--kpi-couzon);">
                    <div class="label">üìä Taux Couzon</div>
                    <div class="val" id="kpi-taux-couzon">0%</div>
                </div>
                <div class="kpi-card" style="border-left-color: var(--warning); background: var(--kpi-pm);">
                    <div class="label">üí∞ Prix moyen/nuit</div>
                    <div class="val" id="kpi-pm">0 ‚Ç¨</div>
                </div>
                <div class="kpi-card" style="border-left-color: #3498db; background: var(--kpi-duree);">
                    <div class="label">üåô Dur√©e moyenne</div>
                    <div class="val" id="kpi-duree">0 nuits</div>
                </div>
                <div class="kpi-card" style="border-left-color: #2ecc71; background: var(--kpi-top-month);">
                    <div class="label">üèÜ Meilleur mois</div>
                    <div class="val" id="kpi-top-month">-</div>
                </div>
            </div>

            <div class="stats-grid-blue">
                <div class="blue-card">
                    <div class="val" id="total-res">0</div>
                    <div class="lbl">R√âSERVATIONS TOTALES</div>
                </div>
                <div class="blue-card">
                    <div class="val" id="total-trevoux">0</div>
                    <div class="lbl">TR√âVOUX</div>
                </div>
                <div class="blue-card">
                    <div class="val" id="total-couzon">0</div>
                    <div class="lbl">COUZON</div>
                </div>
                <div class="blue-card">
                    <div class="val" id="total-ca">0 ‚Ç¨</div>
                    <div class="lbl">CA TOTAL</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><i class="fas fa-chart-line"></i> Comparaison CA Mensuel (‚Ç¨)</div>
                <div style="height: 300px;"><canvas id="monthlyChart"></canvas></div>
            </div>

            <div class="charts-container">
                <div class="card">
                    <div class="card-header"><i class="fas fa-chart-bar"></i> R√©partition par Plateforme</div>
                    <div style="height: 250px;"><canvas id="platformChart"></canvas></div>
                </div>
                <div class="card">
                    <div class="card-header"><i class="fas fa-chart-pie"></i> R√©partition par G√Æte</div>
                    <div style="height: 250px;"><canvas id="giteChart"></canvas></div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header"><i class="fas fa-balance-scale"></i> CA vs Charges vs B√©n√©fice</div>
                <div style="height: 300px;"><canvas id="profitChart"></canvas></div>
            </div>
        </div>

        <div id="tab-charges" class="section-content">
            <div class="card">
                <div class="card-header">Saisie des Charges</div>
                <form onsubmit="handleAddCharge(event)" class="form-row" style="grid-template-columns: repeat(5, 1fr); align-items: end;">
                    <div class="form-group"><label>Date</label><input type="date" id="charge-date" required></div>
                    <div class="form-group"><label>G√Æte</label><select id="charge-gite"><option>Tr√©voux</option><option>Couzon</option></select></div>
                    <div class="form-group"><label>Cat√©gorie</label><select id="charge-cat"><option>√ânergie</option><option>Eau</option><option>Entretien</option><option>Taxes</option><option>Internet</option><option>Remboursement</option></select></div>
                    <div class="form-group"><label>Montant (‚Ç¨)</label><input type="number" step="0.01" id="charge-amount" required></div>
                    <button type="submit" class="btn btn-success" style="height: 42px;">AJOUTER</button>
                </form>
            </div>
            <div class="card">
                <div class="card-header">Historique</div>
                <div id="charges-list"></div>
            </div>
        </div>
        
        <div id="tab-menage" class="section-content">
            <div class="card">
                <div class="card-header">Planning M√©nage Op√©rationnel (D√©parts du jour J √† J+30)</div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div style="background:var(--bg-body); padding:5px 15px; border-radius:20px; border:1px solid #ddd;">
                        üìÖ Mois : <input type="month" id="cleaning-month-select" onchange="renderCleaningView()" style="border:none; font-weight:bold; font-size:1rem; outline:none; background:transparent;">
                    </div>
                    
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-success" onclick="openValidationForm()" style="font-size: 0.9rem;"><i class="fas fa-external-link-alt"></i> Partager Planning</button>
                        <button class="btn btn-primary" onclick="exportCleaningCSV()" style="font-size: 0.9rem;"><i class="fas fa-file-csv"></i> Exporter CSV</button>
                    </div>
                </div>
                
                <div id="cleaning-planning-container">
                    <div style="text-align:center; padding:20px;">S√©lectionnez un mois pour afficher le planning.</div>
                </div>

                <p style="font-size:0.8rem; color:#7f8c9d; margin-top:20px; border-top:1px solid #eee; padding-top:10px;">
                    **L√©gende :** Les t√¢ches affich√©es sont les **d√©parts** (date de fin) pour le mois s√©lectionn√©, √† partir d'aujourd'hui.
                </p>
            </div>
        </div>

        <div id="tab-infos" class="section-content">
            <div class="card">
                <div class="card-header">Configuration iCal</div>
                <div class="form-group"><label>Airbnb Tr√©voux</label><input type="text" id="ical-trevoux-airbnb"></div>
                <div class="form-group"><label>Airbnb Couzon</label><input type="text" id="ical-couzon-airbnb"></div>
                <button class="btn btn-primary" onclick="saveIcalConfig()">Sauvegarder</button>
            </div>
        </div>

        <div id="tab-communication" class="section-content">
            <div class="card">
                <div class="card-header">G√©n√©rateur de Message (WhatsApp)</div>
                <div class="form-row">
                    <div class="form-group">
                        <label>G√Æte</label>
                        <select id="comm-gite" onchange="updateCommPreview()"><option>Tr√©voux</option><option>Couzon</option></select>
                    </div>
                </div>
                <textarea id="comm-preview" style="width:100%; height:150px; margin-bottom:10px; padding:10px; border:1px solid #ddd;"></textarea>
                <button class="btn btn-success" onclick="sendWhatsapp()"><i class="fab fa-whatsapp"></i> Envoyer WhatsApp</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">Info message</div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2>Modifier R√©servation</h2>
            <input type="hidden" id="edit-id">
            <div class="form-group"><label>Nom Client</label><input type="text" id="edit-name"></div>
            <div class="form-group"><label>Montant (‚Ç¨)</label><input type="number" step="0.01" id="edit-amount"></div>
            <div class="form-group"><label>Num√©ro de T√©l.</label><input type="text" id="edit-phone"></div> 
            <div style="margin-top:20px; text-align:right;">
                <button class="btn btn-danger" onclick="closeModal('editModal')">Annuler</button>
                <button class="btn btn-success" onclick="saveEdit()">Enregistrer</button>
            </div>
        </div>
    </div>

    <div id="historicalCaModal" class="modal">
        <div class="modal-content" style="width: 700px;">
            <h2 style="margin-bottom: 20px;">Saisie Manuelle du Chiffre d'Affaires Mensuel (Historique)</h2>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="font-size: 1.2rem;">Ann√©e :</h3>
                <select id="ca-year-select" style="padding: 8px; font-size: 1rem; border-radius: 6px;" onchange="loadHistoricalCaData()">
                    </select>
            </div>

            <div id="ca-grid" class="ca-grid">
                </div>
            <p style="margin-top: 15px; font-size: 0.8rem; color: var(--text-light);">* Saisir le CA total (Tr√©voux + Couzon) pour le mois correspondant. Laissez √† 0 ou vide si non pertinent.</p>

            <div style="margin-top:20px; text-align:right;">
                <button class="btn btn-danger" onclick="closeModal('historicalCaModal')">Annuler</button>
                <button class="btn btn-success" onclick="saveHistoricalCaData()">Sauvegarder les CA</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION SUPABASE ET VARIABLES GLOBALES ---
        const SUPABASE_URL = 'https://ivqiisnudabxemcxxyru.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2cWlpc251ZGFieGVtY3h4eXJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzOTk0NjMsImV4cCI6MjA4MDk3NTQ2M30.9FwJPgR8bbaP7bAemuaVbAN019EO5ql7uciQO9FeHK4';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const CURRENT_YEAR = new Date().getFullYear();
        const MONTHS = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Ao√ªt', 'Sep', 'Oct', 'Nov', 'D√©c'];
        const MONTH_KEYS = ['jan', 'fev', 'mar', 'avr', 'mai', 'juin', 'juil', 'aout', 'sep', 'oct', 'nov', 'dec'];
        
        let DB_RESERVATIONS = [];
        let DB_CHARGES = [];
        let DB_HISTORICAL_CA = {}; 
        let CURRENT_CLEANING_TASKS = []; 
        
        // Chart Instances
        let monthlyChartInstance = null;
        let platformChartInstance = null;
        let giteChartInstance = null;
        let profitChartInstance = null;


        // --- 2. AUTHENTIFICATION & CHARGEMENT DES DONN√âES ---
        
        // Les fonctions de rendu sont d√©clar√©es ici pour √™tre disponibles par loadData et showTab
        
        window.updateDashboard = function() {
            const year = parseInt(document.getElementById('stats-year').value);
            const prevYear = year - 1;

            const resYear = DB_RESERVATIONS.filter(r => new Date(r.date_debut).getFullYear() === year && !r.nom_client.toUpperCase().includes('BLOQU√â'));
            const resPrev = DB_RESERVATIONS.filter(r => new Date(r.date_debut).getFullYear() === prevYear && !r.nom_client.toUpperCase().includes('BLOQU√â'));

            // Calculations
            const caTotal = resYear.reduce((sum, r) => sum + r.montant, 0);
            const countTrevoux = resYear.filter(r => r.gite === 'Tr√©voux').length;
            const countCouzon = resYear.filter(r => r.gite === 'Couzon').length;
            const durationTotal = resYear.reduce((sum, r) => sum + getDuration(r.date_debut, r.date_fin), 0);
            const avgDuration = resYear.length > 0 ? Math.round(durationTotal / resYear.length) : 0;
            const avgPricePerNight = durationTotal > 0 ? Math.round(caTotal / durationTotal) : 0;
            
            // KPI Num√©riques
            document.getElementById('total-res').textContent = resYear.length;
            document.getElementById('total-ca').textContent = caTotal.toFixed(0) + ' ‚Ç¨';
            document.getElementById('total-trevoux').textContent = countTrevoux;
            document.getElementById('total-couzon').textContent = countCouzon;

            // KPI Taux
            const totalGites = countTrevoux + countCouzon;
            document.getElementById('kpi-taux-trevoux').textContent = totalGites ? Math.round((countTrevoux / totalGites) * 100) + '%' : '0%';
            document.getElementById('kpi-taux-couzon').textContent = totalGites ? Math.round((countCouzon / totalGites) * 100) + '%' : '0%';
            document.getElementById('kpi-pm').textContent = avgPricePerNight + ' ‚Ç¨';
            document.getElementById('kpi-duree').textContent = avgDuration + ' nuits';

            // Compteurs Plateformes
            const nbAirbnb = resYear.filter(r => r.plateforme?.toLowerCase().includes('airbnb')).length;
            const nbAbritel = resYear.filter(r => r.plateforme?.toLowerCase().includes('abritel')).length;
            const nbGites = resYear.filter(r => r.plateforme?.toLowerCase().includes('gite')).length;
            document.getElementById('count-airbnb').textContent = nbAirbnb;
            document.getElementById('count-abritel').textContent = nbAbritel;
            document.getElementById('count-gites').textContent = nbGites;


            // --- CHART RENDERING ---

            // 1. MONTHLY CHART (CA)
            const monthlyCA = new Array(12).fill(0);
            resYear.forEach(r => monthlyCA[new Date(r.date_debut).getMonth()] += r.montant);

            const monthlyCAPrev = new Array(12).fill(0);
            resPrev.forEach(r => monthlyCAPrev[new Date(r.date_debut).getMonth()] += r.montant);
            
            const ctxM = document.getElementById('monthlyChart').getContext('2d');
            if (monthlyChartInstance) monthlyChartInstance.destroy();
            monthlyChartInstance = new Chart(ctxM, {
                type: 'bar',
                data: {
                    labels: MONTHS,
                    datasets: [
                        { label: year, data: monthlyCA, backgroundColor: 'var(--color-current-year)' },
                        { label: prevYear, data: monthlyCAPrev, backgroundColor: 'var(--color-prev-year)' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // 2. PLATFORM CHART (Doughnut)
            const ctxP = document.getElementById('platformChart').getContext('2d');
            if (platformChartInstance) platformChartInstance.destroy();
            platformChartInstance = new Chart(ctxP, {
                type: 'doughnut',
                data: {
                    labels: ['Airbnb', 'Abritel', 'G√Ætes de France', 'Autre'],
                    datasets: [{
                        data: [nbAirbnb, nbAbritel, nbGites, resYear.length - nbAirbnb - nbAbritel - nbGites],
                        backgroundColor: ['var(--airbnb)', 'var(--abritel)', 'var(--gites)', 'var(--other)']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // 3. GITE CHART (Pie)
            const ctxG = document.getElementById('giteChart').getContext('2d');
            if (giteChartInstance) giteChartInstance.destroy();
            giteChartInstance = new Chart(ctxG, {
                type: 'pie',
                data: {
                    labels: ['Tr√©voux', 'Couzon'],
                    datasets: [{
                        data: [countTrevoux, countCouzon],
                        backgroundColor: ['var(--trevoux)', 'var(--couzon)']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
            
            // 4. PROFIT CHART (Placeholder, mais la structure est l√†)
            const ctxPr = document.getElementById('profitChart').getContext('2d');
            if (profitChartInstance) profitChartInstance.destroy();
            profitChartInstance = new Chart(ctxPr, {
                type: 'line',
                data: {
                    labels: MONTHS,
                    datasets: [
                        { label: 'CA', data: monthlyCA, borderColor: 'var(--success)', fill: false },
                        { label: 'Charges', data: new Array(12).fill(1000), borderColor: 'var(--danger)', fill: false }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        window.renderChargesList = function() {
            const list = document.getElementById('charges-list');
            if(DB_CHARGES.length === 0) { list.innerHTML = '<p style="padding:10px;">Aucune charge enregistr√©e.</p>'; return; }
            
            DB_CHARGES.sort((a,b) => new Date(b.date) - new Date(a.date));

            let html = '<table style="width:100%; border-collapse:collapse; text-align:left;">';
            html += '<thead><tr><th style="padding:10px;">Date</th><th style="padding:10px;">G√Æte</th><th style="padding:10px;">Cat√©gorie</th><th style="padding:10px; text-align:right;">Montant (‚Ç¨)</th></tr></thead><tbody>';
            
            DB_CHARGES.forEach(c => {
                html += `<tr>
                    <td style="padding:8px; border-bottom:1px solid #eee;">${formatDate(c.date)}</td>
                    <td style="padding:8px; border-bottom:1px solid #eee;">${c.gite}</td>
                    <td style="padding:8px; border-bottom:1px solid #eee;">${c.categorie}</td>
                    <td style="padding:8px; border-bottom:1px solid #eee; font-weight:bold; text-align:right;">${c.montant}</td>
                </tr>`;
            });
            list.innerHTML = html + '</tbody></table>';
        }

        window.renderCleaningView = function() {
            const container = document.getElementById('cleaning-planning-container');
            const monthVal = document.getElementById('cleaning-month-select').value;
            if(!monthVal) return;

            const [selYear, selMonth] = monthVal.split('-').map(Number);
            const startMonth = new Date(selYear, selMonth - 1, 1);
            const endMonth = new Date(selYear, selMonth, 0);
            
            const today = new Date();
            today.setHours(0,0,0,0);

            let tasks = DB_RESERVATIONS.filter(r => {
                const dFin = new Date(r.date_fin);
                return dFin >= startMonth && dFin <= endMonth && dFin >= today;
            });
            
            tasks.sort((a,b) => new Date(a.date_fin) - new Date(b.date_fin));

            if(tasks.length === 0) {
                container.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">Aucun m√©nage pr√©vu pour le reste de ce mois.</div>';
                return;
            }

            const weeks = {};
            tasks.forEach(r => {
                const d = new Date(r.date_fin);
                const wNum = getWeekNumber(d);
                const key = `${d.getFullYear()}-W${wNum}`;
                if(!weeks[key]) {
                     const startW = getStartOfWeek(d);
                     const endW = new Date(startW); endW.setDate(endW.getDate()+6);
                     // CORRECTION: Assure que startW et endW sont convertis en cha√Æne ISO pour formatDate
                     weeks[key] = { 
                        label: `Semaine ${wNum}`, 
                        dates: `${formatDate(startW.toISOString())} - ${formatDate(endW.toISOString())}`, 
                        trevoux: [], 
                        couzon: [] 
                    };
                }
                weeks[key][r.gite === 'Tr√©voux' ? 'trevoux' : 'couzon'].push(r);
            });

            let html = '';
            Object.keys(weeks).sort().forEach(k => {
                const w = weeks[k];
                html += `
                <div class="week-planning-container" style="margin-bottom:25px;">
                    <div class="week-title-bar">${w.label} <span style="font-weight:400; opacity:0.8;">${w.dates}</span></div>
                    <div class="week-grid">
                        <div class="gite-column">
                            <h4 style="color:var(--trevoux); border-bottom:1px solid #ccc;">Tr√©voux (${w.trevoux.length})</h4>
                            ${w.trevoux.map(r => createCleaningCard(r)).join('')}
                        </div>
                        <div class="gite-column">
                            <h4 style="color:var(--couzon); border-bottom:1px solid #ccc;">Couzon (${w.couzon.length})</h4>
                            ${w.couzon.map(r => createCleaningCard(r)).join('')}
                        </div>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }
        
        async function loadData() {
            try {
                let { data: res } = await supabase.from('reservations').select('*');
                DB_RESERVATIONS = (res || []).map(r => ({ ...r, montant: parseFloat(r.montant) || 0, telephone: r.telephone || '' }));
                
                let { data: chg } = await supabase.from('charges').select('*');
                DB_CHARGES = chg || [];

                let { data: hist } = await supabase.from('historical_data').select('year, months');
                DB_HISTORICAL_CA = {};
                (hist || []).forEach(row => {
                    let monthlyData = row.months;
                    if (typeof monthlyData === 'string') {
                        try { monthlyData = JSON.parse(monthlyData); } catch(e) { monthlyData = {}; }
                    }
                    DB_HISTORICAL_CA[row.year] = monthlyData || {};
                });

                renderPlanning();
                window.updateDashboard(); 
                window.renderChargesList();
                window.renderCleaningView(); 

            } catch (error) {
                console.error("Erreur critique lors du chargement des donn√©es Supabase:", error);
                window.showToast(`Erreur de chargement de donn√©es: ${error.message || 'Probl√®me RLS ou R√©seau.'}`, true);
            }
        }
        
        async function initAuth() {
            const yearSelect = document.getElementById('stats-year');
            const years = [CURRENT_YEAR + 1, CURRENT_YEAR, CURRENT_YEAR - 1, CURRENT_YEAR - 2, CURRENT_YEAR - 3];
            yearSelect.innerHTML = years.map(y => `<option value="${y}" ${y === CURRENT_YEAR ? 'selected' : ''}>${y}</option>`).join('');
            
            const caYearSelect = document.getElementById('ca-year-select');
            caYearSelect.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');

            const currentMonth = `${CURRENT_YEAR}-${String(new Date().getMonth() + 1).padStart(2, '0')}`;
            document.getElementById('cleaning-month-select').value = currentMonth;

            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                await loadData(); 
            }
        }


        // --- 3. PLANNING CLASSIQUE (D√©j√† OK, juste pour la lisibilit√©) ---
        function renderPlanning(filterText = '') {
            const container = document.getElementById('planning-container');
            const now = new Date();
            let futureRes = DB_RESERVATIONS.filter(r => new Date(r.date_fin) >= now);
            if(filterText) {
                const term = filterText.toLowerCase();
                futureRes = futureRes.filter(r => r.nom_client && r.nom_client.toLowerCase().includes(term));
            }
            futureRes.sort((a,b) => new Date(a.date_debut) - new Date(b.date_debut));

            if(futureRes.length === 0) {
                container.innerHTML = '<div style="padding:20px; text-align:center;">Aucune r√©servation future.</div>';
                return;
            }

            const weeks = {};
            futureRes.forEach(r => {
                const d = new Date(r.date_debut);
                const wNum = getWeekNumber(d);
                const year = d.getFullYear();
                const key = `${year}-W${wNum}`;
                if(!weeks[key]) {
                    const startW = getStartOfWeek(d);
                    const endW = new Date(startW); endW.setDate(endW.getDate()+6);
                    weeks[key] = { label: `Semaine ${wNum}`, dates: `${formatDateShort(startW)} - ${formatDateShort(endW)}`, trevoux: [], couzon: [] };
                }
                weeks[key][r.gite === 'Tr√©voux' ? 'trevoux' : 'couzon'].push(r);
            });

            let html = '';
            for(const [k, w] of Object.entries(weeks)) {
                html += `
                <div class="week-container">
                    <div class="week-title">${w.label} <span style="font-weight:400; opacity:0.8; margin-left:10px;">${w.dates}</span></div>
                    <div class="week-grid">
                        <div class="day-column">
                            ${w.trevoux.map(r => createResCard(r)).join('')}
                        </div>
                        <div class="day-column">
                            ${w.couzon.map(r => createResCard(r)).join('')}
                        </div>
                    </div>
                </div>`;
            }
            container.innerHTML = html;
        }

        // --- 4. UTILS & HELPERS ---

        function createResCard(r) {
            const platformLower = r.plateforme ? r.plateforme.toLowerCase() : 'autre';
            let platformColor;
            if (platformLower.includes('airbnb')) platformColor = 'var(--airbnb)';
            else if (platformLower.includes('abritel') || platformLower.includes('homeway')) platformColor = 'var(--abritel)';
            else if (platformLower.includes('gite') || platformLower.includes('g√Ætes')) platformColor = 'var(--gites)';
            else platformColor = 'var(--gites)'; 
            
            const dEnd = new Date(r.date_fin);
            const days = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
            
            const isChaining = isChainingDay(r.date_fin, r.gite);
            const finishTime = getCleaningTime(r.date_fin, r.gite, isChaining);
            const menageStr = `üßπ ${days[dEnd.getDay()]} ${dEnd.getDate()} - Pr√™t avant ${finishTime.split('(')[0]}`;

            const isBlocked = r.nom_client && r.nom_client.toUpperCase().includes('BLOQU√â');

            const safeName = r.nom_client ? r.nom_client.replace(/'/g, "\\'") : 'Client';
            const safePhone = r.telephone ? r.telephone.replace(/'/g, "\\'") : '';
            const resId = r.id;

            return `
            <div class="res-card ${isBlocked ? 'blocked' : ''}">
                <div class="actions">
                    <i class="fas fa-pen" style="cursor:pointer; color:#3498db;" onclick="openEdit(${resId}, '${safeName}', ${r.montant}, '${safePhone}')"></i>
                    <i class="fas fa-trash" style="cursor:pointer; color:#e74c3c;" onclick="deleteRes(${resId})"></i>
                </div>
                <div class="client">${isBlocked ? '<i class="fas fa-ban"></i> ' : ''}${r.nom_client}</div>
                <div class="dates"><i class="far fa-calendar"></i> ${formatDate(r.date_debut)} ‚ûù ${formatDate(r.date_fin)}</div>
                ${r.telephone ? `<div class="phone"><i class="fas fa-phone"></i> ${r.telephone}</div>` : ''}
                <div class="price">üí∞ ${Number(r.montant).toFixed(2)} ‚Ç¨</div>
                <div class="menage-info">${menageStr}</div>
                <span class="platform-badge" style="background:${platformColor}">${r.plateforme}</span>
            </div>`;
        }
        
        function createCleaningCard(r) {
            const dEnd = new Date(r.date_fin);
            const days = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
            const isChaining = isChainingDay(r.date_fin, r.gite);
            const finishTime = getCleaningTime(r.date_fin, r.gite, isChaining);
            
            const validationStatus = "A Faire"; 
            const statusClass = 'status-attente';

            return `
            <div style="background:white; border-radius:8px; padding:10px; margin-top:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); border-left: ${isChaining ? '5px solid var(--accent)' : '1px solid #ddd'};">
                <div style="font-weight:bold; color:var(--primary);">üßπ ${days[dEnd.getDay()]} ${formatDate(dEnd)}</div>
                <div style="font-size:0.9rem; color:#666;">Client: ${r.nom_client}</div>
                <div style="margin-top:5px; font-weight:bold; color:${isChaining ? 'var(--accent)' : 'green'}">
                    <i class="fas fa-clock"></i> Pr√™t avant : ${finishTime.split('(')[0]}
                </div>
                <div class="status-indicator ${statusClass}" style="margin-top:5px;">${validationStatus}</div>
            </div>`;
        }

        function getCleaningTime(departureDate, gite, isChaining) {
            const date = new Date(departureDate);
            const dayOfWeek = date.getDay(); 
            if (dayOfWeek === 0) { return isChaining ? '13h00 (Encha√Ænement Dim.)' : '17h00 (Fin de journ√©e, g√Æte pr√™t pour Lundi)'; }
            if (dayOfWeek >= 1 && dayOfWeek <= 6) {
                if (isChaining) { return '12h00 (Encha√Ænement Rapide)'; }
                if (isHoliday(departureDate)) { return '12h00 (Jour F√©ri√© - V√©rif. Report)'; }
                return '12h00 (Standard)';
            }
            return 'V√©rification !'; 
        }

        function isHoliday(date) {
            const d = new Date(date);
            const month = d.getMonth() + 1;
            const day = d.getDate();
            if ( (month === 1 && day === 1) || (month === 5 && (day === 1 || day === 8)) || (month === 7 && day === 14) || (month === 8 && day === 15) || (month === 11 && (day === 1 || day === 11)) || (month === 12 && day === 25)) return true;
            return false;
        }

        function isChainingDay(dateStr, gite) {
            const departureDate = dateStr; 
            const isChaining = DB_RESERVATIONS.some(r => 
                r.gite === gite && 
                r.date_debut === departureDate &&
                r.nom_client.toUpperCase().indexOf('BLOQU√â') === -1
            );
            return isChaining;
        }

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        }
        
        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function formatDate(s) { 
            if(!s) return ''; 
            // CORRECTION: Convertir l'objet Date en cha√Æne ISO avant d'utiliser .match()
            let dateStr = (s instanceof Date) ? s.toISOString().split('T')[0] : s;
            
            if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                const parts = dateStr.split('-');
                return `${parts[2]}/${parts[1]}`;
            }
            // Fallback pour les objets Date (si non standard)
            const date = new Date(s);
            return `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}`; 
        }
        function getDuration(s, e) {
            return (new Date(e) - new Date(s)) / (1000 * 60 * 60 * 24);
        }
        function formatDateShort(d) { 
            const MONTHS = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Ao√ªt', 'Sep', 'Oct', 'Nov', 'D√©c'];
            return `${d.getDate()} ${MONTHS[d.getMonth()].toLowerCase().substring(0, 3)}.`; 
        }
        function showToast(msg, isError = false) { 
            const t=document.getElementById('toast'); 
            t.innerText=msg; 
            t.style.background = isError ? 'var(--danger)' : '#333';
            t.style.display='block'; 
            setTimeout(()=>t.style.display='none',5000); 
        }

        // Placeholders pour les fonctions non connect√©es (√©viter les erreurs)
        function openHistoricalCaModal() { document.getElementById('historicalCaModal').style.display = 'flex'; }
        function loadHistoricalCaData() { console.log("Chargement CA historique..."); }
        function saveHistoricalCaData() { showToast("Sauvegarde CA historique doit √™tre impl√©ment√©e (Supabase)."); }
        function handleAddCharge(event) { event.preventDefault(); showToast("Ajout de charge doit √™tre impl√©ment√© (Supabase)."); }
        function syncAllCalendars() { showToast("Synchronisation iCal lanc√©e..."); }
        function saveIcalConfig() { showToast("Sauvegarde iCal doit √™tre impl√©ment√©e (Supabase)."); }
        function updateCommPreview() { console.log("Pr√©visualisation Com..."); }
        function sendWhatsapp() { showToast("Envoi WhatsApp doit √™tre impl√©ment√©."); }
        function exportCleaningCSV() { showToast("L'exportation CSV sera lanc√©e."); }
        function openValidationForm() { showToast("Lien de partage sera g√©n√©r√©."); }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
        async function saveEdit() {
            const id = document.getElementById('edit-id').value;
            const updates = {
                nom_client: document.getElementById('edit-name').value,
                montant: parseFloat(document.getElementById('edit-amount').value),
                telephone: document.getElementById('edit-phone').value 
            };
            const { error } = await supabase.from('reservations').update(updates).eq('id', id);
            if (error) { console.error(error); showToast("Erreur de sauvegarde", true); }
            else { closeModal('editModal'); loadData(); showToast('Modifi√© avec succ√®s'); }
        }
        async function deleteRes(id) {
            if(confirm('Supprimer cette r√©servation ?')) {
                const { error } = await supabase.from('reservations').delete().eq('id', id);
                if (error) { console.error(error); showToast("Erreur de suppression", true); }
                else { loadData(); showToast('Supprim√© avec succ√®s'); }
            }
        }
        function openEdit(id, name, amount, phone) {
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-name').value = name;
            document.getElementById('edit-amount').value = amount;
            document.getElementById('edit-phone').value = phone;
            document.getElementById('editModal').style.display = 'flex';
        }

        // Helpers de navigation
        function showTab(id, btn) {
            document.querySelectorAll('.section-content').forEach(s => s.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            // Les fonctions sont appel√©es via window. 
            if(id === 'statistiques') window.updateDashboard(); 
            if(id === 'menage') window.renderCleaningView(); 
            if(id === 'charges') window.renderChargesList();
        }

        // Init: Appel l'authentification au chargement de la fen√™tre
        window.onload = initAuth;

    </script>
</body>
</html>
