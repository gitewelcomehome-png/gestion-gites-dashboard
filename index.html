<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion G√Ætes - Tableau de Bord Complet</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ical.js@1.5.0/build/ical.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style> 
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Work+Sans:wght@300;400;600;700&display=swap');
        
        /* --- DESIGN SYSTEM --- */
        :root {
            --primary: #2C3E50; --secondary: #34495E; --accent: #E67E22;
            --bg-body: #F4F6F8; --card-bg: #FFFFFF;
            --airbnb: #FF5A5F; --abritel: #3498DB; --gites: #27AE60; --other: #9B59B6; 
            --trevoux: #667eea; --couzon: #f093fb; 
            --success: #2ecc71; --warning: #f1c40f; --danger: #e74c3c;
            --text-main: #2c3e50; --text-light: #7f8c8d; --border-radius: 12px;
            /* Couleurs KPI */
            --kpi-trevoux: #eaf1ff; --kpi-couzon: #fde8ff; --kpi-pm: #fff8eb; --kpi-duree: #ebf5ff; --kpi-top-month: #e8fff1;
        }
        
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: 'Work Sans', sans-serif; background: var(--bg-body); color: var(--text-main); padding-bottom: 50px; }
        
        /* LOGIN */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2C3E50; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; color: white; }
        .login-box { background: white; padding: 40px; border-radius: 20px; width: 350px; text-align: center; color: #333; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .login-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; }
        .login-btn { width: 100%; padding: 12px; background: var(--trevoux); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }

        /* LAYOUT */
        #app-content { display: none; max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #2C3E50; color: white; padding: 15px 30px; border-radius: 50px; }
        .nav-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .nav-btn { background: transparent; border: none; color: #bdc3c7; padding: 10px 15px; cursor: pointer; font-weight: 600; font-size: 0.95rem; display: flex; align-items: center; gap: 8px; transition: 0.3s; border-radius: 20px; }
        .nav-btn:hover, .nav-btn.active { background: linear-gradient(90deg, #3498db, #8e44ad); color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        
        .section-content { display: none; animation: fadeIn 0.4s ease-in-out; }
        .section-content.active { display: block; }
        .card { background: white; border-radius: var(--border-radius); padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .card-header { font-family: 'Playfair Display', serif; font-size: 1.5rem; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; color: var(--primary); }

        /* STATS */
        .stats-grid-top { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card-colored { padding: 20px; border-radius: 12px; color: white; position: relative; overflow: hidden; height: 100px; }
        .stat-card-colored .value { font-size: 2.2rem; font-weight: bold; }
        .stats-grid-kpi { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 20px; }
        .kpi-card { background: white; padding: 15px; border-radius: 12px; border-left: 4px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .kpi-card .val { font-size: 1.4rem; font-weight: bold; color: #2c3e50; margin-top: 5px; }
        .stats-grid-blue { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; }
        .blue-card { background: #2C3E50; color: white; padding: 20px; border-radius: 12px; text-align: center; }
        .charts-container { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px; }

        /* PLANNING & M√âNAGE */
        .planning-controls { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .week-container { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 25px; }
        .week-title { background: #1a252f; color: white; text-align: center; padding: 10px; font-weight: 600; border-bottom: 1px solid #34495e; }
        .week-grid { display: grid; grid-template-columns: 1fr 1fr; }
        .day-column { padding: 15px; min-height: 100px; border-right: 1px dashed #eee; }
        .res-card { background: white; border: 1px solid #eee; border-radius: 8px; padding: 12px; margin-bottom: 10px; position: relative; transition: transform 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .res-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .res-card.blocked { border-left: 4px solid var(--danger); background: #fff5f5; }
        .platform-badge { position: absolute; bottom: 10px; right: 10px; padding: 3px 8px; border-radius: 4px; color: white; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; }

        /* STYLE SP√âCIFIQUE M√âNAGE */
        .status-indicator { padding: 3px 8px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; display:inline-block; margin-top:5px; }
        .status-attente { background-color: #e74c3c; color: white; }
        .status-valide { background-color: #2ecc71; color: white; }
        .status-propose { background-color: #f1c40f; color: #333; }
        
        /* UTILS */
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: 600; }
        .btn-primary { background: var(--secondary); }
        .btn-success { background: var(--success); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 5000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 500px; max-width: 90%; }
        .toast { position: fixed; bottom: 30px; right: 30px; background: #333; color: white; padding: 15px 25px; border-radius: 8px; display: none; z-index: 10000; }
        
        /* FORMULAIRES */
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }

    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h1 style="font-family:'Playfair Display'; margin-bottom:20px;">Gestion G√Ætes</h1>
            <input type="email" id="email" class="login-input" placeholder="Email" value="gite@admin.com">
            <input type="password" id="password" class="login-input" placeholder="Mot de passe">
            <div id="login-msg" style="color:red; font-size:0.8rem; display:none; margin-bottom:10px;">Erreur de connexion</div>
            <button onclick="handleLogin()" class="login-btn">Se connecter</button>
        </div>
    </div>

    <div id="app-content">
        <header>
            <div class="nav-buttons">
                <button class="nav-btn active" onclick="showTab('reservations', this)"><i class="fas fa-calendar-alt"></i> R√âSERVATIONS</button>
                <button class="nav-btn" onclick="showTab('statistiques', this)"><i class="fas fa-chart-pie"></i> STATISTIQUES</button>
                <button class="nav-btn" onclick="showTab('charges', this)"><i class="fas fa-euro-sign"></i> CHARGES</button>
                <button class="nav-btn" onclick="showTab('menage', this)"><i class="fas fa-broom"></i> PLANNING M√âNAGE</button>
                <button class="nav-btn" onclick="showTab('infos', this)"><i class="fas fa-info-circle"></i> INFOS</button>
            </div>
            <div><button class="btn btn-primary" onclick="handleLogout()" style="padding: 5px 15px; font-size: 0.8rem;">D√©connexion</button></div>
        </header>

        <div id="tab-reservations" class="section-content active">
            <div class="planning-controls">
                <h2 style="font-family:'Playfair Display'; font-size:1.8rem;">Planning Global</h2>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-primary" onclick="loadData()"><i class="fas fa-sync"></i> Actualiser</button>
                    <input type="text" style="padding:10px; border-radius:20px; border:1px solid #ddd;" placeholder="üîç Rechercher..." onkeyup="renderPlanning(this.value)">
                </div>
            </div>
            <div style="display:flex; color:white; font-weight:bold; text-transform:uppercase;">
                <div style="flex:1; text-align:center; padding:10px; background:var(--trevoux); border-top-left-radius:12px;">üè† Tr√©voux</div>
                <div style="flex:1; text-align:center; padding:10px; background:var(--couzon); border-top-right-radius:12px;">üè† Couzon</div>
            </div>
            <div id="planning-container"></div>
        </div>

        <div id="tab-statistiques" class="section-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="font-family:'Playfair Display'; font-size:2rem;">Statistiques</h2>
                <div style="background:white; padding:5px 15px; border-radius:20px; border:1px solid #ddd;">
                    üìÖ Ann√©e : <select id="stats-year" onchange="updateDashboard()" style="border:none; font-weight:bold; font-size:1rem; outline:none;"></select>
                </div>
            </div>

            <div class="stats-grid-top">
                <div class="stat-card-colored" style="background:var(--airbnb);">
                    <h3>Airbnb</h3><div class="value" id="count-airbnb">0</div>
                </div>
                <div class="stat-card-colored" style="background:var(--abritel);">
                    <h3>Abritel</h3><div class="value" id="count-abritel">0</div>
                </div>
                <div class="stat-card-colored" style="background:var(--gites);">
                    <h3>G√Ætes de France</h3><div class="value" id="count-gites">0</div>
                </div>
            </div>

            <div class="stats-grid-kpi">
                <div class="kpi-card" style="border-left-color: var(--trevoux); background: var(--kpi-trevoux);"><div class="label">üìä Taux Tr√©voux</div><div class="val" id="kpi-taux-trevoux">0%</div></div>
                <div class="kpi-card" style="border-left-color: var(--couzon); background: var(--kpi-couzon);"><div class="label">üìä Taux Couzon</div><div class="val" id="kpi-taux-couzon">0%</div></div>
                <div class="kpi-card" style="border-left-color: var(--warning); background: var(--kpi-pm);"><div class="label">üí∞ Prix moyen/nuit</div><div class="val" id="kpi-pm">0 ‚Ç¨</div></div>
                <div class="kpi-card" style="border-left-color: #3498db; background: var(--kpi-duree);"><div class="label">üåô Dur√©e moyenne</div><div class="val" id="kpi-duree">0 nuits</div></div>
                <div class="kpi-card" style="border-left-color: #2ecc71; background: var(--kpi-top-month);"><div class="label">üèÜ Meilleur mois</div><div class="val" id="kpi-top-month">-</div></div>
            </div>

            <div class="stats-grid-blue">
                <div class="blue-card"><div class="val" id="total-res">0</div><div class="lbl">R√âSERVATIONS TOTALES</div></div>
                <div class="blue-card"><div class="val" id="total-ca">0 ‚Ç¨</div><div class="lbl">CA TOTAL</div></div>
            </div>

            <div class="charts-container">
                <div class="card"><div class="card-header">Comparaison CA Mensuel (‚Ç¨)</div><div style="height: 300px;"><canvas id="monthlyChart"></canvas></div></div>
                <div class="card"><div class="card-header">R√©partition Plateforme</div><div style="height: 250px;"><canvas id="platformChart"></canvas></div></div>
            </div>
        </div>

        <div id="tab-charges" class="section-content">
            <div class="card">
                <div class="card-header">Historique des Charges</div>
                <div id="charges-list"></div>
            </div>
        </div>

        <div id="tab-menage" class="section-content">
            <div class="card-header">Planning M√©nage (A partir d'aujourd'hui)</div>
            <div style="margin-bottom:20px; background:white; padding:15px; border-radius:12px;">
                 Mois de r√©f√©rence : <input type="month" id="cleaning-month-select" onchange="renderCleaningView()" style="padding:5px;">
            </div>
            <div id="cleaning-planning-container"></div>
        </div>
        
        <div id="tab-infos" class="section-content"><div class="card"><h3>Infos Pratiques</h3><p>Configuration iCal ici...</p></div></div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2>D√©tails R√©servation</h2>
            <div class="form-group"><label>Nom Client</label><input type="text" id="edit-name"></div>
            <div class="form-group"><label>Montant (‚Ç¨)</label><input type="number" id="edit-amount"></div>
            <div style="margin-top:20px; text-align:right;">
                <button class="btn btn-danger" onclick="document.getElementById('editModal').style.display='none'">Fermer</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // --- 1. CONFIGURATION ---
        const SUPABASE_URL = 'https://ivqiisnudabxemcxxyru.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2cWlpc251ZGFieGVtY3h4eXJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzOTk0NjMsImV4cCI6MjA4MDk3NTQ2M30.9FwJPgR8bbaP7bAemuaVbAN019EO5ql7uciQO9FeHK4';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let DB_RESERVATIONS = [];
        let DB_CHARGES = [];
        let DB_HISTORICAL_CA = {};
        
        let monthlyChartInstance = null;
        let platformChartInstance = null;

        // --- 2. AUTHENTIFICATION ---
        async function initAuth() {
            // Init Ann√©es Stats
            const currentYear = new Date().getFullYear();
            const years = [currentYear + 1, currentYear, currentYear - 1, currentYear - 2];
            document.getElementById('stats-year').innerHTML = years.map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('');
            
            // Init Mois M√©nage (Mois Courant par d√©faut)
            const today = new Date();
            const monthStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            document.getElementById('cleaning-month-select').value = monthStr;

            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                loadData();
            }
        }
        window.handleLogin = async function() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const { error } = await supabase.auth.signInWithPassword({ email: email, password: pass });
            if (error) document.getElementById('login-msg').style.display = 'block';
            else location.reload();
        }
        window.handleLogout = async function() { await supabase.auth.signOut(); location.reload(); }

        // --- 3. CHARGEMENT DONN√âES ---
        async function loadData() {
            try {
                // R√©cup√®re TOUT sans filtre
                let { data: res } = await supabase.from('reservations').select('*');
                DB_RESERVATIONS = (res || []).map(r => ({ ...r, montant: parseFloat(r.montant) || 0 }));
                
                let { data: chg } = await supabase.from('charges').select('*');
                DB_CHARGES = chg || [];

                let { data: hist } = await supabase.from('historical_data').select('*');
                DB_HISTORICAL_CA = {};
                (hist || []).forEach(row => { 
                    try { DB_HISTORICAL_CA[row.year] = typeof row.months === 'string' ? JSON.parse(row.months) : row.months; } catch(e){} 
                });

                renderPlanning();
                updateDashboard();
                renderChargesList();
                renderCleaningView(); // On lance aussi le rendu m√©nage
            } catch (e) { console.error(e); alert("Erreur chargement donn√©es"); }
        }

        // --- 4. PLANNING GLOBAL (Tous les enregistrements) ---
        function renderPlanning(filterText = '') {
            const container = document.getElementById('planning-container');
            let allRes = [...DB_RESERVATIONS];
            
            // Filtre recherche
            if(filterText) {
                allRes = allRes.filter(r => r.nom_client.toLowerCase().includes(filterText.toLowerCase()));
            }

            // Tri par date
            allRes.sort((a,b) => new Date(a.date_debut) - new Date(b.date_debut));
            
            // Supprimer les tr√®s vieilles r√©servations (> 2 mois avant ajd) pour all√©ger
            const cutOffDate = new Date();
            cutOffDate.setMonth(cutOffDate.getMonth() - 2);
            allRes = allRes.filter(r => new Date(r.date_fin) > cutOffDate);

            if(allRes.length === 0) { container.innerHTML = '<div style="padding:20px; text-align:center;">Aucune r√©servation r√©cente.</div>'; return; }

            const weeks = {};
            allRes.forEach(r => {
                const d = new Date(r.date_debut);
                const wNum = getWeekNumber(d);
                // Gestion Ann√©e pour la cl√© (Ex: Semaine 1 en D√©cembre -> Ann√©e Suivante)
                let year = d.getFullYear();
                if (d.getMonth() === 11 && wNum === 1) year++; 
                
                const key = `${year}-W${wNum}`;
                if(!weeks[key]) {
                    const startW = getStartOfWeek(d);
                    const endW = new Date(startW); endW.setDate(endW.getDate()+6);
                    weeks[key] = { label: `Semaine ${wNum}`, dates: `${formatDate(startW)} - ${formatDate(endW)}`, trevoux: [], couzon: [] };
                }
                weeks[key][r.gite === 'Tr√©voux' ? 'trevoux' : 'couzon'].push(r);
            });

            // Tri des cl√©s de semaines (pour √©viter le d√©sordre fin d'ann√©e)
            const sortedKeys = Object.keys(weeks).sort();

            let html = '';
            sortedKeys.forEach(k => {
                const w = weeks[k];
                html += `
                <div class="week-container">
                    <div class="week-title">${w.label} <span style="opacity:0.7; font-weight:400; margin-left:10px;">${w.dates}</span></div>
                    <div class="week-grid">
                        <div class="day-column">${w.trevoux.map(r => createResCard(r)).join('')}</div>
                        <div class="day-column">${w.couzon.map(r => createResCard(r)).join('')}</div>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        // --- 5. STATISTIQUES (Chart.js ACTIF) ---
        function updateDashboard() {
            const year = parseInt(document.getElementById('stats-year').value);
            const prevYear = year - 1;

            // Filtre Donn√©es pour l'ann√©e s√©lectionn√©e
            const resYear = DB_RESERVATIONS.filter(r => new Date(r.date_debut).getFullYear() === year && r.nom_client.toUpperCase().indexOf('BLOQU√â') === -1);
            
            // KPI Cards
            document.getElementById('total-res').innerText = resYear.length;
            const caTotal = resYear.reduce((sum, r) => sum + r.montant, 0);
            document.getElementById('total-ca').innerText = Math.round(caTotal) + ' ‚Ç¨';
            
            const countTrevoux = resYear.filter(r => r.gite === 'Tr√©voux').length;
            const countCouzon = resYear.filter(r => r.gite === 'Couzon').length;
            
            // Calcul Taux Occupation (Simplifi√©: nb res * 4 jours moy / 365)
            // Pour plus de pr√©cision, il faudrait la somme des dur√©es
            const durationTotal = resYear.reduce((sum, r) => {
                return sum + ((new Date(r.date_fin) - new Date(r.date_debut)) / (1000 * 60 * 60 * 24));
            }, 0);
            
            document.getElementById('kpi-taux-trevoux').innerText = resYear.length > 0 ? Math.round((countTrevoux / resYear.length) * 100) + '%' : '0%'; 
            document.getElementById('kpi-taux-couzon').innerText = resYear.length > 0 ? Math.round((countCouzon / resYear.length) * 100) + '%' : '0%';
            document.getElementById('kpi-pm').innerText = resYear.length > 0 ? Math.round(caTotal / durationTotal) + ' ‚Ç¨' : '0 ‚Ç¨';
            document.getElementById('kpi-duree').innerText = resYear.length > 0 ? Math.round(durationTotal / resYear.length) + ' nuits' : '0';

            // Compteurs Plateformes
            document.getElementById('count-airbnb').innerText = resYear.filter(r => (r.plateforme||'').toLowerCase().includes('airbnb')).length;
            document.getElementById('count-abritel').innerText = resYear.filter(r => (r.plateforme||'').toLowerCase().includes('abritel')).length;
            document.getElementById('count-gites').innerText = resYear.filter(r => (r.plateforme||'').toLowerCase().includes('gite')).length;

            // GRAPHIQUE MENSUEL (CA)
            const months = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Ao√ªt', 'Sep', 'Oct', 'Nov', 'D√©c'];
            const monthlyCA = new Array(12).fill(0);
            resYear.forEach(r => {
                const m = new Date(r.date_debut).getMonth();
                monthlyCA[m] += r.montant;
            });
            
            // Ajout Donn√©es Historiques Manuelles si existent
            if (DB_HISTORICAL_CA[year]) {
                // Fusionner ou remplacer si besoin. Ici on additionne si le script auto a rat√© des vieux trucs, ou on prend juste le script auto.
                // Pour simplifier, on prend le calcul auto.
            }
            
            // Donn√©es Ann√©e Pr√©c√©dente (pour comparaison)
            const prevYearData = new Array(12).fill(0);
            const resPrev = DB_RESERVATIONS.filter(r => new Date(r.date_debut).getFullYear() === prevYear);
            resPrev.forEach(r => { prevYearData[new Date(r.date_debut).getMonth()] += r.montant; });
            
            // Rendu Chart Mensuel
            const ctxM = document.getElementById('monthlyChart').getContext('2d');
            if(monthlyChartInstance) monthlyChartInstance.destroy();
            monthlyChartInstance = new Chart(ctxM, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        { label: year, data: monthlyCA, backgroundColor: '#2ecc71' },
                        { label: prevYear, data: prevYearData, backgroundColor: '#e67e22' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // Rendu Chart Plateforme
            const ctxP = document.getElementById('platformChart').getContext('2d');
            if(platformChartInstance) platformChartInstance.destroy();
            const pData = [
                parseInt(document.getElementById('count-airbnb').innerText),
                parseInt(document.getElementById('count-abritel').innerText),
                parseInt(document.getElementById('count-gites').innerText)
            ];
            platformChartInstance = new Chart(ctxP, {
                type: 'doughnut',
                data: {
                    labels: ['Airbnb', 'Abritel', 'G√Ætes'],
                    datasets: [{ data: pData, backgroundColor: ['#FF5A5F', '#3498DB', '#27AE60'] }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        // --- 6. VUE M√âNAGE (FILTRE STRICT "A PARTIR DE CE JOUR") ---
        function renderCleaningView() {
            const container = document.getElementById('cleaning-planning-container');
            const monthVal = document.getElementById('cleaning-month-select').value;
            if(!monthVal) return;

            const [selYear, selMonth] = monthVal.split('-').map(Number);
            const startMonth = new Date(selYear, selMonth - 1, 1);
            const endMonth = new Date(selYear, selMonth, 0);
            
            // Date du jour minuit pour filtre "Futur uniquement"
            const today = new Date();
            today.setHours(0,0,0,0);

            // Filtre: R√©servation se termine dans ce mois ET date de fin >= aujourd'hui
            let tasks = DB_RESERVATIONS.filter(r => {
                const dFin = new Date(r.date_fin);
                return dFin >= startMonth && dFin <= endMonth && dFin >= today;
            });
            
            tasks.sort((a,b) => new Date(a.date_fin) - new Date(b.date_fin));

            if(tasks.length === 0) {
                container.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">Aucun m√©nage pr√©vu pour le reste de ce mois.</div>';
                return;
            }

            let html = '';
            tasks.forEach(r => {
                const dFin = new Date(r.date_fin);
                const isChaining = DB_RESERVATIONS.some(other => other.gite === r.gite && other.date_debut === r.date_fin);
                
                // Statut couleur
                let statusClass = 'status-propose'; 
                let statusText = 'A Faire';
                if(r.menage_valide) {
                     statusText = r.menage_valide;
                     if(statusText.includes('Valid√©')) statusClass = 'status-valide';
                     else if(statusText.includes('Non')) statusClass = 'status-attente';
                }

                html += `
                <div class="res-card" style="${isChaining ? 'border-left:4px solid var(--accent);' : ''}">
                    <div style="display:flex; justify-content:space-between;">
                        <span style="font-weight:bold; font-size:1.1rem;">${r.gite}</span>
                        <span style="font-weight:bold; color:var(--primary);">${formatDate(dFin)}</span>
                    </div>
                    <div style="font-size:0.9rem; color:#666; margin-top:5px;">
                        Client: ${r.nom_client} <br>
                        Heure cible: <strong>${isChaining ? '12h00 (Encha√Ænement)' : 'Standard'}</strong>
                    </div>
                    <div class="status-indicator ${statusClass}">${statusText}</div>
                </div>`;
            });
            container.innerHTML = html;
        }

        // --- 7. CHARGES (Liste Simple) ---
        function renderChargesList() {
            const list = document.getElementById('charges-list');
            if(DB_CHARGES.length === 0) { list.innerHTML = '<p style="padding:10px;">Aucune charge.</p>'; return; }
            let html = '<table style="width:100%; border-collapse:collapse;"><tr><th>Date</th><th>G√Æte</th><th>Montant</th></tr>';
            DB_CHARGES.forEach(c => {
                html += `<tr><td style="padding:8px; border-bottom:1px solid #eee;">${formatDate(c.date)}</td><td style="padding:8px; border-bottom:1px solid #eee;">${c.gite}</td><td style="padding:8px; border-bottom:1px solid #eee;">${c.montant} ‚Ç¨</td></tr>`;
            });
            list.innerHTML = html + '</table>';
        }

        // --- UTILS ---
        function showTab(id, btn) {
            document.querySelectorAll('.section-content').forEach(s => s.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        function createResCard(r) {
            const dStart = new Date(r.date_debut); const dEnd = new Date(r.date_fin);
            const isBlocked = r.nom_client.toUpperCase().includes('BLOQU√â');
            return `<div class="res-card ${isBlocked?'blocked':''}" onclick="openEdit('${r.nom_client}', ${r.montant})">
                <div style="font-weight:700;">${r.nom_client}</div>
                <div style="font-size:0.85rem; color:#555;">${formatDate(dStart)} ‚ûù ${formatDate(dEnd)}</div>
                <div style="font-weight:bold; color:${isBlocked?'red':'#e67e22'}">${r.montant} ‚Ç¨</div>
                <span class="platform-badge" style="background:${r.plateforme?.includes('Airbnb')?'var(--airbnb)':r.plateforme?.includes('Abritel')?'var(--abritel)':'var(--gites)'}">${r.plateforme}</span>
            </div>`;
        }
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        }
        function getStartOfWeek(d) { const date = new Date(d); const day = date.getDay() || 7; if(day !== 1) date.setHours(-24 * (day - 1)); return date; }
        function formatDate(d) { const date = new Date(d); return `${String(date.getDate()).padStart(2,'0')}/${String(date.getMonth()+1).padStart(2,'0')}`; }
        function openEdit(nom, mt) { document.getElementById('edit-name').value=nom; document.getElementById('edit-amount').value=mt; document.getElementById('editModal').style.display='flex'; }

        // INIT
        window.onload = initAuth;
    </script>
</body>
</html>
