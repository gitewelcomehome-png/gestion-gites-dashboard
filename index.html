<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion G√Ætes PRO - Tr√©voux & Couzon</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ical.js@1.5.0/build/ical.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style> 
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Work+Sans:wght@300;400;600;700&display=swap');
    *{margin:0;padding:0;box-sizing:border-box;}
    :root{--primary:#2C5F7D;--bg-light:#F8F9FA;--text-dark:#2C3E50;--trevoux:#667eea;--couzon:#f093fb;--border:#E0E4E8;}
    body{font-family:'Work Sans',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;color:var(--text-dark);}
    .container{max-width:1600px;margin:0 auto;}
    header{text-align:center;margin-bottom:40px;color:white;}
    .nav-tabs{display:flex;gap:10px;margin-bottom:30px;flex-wrap:wrap;justify-content:center;}
    .nav-tab{padding:15px 30px;background:rgba(255,255,255,0.2);border:none;border-radius:12px;color:white;font-weight:600;cursor:pointer;transition:all 0.3s ease;}
    .nav-tab.active{background:white;color:var(--primary);}
    .tab-content{display:none;}
    .tab-content.active{display:block;}
    .card{background:white;border-radius:20px;padding:35px;box-shadow:0 10px 40px rgba(0,0,0,0.15);}
    .card-header{display:flex;align-items:center;gap:15px;margin-bottom:25px;padding-bottom:20px;border-bottom:2px solid var(--border);}
    .btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:600;color:white;transition:0.2s;}
    .btn-primary{background:var(--primary);}
    .btn-email{background:#8e44ad;} 
    
    /* STYLE DES STATS */
    .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
    .stat-card { padding: 20px; border-radius: 12px; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .bg-airbnb { background: #FF5A5F; }
    .bg-abritel { background: #3498DB; }
    .bg-gites { background: #27AE60; }
    .bg-autres { background: #9B59B6; }
    .stat-number { font-size: 2.5rem; font-weight: 700; margin-top: 10px; }
    .stat-label { font-size: 0.9rem; opacity: 0.9; }
    
    .kpi-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 30px; }
    .kpi-card { background: #f8f9fa; padding: 15px; border-radius: 12px; border-left: 4px solid #ccc; }
    .kpi-value { font-size: 1.8rem; font-weight: 700; color: #2C3E50; }
    .kpi-title { font-size: 0.85rem; color: #666; margin-bottom: 5px; }
    
    /* Login */
    #loginOverlay {position: fixed; inset: 0; background: #0f172a; z-index: 10000; display: flex; justify-content: center; align-items: center;}
    .login-box {background: white; padding: 40px; border-radius: 20px; width: 400px;}
    .login-input {width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px;}
    
    /* Menage */
    .menage-grid {display: grid; grid-template-columns: 1fr 1fr; gap: 30px;}
    .menage-col-header {padding: 15px; border-radius: 12px; color: white; margin-bottom: 20px; text-align: center; font-family: 'Playfair Display', serif; font-size: 1.5rem;}
    .menage-col-header.trevoux {background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);}
    .menage-col-header.couzon {background: linear-gradient(135deg,#f093fb 0%,#f5576c 100%);}
    .menage-item {background:#f0f8ff; padding:15px; margin-bottom:10px; border-radius:8px; display:flex; justify-content:space-between; align-items:center;}
    .btn-validation { padding:5px 10px; border-radius:20px; border:none; cursor:pointer; font-size:0.8rem; }
    .validated { background:#d4edda; color:green; } .pending { background:#fff3cd; color:orange; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <h2 style="text-align:center; margin-bottom:20px;">üîí Connexion G√Ætes</h2>
            <form onsubmit="event.preventDefault(); handleLogin();">
                <input type="email" id="loginEmail" class="login-input" placeholder="Email" value="calvignac.gites@gmail.com" required autocomplete="username">
                <input type="password" id="loginPassword" class="login-input" placeholder="Mot de passe" required autocomplete="current-password">
                <button type="submit" class="btn btn-primary" style="width:100%">Se connecter</button>
            </form>
            <p id="loginError" style="color:red; display:none; text-align:center; margin-top:10px;"></p>
        </div>
    </div>

    <div class="container" id="appContainer" style="display: none;">
        <header>
            <div style="position: absolute; top: 20px; right: 20px;">
                <button onclick="handleLogout()" class="btn" style="background:rgba(255,255,255,0.2);">D√©connexion</button>
            </div>
            <h1>üèòÔ∏è Gestion G√Ætes PRO</h1>
        </header>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('reservations')">üìù R√©servations</button>
            <button class="nav-tab" onclick="switchTab('statistiques')">üìä Statistiques</button>
            <button class="nav-tab" onclick="switchTab('menage')">üßπ Planning M√©nage</button>
            <button class="nav-tab" onclick="switchTab('infos-gites')">üìù Infos</button>
            <button class="nav-tab" onclick="switchTab('decouvrir')">üó∫Ô∏è √Ä D√©couvrir</button>
        </div>

        <div id="tab-statistiques" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <span style="font-size:2rem; margin-right:10px;">üìä</span> <h2>Tableau de Bord</h2>
                    <select id="yearFilterStats" onchange="updateStats()" style="margin-left:auto; padding:8px; border-radius:8px;">
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                    </select>
                </div>

                <div class="dashboard-grid">
                    <div class="stat-card bg-airbnb">
                        <div class="stat-label">Airbnb</div>
                        <div class="stat-number" id="countAirbnb">0</div>
                        <div>r√©servations</div>
                    </div>
                    <div class="stat-card bg-abritel">
                        <div class="stat-label">Abritel</div>
                        <div class="stat-number" id="countAbritel">0</div>
                        <div>r√©servations</div>
                    </div>
                    <div class="stat-card bg-gites">
                        <div class="stat-label">G√Ætes de France</div>
                        <div class="stat-number" id="countGites">0</div>
                        <div>r√©servations</div>
                    </div>
                    <div class="stat-card bg-autres">
                        <div class="stat-label">Autres</div>
                        <div class="stat-number" id="countAutres">0</div>
                        <div>r√©servations</div>
                    </div>
                </div>

                <div class="kpi-grid">
                    <div class="kpi-card" style="border-left-color: #667eea;">
                        <div class="kpi-title">üìä Taux Tr√©voux</div>
                        <div class="kpi-value" id="tauxTrevoux">0%</div>
                    </div>
                    <div class="kpi-card" style="border-left-color: #f093fb;">
                        <div class="kpi-title">üìä Taux Couzon</div>
                        <div class="kpi-value" id="tauxCouzon">0%</div>
                    </div>
                    <div class="kpi-card" style="border-left-color: #f1c40f;">
                        <div class="kpi-title">üí∞ Prix moyen/nuit</div>
                        <div class="kpi-value" id="prixMoyen">0 ‚Ç¨</div>
                    </div>
                    <div class="kpi-card" style="border-left-color: #3498db;">
                        <div class="kpi-title">üìÖ Dur√©e moyenne</div>
                        <div class="kpi-value" id="dureeMoyenne">0 nuits</div>
                    </div>
                    <div class="kpi-card" style="border-left-color: #2ecc71;">
                        <div class="kpi-title">üèÜ Meilleur mois</div>
                        <div class="kpi-value" id="meilleurMois" style="font-size:1.2rem;">-</div>
                    </div>
                </div>

                <div class="dashboard-grid" style="background:#0f172a; border-radius:15px; padding:20px; color:white;">
                    <div style="text-align:center;">
                        <div style="opacity:0.7">TOTAL R√âSERVATIONS</div>
                        <div style="font-size:2rem; font-weight:bold;" id="statTotal">0</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="opacity:0.7">TR√âVOUX</div>
                        <div style="font-size:2rem; font-weight:bold;" id="statTrevoux">0</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="opacity:0.7">COUZON</div>
                        <div style="font-size:2rem; font-weight:bold;" id="statCouzon">0</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="opacity:0.7">CA TOTAL</div>
                        <div style="font-size:2rem; font-weight:bold; color:#2ecc71;" id="statCA">0 ‚Ç¨</div>
                    </div>
                </div>

                <div style="height:350px; margin-top:30px;">
                    <canvas id="caChart"></canvas>
                </div>
            </div>
        </div>

        <div id="tab-reservations" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <span>üìÖ</span> <h2>Planning</h2>
                    <button class="btn btn-primary" onclick="syncAllCalendars()" style="margin-left:auto;">Sync Calendriers</button>
                </div>
                <div id="planning-container"></div>
            </div>
        </div>

        <div id="tab-menage" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <span>üßπ</span> <h2>Planning M√©nage</h2>
                    <div style="margin-left:auto; display:flex; gap:10px;">
                        <button class="btn btn-primary" onclick="genererPlanningMenage()">Rafra√Æchir</button>
                        <button class="btn btn-email" onclick="envoyerPlanningEmail()">üìß Envoyer Planning (Lien Validation)</button>
                    </div>
                </div>
                <div id="menagePlanning" style="margin-top:20px;"></div>
            </div>
        </div>

        <div id="tab-charges" class="tab-content"><div class="card"><h2>Charges</h2><div id="chargesList"></div></div></div>
        <div id="tab-infos-gites" class="tab-content"><div class="card"><h2>Infos</h2></div></div>
        <div id="tab-decouvrir" class="tab-content"><div class="card"><h2>D√©couvrir</h2></div></div>

    </div>

    <script>
        const SUPABASE_URL = 'https://ivqiisnudabxemcxxyru.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2cWlpc251ZGFieGVtY3h4eXJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzOTk0NjMsImV4cCI6MjA4MDk3NTQ2M30.9FwJPgR8bbaP7bAemuaVbAN019EO5ql7uciQO9FeHK4';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let caChartInstance; window.DB_VALIDATIONS={};

        async function initApp() {
            const { data: { session } } = await supabase.auth.getSession();
            if(!session) { document.getElementById('loginOverlay').style.display='flex'; }
            else { 
                document.getElementById('loginOverlay').style.display='none'; 
                document.getElementById('appContainer').style.display='block';
                await updateReservationsList();
                await updateStats();
            }
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const { error } = await supabase.auth.signInWithPassword({ email, password });
            if(error) document.getElementById('loginError').innerText = error.message;
            else initApp();
        }
        async function handleLogout() { await supabase.auth.signOut(); location.reload(); }

        // --- STATISTIQUES ---
        async function updateStats() {
            const year = document.getElementById('yearFilterStats').value;
            
            // R√©cup√©rer donn√©es
            const { data: resas } = await supabase.from('reservations').select('*');
            if(!resas || resas.length === 0) return;

            // Filtrer (S√©curit√© sur date_debut)
            const filtered = resas.filter(r => r.date_debut && r.date_debut.startsWith(year));

            let airbnb=0, abritel=0, gites=0, autres=0;
            let totalCA=0, totalNuits=0, totalMontant=0;
            const occupiedTrevoux = new Set();
            const occupiedCouzon = new Set();

            filtered.forEach(r => {
                const site = (r.plateforme || '').toLowerCase();
                const montant = parseFloat(r.montant) || 0;
                totalCA += montant;
                totalMontant += montant;

                if(site.includes('airbnb')) airbnb++;
                else if(site.includes('abritel')) abritel++;
                else if(site.includes('gites')) gites++;
                else autres++;

                if(r.date_debut && r.date_fin) {
                    const d1 = new Date(r.date_debut);
                    const d2 = new Date(r.date_fin);
                    const nuits = Math.ceil((d2 - d1) / (1000 * 60 * 60 * 24));
                    totalNuits += nuits;

                    for(let d = new Date(d1); d < d2; d.setDate(d.getDate()+1)) {
                        const dayStr = d.toISOString().split('T')[0];
                        if(r.gite === 'Tr√©voux') occupiedTrevoux.add(dayStr);
                        if(r.gite === 'Couzon') occupiedCouzon.add(dayStr);
                    }
                }
            });

            // Affichage
            document.getElementById('countAirbnb').innerText = airbnb;
            document.getElementById('countAbritel').innerText = abritel;
            document.getElementById('countGites').innerText = gites;
            document.getElementById('countAutres').innerText = autres;

            const daysInYear = 365;
            document.getElementById('tauxTrevoux').innerText = ((occupiedTrevoux.size / daysInYear)*100).toFixed(1) + '%';
            document.getElementById('tauxCouzon').innerText = ((occupiedCouzon.size / daysInYear)*100).toFixed(1) + '%';

            const avgPrice = filtered.length ? (totalMontant / totalNuits).toFixed(0) : 0;
            const avgDur = filtered.length ? (totalNuits / filtered.length).toFixed(1) : 0;
            document.getElementById('prixMoyen').innerText = avgPrice + ' ‚Ç¨';
            document.getElementById('dureeMoyenne').innerText = avgDur + ' nuits';

            document.getElementById('statTotal').innerText = filtered.length;
            document.getElementById('statTrevoux').innerText = filtered.filter(r => r.gite==='Tr√©voux').length;
            document.getElementById('statCouzon').innerText = filtered.filter(r => r.gite==='Couzon').length;
            document.getElementById('statCA').innerText = totalCA.toFixed(0) + ' ‚Ç¨';

            updateChart(filtered);
        }

        function updateChart(resas) {
            const data = Array(12).fill(0);
            resas.forEach(r => {
                if(r.date_debut) {
                    const m = new Date(r.date_debut).getMonth();
                    data[m] += (parseFloat(r.montant)||0);
                }
            });

            const ctx = document.getElementById('caChart');
            if(caChartInstance) caChartInstance.destroy();
            caChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan','F√©v','Mar','Avr','Mai','Juin','Juil','Ao√ªt','Sep','Oct','Nov','D√©c'],
                    datasets: [{
                        label: 'CA Mensuel',
                        data: data,
                        borderColor: '#2ecc71',
                        backgroundColor: 'rgba(46, 204, 113, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { responsive:true, maintainAspectRatio:false }
            });
        }

        // --- EMAIL VERS VALIDATION.HTML ---
        function envoyerPlanningEmail() {
            // Lien vers validation.html
            const currentUrl = window.location.href;
            const baseUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/')) + '/validation.html';
            
            const subject = "Planning M√©nage G√Ætes - √Ä valider";
            const body = `Bonjour,\n\nMerci de consulter et valider les prochains m√©nages via ce lien :\n\n${baseUrl}\n\nCordialement.`;
            
            window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        }

        // --- GESTION MENAGE (LOGIQUE INTERNE) ---
        async function loadCleaningValidations() {
            const { data } = await supabase.from('cleaning_validation').select('*');
            window.DB_VALIDATIONS = {};
            if(data) data.forEach(v => window.DB_VALIDATIONS[v.reservation_id] = v.status);
        }
        
        async function toggleMenageStatus(reservationId, currentStatus, dateIso, gite) {
            const newStatus = currentStatus === 'validated' ? 'pending' : 'validated';
            const { error } = await supabase.from('cleaning_validation').upsert({
                reservation_id: reservationId,
                gite: gite,
                original_date: dateIso,
                status: newStatus
            }, { onConflict: 'reservation_id' });

            if(!error) {
                window.DB_VALIDATIONS[reservationId] = newStatus;
                genererPlanningMenage();
            } else {
                console.error(error);
                alert("Erreur de sauvegarde. V√©rifiez votre connexion.");
            }
        }

        function getMenageInfo(reservation, allReservations) {
            if(!reservation.date_fin) return null;
            const departDate = new Date(reservation.date_fin);
            let menageDate = new Date(departDate);
            let heure = '12h00';
            const departDay = departDate.getDay();
            
            // Check enchainement (Arriv√©e le jour m√™me)
            const arriveeMemejour = allReservations.find(resa => 
                resa.gite === reservation.gite && resa.id !== reservation.id &&
                resa.date_debut === reservation.date_fin
            );

            if (departDay === 0) { // Dimanche
                if (!arriveeMemejour) {
                     menageDate.setDate(menageDate.getDate() + 1); // Report Lundi
                     const arriveeLundi = allReservations.find(x => x.gite === reservation.gite && x.date_debut === menageDate.toISOString().split('T')[0]);
                     if(arriveeLundi) heure = '07h00';
                } else { heure = '13h00'; }
            } else if (departDay === 6 && !arriveeMemejour) { // Samedi
                // V√©rif dimanche
                const lendemain = new Date(departDate);
                lendemain.setDate(lendemain.getDate() + 1);
                const resaDimanche = allReservations.find(x => x.gite === reservation.gite && x.date_debut === lendemain.toISOString().split('T')[0]);
                
                if(!resaDimanche) {
                    menageDate.setDate(menageDate.getDate() + 2); // Report Lundi
                    const arriveeLundi = allReservations.find(x => x.gite === reservation.gite && x.date_debut === menageDate.toISOString().split('T')[0]);
                    if(arriveeLundi) heure = '07h00';
                }
            } else if (arriveeMemejour) { heure = '11h00'; }

            return {
                dateObj: menageDate,
                dateStr: menageDate.toISOString().split('T')[0],
                heure: heure,
                displayDate: menageDate.toLocaleDateString('fr-FR', {weekday: 'short', day: '2-digit', month: 'short'}),
                enchainement: !!arriveeMemejour
            };
        }

        async function genererPlanningMenage() {
            await loadCleaningValidations();
            const { data: resas } = await supabase.from('reservations').select('*');
            if(!resas) return;

            const now = new Date();
            now.setHours(0,0,0,0);
            
            // Filtre futur
            const relevant = resas.filter(r => new Date(r.date_fin) >= now).sort((a,b)=>new Date(a.date_fin)-new Date(b.date_fin));
            
            const trevoux = relevant.filter(r => r.gite === 'Tr√©voux');
            const couzon = relevant.filter(r => r.gite === 'Couzon');
            
            function renderColumn(list) {
                if(list.length === 0) return '<p style="text-align:center;color:#999;padding:20px;">Aucun m√©nage</p>';
                return list.map(r => {
                    const menage = getMenageInfo(r, resas);
                    if(!menage) return '';
                    const status = window.DB_VALIDATIONS[r.id] || 'pending';
                    const btnClass = status === 'validated' ? 'validated' : 'pending';
                    const btnText = status === 'validated' ? '‚úÖ FAIT' : '‚è≥ √Ä FAIRE';
                    
                    return `<div class="menage-item">
                        <div>
                            <div style="font-weight:bold; color:#2C5F7D">üìÖ ${menage.displayDate} √† ${menage.heure} ${menage.enchainement ? '‚ö°' : ''}</div>
                            <div style="font-size:0.9rem; color:#666">Client: ${r.nom_client || 'Inconnu'}</div>
                        </div>
                        <button class="btn-validation ${btnClass}" onclick="toggleMenageStatus(${r.id}, '${status}', '${menage.dateStr}', '${r.gite}')">${btnText}</button>
                    </div>`;
                }).join('');
            }

            const div = document.getElementById('menagePlanning');
            div.innerHTML = `<div class="menage-grid">
                <div><div class="menage-col-header trevoux">üè∞ Tr√©voux</div>${renderColumn(trevoux)}</div>
                <div><div class="menage-col-header couzon">‚õ∞Ô∏è Couzon</div>${renderColumn(couzon)}</div>
            </div>`;
        }

        async function updateReservationsList() {
            const { data } = await supabase.from('reservations').select('*').order('date_debut');
            if(!data) return;
            const container = document.getElementById('planning-container');
            const active = data.filter(r => new Date(r.date_fin) >= new Date());
            
            container.innerHTML = active.map(r => 
                `<div style="border:1px solid #eee; padding:15px; margin-bottom:10px; border-radius:8px; border-left:4px solid ${r.gite==='Tr√©voux'?'#667eea':'#f093fb'}; background:white;">
                    <div style="font-weight:bold; display:flex; justify-content:space-between;">
                        <span>${r.nom_client || 'Client'}</span>
                        <span style="font-size:0.8rem; background:#eee; padding:2px 8px; border-radius:10px;">${r.plateforme}</span>
                    </div>
                    <div style="color:#666; margin-top:5px;">üìÖ ${new Date(r.date_debut).toLocaleDateString()} ‚ûù ${new Date(r.date_fin).toLocaleDateString()}</div>
                </div>`
            ).join('');
        }

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(b=>b.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
            event.target.classList.add('active');
            if(id==='statistiques') updateStats();
            if(id==='menage') genererPlanningMenage();
        }

        // Placeholders pour fonctions non utilis√©es dans ce contexte simplifi√©
        function chargerUrlsIcal() {}
        async function syncAllCalendars() {}

        initApp();
    </script>
</body>
</html>
