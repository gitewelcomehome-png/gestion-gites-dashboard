<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß GESTION G√éTES - VERSION CORRIG√âE 17 D√âC 14H45</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ical.js@1.5.0/build/ical.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Pas besoin de QRCode.js, on utilise une API -->
    
    <style> @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Work+Sans:wght@300;400;600;700&display=swap');*{margin:0;padding:0;box-sizing:border-box;}
:root{--primary:#2C5F7D;--primary-dark:#1A3A4D;--accent:#E8A87C;--accent-light:#F5D5B8;--bg-light:#F8F9FA;--text-dark:#2C3E50;--success:#27AE60;--trevoux:#667eea;--couzon:#f093fb;--border:#E0E4E8;--warning:#F39C12;--danger:#E74C3C;--airbnb:#FF5A5F;--abritel:#3498DB;--gites:#27AE60;}
body{font-family:'Work Sans',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;color:var(--text-dark);}
.container{max-width:1600px;margin:0 auto;}
header{text-align:center;margin-bottom:40px;color:white;}
h1{font-family:'Playfair Display',serif;font-size:3rem;margin-bottom:10px;text-shadow:2px 2px 4px rgba(0,0,0,0.2);}
.subtitle{font-size:1.1rem;opacity:0.95;font-weight:300;}
.nav-tabs{display:flex;gap:10px;margin-bottom:30px;flex-wrap:wrap;justify-content:center;}
.nav-tab{padding:15px 30px;background:rgba(255,255,255,0.2);border:none;border-radius:12px;color:white;font-weight:600;cursor:pointer;transition:all 0.3s ease;font-family:'Work Sans',sans-serif;font-size:1rem;}
.nav-tab:hover{background:rgba(255,255,255,0.3);}
.nav-tab.active{background:white;color:var(--primary);}
.tab-content{display:none;}
.tab-content.active{display:block;}
.main-grid{display:grid;grid-template-columns:400px 1fr;gap:30px;margin-bottom:30px;}
@media (max-width:1200px){.main-grid{grid-template-columns:1fr;}
}
.card{background:white;border-radius:20px;padding:35px;box-shadow:0 10px 40px rgba(0,0,0,0.15);}
.card-header{display:flex;align-items:center;gap:15px;margin-bottom:25px;padding-bottom:20px;border-bottom:2px solid var(--border);}
.card-icon{font-size:2.5rem;}
.card-title{font-family:'Playfair Display',serif;font-size:1.8rem;color:var(--primary);}
.form-group{margin-bottom:20px;}
label{display:block;margin-bottom:8px;font-weight:600;color:var(--text-dark);font-size:0.95rem;}
input,select,textarea{width:100%;padding:12px 15px;border:2px solid var(--border);border-radius:10px;font-size:1rem;font-family:'Work Sans',sans-serif;transition:all 0.3s ease;background:white;}
input:disabled{background:#f0f0f0;cursor:not-allowed;}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(44,95,125,0.1);}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:15px;}
.btn{width:100%;padding:15px;border:none;border-radius:12px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:all 0.3s ease;font-family:'Work Sans',sans-serif;display:flex;align-items:center;justify-content:center;gap:10px;}
.btn:disabled{opacity:0.5;cursor:not-allowed;}
.btn-primary{background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);color:white;}
.btn-primary:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 20px rgba(44,95,125,0.4);}
.btn-secondary{background:linear-gradient(135deg,var(--accent) 0%,#D89968 100%);color:white;margin-top:10px;}
.btn-sync{background:linear-gradient(135deg,#3498DB 0%,#2874A6 100%);color:white;margin-top:10px;}
.btn-sync:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 20px rgba(52,152,219,0.4);}
.btn-danger{background:linear-gradient(135deg,var(--danger) 0%,#C0392B 100%);color:white;}
.btn-warning{background:linear-gradient(135deg,var(--warning) 0%,#E67E22 100%);color:white;}
.btn-menage{background:linear-gradient(135deg,#27AE60 0%,#229954 100%);color:white;margin-top:10px;}
.btn-menage:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 8px 20px rgba(39,174,96,0.4);}
.menage-item{background:#f0f8ff;padding:15px;margin-bottom:10px;border-radius:8px;border-left:4px solid #27AE60;}
.menage-date{font-weight:700;color:var(--primary);margin-bottom:5px;}
.menage-detail{font-size:0.95rem;color:#666;}
.charges-list{margin-top:20px;}
.charge-item{background:var(--bg-light);padding:15px;border-radius:10px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;}
.charge-info{flex:1;}
.charge-name{font-weight:600;color:var(--primary);}
.charge-amount{font-size:1.2rem;font-weight:700;color:var(--danger);}
.btn-small{padding:8px 15px;font-size:0.9rem;width:auto;}
.stats-section{background:white;border-radius:20px;padding:35px;box-shadow:0 10px 40px rgba(0,0,0,0.15);margin-bottom:30px;}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px;}
.stat-item{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:25px;border-radius:15px;text-align:center;color:white;}
.stat-value{font-size:2.5rem;font-weight:700;margin-bottom:5px;}
.stat-label{font-size:0.9rem;opacity:0.95;}
.chart-container{margin-top:30px;height:350px;}
.gite-section{margin-bottom:30px;}
.gite-header{font-family:'Playfair Display',serif;font-size:1.5rem;padding:15px 20px;border-radius:12px;margin-bottom:15px;color:white;display:flex;align-items:center;gap:10px;}
.gite-header.trevoux{background:linear-gradient(135deg,var(--trevoux) 0%,#667eea 100%);}
.gite-header.couzon{background:linear-gradient(135deg,var(--couzon) 0%,#f5576c 100%);}
.planning-container{width:100%;padding:20px;}
.planning-weeks{display:flex;flex-direction:column;gap:30px;}
.week-block{background:white;border-radius:15px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,0.1);}
.week-header-unique{background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);padding:12px;text-align:center;color:white;}
.week-number-big{font-weight:700;font-size:1.2rem;font-family:'Playfair Display',serif;margin-bottom:3px;}
.week-dates-small{font-size:0.85rem;opacity:0.95;}
.week-content-grid{display:grid;grid-template-columns:1fr 1fr;gap:0;border-top:3px solid var(--primary);}
@media (max-width:1024px){.week-content-grid{grid-template-columns:1fr;}
}
.gite-column-inline{padding:0;border-right:2px solid var(--border);}
.gite-column-inline:last-child{border-right:none;}
.gite-label{padding:15px;text-align:center;font-weight:700;font-size:1.1rem;color:white;}
.gite-label.trevoux-label{background:linear-gradient(135deg,var(--trevoux) 0%,#667eea 100%);}
.gite-label.couzon-label{background:linear-gradient(135deg,var(--couzon) 0%,#f5576c 100%);}
.week-reservation{padding:15px;border-bottom:1px solid var(--border);}
.week-reservation:last-child{border-bottom:none;}
.week-reservation.trevoux{background:rgba(102,126,234,0.05);}
.week-reservation.couzon{background:rgba(240,147,251,0.05);}
.week-empty{padding:40px 20px;text-align:center;color:#999;font-style:italic;background:var(--bg-light);}
.gite-column{background:var(--bg-light);border-radius:15px;overflow:hidden;}
.gite-header.trevoux-header{background:linear-gradient(135deg,var(--trevoux) 0%,#667eea 100%);padding:20px;text-align:center;color:white;}
.gite-header.couzon-header{background:linear-gradient(135deg,var(--couzon) 0%,#f5576c 100%);padding:20px;text-align:center;color:white;}
.gite-header h3{margin:0;font-size:1.5rem;font-family:'Playfair Display',serif;}
.week-reservation-name{font-weight:600;color:var(--primary);margin-bottom:5px;}
.week-reservation-details{font-size:0.85rem;color:#666;}
.month-group{margin-bottom:20px;}
.month-title{font-weight:700;font-size:1.1rem;color:var(--primary);margin-bottom:10px;padding:10px 15px;background:var(--bg-light);border-radius:8px;text-transform:uppercase;}
.reservation-item{background:var(--bg-light);padding:15px;border-radius:10px;margin-bottom:10px;border-left:4px solid var(--primary);}
.reservation-item.trevoux{border-left-color:var(--trevoux);}
.reservation-item.couzon{border-left-color:var(--couzon);}
.reservation-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.reservation-name{font-weight:600;font-size:1.1rem;color:var(--primary);}
.reservation-actions{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap;}
.badge-platform{padding:4px 12px;border-radius:20px;font-size:0.85rem;font-weight:600;color:white;}
.badge-airbnb{background:var(--airbnb);}
.badge-abritel{background:var(--abritel);}
.badge-gites{background:var(--gites);}
.toast{position:fixed;top:30px;right:30px;background:var(--success);color:white;padding:20px 30px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.3);display:none;align-items:center;gap:15px;z-index:1000;animation:slideIn 0.3s ease;max-width:400px;}
@keyframes slideIn{from{transform:translateX(400px);opacity:0;}
to{transform:translateX(0);opacity:1;}
}
.toast.show{display:flex;}
.required{color:#E74C3C;}
.alert{padding:15px 20px;border-radius:10px;margin-bottom:20px;font-weight:500;}
.alert-info{background:#D6EAF8;color:#1F618D;border-left:4px solid #3498DB;}
.alert-warning{background:#FCF3CF;color:#7D6608;border-left:4px solid var(--warning);}
.alert-success{background:#D5F4E6;color:#0E6655;border-left:4px solid var(--success);}
.dates-blocked{background:#FCF3CF;padding:10px 15px;border-radius:8px;margin-top:10px;font-size:0.9rem;color:#7D6608;}
select.inline-edit{padding:5px 10px;font-size:0.9rem;width:auto;min-width:150px;}
input.inline-edit{padding:5px 10px;font-size:0.9rem;width:auto;min-width:100px;}
.sync-progress{margin-top:20px;padding:15px;background:var(--bg-light);border-radius:10px;display:none;}
.sync-progress.show{display:block;}
.progress-item{padding:8px 0;font-size:0.95rem;}
.progress-item.success{color:var(--success);}
.progress-item.error{color:var(--danger);}
.spinner{display:inline-block;width:16px;height:16px;border:3px solid rgba(0,0,0,0.1);border-radius:50%;border-top-color:var(--primary);animation:spin 1s ease-in-out infinite;}
@keyframes spin{to{transform:rotate(360deg);}
}
.modal{display:none;position:fixed;z-index:2000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5);animation:fadeIn 0.3s ease;}
.modal.show{display:flex;align-items:center;justify-content:center;}
.modal-content{background:white;padding:30px;border-radius:20px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;animation:slideUp 0.3s ease;}
@keyframes fadeIn{from{opacity:0;}
to{opacity:1;}
}
@keyframes slideUp{from{transform:translateY(50px);opacity:0;}
to{transform:translateY(0);opacity:1;}
}
body{font-family:'Work Sans',sans-serif;background:radial-gradient(circle at 0% 0%,rgba(255,255,255,0.08),transparent 55%),radial-gradient(circle at 100% 0%,rgba(232,168,124,0.18),transparent 55%),linear-gradient(135deg,#111827 0%,#1f2937 45%,#020617 100%);min-height:100vh;padding:32px 16px;color:var(--text-dark);}
.container{max-width:1500px;margin:0 auto;}
header{text-align:center;margin-bottom:32px;color:#e5e7eb;}
h1{font-size:2.6rem;letter-spacing:0.04em;}
.subtitle{font-size:1rem;opacity:0.9;}
.nav-tabs{background:rgba(15,23,42,0.65);border-radius:999px;padding:6px;border:1px solid rgba(148,163,184,0.45);box-shadow:0 18px 45px rgba(15,23,42,0.55);}
.nav-tab{position:relative;padding:10px 18px;border-radius:999px;font-size:0.9rem;letter-spacing:0.02em;text-transform:uppercase;background:transparent;color:#e5e7eb;border:none;box-shadow:none;}
.nav-tab::before{content:"";position:absolute;inset:0;border-radius:inherit;background:radial-gradient(circle at top left,rgba(148,163,184,0.2),transparent 65%);opacity:0;transition:opacity 0.25s ease;z-index:-1;}
.nav-tab:hover::before{opacity:1;}
.nav-tab.active{background:linear-gradient(135deg,#38bdf8 0%,#6366f1 45%,#ec4899 100%);color:white;box-shadow:0 10px 30px rgba(56,189,248,0.35);transform:translateY(-1px);}
.tab-content{opacity:0;transform:translateY(6px);transition:opacity 0.3s ease,transform 0.3s ease;}
.tab-content.active{opacity:1;transform:translateY(0);}
.card,.stats-section{background:radial-gradient(circle at top left,rgba(255,255,255,0.98),rgba(248,250,252,0.98));border-radius:24px;padding:28px 28px 26px;box-shadow:0 22px 60px rgba(15,23,42,0.32),0 0 0 1px rgba(148,163,184,0.35);border:none;position:relative;overflow:hidden;}
.card::after,.stats-section::after{content:"";position:absolute;inset:0;background:radial-gradient(circle at 0% 0%,rgba(56,189,248,0.08),transparent 55%),radial-gradient(circle at 100% 100%,rgba(236,72,153,0.05),transparent 55%);opacity:0.9;pointer-events:none;z-index:-1;}
.card-header{border-bottom:1px solid rgba(148,163,184,0.45);padding-bottom:16px;margin-bottom:18px;}
.card-icon{font-size:2.1rem;}
.card-title{font-size:1.5rem;color:#0f172a;}
.form-group label{color:#0f172a;font-size:0.9rem;}
input,select,textarea{border-radius:12px;border:1px solid rgba(148,163,184,0.75);background:rgba(255,255,255,0.9);transition:border-color 0.2s ease,box-shadow 0.2s ease,background 0.2s ease;}
input:focus,select:focus,textarea:focus{border-color:#38bdf8;box-shadow:0 0 0 1px rgba(56,189,248,0.6);background:#ffffff;}
.btn{border-radius:999px;font-size:0.95rem;padding:11px 18px;letter-spacing:0.03em;text-transform:uppercase;box-shadow:0 12px 30px rgba(15,23,42,0.28);}
.btn-primary{background:linear-gradient(135deg,#0ea5e9 0%,#6366f1 45%,#ec4899 100%);}
.btn-secondary{background:linear-gradient(135deg,#f97316 0%,#f59e0b 40%,#facc15 100%);color:#111827;}
.btn-sync{background:linear-gradient(135deg,#22c55e 0%,#16a34a 45%,#15803d 100%);}
.btn-menage{background:linear-gradient(135deg,#22c55e 0%,#14b8a6 45%,#0ea5e9 100%);}
.btn-danger{background:linear-gradient(135deg,#ef4444 0%,#b91c1c 55%);}
.btn-warning{background:linear-gradient(135deg,#facc15 0%,#eab308 55%);color:#111827;}
.btn:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 16px 38px rgba(15,23,42,0.4);}
.stats-grid{gap:18px;}
.stat-item{border-radius:18px;background:linear-gradient(135deg,rgba(15,23,42,0.98),rgba(30,64,175,0.98));box-shadow:0 18px 40px rgba(15,23,42,0.55);}
.stat-value{font-size:2.1rem;}
.stat-label{font-size:0.8rem;letter-spacing:0.12em;text-transform:uppercase;}
.gite-label.trevoux-label{background:linear-gradient(135deg,#4a5568 0%,#2d3748 100%);}
.gite-label.couzon-label{background:linear-gradient(135deg,#5a67d8 0%,#4c51bf 100%);}
.week-block{border-radius:22px;}
.week-header-unique{background:linear-gradient(135deg,#0f172a 0%,#1f2937 40%,#111827 100%);}
.week-empty{background:rgba(248,250,252,0.7);color:#6b7280;}
.week-reservation{border-bottom:1px dashed rgba(148,163,184,0.6);}
.week-reservation:last-child{border-bottom:none;}
.week-reservation-name{color:#0f172a;}
.week-reservation-details{color:#4b5563;}
.reservation-item{background:radial-gradient(circle at top left,rgba(248,250,252,0.98),rgba(241,245,249,0.98));border-radius:18px;border-left-width:4px;}
.badge-platform{border-radius:999px;}
.alert{border-radius:14px;border:1px solid rgba(148,163,184,0.4);}
.toast{border-radius:18px;box-shadow:0 18px 40px rgba(15,23,42,0.6);}
.modal-content{border-radius:22px;box-shadow:0 26px 60px rgba(15,23,42,0.7);}
@media (max-width:900px){body{padding:18px 10px 26px;}
h1{font-size:2.1rem;}
.card,.stats-section{padding:22px 18px 20px;}
.nav-tabs{border-radius:18px;flex-wrap:nowrap;overflow-x:auto;scrollbar-width:thin;}
}
.card-header{display:flex;align-items:center;gap:12px;}
.card-header .card-title{flex:1;}
.card-icon{display:inline-flex;align-items:center;justify-content:center;width:44px;height:44px;border-radius:999px;margin-right:4px;font-size:1.6rem;background:radial-gradient(circle at 0% 0%,rgba(248,250,252,0.9),transparent 55%),linear-gradient(135deg,#0ea5e9 0%,#6366f1 40%,#ec4899 100%);color:#0b1120;box-shadow:0 10px 25px rgba(15,23,42,0.35),0 0 0 1px rgba(15,23,42,0.55);}
.card-icon::after{content:"";position:absolute;inset:0;border-radius:inherit;background:radial-gradient(circle at 30% 0%,rgba(255,255,255,0.8),transparent 55%);opacity:0.5;pointer-events:none;}
.card-icon{position:relative;overflow:hidden;}
.platform-airbnb{color:var(--airbnb);font-weight:600;font-size:0.9em;}
.platform-abritel{color:var(--abritel);font-weight:600;font-size:0.9em;}
.platform-gites{color:var(--gites);font-weight:600;font-size:0.9em;}
.badge-platform{display:inline-flex;align-items:center;gap:6px;padding-inline:10px;padding-block:4px;border-radius:999px;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.08em;background:radial-gradient(circle at 0% 0%,rgba(248,250,252,0.9),transparent 55%),linear-gradient(135deg,#0ea5e9 0%,#22c55e 60%,#facc15 100%);color:#0b1120;box-shadow:0 8px 20px rgba(15,23,42,0.35);border:1px solid rgba(15,23,42,0.4);}
.badge-platform::before{content:"";width:8px;height:8px;border-radius:999px;background:rgba(34,197,94,1);box-shadow:0 0 0 4px rgba(34,197,94,0.35);}
</style>
</head>
<body>
    <div class="container">
        <header style="position: relative;">
            <!-- Menu Actions en haut √† droite -->
            <div style="position: absolute; top: 0; right: 0;">
                <select onchange="handleQuickAction(this.value); this.value='';" style="padding: 12px 16px; border-radius: 10px; background: rgba(255,255,255,0.25); color: white; border: 2px solid rgba(255,255,255,0.4); font-weight: 600; cursor: pointer; font-size: 0.95rem; font-family: 'Work Sans', sans-serif; backdrop-filter: blur(10px); box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <option value="" style="background: #1f2937; color: white;">‚öôÔ∏è Actions</option>
                    <option value="import" style="background: #1f2937; color: white;">üìÇ Importer donn√©es</option>
                    <option value="backup" style="background: #1f2937; color: white;">üíæ Sauvegarder</option>
                    <option value="archives" style="background: #1f2937; color: white;">üì¶ Archives</option>
                    <option value="ical" style="background: #1f2937; color: white;">‚öôÔ∏è Config iCal</option>
                </select>
            </div>
            
            <!-- Input file cach√© pour import rapide -->
            <input type="file" id="importFileQuick" accept=".json" style="display: none;" onchange="importAllData(event)">
            
            <h1>üèòÔ∏è Gestion G√Ætes PRO</h1>
            <p class="subtitle">Tr√©voux & Couzon - Synchronisation iCal automatique</p>
        </header>
        
        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('reservations')">üìù R√©servations</button>
            <button class="nav-tab" onclick="switchTab('statistiques')">üìä Statistiques</button>
            <button class="nav-tab" onclick="switchTab('charges')">üí∂ Charges & Rentabilit√©</button>
            <button class="nav-tab" onclick="switchTab('menage')">üßπ Planning M√©nage</button>
            <button class="nav-tab" onclick="switchTab('infos-gites')">üìù Infos Pratiques</button>
            <button class="nav-tab" onclick="switchTab('decouvrir')">üó∫Ô∏è √Ä D√©couvrir</button>
        </div>
        
        <!-- ONGLET GESTION iCAL -->
        <div id="tab-gestion" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">‚öôÔ∏è</span>
                    <h2 class="card-title">Gestion URLs iCal</h2>
                </div>
                
                <div class="alert alert-info">
                    <strong>üîÑ Synchronisation automatique</strong><br>
                    Les calendriers sont synchronis√©s automatiquement √† l'ouverture de la page.
                </div>
                
                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Limitation RGPD</strong><br>
                    Les fichiers iCal publics ne contiennent PAS les noms des clients. Les r√©servations seront import√©es avec "R√©servation [Plateforme]".
                </div>
                
                <h3 style="margin: 30px 0 15px; color: var(--trevoux);">üè∞ Tr√©voux</h3>
                <div class="form-group">
                    <label>Airbnb iCal URL</label>
                    <textarea id="icalAirbnbTrevoux" rows="2" style="font-size:0.85rem"></textarea>
                </div>
                <div class="form-group">
                    <label>Abritel iCal URL</label>
                    <textarea id="icalAbritelTrevoux" rows="2" style="font-size:0.85rem"></textarea>
                </div>
                <div class="form-group">
                    <label>G√Ætes de France iCal URL</label>
                    <textarea id="icalGitesTrevoux" rows="2" style="font-size:0.85rem"></textarea>
                </div>
                
                <h3 style="margin: 30px 0 15px; color: var(--couzon);">‚õ∞Ô∏è Couzon</h3>
                <div class="form-group">
                    <label>Airbnb iCal URL</label>
                    <textarea id="icalAirbnbCouzon" rows="2" style="font-size:0.85rem"></textarea>
                </div>
                <div class="form-group">
                    <label>Abritel iCal URL</label>
                    <textarea id="icalAbritelCouzon" rows="2" style="font-size:0.85rem"></textarea>
                </div>
                <div class="form-group">
                    <label>G√Ætes de France iCal URL</label>
                    <textarea id="icalGitesCouzon" rows="2" style="font-size:0.85rem"></textarea>
                </div>
                
                <button class="btn btn-primary" onclick="sauvegarderUrlsIcal()">
                    <span>üíæ</span> Sauvegarder les URLs
                </button>
                
                <button class="btn btn-sync" onclick="syncAllCalendars()" style="margin-top:10px">
                    <span>üîÑ</span> Synchroniser maintenant
                </button>
                
                <div id="syncProgress" class="sync-progress" style="display:none;margin-top:20px">
                    <strong>Synchronisation en cours...</strong>
                    <div id="syncMessages"></div>
                </div>
            </div>
        </div>
        
        <!-- ONGLET R√âSERVATIONS -->
        <div id="tab-reservations" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">üìÖ</span>
                    <h2 class="card-title">Planning des r√©servations</h2>
                    <div style="margin-left: auto; display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="searchReservations" placeholder="üîç Rechercher..." style="padding: 10px 15px; border-radius: 8px; border: 2px solid var(--border); width: 250px; font-size: 0.9rem; font-family: 'Work Sans', sans-serif;" oninput="filterReservations(this.value)">
                    </div>
                </div>
                
                <!-- Statut synchronisation -->
                <div id="syncStatus" style="padding:12px;background:#e7f3ff;border-radius:8px;margin-bottom:20px;font-size:0.9rem;display:none">
                    <span id="syncStatusIcon">üîÑ</span> <span id="syncStatusText">Synchronisation en cours...</span>
                </div>
                
                <div id="planning-container" class="planning-container">
                    <!-- Le planning sera g√©n√©r√© ici par JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- ONGLET ARCHIVES -->
        <div id="tab-archives" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">üì¶</span>
                    <h2 class="card-title">Archives</h2>
                </div>
                <div id="archivesSection">
                    <p style="text-align: center; color: #999; padding: 40px;">Aucune archive</p>
                </div>
            </div>
        </div>
        
        <!-- ONGLET STATISTIQUES -->
        <div id="tab-statistiques" class="tab-content">
            <div class="stats-section">
                <div class="card-header">
                    <span class="card-icon">üìä</span>
                    <h2 class="card-title">Statistiques</h2>
                    <div style="margin-left: auto; display: flex; gap: 10px; align-items: center;">
                        <label for="yearFilterStats" style="font-weight: 600; color: var(--primary); font-size: 0.9rem;">üìÖ Ann√©e :</label>
                        <select id="yearFilterStats" onchange="filterStatsByYear()" 
                            style="width: 110px; padding: 8px; border: 2px solid var(--border); border-radius: 8px; font-size: 0.9rem; text-align: center; font-weight: 600; cursor: pointer; background: white;">
                            <option value="">Chargement...</option>
                        </select>
                        <button class="btn btn-secondary" onclick="toggleHistoricalDataForm()" style="padding: 8px 16px; font-size: 0.9rem; width: auto; margin-top: 0;">
                            üìÖ G√©rer les donn√©es
                        </button>
                    </div>
                </div>
                
                <!-- üìä Compteurs par plateforme -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px;">
                    <div style="background: linear-gradient(135deg, #FF5A5F 0%, #FF385C 100%); padding: 20px; border-radius: 12px; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                        <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 8px;">Airbnb</div>
                        <div id="countAirbnb" style="font-size: 2rem; font-weight: 700;">-</div>
                        <div style="font-size: 0.875rem; opacity: 0.8;">r√©servations</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #3498DB 0%, #2874A6 100%); padding: 20px; border-radius: 12px; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                        <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 8px;">Abritel</div>
                        <div id="countAbritel" style="font-size: 2rem; font-weight: 700;">-</div>
                        <div style="font-size: 0.875rem; opacity: 0.8;">r√©servations</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #27AE60 0%, #229954 100%); padding: 20px; border-radius: 12px; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                        <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 8px;">G√Ætes de France</div>
                        <div id="countGites" style="font-size: 2rem; font-weight: 700;">-</div>
                        <div style="font-size: 0.875rem; opacity: 0.8;">r√©servations</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #9B59B6 0%, #8E44AD 100%); padding: 20px; border-radius: 12px; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                        <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 8px;">Autres</div>
                        <div id="countAutres" style="font-size: 2rem; font-weight: 700;">-</div>
                        <div style="font-size: 0.875rem; opacity: 0.8;">r√©servations</div>
                    </div>
                </div>
                
                <!-- üìà NOUVELLES STATISTIQUES UTILES -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 32px;">
                    <!-- Taux d'occupation Tr√©voux -->
                    <div class="card" style="padding: 20px; background: linear-gradient(135deg, rgba(102,126,234,0.1) 0%, rgba(102,126,234,0.05) 100%);">
                        <div style="font-size: 0.875rem; color: #666; margin-bottom: 8px;">üìä Taux Tr√©voux</div>
                        <div id="tauxTrevoux" style="font-size: 2rem; font-weight: 700; color: #667eea;">-%</div>
                        <div style="font-size: 0.75rem; color: #999; margin-top: 4px;">ann√©e en cours</div>
                    </div>
                    
                    <!-- Taux d'occupation Couzon -->
                    <div class="card" style="padding: 20px; background: linear-gradient(135deg, rgba(245,87,108,0.1) 0%, rgba(245,87,108,0.05) 100%);">
                        <div style="font-size: 0.875rem; color: #666; margin-bottom: 8px;">üìä Taux Couzon</div>
                        <div id="tauxCouzon" style="font-size: 2rem; font-weight: 700; color: #f5576c;">-%</div>
                        <div style="font-size: 0.75rem; color: #999; margin-top: 4px;">ann√©e en cours</div>
                    </div>
                    
                    <!-- Prix moyen nuit√©e -->
                    <div class="card" style="padding: 20px;">
                        <div style="font-size: 0.875rem; color: #666; margin-bottom: 8px;">üí∞ Prix moyen/nuit</div>
                        <div id="prixMoyen" style="font-size: 2rem; font-weight: 700; color: #27AE60;">- ‚Ç¨</div>
                        <div style="font-size: 0.75rem; color: #999; margin-top: 4px;">toutes r√©servations</div>
                    </div>
                    
                    <!-- Dur√©e moyenne s√©jour -->
                    <div class="card" style="padding: 20px;">
                        <div style="font-size: 0.875rem; color: #666; margin-bottom: 8px;">üìÖ Dur√©e moyenne</div>
                        <div id="dureeMoyenne" style="font-size: 2rem; font-weight: 700; color: #3498DB;">- nuits</div>
                        <div style="font-size: 0.75rem; color: #999; margin-top: 4px;">par s√©jour</div>
                    </div>
                    
                    <!-- Meilleur mois -->
                    <div class="card" style="padding: 20px;">
                        <div style="font-size: 0.875rem; color: #666; margin-bottom: 8px;">üèÜ Meilleur mois</div>
                        <div id="meilleurMois" style="font-size: 1.3rem; font-weight: 700; color: var(--primary);">-</div>
                        <div id="meilleurMoisCA" style="font-size: 0.875rem; color: #27AE60; margin-top: 4px; font-weight: 600;">- ‚Ç¨</div>
                    </div>
                </div>
                
                
                <!-- Formulaire cach√© des donn√©es historiques -->
                <div id="historicalDataForm" style="display: none; margin-bottom: 30px;">
                    <div class="card" style="background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);">
                        <div style="margin-bottom: 20px;">
                            <h3 style="margin: 0 0 15px 0; color: var(--primary);">üìÖ Donn√©es Historiques (Ann√©es Pr√©c√©dentes)</h3>
                            <div class="alert alert-info" style="margin-bottom: 20px;">
                                <strong>‚ÑπÔ∏è Info :</strong> Saisissez les chiffres d'affaires des ann√©es pr√©c√©dentes pour comparer avec l'ann√©e en cours dans les graphiques.
                            </div>
                            
                            <!-- Champ ann√©e pour la saisie -->
                            <div style="margin-bottom: 20px;">
                                <label style="font-weight: 600; display: block; margin-bottom: 10px;">Ann√©e √† saisir <span style="color: red;">*</span></label>
                                <input type="number" id="historicalYear" placeholder="Ex: 2024" min="2000" max="2050" 
                                    style="width: 150px; padding: 10px; border: 2px solid var(--border); border-radius: 8px; font-weight: 600;">
                                <small style="color: #666; font-size: 0.85rem; margin-left: 10px;">Ann√©e pour laquelle saisir les donn√©es</small>
                            </div>
                        </div>
                        
                        <!-- Tableau Total uniquement -->
                        <div style="overflow-x: auto; margin-bottom: 20px;">
                            <table style="width: 100%; border-collapse: collapse; background: white;">
                                <thead>
                                    <tr style="background: linear-gradient(135deg, var(--primary) 0%, #667eea 100%); color: white;">
                                        <th style="padding: 12px; text-align: left; border: 1px solid #ddd; width: 30%;">Mois</th>
                                        <th style="padding: 12px; text-align: center; border: 1px solid #ddd;">üí∞ Total CA (‚Ç¨)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #ddd; font-weight: 600;">Janvier</td>
                                        <td style="padding: 10px; border: 1px solid #ddd;">
                                            <input type="number" id="hist_total_jan" placeholder="0" step="0.01" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; text-align: right; background: #fff9e6;">
                                        </td>
                                    </tr>
                                    <tr style="background: #f8f9fa;">
                                        <td style="padding: 10px; border: 1px solid #ddd; font-weight: 600;">F√©vrier</td>
                                        <td style="padding: 10px; border: 1px solid #ddd;">
                                            <input type="number" id="hist_total_feb" placeholder="0" step="0.01" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; text-align: right; background: #fff9e6;">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #ddd; font-weight: 600;">Mars</td>
                                        <td style="padding: 10px; border: 1px solid #ddd;">
                                            <input type="number" id="hist_total_mar" placeholder="0" step="0.01" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; text-align: right; background: #fff9e6;">
                                        </td>
                                    </tr>
                                    <tr style="background: #f8f9fa;">
                                        <td style="padding: 10px; border: 1px solid #ddd; font-weight: 600;">Avril</td>
                                        <td style="padding: 10px; border: 1px solid #ddd;">
                                            <input type="number" id="hist_total_apr" placeholder="0" step="0.01" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; text-align: right; background: #fff9e6;">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #ddd; font-weight: 600;">Mai</td>
                                        <td style="padding: 10px; border: 1px solid #ddd;">
                                            <input type="number" id="hist_total_may" placeholder="0" step="0.01" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; text-align: right; background: #fff9e6;">
                                        </td>
                                    </tr>
                                    <tr style="background: #f8f9fa;">
                                        <td style="padding: 10px; border: 1px solid #ddd; font-weight: 600;">Juin</td>
                                        <td style="padding: 10px; border: 1px solid #ddd;">
                                            <input type="number" id="hist_total_jun" placeholder="0" step="0.01" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; text-align: right; background: #fff9e6;">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #ddd; font-weight: 600;">Juillet</td>
                                        <td style="padding: 10px; border: 1px solid #ddd;">
                                            <input type="number" id="hist_total_jul" placeholder="0" step="0.01" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; text-align: right; background: #fff9e6;">
                                        </td>
                                    </tr>
                                    <tr style="background: #f8f9fa;">
                                        <td style="padding: 10px; border: 1px solid #ddd; font-weight: 600;">Ao√ªt</td>
                                        <td style="padding: 10px; border: 1px solid #ddd;">
                                            <input type="number" id="hist_total_aug" placeholder="0" step="0.01" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; text-align: right; background: #fff9e6;">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #ddd; font-weight: 600;">Septembre</td>
                                        <td style="padding: 10px; border: 1px solid #ddd;">
                                            <input type="number" id="hist_total_sep" placeholder="0" step="0.01" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; text-align: right; background: #fff9e6;">
                                        </td>
                                    </tr>
                                    <tr style="background: #f8f9fa;">
                                        <td style="padding: 10px; border: 1px solid #ddd; font-weight: 600;">Octobre</td>
                                        <td style="padding: 10px; border: 1px solid #ddd;">
                                            <input type="number" id="hist_total_oct" placeholder="0" step="0.01" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; text-align: right; background: #fff9e6;">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #ddd; font-weight: 600;">Novembre</td>
                                        <td style="padding: 10px; border: 1px solid #ddd;">
                                            <input type="number" id="hist_total_nov" placeholder="0" step="0.01" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; text-align: right; background: #fff9e6;">
                                        </td>
                                    </tr>
                                    <tr style="background: #f8f9fa;">
                                        <td style="padding: 10px; border: 1px solid #ddd; font-weight: 600;">D√©cembre</td>
                                        <td style="padding: 10px; border: 1px solid #ddd;">
                                            <input type="number" id="hist_total_dec" placeholder="0" step="0.01" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; text-align: right; background: #fff9e6;">
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button type="button" class="btn btn-success" onclick="saveHistoricalDataTotal()">
                                üíæ Sauvegarder
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="loadHistoricalDataTotal()">
                                üìÇ Charger donn√©es existantes
                            </button>
                            <button type="button" class="btn btn-danger" onclick="deleteHistoricalDataTotal()">
                                üóëÔ∏è Supprimer ann√©e
                            </button>
                        </div>
                        
                        <div id="historicalDataList" style="margin-top: 30px;">
                            <h4 style="color: var(--primary); margin-bottom: 15px;">üìã Ann√©es enregistr√©es</h4>
                            <div id="historicalYearsList"></div>
                        </div>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="statTotal">0</div>
                        <div class="stat-label">R√©servations totales</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statTrevoux">0</div>
                        <div class="stat-label">Tr√©voux</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statCouzon">0</div>
                        <div class="stat-label">Couzon</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statCA">0 ‚Ç¨</div>
                        <div class="stat-label">CA Total</div>
                    </div>
                </div>
                
                <!-- Section s√©lection ann√©es pour comparaison -->
                <div class="card" style="margin: 30px 0; padding: 20px; background: #f8f9fa;">
                    <h4 style="color: var(--primary); margin-bottom: 15px;">üìä Comparer les ann√©es</h4>
                    <div id="yearComparisonCheckboxes" style="display: flex; flex-wrap: wrap; gap: 15px;">
                        <!-- Les checkboxes seront g√©n√©r√©es dynamiquement -->
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="caChart"></canvas>
                </div>
                
                <div class="chart-container" style="margin-top: 50px;">
                    <canvas id="gitesChart"></canvas>
                </div>
                
                <div class="chart-container" style="margin-top: 50px;">
                    <canvas id="platformsChart"></canvas>
                </div>
                
                <!-- Nouveau graphique CA vs Charges -->
                <div class="chart-container" style="margin-top: 50px;">
                    <canvas id="profitChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- ONGLET CHARGES & RENTABILIT√â -->
        <div id="tab-charges" class="tab-content">
            <div class="main-grid">
                <!-- Formulaire charges -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-icon">üí∂</span>
                        <h2 class="card-title">Ajouter une Charge</h2>
                    </div>
                    
                    <form id="chargeForm">
                        <div class="form-group">
                            <label>G√Æte concern√© <span class="required">*</span></label>
                            <select id="chargeGite">
                                <option value="">-- S√©lectionnez --</option>
                                <option value="Tr√©voux">Tr√©voux</option>
                                <option value="Couzon">Couzon</option>
                                <option value="Commun">Commun (les deux)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Nom de la charge <span class="required">*</span></label>
                            <input type="text" id="chargeNom" placeholder="Ex: √âlectricit√©, M√©nage, Assurance">
                        </div>
                        
                        <div class="form-group">
                            <label>Montant (‚Ç¨) <span class="required">*</span></label>
                            <input type="number" id="chargeMontant" step="0.01" placeholder="150.00">
                        </div>
                        
                        <div class="form-group">
                            <label>Type <span class="required">*</span></label>
                            <select id="chargeType">
                                <option value="mensuelle">Mensuelle</option>
                                <option value="annuelle">Annuelle</option>
                                <option value="ponctuelle">Ponctuelle</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" id="chargeDate">
                        </div>
                        
                        <div class="form-group">
                            <label>Notes</label>
                            <textarea id="chargeNotes" placeholder="Informations compl√©mentaires..."></textarea>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">
                            <span>‚ûï</span> Ajouter la charge
                        </button>
                    </form>
                </div>
                
                <!-- Liste charges et rentabilit√© -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-icon">üìä</span>
                        <h2 class="card-title">Rentabilit√© & URSSAF</h2>
                    </div>
                    
                    <div class="alert alert-info">
                        <strong>üí° Calcul URSSAF :</strong> En tant que LMP, vous devez provisionner environ 22% de vos recettes pour l'URSSAF (cotisations sociales).
                    </div>
                    
                    <div class="stats-grid" style="margin-bottom: 20px;">
                        <div class="stat-item" style="background: linear-gradient(135deg, var(--success) 0%, #229954 100%);">
                            <div class="stat-value" id="totalRecettes">0 ‚Ç¨</div>
                            <div class="stat-label">Recettes totales</div>
                        </div>
                        <div class="stat-item" style="background: linear-gradient(135deg, var(--danger) 0%, #C0392B 100%);">
                            <div class="stat-value" id="totalCharges">0 ‚Ç¨</div>
                            <div class="stat-label">Charges totales</div>
                        </div>
                        <div class="stat-item" style="background: linear-gradient(135deg, var(--warning) 0%, #E67E22 100%);">
                            <div class="stat-value" id="provisionUrssaf">0 ‚Ç¨</div>
                            <div class="stat-label">√Ä provisionner URSSAF (22%)</div>
                        </div>
                        <div class="stat-item" style="background: linear-gradient(135deg, #3498DB 0%, #2874A6 100%);">
                            <div class="stat-value" id="resultatNet">0 ‚Ç¨</div>
                            <div class="stat-label">R√©sultat net estim√©</div>
                        </div>
                    </div>
                    
                    <div class="card-header" style="margin-top: 30px;">
                        <span class="card-icon">üìã</span>
                        <h3 class="card-title" style="font-size: 1.3rem;">Liste des Charges</h3>
                    </div>
                    
                    <div class="charges-list" id="chargesList">
                        <p style="text-align: center; color: #999; padding: 20px;">Aucune charge enregistr√©e</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ONGLET PLANNING M√âNAGE -->
        <div id="tab-menage" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <span class="card-icon">üßπ</span>
                    <h2 class="card-title">Planning des M√©nages</h2>
                </div>
                
                <div class="alert alert-warning">
                    <strong>üìã R√®gles de planning automatique :</strong><br>
                    ‚Ä¢ <strong>Semaine (Lun-Ven) et Samedi</strong> : M√©nage apr√®s-midi (12h00)<br>
                    ‚Ä¢ <strong>Dimanche</strong> : AUCUN m√©nage, sauf enchainement m√™me jour ‚Üí 13h00<br>
                    ‚Ä¢ <strong>Jours f√©ri√©s</strong> : M√©nage report√© au jour ouvr√© suivant (sauf enchainement)<br>
                    ‚Ä¢ <strong>Enchainement</strong> : Si d√©part matin + arriv√©e m√™me jour avec m√©nage veille non fait ‚Üí reporter au lendemain<br>
                    ‚Ä¢ <strong>Arriv√©e le jour du d√©part</strong> : M√©nage le matin (07h00) si besoin avant l'arriv√©e
                </div>
                
                <button class="btn btn-menage" onclick="genererPlanningMenage()">
                    <span>üßπ</span> G√©n√©rer Planning M√©nage (Mois en cours + Prochain)
                </button>

                <div style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 12px; align-items: center;">
                    <label for="menageExportMonth" style="font-size: 0.9rem;">Mois √† exporter (m√©nages) :</label>
                    <input type="month" id="menageExportMonth" style="padding: 8px 10px; border-radius: 10px; border: 1px solid var(--border); min-width: 180px;">
                    <button class="btn btn-secondary" type="button" onclick="exportPlanningMenageMois()">
                        <span>üìä</span> T√©l√©charger Excel m√©nages (mois s√©lectionn√©)
                    </button>
                </div>
                
                <div id="menagePlanning" style="margin-top: 30px;">
                </div>
            </div>
        </div>
        
        <!-- ONGLET INFOS PRATIQUES ULTRA-COMPLET -->
        <div id="tab-infos-gites" class="tab-content">
            
            <!-- S√âLECTEUR DE G√éTE -->
            <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <div class="card-header" style="border-bottom: 2px solid rgba(255,255,255,0.3);">
                    <span class="card-icon">üìã</span>
                    <h2 class="card-title">Infos Pratiques - Guide Client Ultra-Complet</h2>
                </div>
                <div style="padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; margin-bottom: 20px;">
                        <p style="font-size: 1.1rem; opacity: 0.95;">Remplissez toutes les informations pour cr√©er le guide client parfait ‚Ä¢ Bilingue FR/EN</p>
                        <div style="display: flex; gap: 15px;">
                            <button class="btn" onclick="selectGiteInfos('Tr√©voux')" id="btnTrevoux" style="background: white; color: #667eea; font-weight: 700; padding: 12px 30px;">
                                üè° Tr√©voux
                            </button>
                            <button class="btn" onclick="selectGiteInfos('Couzon')" id="btnCouzon" style="background: rgba(255,255,255,0.2); color: white; font-weight: 700; padding: 12px 30px;">
                                ‚õ∞Ô∏è Couzon
                            </button>
                        </div>
                    </div>
                    
                    <!-- Boutons Export/Import -->
                    <div style="display: flex; gap: 10px; justify-content: flex-end; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.3);">
                        <button onclick="exporterInfosGites()" class="btn" style="background: rgba(255,255,255,0.2); color: white; padding: 10px 20px; display: flex; align-items: center; gap: 8px;">
                            <span>üì§</span> Exporter (Backup)
                        </button>
                        <button onclick="importerInfosGites()" class="btn" style="background: rgba(255,255,255,0.2); color: white; padding: 10px 20px; display: flex; align-items: center; gap: 8px;">
                            <span>üì•</span> Importer
                        </button>
                    </div>
                </div>
            </div>

            <!-- BARRE DE PROGRESSION -->
            <div class="card">
                <div style="padding: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong style="color: var(--primary);">Progression du formulaire</strong>
                        <span id="progressText" style="color: var(--gray);">0%</span>
                    </div>
                    <div style="background: var(--border); height: 10px; border-radius: 5px; overflow: hidden;">
                        <div id="progressBarInfos" style="width: 0%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s;"></div>
                    </div>
                </div>
            </div>

            <!-- ALERTE INFO -->
            <div class="alert alert-info">
                <strong>üí° Guide complet :</strong> Remplissez un maximum d'informations pour offrir la meilleure exp√©rience client. Les champs marqu√©s d'une <span style="color: #ef4444; font-weight: 700;">*</span> sont obligatoires.
            </div>

            <form id="infosGiteForm" onsubmit="sauvegarderInfosGiteComplet(event)">

                <!-- ==================== SECTION 1 : INFORMATIONS DE BASE ==================== -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-icon">üìç</span>
                        <h2 class="card-title">Informations de Base</h2>
                    </div>

                    <div style="display: grid; gap: 20px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Adresse compl√®te <span style="color: #ef4444;">*</span></label>
                                <input type="text" id="infos_adresse" class="form-control" placeholder="12 rue de la R√©publique, 01600 Tr√©voux">
                                <small style="color: var(--gray); font-style: italic;">Adresse exacte avec code postal pour GPS</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">T√©l√©phone urgence <span style="color: #ef4444;">*</span></label>
                                <input type="tel" id="infos_telephone" class="form-control" placeholder="06 12 34 56 78">
                                <small style="color: var(--gray); font-style: italic;">Joignable 24h/24 pendant le s√©jour</small>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Coordonn√©es GPS - Latitude</label>
                                <input type="text" id="infos_gpsLat" class="form-control" placeholder="45.9423">
                                <small style="color: var(--gray); font-style: italic;">Format d√©cimal, ex: 45.9423</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Coordonn√©es GPS - Longitude</label>
                                <input type="text" id="infos_gpsLon" class="form-control" placeholder="4.7681">
                                <small style="color: var(--gray); font-style: italic;">Format d√©cimal, ex: 4.7681</small>
                            </div>
                        </div>

                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Email contact <span style="color: #ef4444;">*</span></label>
                            <input type="email" id="infos_email" class="form-control" placeholder="contact@gite-trevoux.fr">
                        </div>
                    </div>
                </div>

                <!-- ==================== SECTION 2 : WIFI ==================== -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-icon">üì∂</span>
                        <h2 class="card-title">WiFi & Connectivit√©</h2>
                    </div>

                    <div style="display: grid; gap: 20px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Nom du r√©seau WiFi (SSID) <span style="color: #ef4444;">*</span></label>
                                <input type="text" id="infos_wifiSSID" class="form-control" required placeholder="Gite_Trevoux_5G" oninput="updateQRCodeWifi()">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Mot de passe WiFi <span style="color: #ef4444;">*</span></label>
                                <input type="text" id="infos_wifiPassword" class="form-control" required placeholder="MonMotDePasse2024" oninput="updateQRCodeWifi()">
                            </div>
                        </div>

                        <!-- QR CODE WIFI -->
                        <div id="qrCodeWifiSection" style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); padding: 20px; border-radius: 12px; border: 2px solid #4caf50; display: none;">
                            <div style="display: flex; gap: 20px; align-items: center;">
                                <div style="flex: 0 0 auto;">
                                    <canvas id="qrCodeWifiCanvas" width="200" height="200" style="background: white; border-radius: 8px; padding: 10px;"></canvas>
                                </div>
                                <div style="flex: 1;">
                                    <h3 style="color: #2e7d32; margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                                        <span style="font-size: 1.5rem;">üì±</span>
                                        QR Code WiFi G√©n√©r√© !
                                    </h3>
                                    <p style="color: #555; margin-bottom: 15px;">
                                        Tes clients peuvent scanner ce QR code avec leur smartphone pour se connecter automatiquement au WiFi, sans avoir √† taper le mot de passe !
                                    </p>
                                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                        <button type="button" onclick="telechargerQRCodeWifi()" class="btn" style="background: #4caf50; color: white; padding: 10px 20px; display: flex; align-items: center; gap: 8px;">
                                            <span>‚¨áÔ∏è</span> T√©l√©charger QR Code
                                        </button>
                                        <button type="button" onclick="imprimerQRCodeWifi()" class="btn" style="background: #2196f3; color: white; padding: 10px 20px; display: flex; align-items: center; gap: 8px;">
                                            <span>üñ®Ô∏è</span> Imprimer
                                        </button>
                                    </div>
                                    <p style="margin-top: 15px; font-size: 0.9rem; color: #666;">
                                        üí° <strong>Astuce :</strong> Imprime ce QR code et affiche-le dans le logement (sur le frigo, √† l'entr√©e, etc.)
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">D√©bit approximatif</label>
                                <select id="infos_wifiDebit" class="form-control">
                                    <option value="">-- S√©lectionner --</option>
                                    <option value="< 10 Mbps">Faible (< 10 Mbps)</option>
                                    <option value="10-50 Mbps">Moyen (10-50 Mbps)</option>
                                    <option value="50-100 Mbps">Bon (50-100 Mbps)</option>
                                    <option value="100-500 Mbps">Excellent (100-500 Mbps)</option>
                                    <option value="> 500 Mbps">Tr√®s excellent (> 500 Mbps)</option>
                                    <option value="> 750 Mbps">Ultra rapide (> 750 Mbps)</option>
                                </select>
                                <small style="color: var(--gray); font-style: italic;">Pour rassurer les t√©l√©travailleurs</small>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Localisation de la box/routeur</label>
                                <input type="text" id="infos_wifiLocalisation" class="form-control" placeholder="Placard de l'entr√©e">
                                <small style="color: var(--gray); font-style: italic;">En cas de probl√®me</small>
                            </div>
                        </div>

                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Zones de meilleure r√©ception</label>
                            <textarea id="infos_wifiZones" class="form-control" rows="3" placeholder="Excellent dans le salon et la cuisine. Signal plus faible dans la chambre du fond."></textarea>
                        </div>
                    </div>
                </div>

                <!-- ==================== SECTION 3 : ARRIV√âE ==================== -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-icon">üîë</span>
                        <h2 class="card-title">Consignes d'Arriv√©e</h2>
                    </div>

                    <div style="display: grid; gap: 25px;">
                        <!-- Horaires -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px;">
                            <h3 style="color: var(--primary); margin-bottom: 15px; font-size: 1.2rem;">‚è∞ Horaires</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Heure d'arriv√©e <span style="color: #ef4444;">*</span></label>
                                    <input type="text" id="infos_heureArrivee" class="form-control" placeholder="√Ä partir de 15h00">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Arriv√©e tardive possible ?</label>
                                    <select id="infos_arriveeTardive" class="form-control">
                                        <option value="">-- S√©lectionner --</option>
                                        <option value="Oui, sans suppl√©ment">Oui, sans suppl√©ment</option>
                                        <option value="Oui, avec suppl√©ment">Oui, avec suppl√©ment</option>
                                        <option value="Non">Non</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Parking -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px;">
                            <h3 style="color: var(--primary); margin-bottom: 15px; font-size: 1.2rem;">üöó Parking</h3>
                            <div style="display: grid; gap: 15px;">
                                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Parking disponible ? <span style="color: #ef4444;">*</span></label>
                                        <select id="infos_parkingDispo" class="form-control" onchange="toggleParkingInfos()">
                                            <option value="">-- S√©lectionner --</option>
                                            <option value="Oui, gratuit sur place">Oui, gratuit sur place</option>
                                            <option value="Oui, payant sur place">Oui, payant sur place</option>
                                            <option value="Parking public √† proximit√©">Parking public √† proximit√©</option>
                                            <option value="Rue uniquement">Stationnement rue uniquement</option>
                                            <option value="Non">Non</option>
                                        </select>
                                    </div>
                                    <div id="parkingPlacesDiv" style="display: none;">
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Nombre de places</label>
                                        <input type="number" id="infos_parkingPlaces" class="form-control" min="0" placeholder="1">
                                    </div>
                                </div>
                                <div id="parkingDetailsDiv" style="display: none;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Instructions parking d√©taill√©es</label>
                                    <textarea id="infos_parkingDetails" class="form-control" rows="4" placeholder="Entrez par le portail bleu, le parking est sur votre droite. Code digicode: 1234."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Acc√®s aux cl√©s -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px;">
                            <h3 style="color: var(--primary); margin-bottom: 15px; font-size: 1.2rem;">üîë Acc√®s aux Cl√©s</h3>
                            <div style="display: grid; gap: 15px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Type d'acc√®s <span style="color: #ef4444;">*</span></label>
                                        <select id="infos_typeAcces" class="form-control">
                                            <option value="">-- S√©lectionner --</option>
                                            <option value="Bo√Æte √† cl√©s">Bo√Æte √† cl√©s s√©curis√©e</option>
                                            <option value="Remise en main propre">Remise en main propre</option>
                                            <option value="Code porte">Code porte √©lectronique</option>
                                            <option value="Chez voisin">Chez le voisin</option>
                                            <option value="Autre">Autre</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Code d'acc√®s / Emplacement <span style="color: #ef4444;">*</span></label>
                                        <input type="text" id="infos_codeAcces" class="form-control" placeholder="Code 1234 - Bo√Æte devant la porte">
                                    </div>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Instructions d√©taill√©es pour r√©cup√©rer les cl√©s <span style="color: #ef4444;">*</span></label>
                                    <textarea id="infos_instructionsCles" class="form-control" rows="6" placeholder="1. Garez-vous sur le parking
2. La bo√Æte √† cl√©s est sur le mur √† droite
3. Composez le code 1234..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Acc√®s au logement -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px;">
                            <h3 style="color: var(--primary); margin-bottom: 15px; font-size: 1.2rem;">üö∂ Du Parking au Logement</h3>
                            <div style="display: grid; gap: 15px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">√âtage</label>
                                        <select id="infos_etage" class="form-control">
                                            <option value="">-- S√©lectionner --</option>
                                            <option value="Rez-de-chauss√©e">Rez-de-chauss√©e</option>
                                            <option value="1er √©tage">1er √©tage</option>
                                            <option value="2√®me √©tage">2√®me √©tage</option>
                                            <option value="3√®me √©tage">3√®me √©tage</option>
                                            <option value="4√®me √©tage et +">4√®me √©tage et +</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Ascenseur disponible ?</label>
                                        <select id="infos_ascenseur" class="form-control">
                                            <option value="">-- S√©lectionner --</option>
                                            <option value="Oui">Oui</option>
                                            <option value="Non">Non</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Itin√©raire du parking √† la porte</label>
                                    <textarea id="infos_itineraireLogement" class="form-control" rows="4" placeholder="Depuis le parking, prenez l'escalier sur votre gauche..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Premi√®re visite -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px;">
                            <h3 style="color: var(--primary); margin-bottom: 15px; font-size: 1.2rem;">üè† Premi√®re Visite du Logement</h3>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Instructions pour la d√©couverte</label>
                                <textarea id="infos_premiereVisite" class="form-control" rows="6" placeholder="√Ä votre arriv√©e :
1. LUMI√àRES : Interrupteur √† droite
2. CHAUFFAGE : Thermostat dans le salon..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ==================== SECTION 4 : LE LOGEMENT ==================== -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-icon">üè†</span>
                        <h2 class="card-title">Le Logement - Guide Complet</h2>
                    </div>

                    <div style="display: grid; gap: 25px;">
                        <!-- Chauffage -->
                        <div style="background: #fff3e0; padding: 20px; border-radius: 12px;">
                            <h3 style="color: #f59e0b; margin-bottom: 15px; font-size: 1.2rem;">üî• Chauffage & Climatisation</h3>
                            <div style="display: grid; gap: 15px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Type de chauffage <span style="color: #ef4444;">*</span></label>
                                        <select id="infos_typeChauffage" class="form-control">
                                            <option value="">-- S√©lectionner --</option>
                                            <option value="√âlectrique">√âlectrique</option>
                                            <option value="Gaz">Gaz</option>
                                            <option value="Pompe √† chaleur">Pompe √† chaleur</option>
                                            <option value="Po√™le √† bois">Po√™le √† bois</option>
                                            <option value="Radiateurs √©lectriques">Radiateurs √©lectriques</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Climatisation disponible ?</label>
                                        <select id="infos_climatisation" class="form-control">
                                            <option value="">-- S√©lectionner --</option>
                                            <option value="Oui, r√©versible">Oui, climatisation r√©versible</option>
                                            <option value="Oui, clim seule">Oui, climatisation seule</option>
                                            <option value="Non, ventilateurs">Non, ventilateurs disponibles</option>
                                            <option value="Non">Non</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Instructions chauffage/climatisation <span style="color: #ef4444;">*</span></label>
                                    <textarea id="infos_instructionsChauffage" class="form-control" rows="8" placeholder="CHAUFFAGE :
- Thermostat dans le salon
- Temp√©rature recommand√©e : 19-21¬∞C..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Cuisine -->
                        <div style="background: #e8f5e9; padding: 20px; border-radius: 12px;">
                            <h3 style="color: #27AE60; margin-bottom: 15px; font-size: 1.2rem;">üç≥ Cuisine</h3>
                            <div style="display: grid; gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">√âquipements disponibles</label>
                                    <textarea id="infos_equipementsCuisine" class="form-control" rows="5" placeholder="- Four √©lectrique
- Plaques induction
- Lave-vaisselle..."></textarea>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Instructions Four</label>
                                    <textarea id="infos_instructionsFour" class="form-control" rows="4" placeholder="Four Whirlpool :
- Allumage : bouton de gauche..."></textarea>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Instructions Plaques de Cuisson</label>
                                    <textarea id="infos_instructionsPlaques" class="form-control" rows="4" placeholder="‚ö†Ô∏è INDUCTION : casseroles compatibles uniquement..."></textarea>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Instructions Lave-Vaisselle</label>
                                    <textarea id="infos_instructionsLaveVaisselle" class="form-control" rows="4" placeholder="Lave-vaisselle Siemens..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Linge -->
                        <div style="background: #e3f2fd; padding: 20px; border-radius: 12px;">
                            <h3 style="color: #2196F3; margin-bottom: 15px; font-size: 1.2rem;">üß∫ Linge & Buanderie</h3>
                            <div style="display: grid; gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Instructions Lave-Linge</label>
                                    <textarea id="infos_instructionsLaveLinge" class="form-control" rows="6" placeholder="Lave-linge Samsung :
- Lessive fournie..."></textarea>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">S√®che-linge disponible ?</label>
                                        <select id="infos_secheLinge" class="form-control">
                                            <option value="">-- S√©lectionner --</option>
                                            <option value="Oui">Oui, s√®che-linge</option>
                                            <option value="Non, √©tendoir">Non, √©tendoir</option>
                                            <option value="Non">Non</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Fer et planche √† repasser</label>
                                        <input type="text" id="infos_ferRepasser" class="form-control" placeholder="Placard de l'entr√©e">
                                    </div>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Linge de maison fourni</label>
                                    <textarea id="infos_lingeFourni" class="form-control" rows="4" placeholder="Fourni :
- Draps (lits faits)
- Serviettes (2 par personne)..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Chambres -->
                        <div style="background: #f3e5f5; padding: 20px; border-radius: 12px;">
                            <h3 style="color: #9c27b0; margin-bottom: 15px; font-size: 1.2rem;">üõèÔ∏è Chambres</h3>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Configuration des chambres</label>
                                <textarea id="infos_configurationChambres" class="form-control" rows="6" placeholder="CHAMBRE 1 : 1 lit double 160x200cm
CHAMBRE 2 : 2 lits simples..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ==================== SECTION 5 : TRI DES D√âCHETS ==================== -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-icon">üóëÔ∏è</span>
                        <h2 class="card-title">Tri des D√©chets</h2>
                    </div>

                    <div style="display: grid; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Instructions tri s√©lectif <span style="color: #ef4444;">*</span></label>
                            <textarea id="infos_instructionsTri" class="form-control" rows="8" placeholder="üü° BAC JAUNE : plastique, cartons...
üü¢ BAC VERT : ordures m√©nag√®res..."></textarea>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Jours de collecte</label>
                                <textarea id="infos_joursCollecte" class="form-control" rows="3" placeholder="Lundi et Jeudi matin..."></textarea>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">D√©ch√®terie la plus proche</label>
                                <input type="text" id="infos_decheterie" class="form-control" placeholder="123 route de Lyon, 3km">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ==================== SECTION 6 : S√âCURIT√â ==================== -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-icon">üîê</span>
                        <h2 class="card-title">S√©curit√© & Urgences</h2>
                    </div>

                    <div style="display: grid; gap: 15px;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">D√©tecteur de fum√©e</label>
                                <input type="text" id="infos_detecteurFumee" class="form-control" placeholder="Plafond du couloir">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Extincteur</label>
                                <input type="text" id="infos_extincteur" class="form-control" placeholder="Cuisine, sous l'√©vier">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Coupure d'eau</label>
                                <input type="text" id="infos_coupureEau" class="form-control" placeholder="Sous lavabo salle de bain">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Disjoncteur g√©n√©ral</label>
                                <input type="text" id="infos_disjoncteur" class="form-control" placeholder="Tableau entr√©e">
                            </div>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Consignes en cas d'urgence</label>
                            <textarea id="infos_consignesUrgence" class="form-control" rows="6" placeholder="EN CAS D'INCENDIE : 18
EN CAS DE FUITE : coupez l'eau..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- ==================== SECTION 7 : D√âPART ==================== -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-icon">üö™</span>
                        <h2 class="card-title">Consignes de D√©part</h2>
                    </div>

                    <div style="display: grid; gap: 15px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Heure de d√©part <span style="color: #ef4444;">*</span></label>
                                <input type="text" id="infos_heureDepart" class="form-control" placeholder="Avant 10h00">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">D√©part tardif possible ?</label>
                                <select id="infos_departTardif" class="form-control">
                                    <option value="">-- S√©lectionner --</option>
                                    <option value="Oui, sans suppl√©ment">Oui, sans suppl√©ment</option>
                                    <option value="Oui, avec suppl√©ment">Oui, avec suppl√©ment</option>
                                    <option value="Non">Non</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Check-list de d√©part <span style="color: #ef4444;">*</span></label>
                            <textarea id="infos_checklistDepart" class="form-control" rows="10" placeholder="‚úÖ VAISSELLE : Laver et ranger
‚úÖ POUBELLES : Descendre au local
‚úÖ LINGE : D√©poser serviettes dans SDB..."></textarea>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Restitution des cl√©s <span style="color: #ef4444;">*</span></label>
                            <textarea id="infos_restitutionCles" class="form-control" rows="4" placeholder="Remettre les cl√©s dans la bo√Æte..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- ==================== SECTION 8 : R√àGLEMENT ==================== -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-icon">üìã</span>
                        <h2 class="card-title">R√®glement Int√©rieur</h2>
                    </div>

                    <div style="display: grid; gap: 15px;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Politique tabac <span style="color: #ef4444;">*</span></label>
                                <select id="infos_tabac" class="form-control">
                                    <option value="">-- S√©lectionner --</option>
                                    <option value="Interdit partout">Interdit partout</option>
                                    <option value="Interdit int√©rieur">Interdit int√©rieur (ext√©rieur OK)</option>
                                    <option value="Autoris√© ext√©rieur">Autoris√© terrasse/balcon</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Animaux accept√©s ? <span style="color: #ef4444;">*</span></label>
                                <select id="infos_animaux" class="form-control">
                                    <option value="">-- S√©lectionner --</option>
                                    <option value="Non">Non, refus√©s</option>
                                    <option value="Oui, gratuit">Oui, sans suppl√©ment</option>
                                    <option value="Oui, payant">Oui, avec suppl√©ment</option>
                                    <option value="Sur demande">Sur demande</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Nombre max de personnes <span style="color: #ef4444;">*</span></label>
                                <input type="number" id="infos_nbMaxPersonnes" class="form-control" min="1" placeholder="6">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Montant de la caution</label>
                                <input type="text" id="infos_caution" class="form-control" placeholder="500‚Ç¨">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- BOUTON SAUVEGARDE -->
                <div class="card" style="background: linear-gradient(135deg, #10b981, #059669); color: white;">
                    <button type="submit" class="btn" style="width: 100%; padding: 20px; background: none; border: none; color: white; font-size: 1.3rem; font-weight: 700; cursor: pointer;">
                        üíæ ENREGISTRER TOUTES LES INFORMATIONS
                    </button>
                </div>

            </form>
        </div>
        
        <!-- ONGLET √Ä D√âCOUVRIR -->
        <div id="tab-decouvrir" class="tab-content">
            
            <!-- S√âLECTEUR DE G√éTE -->
            <div class="card" style="background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%); color: white;">
                <div class="card-header" style="border-bottom: 2px solid rgba(255,255,255,0.3);">
                    <span class="card-icon">üó∫Ô∏è</span>
                    <h2 class="card-title">√Ä D√©couvrir Autour des G√Ætes</h2>
                </div>
                <div style="padding: 20px;">
                    <p style="font-size: 1.1rem; opacity: 0.95; margin-bottom: 20px;">Activit√©s, restaurants, sites touristiques dans un rayon de 25km ‚Ä¢ Mise √† jour automatique des √©v√©nements</p>
                    <div style="display: flex; gap: 15px;">
                        <button class="btn" style="background: white; color: #FF6B6B; font-weight: 700; padding: 15px 40px;" onclick="selectGiteDecouvrir('Tr√©voux')">
                            üè∞ Tr√©voux
                        </button>
                        <button class="btn" style="background: white; color: #FF6B6B; font-weight: 700; padding: 15px 40px;" onclick="selectGiteDecouvrir('Couzon')">
                            ‚õ∞Ô∏è Couzon
                        </button>
                    </div>
                </div>
            </div>

            <form id="formDecouvrir" style="display: none;">
                <input type="hidden" id="decouvrir_gite">
                
                <!-- TITRE G√éTE S√âLECTIONN√â -->
                <div class="alert alert-info">
                    <strong>üìç G√Æte s√©lectionn√© :</strong> <span id="selectedGiteDecouvrir" style="font-weight: 700;"></span>
                </div>

                <!-- BOUTONS D'ACTION RAPIDE -->
                <div class="card">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <button type="button" class="btn" style="background: #10b981;" onclick="rechercherAutomatique('restaurants')">
                            üçΩÔ∏è Chercher Restaurants
                        </button>
                        <button type="button" class="btn" style="background: #3b82f6;" onclick="rechercherAutomatique('tourist_attraction')">
                            üèõÔ∏è Chercher Sites Touristiques
                        </button>
                        <button type="button" class="btn" style="background: #f59e0b;" onclick="rechercherAutomatique('shopping_mall')">
                            üõçÔ∏è Chercher Commerces
                        </button>
                        <button type="button" class="btn" style="background: #8b5cf6;" onclick="rechercherAutomatique('park')">
                            üå≥ Chercher Parcs/Nature
                        </button>
                        <button type="button" class="btn" style="background: #ef4444;" onclick="rechercherEvenements()">
                            üìÖ √âv√©nements cette semaine
                        </button>
                    </div>
                </div>

                <!-- √âV√âNEMENTS DE LA SEMAINE -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-icon">üìÖ</span>
                        <h2 class="card-title">√âv√©nements de la Semaine</h2>
                        <button type="button" class="btn btn-secondary" onclick="refreshEvenements()" style="margin-left: auto;">
                            üîÑ Actualiser
                        </button>
                    </div>
                    
                    <div class="alert alert-info">
                        <strong>üîÑ Mise √† jour automatique :</strong> Cette section se met √† jour chaque semaine avec les √©v√©nements locaux.
                    </div>
                    
                    <div id="evenementsListe" style="display: grid; gap: 15px;">
                        <p style="text-align: center; color: #999; padding: 40px;">
                            Cliquez sur "√âv√©nements cette semaine" pour charger les √©v√©nements locaux
                        </p>
                    </div>
                </div>

                <!-- LISTE DES ACTIVIT√âS PAR CAT√âGORIE -->
                <div class="card">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <span class="card-icon">üìã</span>
                            <h2 class="card-title">Activit√©s Enregistr√©es</h2>
                        </div>
                        <button type="button" onclick="toggleFormAjout()" style="background: linear-gradient(135deg, #27AE60 0%, #229954 100%); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(39,174,96,0.3); transition: all 0.3s ease;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" title="Ajouter une activit√©">
                            ‚ûï
                        </button>
                    </div>

                    <!-- FORMULAIRE D'AJOUT (CACH√â PAR D√âFAUT) -->
                    <div id="formAjoutActivite" style="display: none; margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 12px; border: 2px dashed #27AE60;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; color: #27AE60; font-size: 1.3rem;">‚ûï Ajouter une Activit√©</h3>
                            <button type="button" onclick="toggleFormAjout()" style="background: transparent; border: none; font-size: 1.5rem; cursor: pointer; color: #666;" title="Fermer">
                                ‚úñÔ∏è
                            </button>
                        </div>

                        <div style="display: grid; gap: 20px;">
                            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Nom de l'activit√© *</label>
                                    <input type="text" id="activite_nom" class="form-control" placeholder="Restaurant Le Gourmet">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Cat√©gorie *</label>
                                    <select id="activite_categorie" class="form-control">
                                        <option value="">-- S√©lectionner --</option>
                                        <option value="üçΩÔ∏è Restaurant">üçΩÔ∏è Restaurant</option>
                                        <option value="üèõÔ∏è Site Touristique">üèõÔ∏è Site Touristique</option>
                                        <option value="üõçÔ∏è Commerce">üõçÔ∏è Commerce</option>
                                        <option value="üå≥ Nature & Randonn√©e">üå≥ Nature & Randonn√©e</option>
                                        <option value="üè• Sant√© & Services">üè• Sant√© & Services</option>
                                        <option value="‚öΩ Sport & Loisirs">‚öΩ Sport & Loisirs</option>
                                        <option value="üé≠ Culture">üé≠ Culture</option>
                                        <option value="üé® Autre">üé® Autre</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Description</label>
                                <textarea id="activite_description" class="form-control" rows="3" placeholder="Excellent restaurant traditionnel fran√ßais avec terrasse..."></textarea>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Adresse compl√®te *</label>
                                    <input type="text" id="activite_adresse" class="form-control" placeholder="12 Place du March√©, 01600 Tr√©voux">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Distance (km)</label>
                                    <input type="number" id="activite_distance" class="form-control" step="0.1" placeholder="2.5">
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Site web</label>
                                    <input type="url" id="activite_website" class="form-control" placeholder="https://restaurant-exemple.fr">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">T√©l√©phone</label>
                                    <input type="tel" id="activite_telephone" class="form-control" placeholder="04 74 00 00 00">
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Note Google (0-5)</label>
                                    <input type="number" id="activite_note" class="form-control" step="0.1" min="0" max="5" placeholder="4.5">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Nombre d'avis</label>
                                    <input type="number" id="activite_avis" class="form-control" placeholder="127">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Gamme de prix</label>
                                    <select id="activite_prix" class="form-control">
                                        <option value="">-- S√©lectionner --</option>
                                        <option value="‚Ç¨">‚Ç¨ (√âconomique)</option>
                                        <option value="‚Ç¨‚Ç¨">‚Ç¨‚Ç¨ (Moyen)</option>
                                        <option value="‚Ç¨‚Ç¨‚Ç¨">‚Ç¨‚Ç¨‚Ç¨ (√âlev√©)</option>
                                        <option value="‚Ç¨‚Ç¨‚Ç¨‚Ç¨">‚Ç¨‚Ç¨‚Ç¨‚Ç¨ (Tr√®s √©lev√©)</option>
                                    </select>
                                </div>
                            </div>

                            <button type="button" class="btn btn-primary" onclick="ajouterActivite()">
                                ‚ûï Ajouter cette activit√©
                            </button>
                        </div>
                    </div>

                    <div id="activitesParCategorie">
                        <p style="text-align: center; color: #999; padding: 40px;">
                            Aucune activit√© enregistr√©e pour ce g√Æte
                        </p>
                    </div>
                </div>

                <!-- BOUTON G√âN√âRATION GUIDE CLIENT -->
                <div class="card" style="background: linear-gradient(135deg, #10b981, #059669); color: white;">
                    <button type="button" class="btn" style="width: 100%; padding: 20px; background: none; border: none; color: white; font-size: 1.3rem; font-weight: 700; cursor: pointer;" onclick="genererGuideDecouverte()">
                        üìÑ G√âN√âRER LE GUIDE "√Ä D√âCOUVRIR" (PDF)
                    </button>
                </div>
            </form>
        </div>
        
        <!-- ONGLET SAUVEGARDE -->
        <div id="tab-sauvegarde" class="tab-content">
            <div class="main-grid">
                <div class="card">
                    <div class="card-header">
                        <span class="card-icon">üì§</span>
                        <h2 class="card-title">Sauvegarder</h2>
                    </div>
                    
                    <div class="alert alert-success">
                        <strong>‚úì Sauvegarde automatique activ√©e</strong><br>
                        Vos donn√©es sont sauvegard√©es automatiquement.
                    </div>
                    
                    <button class="btn btn-primary" onclick="exportAllData()">
                        <span>üì•</span> T√©l√©charger Sauvegarde (.json)
                    </button>
                    
                    <button class="btn btn-secondary" onclick="exportToExcel()">
                        <span>üìä</span> T√©l√©charger Excel
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <span class="card-icon">üì•</span>
                        <h2 class="card-title">Restaurer</h2>
                    </div>
                    
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è Attention !</strong><br>
                        L'import remplacera TOUTES vos donn√©es actuelles.
                    </div>
                    
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importAllData(event)">
                    <button class="btn btn-warning" onclick="document.getElementById('importFile').click()">
                        <span>üìÇ</span> Importer Sauvegarde
                    </button>
                    
                    <button class="btn btn-danger" onclick="clearAllData()" style="margin-top: 20px;">
                        <span>üóëÔ∏è</span> Supprimer toutes les donn√©es
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal √âdition -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="card-header">
                <span class="card-icon">‚úèÔ∏è</span>
                <h2 class="card-title">Modifier R√©servation</h2>
            </div>
            
            <form id="editForm">
                <input type="hidden" id="editId">
                
                <div class="form-group">
                    <label>Nom <span class="required">*</span></label>
                    <input type="text" id="editNom">
                </div>
                
                <div class="form-group">
                    <label>üì± T√©l√©phone</label>
                    <input type="tel" id="editTelephone" placeholder="+33 6 12 34 56 78">
                </div>
                
                <div class="form-group">
                    <label>Provenance</label>
                    <input type="text" id="editProvenance">
                </div>
                
                <div class="form-group">
                    <label>Nb Personnes</label>
                    <input type="number" id="editNbPersonnes" min="1">
                </div>
                
                <div class="form-group">
                    <label>Montant (‚Ç¨) <span class="required">*</span></label>
                    <input type="number" id="editMontant" step="0.01">
                </div>
                
                <div class="form-group">
                    <label>Acompte (‚Ç¨)</label>
                    <input type="number" id="editAcompte" step="0.01">
                </div>
                
                <div class="form-group">
                    <label>Statut paiement</label>
                    <select id="editPaiement">
                        <option value="En attente">En attente</option>
                        <option value="Partiellement pay√©">Partiellement pay√©</option>
                        <option value="Pay√©">Pay√©</option>
                        <option value="Annul√©">Annul√©</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">
                        <span>‚úì</span> Enregistrer
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">
                        Annuler
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast">
        <span style="font-size: 1.5rem;">‚úì</span>
        <span id="toastMessage"></span>
    </div>
    
    <script>
        // ==========================================
        // ‚ö†Ô∏è CONFIGURATION FUSEAU HORAIRE ‚ö†Ô∏è
        // ==========================================
        // Forcer le fuseau horaire Europe/Paris pour toutes les dates
        // Note: JavaScript utilise le fuseau local du navigateur par d√©faut
        const TIMEZONE = 'Europe/Paris';
        
        // Fonction helper pour cr√©er des dates en heure locale Paris
        function createParisDate(...args) {
            const date = new Date(...args);
            // Les dates sont d√©j√† en heure locale du navigateur
            // On s'assure juste que le parsing est coh√©rent
            return date;
        }
        
        // Supabase pour toutes les donn√©es (plus de IndexedDB)
        const SUPABASE_URL = 'https://ivqiisnudabxemcxxyru.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2cWlpc251ZGFieGVtY3h4eXJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzOTk0NjMsImV4cCI6MjA4MDk3NTQ2M30.9FwJPgR8bbaP7bAemuaVbAN019EO5ql7uciQO9FeHK4';
        
        // V√©rifier si supabase n'est pas d√©j√† d√©clar√© (√©vite les erreurs de double chargement)
        let supabase;
        if (typeof window.supabaseClient === 'undefined') {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            window.supabaseClient = supabase; // Stocker globalement
        } else {
            supabase = window.supabaseClient;
        }
        let caChartInstance, gitesChartInstance, platformsChartInstance, profitChartInstance;
        
        // ==========================================
        // ‚ö†Ô∏è SECTION SYNCHRONISATION iCAL - NE PAS MODIFIER SANS DEMANDE EXPLICITE ‚ö†Ô∏è
        // ==========================================
        
        // URLs iCal par d√©faut
        const DEFAULT_ICAL_CONFIGS = {
            couzon: {
                airbnb: 'https://www.airbnb.fr/calendar/ical/13366259.ics?s=d2cd55cf08b32b26b639189d5d4bf93e',
                abritel: 'http://www.homelidays.com/icalendar/d31158afb72048aabba35b3188771598.ics',
                gitesDeFrance: 'https://reservation.itea.fr/iCal_753fbf35431f67e8118e8757e06d2bef.ics?aicc=f26bc80e2e964f8fabb080bbbd3557c8'
            },
            trevoux: {
                airbnb: 'https://www.airbnb.fr/calendar/ical/37315488.ics?s=082e23b5f091ef093d1767499f409dda',
                abritel: 'http://www.abritel.fr/icalendar/0e7482c3c4cf4d08a5811bb27dc86e17.ics?nonTentative',
                gitesDeFrance: 'https://reservation.itea.fr/iCal_a56598e138f4257a14f7e5c5041afdf7.ics?aicc=e9a8169fa0094d7a1f24f1b47f79c65'
            }
        };
        
        // Fonction pour obtenir les URLs iCal (depuis localStorage ou d√©faut)
        function getIcalConfigs() {
            const stored = localStorage.getItem('icalUrls');
            if (stored) {
                return JSON.parse(stored);
            }
            return DEFAULT_ICAL_CONFIGS;
        }
        
        // Charger les URLs dans les champs du formulaire
        function chargerUrlsIcal() {
            const configs = getIcalConfigs();
            document.getElementById('icalAirbnbCouzon').value = configs.couzon.airbnb;
            document.getElementById('icalAbritelCouzon').value = configs.couzon.abritel;
            document.getElementById('icalGitesCouzon').value = configs.couzon.gitesDeFrance;
            document.getElementById('icalAirbnbTrevoux').value = configs.trevoux.airbnb;
            document.getElementById('icalAbritelTrevoux').value = configs.trevoux.abritel;
            document.getElementById('icalGitesTrevoux').value = configs.trevoux.gitesDeFrance;
        }
        
        // Sauvegarder les URLs depuis le formulaire
        function sauvegarderUrlsIcal() {
            const configs = {
                couzon: {
                    airbnb: document.getElementById('icalAirbnbCouzon').value.trim(),
                    abritel: document.getElementById('icalAbritelCouzon').value.trim(),
                    gitesDeFrance: document.getElementById('icalGitesCouzon').value.trim()
                },
                trevoux: {
                    airbnb: document.getElementById('icalAirbnbTrevoux').value.trim(),
                    abritel: document.getElementById('icalAbritelTrevoux').value.trim(),
                    gitesDeFrance: document.getElementById('icalGitesTrevoux').value.trim()
                }
            };
            localStorage.setItem('icalUrls', JSON.stringify(configs));
            showToast('‚úì URLs iCal sauvegard√©es');
        }
        
        // Variable globale pour les configs
        let ICAL_CONFIGS = getIcalConfigs();
        
        // IndexedDB supprim√©e - Tout est sur Supabase maintenant
        function initDB() {
            console.log('‚úì Supabase pr√™t - IndexedDB non n√©cessaire');
            return Promise.resolve();
        }
        
        // ==========================================
        // üî• FONCTIONS R√âSERVATIONS - SUPABASE
        // ==========================================
        
        async function addReservation(reservation) {
            try {
                // Helper pour formater les dates en YYYY-MM-DD (heure locale fran√ßaise)
                function formatDateForSupabase(dateStr) {
                    if (!dateStr) return null;
                    
                    // Si c'est d√©j√† au bon format YYYY-MM-DD
                    if (typeof dateStr === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                        return dateStr;
                    }
                    
                    // Si c'est un objet Date
                    if (dateStr instanceof Date) {
                        return dateToLocalString(dateStr);
                    }
                    
                    // Sinon essayer de parser en utilisant parseLocalDate (pas new Date!)
                    if (typeof dateStr === 'string') {
                        // Si format ISO complet (avec heure), extraire juste la date
                        if (dateStr.includes('T')) {
                            return dateStr.split('T')[0];
                        }
                        // Sinon parser correctement
                        try {
                            const parsed = parseLocalDate(dateStr);
                            if (!isNaN(parsed.getTime())) {
                                return dateToLocalString(parsed);
                            }
                        } catch (e) {
                            console.error('Erreur parsing date:', dateStr, e);
                        }
                    }
                    
                    return null;
                }
                
                const data = {
                    gite: reservation.gite,
                    date_debut: formatDateForSupabase(reservation.dateDebut),
                    date_fin: formatDateForSupabase(reservation.dateFin),
                    plateforme: reservation.site || reservation.plateforme || 'Autre',
                    montant: parseFloat(reservation.montant) || 0,
                    nom_client: reservation.nom || reservation.nomClient || null,
                    telephone: reservation.telephone || null,
                    provenance: reservation.provenance || null,
                    nb_personnes: reservation.nbPersonnes || 0,
                    acompte: parseFloat(reservation.acompte) || 0,
                    restant: parseFloat(reservation.restant) || 0,
                    paiement: reservation.paiement || 'En attente',
                    timestamp: reservation.timestamp || new Date().toISOString(),
                    synced_from: reservation.syncedFrom || null
                };
                
                if (!data.date_debut || !data.date_fin) {
                    throw new Error('Dates invalides');
                }
                
                const result = await supabase
                    .from('reservations')
                    .insert(data)
                    .select()
                    .single();
                
                if (result.error) throw result.error;
                
                // Invalider le cache
                invalidateCache('reservations');
                
                return result.data.id;
            } catch (error) {
                console.error('Erreur addReservation:', error);
                throw error;
            }
        }
        
        // ==========================================
        // üöÄ SYST√àME DE CACHE INTELLIGENT
        // ==========================================
        
        const CACHE = {
            reservations: null,
            reservationsTimestamp: 0,
            charges: null,
            chargesTimestamp: 0,
            historicalData: null,
            historicalTimestamp: 0,
            TTL: 60000 // 1 minute
        };
        
        function invalidateCache(type) {
            if (type === 'reservations') {
                CACHE.reservations = null;
                CACHE.reservationsTimestamp = 0;
            } else if (type === 'charges') {
                CACHE.charges = null;
                CACHE.chargesTimestamp = 0;
            } else if (type === 'historical') {
                CACHE.historicalData = null;
                CACHE.historicalTimestamp = 0;
            } else if (type === 'all') {
                CACHE.reservations = null;
                CACHE.reservationsTimestamp = 0;
                CACHE.charges = null;
                CACHE.chargesTimestamp = 0;
                CACHE.historicalData = null;
                CACHE.historicalTimestamp = 0;
            }
        }
        
        async function getAllReservations(forceRefresh) {
            // Utiliser le cache si valide
            if (!forceRefresh && CACHE.reservations && (Date.now() - CACHE.reservationsTimestamp < CACHE.TTL)) {
                console.log('üì¶ Cache hit: reservations');
                return CACHE.reservations;
            }
            
            try {
                console.log('üîÑ Fetching reservations from Supabase...');
                const result = await supabase
                    .from('reservations')
                    .select('*')
                    .order('date_debut', { ascending: true });
                
                if (result.error) throw result.error;
                
                // Convertir snake_case en camelCase pour compatibilit√©
                const reservations = (result.data || []).map(function(r) {
                    return {
                        id: r.id,
                        gite: r.gite,
                        dateDebut: r.date_debut,
                        dateFin: r.date_fin,
                        site: r.plateforme,
                        montant: r.montant,
                        nom: r.nom_client,
                        telephone: r.telephone,
                        provenance: r.provenance,
                        nbPersonnes: r.nb_personnes,
                        acompte: r.acompte,
                        restant: r.restant,
                        paiement: r.paiement,
                        nuits: calculateNights(r.date_debut, r.date_fin),
                        timestamp: r.timestamp,
                        syncedFrom: r.synced_from
                    };
                });
                
                // Mettre en cache
                CACHE.reservations = reservations;
                CACHE.reservationsTimestamp = Date.now();
                
                return reservations;
            } catch (error) {
                console.error('Erreur getAllReservations:', error);
                showToast('‚ùå Erreur chargement r√©servations', 'error');
                return [];
            }
        }
        
        async function updateReservation(id, updates) {
            try {
                const data = {};
                if (updates.gite !== undefined) data.gite = updates.gite;
                if (updates.dateDebut !== undefined) data.date_debut = updates.dateDebut;
                if (updates.dateFin !== undefined) data.date_fin = updates.dateFin;
                if (updates.site !== undefined) data.plateforme = updates.site;
                if (updates.montant !== undefined) data.montant = parseFloat(updates.montant);
                if (updates.nom !== undefined) data.nom_client = updates.nom;
                if (updates.telephone !== undefined) data.telephone = updates.telephone;
                if (updates.provenance !== undefined) data.provenance = updates.provenance;
                if (updates.nbPersonnes !== undefined) data.nb_personnes = updates.nbPersonnes;
                if (updates.acompte !== undefined) data.acompte = parseFloat(updates.acompte);
                if (updates.restant !== undefined) data.restant = parseFloat(updates.restant);
                if (updates.paiement !== undefined) data.paiement = updates.paiement;
                
                const result = await supabase
                    .from('reservations')
                    .update(data)
                    .eq('id', id);
                
                if (result.error) throw result.error;
                
                // Invalider le cache
                invalidateCache('reservations');
            } catch (error) {
                console.error('Erreur updateReservation:', error);
                throw error;
            }
        }
        
        async function deleteReservation(id) {
            try {
                const result = await supabase
                    .from('reservations')
                    .delete()
                    .eq('id', id);
                
                if (result.error) throw result.error;
                
                // Invalider le cache
                invalidateCache('reservations');
            } catch (error) {
                console.error('Erreur deleteReservation:', error);
                throw error;
            }
        }
        
        // ==========================================
        // üî• FONCTIONS CHARGES - SUPABASE
        // ==========================================
        
        async function addCharge(charge) {
            try {
                const data = {
                    nom: charge.nom,
                    montant: parseFloat(charge.montant),
                    type: charge.type,
                    date: charge.date || null,
                    gite: charge.gite || null
                };
                
                const result = await supabase
                    .from('charges')
                    .insert(data)
                    .select()
                    .single();
                
                if (result.error) throw result.error;
                
                // Invalider le cache
                invalidateCache('charges');
                
                return result.data.id;
            } catch (error) {
                console.error('Erreur addCharge:', error);
                throw error;
            }
        }
        
        async function getAllCharges(forceRefresh) {
            // Utiliser le cache si valide
            if (!forceRefresh && CACHE.charges && (Date.now() - CACHE.chargesTimestamp < CACHE.TTL)) {
                console.log('üì¶ Cache hit: charges');
                return CACHE.charges;
            }
            
            try {
                console.log('üîÑ Fetching charges from Supabase...');
                const result = await supabase
                    .from('charges')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (result.error) throw result.error;
                
                // Mettre en cache
                CACHE.charges = result.data || [];
                CACHE.chargesTimestamp = Date.now();
                
                return CACHE.charges;
            } catch (error) {
                console.error('Erreur getAllCharges:', error);
                showToast('‚ùå Erreur chargement charges', 'error');
                return [];
            }
        }
        
        async function deleteCharge(id) {
            try {
                const result = await supabase
                    .from('charges')
                    .delete()
                    .eq('id', id);
                
                if (result.error) throw result.error;
                
                // Invalider le cache
                invalidateCache('charges');
            } catch (error) {
                console.error('Erreur deleteCharge:', error);
                throw error;
            }
        }
        
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.style.background = type === 'error' ? 'var(--danger)' : 'var(--success)';
            document.getElementById('toastMessage').textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 4000);
        }
        
        // Fonction pour parser les dates en heure locale (√©vite le d√©calage UTC)
        // ==========================================
        // üá´üá∑ GESTION DATES TIMEZONE FRAN√áAIS
        // ==========================================
        
        // Convertir une Date JavaScript en format YYYY-MM-DD
        // Pour les dates iCal : elles peuvent √™tre en UTC ou en local selon le format
        function dateToLocalString(date) {
            if (!date) return null;
            if (!(date instanceof Date)) {
                date = new Date(date);
            }
            if (isNaN(date.getTime())) return null;
            
            // Extraire l'ann√©e, mois, jour en HEURE LOCALE (pas UTC)
            // Car les dates de r√©servation doivent √™tre en heure locale fran√ßaise
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return year + '-' + month + '-' + day;
        }
        
        function parseLocalDate(dateStr) {
            // dateStr format: "YYYY-MM-DD"
            const [year, month, day] = dateStr.split('-').map(Number);
            return new Date(year, month - 1, day); // month - 1 car les mois JS commencent √† 0
        }
        
        function calculateNights(debut, fin) {
            const d1 = parseLocalDate(debut);
            const d2 = parseLocalDate(fin);
            return Math.ceil((d2 - d1) / (1000 * 60 * 60 * 24));
        }
        
        function formatDate(dateStr) {
            const date = parseLocalDate(dateStr);
            return date.toLocaleDateString('fr-FR');
        }
        
        function getMonthYear(dateStr) {
            const date = parseLocalDate(dateStr);
            return date.toLocaleDateString('fr-FR', { year: 'numeric', month: 'long' });
        }
        
        // ==========================================
        // üè† HELPER POUR LES NOMS DE G√éTES
        // ==========================================
        
        function isCouzon(giteName) {
            // Accepte "Couzon", "Couzon-au-Mont-d'Or", "couzon"
            if (!giteName) return false;
            const normalized = giteName.toLowerCase().trim();
            return normalized === 'couzon' || normalized === 'couzon-au-mont-d\'or' || normalized.startsWith('couzon');
        }
        
        function isTrevoux(giteName) {
            // Accepte "Tr√©voux", "trevoux", "Tr√©voux", etc.
            if (!giteName) return false;
            const normalized = giteName.toLowerCase().trim();
            return normalized === 'tr√©voux' || normalized === 'trevoux';
        }
        
        // ==========================================
        // ‚öôÔ∏è MENU ACTIONS RAPIDES
        // ==========================================
        
        function handleQuickAction(action) {
            switch(action) {
                case 'import':
                    document.getElementById('importFileQuick').click();
                    break;
                case 'backup':
                    sauvegarderTout();
                    break;
                case 'archives':
                    switchTab('archives');
                    break;
                case 'ical':
                    switchTab('gestion');
                    break;
            }
        }
        
        // ==========================================
        // üîç RECHERCHE R√âSERVATIONS
        // ==========================================
        
        async function filterReservations(searchTerm) {
            const reservations = await getAllReservations();
            
            if (!searchTerm || searchTerm.trim() === '') {
                // Pas de recherche, afficher tout
                updateReservationsList();
                return;
            }
            
            const term = searchTerm.toLowerCase().trim();
            const filtered = reservations.filter(r => {
                return (
                    (r.nom && r.nom.toLowerCase().includes(term)) ||
                    (r.telephone && r.telephone.includes(term)) ||
                    (r.gite && r.gite.toLowerCase().includes(term)) ||
                    (r.site && r.site.toLowerCase().includes(term)) ||
                    (r.provenance && r.provenance.toLowerCase().includes(term))
                );
            });
            
            // Afficher r√©sultats
            displayFilteredReservations(filtered);
        }
        
        function displayFilteredReservations(reservations) {
            const container = document.getElementById('planning-container');
            
            if (reservations.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">Aucun r√©sultat</p>';
                return;
            }
            
            let html = '<div class="planning-weeks"><h3 style="margin-bottom: 20px;">üîç R√©sultats de recherche (' + reservations.length + ')</h3>';
            
            reservations.forEach(r => {
                const platformLogo = getPlatformLogo(r.site);
                const messageEnvoye = r.messageEnvoye ? ' <span style="color: #27ae60; font-weight: 600;">‚úì</span>' : '';
                const telephoneDisplay = r.telephone ? `<br><span style="font-size: 0.9rem;">üì± ${r.telephone}</span>` : '';
                
                const isIncomplete = !r.nom || r.nom.includes('‚ö†Ô∏è') || r.nom.includes('√Ä COMPL√âTER') || r.nom.includes('Client');
                const incompleteBadge = isIncomplete ? 
                    '<span style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 700; margin-left: 8px;">‚ö†Ô∏è √Ä COMPL√âTER</span>' : 
                    '';
                
                html += `
                    <div class="week-reservation" style="margin-bottom: 15px; padding: 12px; border-radius: 12px; background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.1); ${isIncomplete ? 'border-left: 4px solid #ff6b6b;' : ''}">
                        <div style="position: relative;">
                            <div style="position: absolute; top: 0; right: 0; display: flex; gap: 4px;">
                                <button onclick="openEditModal(${r.id})" style="background: #e3f2fd; border: none; border-radius: 6px; padding: 6px 8px; cursor: pointer; font-size: 1rem;" title="Modifier">‚úèÔ∏è</button>
                                <button onclick="genererPageClient(${r.id})" style="background: #e8f5e9; border: none; border-radius: 6px; padding: 6px 8px; cursor: pointer; font-size: 1rem;" title="Page Client">üìÑ</button>
                                <button onclick="deleteReservationById(${r.id})" style="background: #ffebee; border: none; border-radius: 6px; padding: 6px 8px; cursor: pointer; font-size: 1rem;" title="Supprimer">üóëÔ∏è</button>
                            </div>
                            
                            <div style="font-weight: 700; font-size: 1.15rem; color: #0f172a; margin-bottom: 8px;">
                                ${r.nom}${messageEnvoye}${incompleteBadge}
                            </div>
                            
                            <div style="font-size: 1.05rem; color: #334155; margin-bottom: 8px;">
                                üìÖ <strong>${formatDate(r.dateDebut)} ‚Üí ${formatDate(r.dateFin)}</strong>${telephoneDisplay}<br>
                                üí∞ <strong>${r.montant.toFixed(2)} ‚Ç¨</strong> ‚Ä¢ ${platformLogo}
                            </div>
                            
                            <div style="font-size: 0.9rem; color: #64748b;">
                                üè† ${r.gite}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // ==========================================
        // üìä COMPTEURS PAR PLATEFORME
        // ==========================================
        
        function updatePlatformCounters(reservations) {
            // Utiliser directement les r√©servations pass√©es (d√©j√† filtr√©es si n√©cessaire)
            
            // Compter par plateforme
            let countAirbnb = 0;
            let countAbritel = 0;
            let countGites = 0;
            let countAutres = 0;
            
            reservations.forEach(r => {
                const site = (r.site || '').toLowerCase();
                if (site.includes('airbnb')) {
                    countAirbnb++;
                } else if (site.includes('abritel') || site.includes('homeaway')) {
                    countAbritel++;
                } else if (site.includes('g√Ætes') || site.includes('gites')) {
                    countGites++;
                } else {
                    countAutres++;
                }
            });
            
            // Mettre √† jour les compteurs
            document.getElementById('countAirbnb').textContent = countAirbnb;
            document.getElementById('countAbritel').textContent = countAbritel;
            document.getElementById('countGites').textContent = countGites;
            document.getElementById('countAutres').textContent = countAutres;
        }
        
        // ==========================================
        // üìà STATISTIQUES AVANC√âES
        // ==========================================
        
        function updateAdvancedStats(reservations) {
            // Utiliser directement les r√©servations pass√©es (d√©j√† filtr√©es si n√©cessaire)
            
            // Taux d'occupation
            const trevoux = reservations.filter(r => isTrevoux(r.gite));
            const couzon = reservations.filter(r => isCouzon(r.gite));
            
            const joursOccupesTrevoux = trevoux.reduce((sum, r) => {
                const debut = parseLocalDate(r.dateDebut);
                const fin = parseLocalDate(r.dateFin);
                return sum + Math.ceil((fin - debut) / (1000 * 60 * 60 * 24));
            }, 0);
            
            const joursOccupesCouzon = couzon.reduce((sum, r) => {
                const debut = parseLocalDate(r.dateDebut);
                const fin = parseLocalDate(r.dateFin);
                return sum + Math.ceil((fin - debut) / (1000 * 60 * 60 * 24));
            }, 0);
            
            const joursAnnee = 365;
            const tauxTrevoux = ((joursOccupesTrevoux / joursAnnee) * 100).toFixed(1);
            const tauxCouzon = ((joursOccupesCouzon / joursAnnee) * 100).toFixed(1);
            
            document.getElementById('tauxTrevoux').textContent = tauxTrevoux + '%';
            document.getElementById('tauxCouzon').textContent = tauxCouzon + '%';
            
            // Prix moyen par nuit
            let totalMontant = 0;
            let totalNuits = 0;
            
            reservations.forEach(r => {
                const debut = parseLocalDate(r.dateDebut);
                const fin = parseLocalDate(r.dateFin);
                const nuits = Math.ceil((fin - debut) / (1000 * 60 * 60 * 24));
                totalMontant += r.montant;
                totalNuits += nuits;
            });
            
            const prixMoyen = totalNuits > 0 ? (totalMontant / totalNuits).toFixed(0) : 0;
            document.getElementById('prixMoyen').textContent = prixMoyen + ' ‚Ç¨';
            
            // Dur√©e moyenne
            const dureeMoyenne = reservations.length > 0 ? (totalNuits / reservations.length).toFixed(1) : 0;
            document.getElementById('dureeMoyenne').textContent = dureeMoyenne + ' nuits';
            
            // Meilleur mois
            const moisCA = {};
            reservations.forEach(r => {
                const date = parseLocalDate(r.dateDebut);
                const mois = date.toLocaleDateString('fr-FR', { month: 'long' });
                moisCA[mois] = (moisCA[mois] || 0) + r.montant;
            });
            
            let meilleurMois = '-';
            let meilleurCA = 0;
            
            Object.keys(moisCA).forEach(mois => {
                if (moisCA[mois] > meilleurCA) {
                    meilleurCA = moisCA[mois];
                    meilleurMois = mois.charAt(0).toUpperCase() + mois.slice(1);
                }
            });
            
            document.getElementById('meilleurMois').textContent = meilleurMois;
            document.getElementById('meilleurMoisCA').textContent = meilleurCA > 0 ? meilleurCA.toFixed(0) + ' ‚Ç¨' : '-';
        }
        
        // ==========================================
        // üìÖ FILTRE PAR ANN√âE POUR LES STATS
        // ==========================================
        
        async function populateYearFilter() {
            const reservations = await getAllReservations();
            const years = new Set();
            
            reservations.forEach(r => {
                const year = parseLocalDate(r.dateDebut).getFullYear();
                years.add(year);
            });
            
            const sortedYears = Array.from(years).sort((a, b) => b - a);
            const currentYear = new Date().getFullYear();
            
            const select = document.getElementById('yearFilterStats');
            select.innerHTML = '';
            
            sortedYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
            
            // Initialiser aussi le champ historicalYear pour la gestion des donn√©es
            if (document.getElementById('historicalYear')) {
                document.getElementById('historicalYear').value = currentYear;
            }
        }
        
        async function filterStatsByYear() {
            const selectedYear = parseInt(document.getElementById('yearFilterStats').value);
            const reservations = await getAllReservations();
            
            // Filtrer les r√©servations par ann√©e
            const filteredReservations = reservations.filter(r => {
                const year = parseLocalDate(r.dateDebut).getFullYear();
                return year === selectedYear;
            });
            
            // Mettre √† jour tous les compteurs et stats avec les r√©servations filtr√©es
            updatePlatformCounters(filteredReservations);
            updateAdvancedStats(filteredReservations);
            
            // Mettre √† jour aussi les stats du bas (R√©servations totales, Tr√©voux, Couzon, CA)
            // IMPORTANT: Ne compter QUE les r√©servations avec un g√Æte valide
            const trevoux = filteredReservations.filter(r => isTrevoux(r.gite));
            const couzon = filteredReservations.filter(r => isCouzon(r.gite));
            
            const caTrevoux = trevoux.reduce((sum, r) => sum + r.montant, 0);
            const caCouzon = couzon.reduce((sum, r) => sum + r.montant, 0);
            const caTotal = caTrevoux + caCouzon;
            
            // Le total = Tr√©voux + Couzon (ignore les r√©servations sans g√Æte valide)
            const totalReservations = trevoux.length + couzon.length;
            
            document.getElementById('statTotal').textContent = totalReservations;
            document.getElementById('statTrevoux').textContent = trevoux.length;
            document.getElementById('statCouzon').textContent = couzon.length;
            document.getElementById('statCA').textContent = caTotal.toFixed(0) + ' ‚Ç¨';
            
            // Mettre √† jour aussi les graphiques si on est dans l'onglet statistiques
            await updateAllCharts(filteredReservations);
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            event.target.classList.add('active');
            if (tabName === 'statistiques') updateAllCharts();
            if (tabName === 'archives') updateArchivesDisplay();
            if (tabName === 'charges') updateChargesDisplay();
        }
        
        function autoSetDateFin() {
            const dateDebut = document.getElementById('dateDebut').value;
            if (dateDebut) {
                const date = new Date(dateDebut);
                date.setDate(date.getDate() + 2);
                document.getElementById('dateFin').value = date.toISOString().split('T')[0];
            }
        }
        
        async function updateBlockedDates() {
            const gite = document.getElementById('gite').value;
            if (!gite) return;
            const reservations = await getAllReservations();
            const blockedDates = reservations
                .filter(r => r.gite === gite && new Date(r.dateFin) >= new Date())
                .map(r => `${formatDate(r.dateDebut)} - ${formatDate(r.dateFin)}`)
                .join(', ');
            if (blockedDates) {
                document.getElementById('blockedDatesList').textContent = blockedDates;
                document.getElementById('blockedDatesInfo').style.display = 'block';
            } else {
                document.getElementById('blockedDatesInfo').style.display = 'none';
            }
        }
        
        async function checkDateOverlap(gite, dateDebut, dateFin, excludeId = null) {
            const reservations = await getAllReservations();
            const debut = parseLocalDate(dateDebut);
            const fin = parseLocalDate(dateFin);
            for (const r of reservations) {
                if (r.id === excludeId) continue;
                if (r.gite !== gite) continue;
                const rDebut = parseLocalDate(r.dateDebut);
                const rFin = parseLocalDate(r.dateFin);
                if ((debut >= rDebut && debut < rFin) || (fin > rDebut && fin <= rFin) || (debut <= rDebut && fin >= rFin)) {
                    return true;
                }
            }
            return false;
        }
        
        function getPlatformBadgeClass(site) {
            if (site.toLowerCase().includes('airbnb')) return 'badge-airbnb';
            if (site.toLowerCase().includes('abritel') || site.toLowerCase().includes('homelidays')) return 'badge-abritel';
            if (site.toLowerCase().includes('g√Ætes') || site.toLowerCase().includes('gites')) return 'badge-gites';
            return 'badge-airbnb';
        }
        
        async function syncAllCalendars() {
            // Recharger les configs depuis localStorage
            ICAL_CONFIGS = getIcalConfigs();
            
            const syncBtn = document.getElementById('syncBtn');
            const syncProgress = document.getElementById('syncProgress');
            const syncMessages = document.getElementById('syncMessages');
            const syncStatus = document.getElementById('syncStatus');
            const syncStatusIcon = document.getElementById('syncStatusIcon');
            const syncStatusText = document.getElementById('syncStatusText');
            
            // Afficher le statut
            if (syncStatus) {
                syncStatus.style.display = 'block';
                syncStatus.style.background = '#fff3cd';
                syncStatusIcon.textContent = 'üîÑ';
                syncStatusText.textContent = 'Synchronisation en cours...';
            }
            
            if (syncBtn) syncBtn.disabled = true;
            if (syncProgress) {
                syncProgress.style.display = 'block';
                syncMessages.innerHTML = '';
            }
            
            let totalAdded = 0;
            let totalSkipped = 0;
            let totalErrors = 0;
            
            function addMessage(text, type = 'info') {
                if (!syncMessages) return;
                const msg = document.createElement('div');
                msg.className = `progress-item ${type}`;
                msg.innerHTML = type === 'info' ? `<span class="spinner"></span> ${text}` : `‚úì ${text}`;
                syncMessages.appendChild(msg);
            }
            
            try {
                addMessage('Synchronisation Couzon...', 'info');
                for (const [platform, url] of Object.entries(ICAL_CONFIGS.couzon)) {
                    if (!url) continue;
                    try {
                        addMessage(`  ‚Ä¢ ${platform}...`, 'info');
                        const result = await syncCalendar('Couzon', platform, url);
                        totalAdded += result.added;
                        totalSkipped += result.skipped;
                        addMessage(`  ‚úì ${platform}: ${result.added} ajout√©es, ${result.skipped} ignor√©es`, 'success');
                    } catch (error) {
                        totalErrors++;
                        addMessage(`  ‚úó ${platform}: Erreur`, 'error');
                    }
                }
                
                addMessage('Synchronisation Tr√©voux...', 'info');
                for (const [platform, url] of Object.entries(ICAL_CONFIGS.trevoux)) {
                    if (!url) continue;
                    try {
                        addMessage(`  ‚Ä¢ ${platform}...`, 'info');
                        const result = await syncCalendar('Tr√©voux', platform, url);
                        totalAdded += result.added;
                        totalSkipped += result.skipped;
                        addMessage(`  ‚úì ${platform}: ${result.added} ajout√©es, ${result.skipped} ignor√©es`, 'success');
                    } catch (error) {
                        totalErrors++;
                        addMessage(`  ‚úó ${platform}: Erreur`, 'error');
                    }
                }
                
                addMessage('', 'info');
                addMessage(`‚úì Synchronisation termin√©e !`, 'success');
                addMessage(`üìä Total: ${totalAdded} ajout√©es, ${totalSkipped} ignor√©es, ${totalErrors} erreurs`, 'success');
                
                if (totalAdded > 0) {
                    addMessage('', 'info');
                    addMessage(`‚ö†Ô∏è IMPORTANT: Les iCal publics ne contiennent PAS les noms des clients (RGPD)`, 'info');
                    addMessage(`üí° Allez dans "R√©servations" et cliquez "‚ö†Ô∏è Compl√©ter" pour ajouter les noms`, 'info');
                }
                
                await updateReservationsList();
                await updateStats();
                
                // Mettre √† jour le statut en haut
                if (syncStatus) {
                    const now = new Date();
                    const dateStr = now.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric' });
                    const timeStr = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                    
                    if (totalErrors > 0) {
                        syncStatus.style.background = '#fff3cd';
                        syncStatusIcon.textContent = '‚ö†Ô∏è';
                        syncStatusText.textContent = `Synchronisation effectu√©e avec ${totalErrors} erreur(s) - ${dateStr} √† ${timeStr}`;
                    } else {
                        syncStatus.style.background = '#d4edda';
                        syncStatusIcon.textContent = '‚úì';
                        syncStatusText.textContent = `Derni√®re synchronisation r√©ussie : ${dateStr} √† ${timeStr} (${totalAdded} r√©servations ajout√©es)`;
                    }
                    
                    // Sauvegarder le statut
                    localStorage.setItem('lastSyncStatus', JSON.stringify({
                        date: now.toISOString(),
                        added: totalAdded,
                        errors: totalErrors
                    }));
                }
                
                showToast(`‚úì Sync termin√©e : ${totalAdded} r√©servations ajout√©es`);
                
            } catch (error) {
                addMessage('‚úó Erreur g√©n√©rale', 'error');
                if (syncStatus) {
                    syncStatus.style.background = '#f8d7da';
                    syncStatusIcon.textContent = '‚ùå';
                    syncStatusText.textContent = 'Erreur lors de la synchronisation';
                }
                showToast('‚ùå Erreur sync', 'error');
                console.error(error);
            }
            
            if (syncBtn) syncBtn.disabled = false;
        }
        
        async function syncCalendar(gite, platform, url) {
            const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
            
            try {
                const response = await fetch(proxyUrl);
                const text = await response.text();
                const jcalData = ICAL.parse(text);
                const comp = new ICAL.Component(jcalData);
                const vevents = comp.getAllSubcomponents('vevent');
                
                let added = 0;
                let skipped = 0;
                
                for (const vevent of vevents) {
                    const event = new ICAL.Event(vevent);
                    
                    const summary = event.summary || '';
                    const description = event.description || '';
                    
                    // üá´üá∑ CORRECTION TIMEZONE : Ne pas utiliser toISOString() qui convertit en UTC !
                    // Utiliser dateToLocalString pour garder l'heure locale fran√ßaise
                    const dateDebut = dateToLocalString(event.startDate.toJSDate());
                    const dateFin = dateToLocalString(event.endDate.toJSDate());
                    
                    // üîç DEBUG: Logger les dates pour comprendre le probl√®me
                    console.log('üìÖ iCal Event:', {
                        summary: summary,
                        startDate_raw: event.startDate.toString(),
                        endDate_raw: event.endDate.toString(),
                        startDate_js: event.startDate.toJSDate(),
                        endDate_js: event.endDate.toJSDate(),
                        dateDebut: dateDebut,
                        dateFin: dateFin
                    });
                    
                    // Nom du client (rarement disponible dans les iCal publics pour confidentialit√©)
                    let nom = '√Ä COMPL√âTER';
                    
                    // V√©rifier si le summary contient un vrai nom (pas juste "R√©serv√©", "Busy", etc.)
                    const genericTerms = ['r√©serv√©', 'reserved', 'busy', 'occup√©', 'not available', 'indisponible', 'blocked', 'bloqu√©'];
                    const isGeneric = genericTerms.some(term => summary.toLowerCase().includes(term));
                    
                    if (summary && !isGeneric && summary.length > 3) {
                        // Semble √™tre un vrai nom
                        nom = summary;
                    } else {
                        // Nom g√©n√©rique selon plateforme
                        if (platform.toLowerCase().includes('airbnb')) {
                            nom = '‚ö†Ô∏è Client Airbnb';
                        } else if (platform.toLowerCase().includes('abritel') || platform.toLowerCase().includes('homelidays')) {
                            nom = '‚ö†Ô∏è Client Abritel';
                        } else if (platform.toLowerCase().includes('gites')) {
                            nom = '‚ö†Ô∏è Client G√Ætes de France';
                        }
                    }
                    
                    // Extraction du tarif depuis la description
                    let montant = 0;
                    
                    // Patterns de recherche de prix
                    const pricePatterns = [
                        /(?:total|montant|price|amount)[:\s]*(\d+[,.]?\d*)\s*‚Ç¨/i,
                        /‚Ç¨\s*(\d+[,.]?\d*)/,
                        /(\d+[,.]?\d*)\s*‚Ç¨/,
                        /(\d{2,4}[,.]?\d{0,2})\s*EUR/i
                    ];
                    
                    for (const pattern of pricePatterns) {
                        const match = description.match(pattern);
                        if (match) {
                            const price = match[1].replace(',', '.');
                            montant = parseFloat(price);
                            if (montant > 0 && montant < 10000) break; // Prix raisonnable trouv√©
                        }
                    }
                    
                    // Si toujours pas de tarif, chercher dans le summary aussi
                    if (montant === 0) {
                        const summaryMatch = summary.match(/(\d{2,4}[,.]?\d{0,2})\s*‚Ç¨/);
                        if (summaryMatch) {
                            montant = parseFloat(summaryMatch[1].replace(',', '.'));
                        }
                    }
                    
                    // V√©rifier doublon
                    if (await checkDateOverlap(gite, dateDebut, dateFin)) {
                        skipped++;
                        continue;
                    }
                    
                    // D√©terminer site
                    let site;
                    if (platform.toLowerCase().includes('airbnb')) site = 'Airbnb';
                    else if (platform.toLowerCase().includes('abritel') || platform.toLowerCase().includes('homelidays')) site = 'Abritel';
                    else if (platform.toLowerCase().includes('gites')) site = 'G√Ætes de France (centrale)';
                    else site = platform;
                    
                    const reservation = {
                        gite: gite,
                        nom: nom,
                        telephone: '', // T√©l√©phone vide, √† remplir manuellement
                        provenance: '',
                        dateDebut: dateDebut,
                        dateFin: dateFin,
                        nuits: calculateNights(dateDebut, dateFin),
                        nbPersonnes: 0,
                        montant: montant,
                        acompte: 0,
                        restant: montant,
                        paiement: 'En attente',
                        site: site,
                        timestamp: new Date().toISOString(),
                        syncedFrom: platform
                    };
                    
                    await addReservation(reservation);
                    added++;
                }
                
                return { added, skipped };
                
            } catch (error) {
                console.error(`Erreur sync ${gite} ${platform}:`, error);
                throw error;
            }
        }
        
        // ==========================================
        // ‚ö†Ô∏è FIN SECTION SYNCHRONISATION iCAL ‚ö†Ô∏è
        // ==========================================
        
        async function autoSaveJSON() {
            const reservations = await getAllReservations();
            const backup = {
                version: '1.0',
                date: new Date().toISOString(),
                reservations: reservations
            };
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `AutoSave_Gites_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        
        function openEditModal(id) {
            getAllReservations().then(reservations => {
                const reservation = reservations.find(r => r.id === id);
                if (!reservation) return;
                
                document.getElementById('editId').value = reservation.id;
                document.getElementById('editNom').value = reservation.nom;
                document.getElementById('editTelephone').value = reservation.telephone || '';
                document.getElementById('editProvenance').value = reservation.provenance || '';
                document.getElementById('editNbPersonnes').value = reservation.nbPersonnes || '';
                document.getElementById('editMontant').value = reservation.montant;
                document.getElementById('editAcompte').value = reservation.acompte || 0;
                document.getElementById('editPaiement').value = reservation.paiement;
                
                document.getElementById('editModal').classList.add('show');
            });
        }
        
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('show');
        }
        
        document.getElementById('editForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const id = parseInt(document.getElementById('editId').value);
            const montant = parseFloat(document.getElementById('editMontant').value);
            const acompte = parseFloat(document.getElementById('editAcompte').value) || 0;
            
            const updates = {
                nom: document.getElementById('editNom').value,
                telephone: document.getElementById('editTelephone').value,
                provenance: document.getElementById('editProvenance').value,
                nbPersonnes: parseInt(document.getElementById('editNbPersonnes').value) || 0,
                montant: montant,
                acompte: acompte,
                restant: montant - acompte,
                paiement: document.getElementById('editPaiement').value
            };
            
            await updateReservation(id, updates);
            await updateReservationsList();
            await updateStats();
            await autoSaveJSON();
            closeEditModal();
            showToast('‚úì R√©servation mise √† jour');
        });
        
        async function updatePaiementStatus(id, newStatus) {
            await updateReservation(id, { paiement: newStatus });
            await updateReservationsList();
            await autoSaveJSON();
            showToast('‚úì Statut mis √† jour');
        }
        
        async function deleteReservationById(id) {
            if (confirm('Supprimer cette r√©servation ?')) {
                await deleteReservation(id);
                await updateReservationsList();
                await updateStats();
                await updateArchivesDisplay();
                await autoSaveJSON();
                showToast('‚úì R√©servation supprim√©e');
            }
        }
        
        // ==========================================
        // ‚ö†Ô∏è SECTION AFFICHAGE R√âSERVATIONS - NE PAS MODIFIER SANS APPROBATION ‚ö†Ô∏è
        // ==========================================
        
        async function updateReservationsList() {
            const reservations = await getAllReservations();
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const active = reservations.filter(r => parseLocalDate(r.dateFin) >= today);
            
            const container = document.getElementById('planning-container');
            
            if (active.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">Aucune r√©servation</p>';
                return;
            }
            
            // Organiser par g√Æte
            const byGite = {
                'Tr√©voux': active.filter(r => r.gite === 'Tr√©voux'),
                'Couzon': active.filter(r => r.gite === 'Couzon')
            };
            
            // Trier par date
            byGite['Tr√©voux'].sort((a, b) => parseLocalDate(a.dateDebut) - parseLocalDate(b.dateDebut));
            byGite['Couzon'].sort((a, b) => parseLocalDate(a.dateDebut) - parseLocalDate(b.dateDebut));
            
            // Obtenir toutes les semaines √† afficher (bas√© sur la date de D√âBUT uniquement)
            const allWeeks = new Set();
            active.forEach(r => {
                const start = parseLocalDate(r.dateDebut);
                allWeeks.add(getWeekNumber(start));
            });
            
            const sortedWeeks = Array.from(allWeeks).sort((a, b) => {
                const [yearA, weekA] = a.split('-W').map(Number);
                const [yearB, weekB] = b.split('-W').map(Number);
                return yearA !== yearB ? yearA - yearB : weekA - weekB;
            });
            
            // G√©n√©rer le HTML avec en-t√™tes sticky par g√Æte
            let html = '<div class="planning-weeks">';
            
            // En-t√™tes sticky
            html += `
                <div style="display: grid; grid-template-columns: 1fr 1fr; position: sticky; top: 0; z-index: 100; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div class="gite-label trevoux-label" style="margin: 0; border-radius: 0;">üè† Tr√©voux</div>
                    <div class="gite-label couzon-label" style="margin: 0; border-radius: 0;">üè† Couzon</div>
                </div>
            `;
            
            sortedWeeks.forEach(weekKey => {
                const [year, weekNum] = weekKey.split('-W').map(Number);
                const weekDates = getWeekDates(year, weekNum);
                
                // En-t√™te de semaine
                html += `
                    <div class="week-block">
                        <div class="week-header-unique">
                            <div class="week-number-big">Semaine ${weekNum}</div>
                            <div class="week-dates-small">${formatDateShort(weekDates.start)} - ${formatDateShort(weekDates.end)}</div>
                        </div>
                        
                        <div class="week-content-grid" style="border-top: none;">
                            <div class="gite-column-inline">
                                ${generateWeekReservations(byGite['Tr√©voux'], weekKey, 'trevoux', active)}
                            </div>
                            
                            <div class="gite-column-inline">
                                ${generateWeekReservations(byGite['Couzon'], weekKey, 'couzon', active)}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function generateWeekReservations(reservations, weekKey, cssClass, toutesReservations) {
            // Trouver les r√©servations dont la date de D√âBUT est dans cette semaine
            const weekReservations = reservations.filter(r => {
                const start = parseLocalDate(r.dateDebut);
                return getWeekNumber(start) === weekKey;
            });
            
            if (weekReservations.length === 0) {
                return '<div class="week-empty">Disponible</div>';
            }
            
            let html = '';
            weekReservations.forEach(r => {
                const platformLogo = getPlatformLogo(r.site);
                const dateMenage = calculerDateMenage(r, toutesReservations);
                const messageEnvoye = r.messageEnvoye ? ' <span style="color: #27ae60; font-weight: 600;">‚úì</span>' : '';
                const telephoneDisplay = r.telephone ? `<br><span style="font-size: 0.9rem;">üì± ${r.telephone}</span>` : '';
                html += `
                    <div class="week-reservation ${cssClass}" style="position: relative; padding: 12px; padding-top: 40px;">
                        <div style="position: absolute; top: 8px; right: 8px; display: flex; gap: 4px;">
                            <button onclick="openEditModal(${r.id})" style="background: #e3f2fd; border: none; border-radius: 6px; padding: 6px 8px; cursor: pointer; font-size: 1rem; transition: all 0.2s;" title="Modifier">‚úèÔ∏è</button>
                            <button onclick="genererPageClient(${r.id})" style="background: #e8f5e9; border: none; border-radius: 6px; padding: 6px 8px; cursor: pointer; font-size: 1rem; transition: all 0.2s;" title="Page Client">üìÑ</button>
                            <button onclick="deleteReservationById(${r.id})" style="background: #ffebee; border: none; border-radius: 6px; padding: 6px 8px; cursor: pointer; font-size: 1rem; transition: all 0.2s;" title="Supprimer">üóëÔ∏è</button>
                        </div>
                        
                        <!-- Nom en haut -->
                        <div style="font-weight: 700; font-size: 1.15rem; color: #0f172a; margin-bottom: 8px; line-height: 1.3;">
                            ${r.nom}${messageEnvoye}
                        </div>
                        
                        <!-- Dates et tarif -->
                        <div style="font-size: 1.05rem; color: #334155; margin-bottom: 8px; line-height: 1.5;">
                            üìÖ <strong>${formatDate(r.dateDebut)} ‚Üí ${formatDate(r.dateFin)}</strong>${telephoneDisplay}<br>
                            üí∞ <strong>${r.montant.toFixed(2)} ‚Ç¨</strong>
                        </div>
                        
                        <!-- Pied : M√©nage √† gauche, Plateforme √† droite -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding-top: 8px; border-top: 1px solid #e5e7eb;">
                            <div style="font-size: 0.85rem; color: #64748b;">
                                üßπ ${dateMenage}
                            </div>
                            <div>
                                ${platformLogo}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            return html;
        }
        
        // ==========================================
        // ‚ö†Ô∏è FIN SECTION AFFICHAGE R√âSERVATIONS ‚ö†Ô∏è
        // ==========================================
        
        function getPlatformLogo(platform) {
            const normalizedPlatform = platform.toLowerCase();
            
            if (normalizedPlatform.includes('airbnb')) {
                return '<span style="display: inline-flex; align-items: center; padding: 3px 10px; background: #FF5A5F; color: white; border-radius: 6px; font-weight: 600; font-size: 0.75rem; letter-spacing: 0.5px;">airbnb</span>';
            } else if (normalizedPlatform.includes('abritel') || normalizedPlatform.includes('homeaway') || normalizedPlatform.includes('homelidays')) {
                return '<span style="display: inline-flex; align-items: center; padding: 3px 10px; background: #0D4F8B; color: white; border-radius: 6px; font-weight: 600; font-size: 0.75rem; letter-spacing: 0.5px;">abritel</span>';
            } else if (normalizedPlatform.includes('g√Ætes') || normalizedPlatform.includes('gites')) {
                return '<span style="display: inline-flex; align-items: center; padding: 3px 10px; background: #27AE60; color: white; border-radius: 6px; font-weight: 600; font-size: 0.75rem; letter-spacing: 0.5px;">g√Ætes de france</span>';
            } else {
                return `<span style="display: inline-flex; align-items: center; padding: 3px 10px; background: #95a5a6; color: white; border-radius: 6px; font-weight: 600; font-size: 0.75rem;">${platform}</span>`;
            }
        }
        
        function calculerDateMenage(reservation, toutesReservations) {
            const departDate = parseLocalDate(reservation.dateFin);
            const departDay = departDate.getDay(); // 0=dimanche, 6=samedi
            
            let menageDate = new Date(departDate);
            let heure = '12h00'; // Par d√©faut apr√®s-midi
            
            // V√©rifier s'il y a une arriv√©e le jour du d√©part
            const arriveeMemejour = toutesReservations.find(r => 
                r.gite === reservation.gite && 
                r.id !== reservation.id &&
                parseLocalDate(r.dateDebut).toDateString() === departDate.toDateString()
            );
            
            // R√àGLE 1: Dimanche - Reporter au lundi (sauf enchainement)
            if (departDay === 0) {
                if (arriveeMemejour) {
                    // Exception: enchainement dimanche
                    heure = '13h00';
                } else {
                    // Reporter au lundi
                    menageDate.setDate(menageDate.getDate() + 1);
                    
                    const arriveeLundi = toutesReservations.find(r => 
                        r.gite === reservation.gite && 
                        r.id !== reservation.id &&
                        parseLocalDate(r.dateDebut).toDateString() === menageDate.toDateString()
                    );
                    
                    heure = arriveeLundi ? '07h00' : '12h00';
                }
            }
            // R√àGLE 2: Samedi - V√©rifier r√©servation samedi/dimanche avant de d√©cider
            else if (departDay === 6) {
                if (arriveeMemejour) {
                    heure = '12h00'; // Apr√®s-midi m√™me si enchainement
                } else {
                    // V√©rifier s'il y a une r√©servation samedi soir ou dimanche soir
                    const samediDate = new Date(departDate);
                    const dimancheDate = new Date(departDate);
                    dimancheDate.setDate(dimancheDate.getDate() + 1);
                    
                    const resaSamediOuDimanche = toutesReservations.find(r =>
                        r.gite === reservation.gite &&
                        r.id !== reservation.id &&
                        (parseLocalDate(r.dateDebut).toDateString() === samediDate.toDateString() ||
                         parseLocalDate(r.dateDebut).toDateString() === dimancheDate.toDateString())
                    );
                    
                    if (resaSamediOuDimanche) {
                        // Il y a une r√©servation samedi ou dimanche ‚Üí m√©nage le samedi
                        heure = '12h00';
                    } else {
                        // Pas de r√©servation samedi/dimanche ‚Üí reporter au lundi
                        menageDate.setDate(menageDate.getDate() + 2);
                        
                        const arriveeLundi = toutesReservations.find(r => 
                            r.gite === reservation.gite && 
                            r.id !== reservation.id &&
                            parseLocalDate(r.dateDebut).toDateString() === menageDate.toDateString()
                        );
                        
                        heure = arriveeLundi ? '07h00' : '12h00';
                    }
                }
            }
            // R√àGLE 3: Mercredi ou Jeudi - V√©rifier r√©servation avant vendredi
            else if (departDay === 3 || departDay === 4) { // 3=mercredi, 4=jeudi
                if (arriveeMemejour) {
                    // Il y a un enchainement ‚Üí m√©nage le jour m√™me
                    heure = '12h00';
                } else {
                    // V√©rifier s'il y a une r√©servation jeudi ou vendredi (avant le vendredi)
                    const jeudiDate = new Date(departDate);
                    if (departDay === 3) {
                        jeudiDate.setDate(jeudiDate.getDate() + 1); // Si d√©part mercredi, v√©rifier jeudi
                    }
                    const vendrediDate = new Date(departDate);
                    const joursAajouter = departDay === 3 ? 2 : 1; // Mercredi +2 = vendredi, Jeudi +1 = vendredi
                    vendrediDate.setDate(vendrediDate.getDate() + joursAajouter);
                    
                    const resaAvantVendredi = toutesReservations.find(r =>
                        r.gite === reservation.gite &&
                        r.id !== reservation.id &&
                        (parseLocalDate(r.dateDebut) < vendrediDate)
                    );
                    
                    if (resaAvantVendredi) {
                        // Il y a une r√©servation avant vendredi ‚Üí m√©nage le jour du d√©part
                        heure = '12h00';
                    } else {
                        // Pas de r√©servation avant vendredi ‚Üí reporter au vendredi
                        menageDate.setDate(menageDate.getDate() + joursAajouter);
                        
                        const arriveeVendredi = toutesReservations.find(r =>
                            r.gite === reservation.gite &&
                            r.id !== reservation.id &&
                            parseLocalDate(r.dateDebut).toDateString() === menageDate.toDateString()
                        );
                        
                        heure = arriveeVendredi ? '07h00' : '12h00';
                    }
                }
            }
            // R√àGLE 4: Autres jours semaine (Lun, Mar, Ven) - Apr√®s-midi TOUJOURS
            else {
                heure = '12h00'; // TOUJOURS apr√®s-midi en semaine
            }
            
            // V√©rifier jour f√©ri√© (sauf enchainement m√™me jour)
            if (!arriveeMemejour && isJourFerie(menageDate)) {
                do {
                    menageDate.setDate(menageDate.getDate() + 1);
                } while (isJourFerie(menageDate) || menageDate.getDay() === 0);
            }
            
            const joursComplets = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
            return `${joursComplets[menageDate.getDay()]} ${formatDateShort(menageDate)} √† ${heure}`;
        }
        
        function isJourFerie(date) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            
            const feriesFixes = [
                `${year}-01-01`, `${year}-05-01`, `${year}-05-08`, `${year}-07-14`,
                `${year}-08-15`, `${year}-11-01`, `${year}-11-11`, `${year}-12-25`
            ];
            
            const dateKey = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            if (feriesFixes.includes(dateKey)) return true;
            
            // P√¢ques mobiles
            const a = year % 19;
            const b = Math.floor(year / 100);
            const c = year % 100;
            const d = Math.floor(b / 4);
            const e = b % 4;
            const f = Math.floor((b + 8) / 25);
            const g = Math.floor((b - f + 1) / 3);
            const h = (19 * a + b - d - g + 15) % 30;
            const i = Math.floor(c / 4);
            const k = c % 4;
            const l = (32 + 2 * e + 2 * i - h - k) % 7;
            const m = Math.floor((a + 11 * h + 22 * l) / 451);
            const paquesMois = Math.floor((h + l - 7 * m + 114) / 31);
            const paquesJour = ((h + l - 7 * m + 114) % 31) + 1;
            
            const paques = new Date(year, paquesMois - 1, paquesJour);
            const lundiPaques = new Date(paques);
            lundiPaques.setDate(lundiPaques.getDate() + 1);
            const ascension = new Date(paques);
            ascension.setDate(ascension.getDate() + 39);
            const lundiPentecote = new Date(paques);
            lundiPentecote.setDate(lundiPentecote.getDate() + 50);
            
            const dateStr = date.toDateString();
            return dateStr === lundiPaques.toDateString() || 
                   dateStr === ascension.toDateString() || 
                   dateStr === lundiPentecote.toDateString();
        }
        
        function formatDateShort(date) {
            return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' });
        }
        
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return `${d.getUTCFullYear()}-W${String(weekNo).padStart(2, '0')}`;
        }
        
        function getWeekDates(year, weekNum) {
            const simple = new Date(year, 0, 1 + (weekNum - 1) * 7);
            const dow = simple.getDay();
            const ISOweekStart = simple;
            if (dow <= 4) ISOweekStart.setDate(simple.getDate() - simple.getDay() + 1);
            else ISOweekStart.setDate(simple.getDate() + 8 - simple.getDay());
            
            const start = new Date(ISOweekStart);
            const end = new Date(ISOweekStart);
            end.setDate(end.getDate() + 6);
            
            return { start, end };
        }
        
        async function updateArchivesDisplay() {
            const reservations = await getAllReservations();
            const section = document.getElementById('archivesSection');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const archives = reservations.filter(r => parseLocalDate(r.dateFin) < today);
            archives.sort((a, b) => parseLocalDate(b.dateFin) - parseLocalDate(a.dateFin));
            
            if (archives.length === 0) {
                section.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">Aucune archive</p>';
                return;
            }
            
            let html = '<div class="gite-section">';
            
            archives.forEach(r => {
                const badgeClass = getPlatformBadgeClass(r.site);
                html += `
                    <div class="reservation-item ${r.gite.toLowerCase()}">
                        <div class="reservation-header">
                            <span class="reservation-name">${r.nom} - ${r.gite}</span>
                            <span class="badge-platform ${badgeClass}">
                                ${r.site}
                            </span>
                        </div>
                        <div style="margin-top: 8px; font-size: 0.9rem; color: #666;">
                            üìÖ ${formatDate(r.dateDebut)} ‚Üí ${formatDate(r.dateFin)} (${r.nuits} nuits)
                        </div>
                        <div style="margin-top: 8px; font-size: 0.9rem;">
                            üí∞ ${r.montant.toFixed(2)} ‚Ç¨ | Statut: ${r.paiement}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            section.innerHTML = html;
        }
        
        async function updateStats() {
            const reservations = await getAllReservations();
            const historicalData = await getAllHistoricalData();
            
            // Filtrer par l'ann√©e s√©lectionn√©e
            const selectedYear = parseInt(document.getElementById('yearFilterStats')?.value || new Date().getFullYear());
            const filteredReservations = reservations.filter(r => {
                const year = parseLocalDate(r.dateDebut).getFullYear();
                return year === selectedYear;
            });
            
            // Compter toutes les r√©servations de l'ann√©e (pas seulement futures)
            // IMPORTANT: Ne compter QUE les r√©servations avec un g√Æte valide
            const trevoux = filteredReservations.filter(r => isTrevoux(r.gite));
            const couzon = filteredReservations.filter(r => isCouzon(r.gite));
            
            const caTrevoux = trevoux.reduce((sum, r) => sum + r.montant, 0);
            const caCouzon = couzon.reduce((sum, r) => sum + r.montant, 0);
            const caTotal = caTrevoux + caCouzon;
            
            // Le total = Tr√©voux + Couzon (ignore les r√©servations sans g√Æte valide)
            const totalReservations = trevoux.length + couzon.length;
            
            document.getElementById('statTotal').textContent = totalReservations;
            document.getElementById('statTrevoux').textContent = trevoux.length;
            document.getElementById('statCouzon').textContent = couzon.length;
            document.getElementById('statCA').textContent = caTotal.toFixed(0) + ' ‚Ç¨';
            
            // G√©n√©rer les checkboxes de comparaison d'ann√©es
            generateYearComparisonCheckboxes(reservations, historicalData);
            
            // Mettre √† jour les graphiques avec les donn√©es filtr√©es
            updateAllCharts(filteredReservations);
        }
        
        function generateYearComparisonCheckboxes(reservations, historicalData) {
            const container = document.getElementById('yearComparisonCheckboxes');
            const allYears = new Set();
            const yearsWithReservations = new Set();
            const yearsWithTotal = new Set();
            
            // Ann√©es des r√©servations
            reservations.forEach(r => {
                const year = parseLocalDate(r.dateDebut).getFullYear();
                allYears.add(year);
                yearsWithReservations.add(year);
            });
            
            // Ann√©es historiques
            historicalData.forEach(d => {
                allYears.add(d.year);
                if (d.gite === 'Total') {
                    yearsWithTotal.add(d.year);
                }
            });
            
            const sortedYears = Array.from(allYears).sort((a, b) => b - a);
            const currentYear = new Date().getFullYear();
            
            let html = '';
            sortedYears.forEach(year => {
                const isCurrentYear = year === currentYear;
                // Badge "Auto" UNIQUEMENT pour l'ann√©e en cours ET qui a des r√©servations ET pas de Total manuel
                const isAuto = isCurrentYear && yearsWithReservations.has(year) && !yearsWithTotal.has(year);
                // Ne cocher automatiquement QUE l'ann√©e en cours
                const checked = isCurrentYear ? 'checked' : '';
                const badge = isAuto ? '<span style="background: #27AE60; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; margin-left: 5px;">Auto ‚ö°</span>' : '';
                const bgColor = isAuto ? '#e8f5e9' : 'white';
                const borderColor = isAuto ? '#27AE60' : 'var(--border)';
                const textColor = isAuto ? '#27AE60' : 'var(--primary)';
                
                html += `
                    <label style="display: flex; align-items: center; gap: 8px; padding: 10px 15px; background: ${bgColor}; border: 2px solid ${borderColor}; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <input type="checkbox" value="${year}" ${checked} onchange="updateAllCharts()" 
                            style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-weight: 600; color: ${textColor};">${year}${badge}</span>
                    </label>
                `;
            });
            
            container.innerHTML = html;
        }
        
        async function updateAllCharts(filteredReservations = null) {
            const reservations = filteredReservations || await getAllReservations();
            const historicalData = await getAllHistoricalData();
            
            // Filtrer selon l'ann√©e s√©lectionn√©e dans le dropdown (si pas d√©j√† filtr√©)
            let reservationsForStats = reservations;
            if (!filteredReservations) {
                const selectedYear = parseInt(document.getElementById('yearFilterStats')?.value || new Date().getFullYear());
                reservationsForStats = reservations.filter(r => {
                    const year = parseLocalDate(r.dateDebut).getFullYear();
                    return year === selectedYear;
                });
            }
            
            // Mettre √† jour les compteurs et stats avanc√©es
            updatePlatformCounters(reservationsForStats);
            updateAdvancedStats(reservationsForStats);
            
            // R√©cup√©rer les ann√©es s√©lectionn√©es via les checkboxes
            const checkboxes = document.querySelectorAll('#yearComparisonCheckboxes input[type="checkbox"]:checked');
            const selectedYears = Array.from(checkboxes).map(cb => parseInt(cb.value)).sort();
            
            if (selectedYears.length === 0) {
                // Pas d'ann√©es s√©lectionn√©es, afficher un message
                const ctx1 = document.getElementById('caChart').getContext('2d');
                if (caChartInstance) caChartInstance.destroy();
                return;
            }
            
            // Pr√©parer les couleurs pour chaque ann√©e
            const colors = [
                { border: '#667eea', bg: 'rgba(102, 126, 234, 0.1)' },
                { border: '#f093fb', bg: 'rgba(240, 147, 251, 0.1)' },
                { border: '#27AE60', bg: 'rgba(39, 174, 96, 0.1)' },
                { border: '#FF5A5F', bg: 'rgba(255, 90, 95, 0.1)' },
                { border: '#3498DB', bg: 'rgba(52, 152, 219, 0.1)' },
                { border: '#F39C12', bg: 'rgba(243, 156, 18, 0.1)' }
            ];
            
            // Pr√©parer les donn√©es par ann√©e
            const dataByYear = {};
            
            selectedYears.forEach(year => {
                dataByYear[year] = {
                    trevoux: Array(12).fill(0),
                    couzon: Array(12).fill(0),
                    total: Array(12).fill(0)
                };
                
                // Donn√©es des r√©servations
                reservations.filter(r => parseLocalDate(r.dateDebut).getFullYear() === year).forEach(r => {
                    const month = parseLocalDate(r.dateDebut).getMonth();
                    // Normaliser le nom du g√Æte (enlever accents et mettre en minuscule)
                    const giteNormalized = r.gite.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                    if (dataByYear[year][giteNormalized]) {
                        dataByYear[year][giteNormalized][month] += r.montant;
                        dataByYear[year].total[month] += r.montant;
                    }
                });
                
                // Ajouter les donn√©es historiques si disponibles (g√Æte "Total")
                const histTotal = historicalData.find(d => d.year === year && d.gite === 'Total');
                
                if (histTotal) {
                    const months = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
                    months.forEach((m, idx) => {
                        const value = histTotal.months[m] || 0;
                        dataByYear[year].total[idx] += value;
                    });
                }
            });
            
            // Labels des mois
            const monthLabels = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Ao√ªt', 'Sep', 'Oct', 'Nov', 'D√©c'];
            
            // Cr√©er les datasets pour chaque ann√©e
            const datasets = [];
            selectedYears.forEach((year, idx) => {
                const color = colors[idx % colors.length];
                datasets.push({
                    label: `${year} - Total`,
                    data: dataByYear[year].total,
                    borderColor: color.border,
                    backgroundColor: color.bg,
                    tension: 0.4,
                    fill: true,
                    borderWidth: 2
                });
            });
            
            // Graphique CA mensuel
            const ctx1 = document.getElementById('caChart').getContext('2d');
            if (caChartInstance) caChartInstance.destroy();
            
            caChartInstance = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        title: { 
                            display: true, 
                            text: 'Comparaison CA mensuel (‚Ç¨)', 
                            font: { size: 16, weight: 'bold' } 
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' ‚Ç¨';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: value => value + ' ‚Ç¨' }
                        }
                    }
                }
            });
            
            // Graphique r√©partition par g√Æte (ann√©e courante uniquement)
            const ctx2 = document.getElementById('gitesChart').getContext('2d');
            if (gitesChartInstance) gitesChartInstance.destroy();
            
            const currentYear = new Date().getFullYear();
            const currentReservations = reservations.filter(r => parseLocalDate(r.dateDebut).getFullYear() === currentYear);
            const trevoux = currentReservations.filter(r => r.gite === 'Tr√©voux');
            const couzon = currentReservations.filter(r => r.gite === 'Couzon');
            
            gitesChartInstance = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Tr√©voux', 'Couzon'],
                    datasets: [{
                        data: [trevoux.length, couzon.length],
                        backgroundColor: ['#667eea', '#f093fb'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'bottom' },
                        title: { 
                            display: true, 
                            text: `R√©partition par g√Æte (${currentYear})`, 
                            font: { size: 16, weight: 'bold' } 
                        }
                    }
                }
            });
            
            // Graphique plateformes (ann√©e courante uniquement)
            const ctx3 = document.getElementById('platformsChart').getContext('2d');
            if (platformsChartInstance) platformsChartInstance.destroy();
            
            const platforms = {};
            currentReservations.forEach(r => {
                platforms[r.site] = (platforms[r.site] || 0) + 1;
            });
            
            platformsChartInstance = new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: Object.keys(platforms),
                    datasets: [{
                        label: 'R√©servations',
                        data: Object.values(platforms),
                        backgroundColor: ['#3498DB', '#FF5A5F', '#27AE60', '#E8A87C'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { 
                            display: true, 
                            text: `R√©partition par plateforme (${currentYear})`, 
                            font: { size: 16, weight: 'bold' } 
                        }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
            
            // Graphique CA vs Charges vs B√©n√©fice (ann√©e en cours uniquement)
            const ctx4 = document.getElementById('profitChart').getContext('2d');
            if (profitChartInstance) profitChartInstance.destroy();
            
            // Calculer CA mensuel pour l'ann√©e en cours
            const caParMois = Array(12).fill(0);
            currentReservations.forEach(r => {
                const month = parseLocalDate(r.dateDebut).getMonth();
                caParMois[month] += r.montant;
            });
            
            // R√©cup√©rer les charges
            const charges = await getAllCharges();
            const chargesParMois = Array(12).fill(0);
            
            charges.forEach(c => {
                const chargeDate = new Date(c.date);
                if (chargeDate.getFullYear() === currentYear) {
                    if (c.type === 'mensuelle') {
                        // Charge mensuelle : r√©partir sur tous les mois
                        for (let i = 0; i < 12; i++) {
                            chargesParMois[i] += c.montant;
                        }
                    } else if (c.type === 'annuelle') {
                        // Charge annuelle : r√©partir sur tous les mois
                        const montantMensuel = c.montant / 12;
                        for (let i = 0; i < 12; i++) {
                            chargesParMois[i] += montantMensuel;
                        }
                    } else {
                        // Charge ponctuelle : ajouter au mois concern√©
                        const month = chargeDate.getMonth();
                        chargesParMois[month] += c.montant;
                    }
                }
            });
            
            // Calculer le b√©n√©fice mensuel (CA - Charges)
            const beneficeParMois = caParMois.map((ca, idx) => ca - chargesParMois[idx]);
            
            profitChartInstance = new Chart(ctx4, {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: [
                        {
                            label: 'Chiffre d\'affaires',
                            data: caParMois,
                            borderColor: '#27AE60',
                            backgroundColor: 'rgba(39, 174, 96, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3
                        },
                        {
                            label: 'Charges',
                            data: chargesParMois,
                            borderColor: '#E74C3C',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 2
                        },
                        {
                            label: 'B√©n√©fice',
                            data: beneficeParMois,
                            borderColor: '#3498DB',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 2,
                            borderDash: [5, 5]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        title: { 
                            display: true, 
                            text: `CA vs Charges vs B√©n√©fice (${currentYear})`, 
                            font: { size: 16, weight: 'bold' } 
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' ‚Ç¨';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: value => value + ' ‚Ç¨' }
                        }
                    }
                }
            });
        }
        
        async function exportToExcel() {
            const reservations = await getAllReservations();
            if (reservations.length === 0) {
                showToast('‚ö†Ô∏è Aucune r√©servation', 'error');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            const trevoux = reservations.filter(r => r.gite === 'Tr√©voux').map(r => ({
                'Noms': r.nom, 'Provenance': r.provenance, 'Date d√©but': r.dateDebut,
                'Date fin': r.dateFin, 'Nbr Nuits': r.nuits, 'Nbr Personnes': r.nbPersonnes,
                'Montant total': r.montant, 'Acompte': r.acompte, 'Montant restant': r.restant,
                'Paiement': r.paiement, 'Site': r.site
            }));
            const couzon = reservations.filter(r => r.gite === 'Couzon').map(r => ({
                'Noms': r.nom, 'Provenance': r.provenance, 'Date d√©but': r.dateDebut,
                'Date fin': r.dateFin, 'Nbr Nuits': r.nuits, 'Nbr Personnes': r.nbPersonnes,
                'Montant total': r.montant, 'Acompte': r.acompte, 'Montant restant': r.restant,
                'Paiement': r.paiement, 'Site': r.site
            }));
            
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(trevoux), 'Tr√©voux');
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(couzon), 'Couzon');
            XLSX.writeFile(wb, `Reservations_${new Date().toISOString().split('T')[0]}.xlsx`);
            showToast('‚úì Excel t√©l√©charg√© !');
        }
        
        async function sauvegarderTout() {
            try {
                await exportAllData();
                await exportToExcel();
                showToast('‚úì JSON + Excel sauvegard√©s !');
            } catch (error) {
                showToast('‚ùå Erreur lors de la sauvegarde');
                console.error(error);
            }
        }
        
        async function exportAllData() {
            const reservations = await getAllReservations();
            const backup = {
                version: '1.0',
                date: new Date().toISOString(),
                reservations: reservations
            };
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Sauvegarde_Gites_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('‚úì Sauvegarde t√©l√©charg√©e !');
        }
        
        async function importAllData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!confirm('‚ö†Ô∏è L\'import va REMPLACER toutes vos donn√©es. Continuer ?')) {
                event.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    const transaction = db.transaction(['reservations'], 'readwrite');
                    transaction.objectStore('reservations').clear();
                    
                    for (const r of backup.reservations) {
                        delete r.id;
                        await addReservation(r);
                    }
                    
                    await updateReservationsList();
                    await updateStats();
                    await updateArchivesDisplay();
                    showToast('‚úì Donn√©es import√©es !');
                    event.target.value = '';
                } catch (error) {
                    showToast('‚ùå Erreur import', 'error');
                    console.error(error);
                }
            };
            reader.readAsText(file);
        }
        
        // Gestionnaire formulaire charges
        document.getElementById('chargeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const charge = {
                gite: document.getElementById('chargeGite').value,
                nom: document.getElementById('chargeNom').value,
                montant: parseFloat(document.getElementById('chargeMontant').value),
                type: document.getElementById('chargeType').value,
                date: document.getElementById('chargeDate').value || new Date().toISOString().split('T')[0],
                notes: document.getElementById('chargeNotes').value,
                timestamp: new Date().toISOString()
            };
            
            await addCharge(charge);
            this.reset();
            await updateChargesDisplay();
            await updateStats(); // Mettre √† jour le graphique CA vs Charges
            showToast('‚úì Charge ajout√©e');
        });
        
        async function updateChargesDisplay() {
            const reservations = await getAllReservations();
            const charges = await getAllCharges();
            
            // Calcul recettes
            const totalRecettes = reservations.reduce((sum, r) => sum + r.montant, 0);
            
            // Calcul charges
            let totalCharges = 0;
            charges.forEach(c => {
                if (c.type === 'mensuelle') {
                    totalCharges += c.montant * 12;
                } else if (c.type === 'annuelle') {
                    totalCharges += c.montant;
                } else {
                    totalCharges += c.montant;
                }
            });
            
            // Calcul URSSAF (22% des recettes)
            const provisionUrssaf = totalRecettes * 0.22;
            
            // R√©sultat net
            const resultatNet = totalRecettes - totalCharges - provisionUrssaf;
            
            document.getElementById('totalRecettes').textContent = totalRecettes.toFixed(0) + ' ‚Ç¨';
            document.getElementById('totalCharges').textContent = totalCharges.toFixed(0) + ' ‚Ç¨';
            document.getElementById('provisionUrssaf').textContent = provisionUrssaf.toFixed(0) + ' ‚Ç¨';
            document.getElementById('resultatNet').textContent = resultatNet.toFixed(0) + ' ‚Ç¨';
            
            // Liste des charges
            const chargesList = document.getElementById('chargesList');
            if (charges.length === 0) {
                chargesList.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Aucune charge enregistr√©e</p>';
                return;
            }
            
            let html = '';
            charges.forEach(c => {
                html += `
                    <div class="charge-item">
                        <div class="charge-info">
                            <div class="charge-name">${c.nom} - ${c.gite}</div>
                            <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                                ${c.type.charAt(0).toUpperCase() + c.type.slice(1)} | ${formatDate(c.date)}
                                ${c.notes ? '<br>' + c.notes : ''}
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div class="charge-amount">${c.montant.toFixed(2)} ‚Ç¨</div>
                            <button class="btn btn-danger btn-small" onclick="deleteChargeById(${c.id})">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            });
            
            chargesList.innerHTML = html;
        }
        
        async function deleteChargeById(id) {
            if (confirm('Supprimer cette charge ?')) {
                await deleteCharge(id);
                await updateChargesDisplay();
                await updateStats(); // Mettre √† jour le graphique CA vs Charges
                showToast('‚úì Charge supprim√©e');
            }
        }
        
        // ==========================================
        // üìä GESTION DONN√âES HISTORIQUES
        // ==========================================
        
        function toggleHistoricalDataForm() {
            const form = document.getElementById('historicalDataForm');
            if (form.style.display === 'none') {
                form.style.display = 'block';
                displayHistoricalYearsList();
            } else {
                form.style.display = 'none';
            }
        }
        
        async function saveHistoricalData() {
            const year = parseInt(document.getElementById('historicalYear').value);
            const gite = document.getElementById('historicalGite').value;
            const currentYear = new Date().getFullYear();
            
            if (!year || year < 2000 || year >= currentYear) {
                showToast(`‚ö†Ô∏è Saisissez une ann√©e pr√©c√©dente (max: ${currentYear - 1})`, 'error');
                return;
            }
            
            const months = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
            const data = {
                year: year,
                gite: gite,
                months: {}
            };
            
            months.forEach(m => {
                const value = parseFloat(document.getElementById(`hist_${m}`).value) || 0;
                data.months[m] = value;
            });
            
            try {
                // Supprimer l'ancien si existe
                const existing = await getHistoricalData(year, gite);
                if (existing) {
                    await deleteHistoricalDataById(existing.id);
                }
                
                // Ajouter le nouveau avec Promise
                await new Promise((resolve, reject) => {
                    const transaction = db.transaction(['historicalData'], 'readwrite');
                    const request = transaction.objectStore('historicalData').add(data);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject('Erreur ajout');
                });
                
                showToast(`‚úì Donn√©es ${year} - ${gite} sauvegard√©es`);
                displayHistoricalYearsList();
                clearHistoricalForm();
                updateStats(); // Rafra√Æchir les graphiques
            } catch (error) {
                showToast('‚ùå Erreur sauvegarde', 'error');
                console.error(error);
            }
        }
        
        // ==========================================
        // üî• FONCTIONS HISTORICAL DATA - SUPABASE
        // ==========================================
        
        async function getHistoricalData(year, gite) {
            try {
                const { data, error } = await supabase
                    .from('historical_data')
                    .select('*')
                    .eq('year', year)
                    .eq('gite', gite)
                    .single();
                
                if (error && error.code !== 'PGRST116') throw error;
                return data;
            } catch (error) {
                console.error('Erreur getHistoricalData:', error);
                return null;
            }
        }
        
        async function getAllHistoricalData() {
            try {
                const { data, error } = await supabase
                    .from('historical_data')
                    .select('*')
                    .order('year', { ascending: false });
                
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('Erreur getAllHistoricalData:', error);
                return [];
            }
        }
        
        async function deleteHistoricalDataById(id) {
            try {
                const { error } = await supabase
                    .from('historical_data')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
            } catch (error) {
                console.error('Erreur deleteHistoricalDataById:', error);
                throw error;
            }
        }
        
        async function saveHistoricalDataTotal() {
            const year = parseInt(document.getElementById('historicalYear').value);
            
            if (!year || year < 2000 || year > 2030) {
                showToast('‚ö†Ô∏è Ann√©e invalide (entre 2000 et 2030)', 'error');
                return;
            }
            
            const months = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
            
            const monthsData = {};
            months.forEach(m => {
                const value = parseFloat(document.getElementById(`hist_total_${m}`).value) || 0;
                monthsData[m] = value;
            });
            
            try {
                const existing = await getHistoricalData(year, 'Total');
                
                if (existing) {
                    const { error } = await supabase
                        .from('historical_data')
                        .update({ months: monthsData })
                        .eq('id', existing.id);
                    
                    if (error) throw error;
                } else {
                    const { error } = await supabase
                        .from('historical_data')
                        .insert({ year: year, gite: 'Total', months: monthsData });
                    
                    if (error) throw error;
                }
                
                showToast(`‚úì Donn√©es ${year} sauvegard√©es`);
                displayHistoricalYearsList();
                clearHistoricalFormTotal();
                updateStats();
            } catch (error) {
                console.error('Erreur saveHistoricalDataTotal:', error);
                showToast('‚ùå Erreur sauvegarde: ' + error.message, 'error');
            }
        }
        
        async function loadHistoricalDataTotal() {
            const year = parseInt(document.getElementById('historicalYear').value);
            
            if (!year) {
                showToast('‚ö†Ô∏è S√©lectionnez une ann√©e', 'error');
                return;
            }
            
            const dataTotal = await getHistoricalData(year, 'Total');
            
            if (!dataTotal) {
                showToast(`‚ÑπÔ∏è Aucune donn√©e pour ${year}`, 'error');
                return;
            }
            
            const months = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
            months.forEach(m => {
                document.getElementById(`hist_total_${m}`).value = dataTotal.months[m] || 0;
            });
            
            showToast(`‚úì Donn√©es ${year} charg√©es`);
        }
        
        async function deleteHistoricalDataTotal() {
            const year = parseInt(document.getElementById('historicalYear').value);
            
            if (!year) {
                showToast('‚ö†Ô∏è S√©lectionnez une ann√©e', 'error');
                return;
            }
            
            if (!confirm(`Supprimer toutes les donn√©es ${year} ?`)) {
                return;
            }
            
            const dataTotal = await getHistoricalData(year, 'Total');
            
            if (dataTotal) {
                await deleteHistoricalDataById(dataTotal.id);
            }
            
            showToast(`‚úì Donn√©es ${year} supprim√©es`);
            clearHistoricalFormTotal();
            displayHistoricalYearsList();
            updateStats();
        }
        
        function clearHistoricalFormTotal() {
            document.getElementById('historicalYear').value = '';
            const months = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
            months.forEach(m => {
                document.getElementById(`hist_total_${m}`).value = '';
            });
        }
        
        // Fonctions anciennes - d√©sactiv√©es
        async function loadHistoricalData() {
            showToast('‚ö†Ô∏è Utilisez le formulaire Total', 'error');
        }
        
        async function deleteHistoricalData() {
            showToast('‚ö†Ô∏è Utilisez le formulaire Total', 'error');
        }
        
        function clearHistoricalForm() {
            clearHistoricalFormTotal();
        }
        
        async function displayHistoricalYearsList() {
            const data = await getAllHistoricalData();
            const container = document.getElementById('historicalYearsList');
            
            if (data.length === 0) {
                container.innerHTML = '<p style="color: #999; font-style: italic;">Aucune donn√©e historique enregistr√©e</p>';
                return;
            }
            
            // Grouper par ann√©e
            const byYear = {};
            data.forEach(d => {
                if (!byYear[d.year]) byYear[d.year] = {};
                byYear[d.year][d.gite] = d;
            });
            
            let html = '<div style="display: flex; flex-wrap: wrap; gap: 15px;">';
            Object.keys(byYear).sort().reverse().forEach(year => {
                html += `
                    <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid var(--border); min-width: 200px;">
                        <div style="font-weight: 700; color: var(--primary); margin-bottom: 10px; font-size: 1.1rem;">üìÖ ${year}</div>
                `;
                
                if (byYear[year]['Total']) {
                    const total = Object.values(byYear[year]['Total'].months).reduce((a, b) => a + b, 0);
                    html += `
                        <div style="margin-bottom: 5px;">
                            <span style="font-weight: 600;">Total:</span> ${total.toFixed(2)} ‚Ç¨
                        </div>
                    `;
                }
                
                html += '</div>';
            });
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // ==========================================
        // FIN GESTION DONN√âES HISTORIQUES
        // ==========================================
        
        // ==========================================
        // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è SECTION PLANNING M√âNAGE - VERROUILL√âE ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
        // ‚õî NE PAS MODIFIER SANS APPROBATION EXPLICITE DU CLIENT ‚õî
        // Cette section contient la logique m√©tier critique des r√®gles de m√©nage
        // Toute modification peut impacter la coh√©rence des dates dans :
        // - L'affichage des r√©servations
        // - Le planning m√©nage
        // - L'export Excel
        // ==========================================
        
        // G√©n√©ration planning m√©nage
        async function genererPlanningMenage() {
            const reservations = await getAllReservations();
            
            // Fonction pour v√©rifier si c'est un jour f√©ri√©
            function isJourFerie(date) {
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const day = date.getDate();
                
                // Jours f√©ri√©s fixes
                const feriesFixes = [
                    `${year}-01-01`, // Nouvel An
                    `${year}-05-01`, // F√™te du travail
                    `${year}-05-08`, // Victoire 1945
                    `${year}-07-14`, // F√™te nationale
                    `${year}-08-15`, // Assomption
                    `${year}-11-01`, // Toussaint
                    `${year}-11-11`, // Armistice 1918
                    `${year}-12-25`, // No√´l
                ];
                
                const dateKey = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                if (feriesFixes.includes(dateKey)) return true;
                
                // P√¢ques et jours mobiles (formule de Meeus/Jones/Butcher)
                const a = year % 19;
                const b = Math.floor(year / 100);
                const c = year % 100;
                const d = Math.floor(b / 4);
                const e = b % 4;
                const f = Math.floor((b + 8) / 25);
                const g = Math.floor((b - f + 1) / 3);
                const h = (19 * a + b - d - g + 15) % 30;
                const i = Math.floor(c / 4);
                const k = c % 4;
                const l = (32 + 2 * e + 2 * i - h - k) % 7;
                const m = Math.floor((a + 11 * h + 22 * l) / 451);
                const paquesMois = Math.floor((h + l - 7 * m + 114) / 31);
                const paquesJour = ((h + l - 7 * m + 114) % 31) + 1;
                
                const paques = new Date(year, paquesMois - 1, paquesJour);
                const lundiPaques = new Date(paques);
                lundiPaques.setDate(lundiPaques.getDate() + 1);
                const ascension = new Date(paques);
                ascension.setDate(ascension.getDate() + 39);
                const lundiPentecote = new Date(paques);
                lundiPentecote.setDate(lundiPentecote.getDate() + 50);
                
                const dateStr = date.toDateString();
                if (dateStr === lundiPaques.toDateString()) return true;
                if (dateStr === ascension.toDateString()) return true;
                if (dateStr === lundiPentecote.toDateString()) return true;
                
                return false;
            }
            
            // Filtrer mois en cours + prochain
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const nextMonth = currentMonth === 11 ? 0 : currentMonth + 1;
            const nextYear = currentMonth === 11 ? currentYear + 1 : currentYear;
            
            const relevant = reservations.filter(r => {
                const date = parseLocalDate(r.dateFin);
                const month = date.getMonth();
                const year = date.getFullYear();
                return (year === currentYear && month === currentMonth) || 
                       (year === nextYear && month === nextMonth);
            });
            
            relevant.sort((a, b) => parseLocalDate(a.dateFin) - parseLocalDate(b.dateFin));
            
            const planning = [];
            const menagesPrevus = {}; // Pour suivre les m√©nages d√©j√† pr√©vus par g√Æte/date
            
            relevant.forEach(r => {
                const departDate = parseLocalDate(r.dateFin);
                
                // Utiliser la fonction calculerDateMenage pour garantir la coh√©rence
                const dateMenageFormatted = calculerDateMenage(r, relevant);
                
                // Parser le r√©sultat pour extraire la date et l'heure
                // Format: "Lundi 23 d√©c. √† 12h00"
                const match = dateMenageFormatted.match(/(\w+) (\d+) (\w+)\. √† (\d+h\d+)/);
                if (!match) return;
                
                const [_, jourNom, jour, mois, heure] = match;
                
                // Reconstruire la date du m√©nage
                const moisMap = {
                    'janv': 0, 'f√©vr': 1, 'mars': 2, 'avr': 3, 'mai': 4, 'juin': 5,
                    'juil': 6, 'ao√ªt': 7, 'sept': 8, 'oct': 9, 'nov': 10, 'd√©c': 11
                };
                
                const menageDate = new Date(departDate);
                menageDate.setMonth(moisMap[mois]);
                menageDate.setDate(parseInt(jour));
                
                // Si le mois du m√©nage est < mois du d√©part, c'est l'ann√©e suivante
                if (menageDate < departDate) {
                    menageDate.setFullYear(menageDate.getFullYear() + 1);
                }
                
                // V√©rifier enchainement
                const arriveeMemejour = relevant.find(resa => 
                    resa.gite === r.gite && 
                    resa.id !== r.id &&
                    parseLocalDate(resa.dateDebut).toDateString() === departDate.toDateString()
                );
                
                planning.push({
                    date: menageDate,
                    heure: heure,
                    gite: r.gite,
                    clientName: r.nom,
                    departDate: departDate,
                    enchainement: arriveeMemejour ? true : false
                });
            });
            
            if (planning.length === 0) {
                showToast('Aucun m√©nage √† planifier', 'error');
                return;
            }
            
            // Afficher
            const menageDiv = document.getElementById('menagePlanning');
            let html = '<div class="card" style="margin-top: 20px;"><h3 style="margin-bottom: 20px;">Planning g√©n√©r√© (mois en cours + prochain)</h3>';
            
            planning.forEach(p => {
                const enchainementBadge = p.enchainement ? ' <span style="background: #f39c12; color: white; padding: 2px 8px; border-radius: 5px; font-size: 0.8rem;">‚ö° Enchainement</span>' : '';
                html += `
                    <div class="menage-item">
                        <div class="menage-date">
                            üìÖ ${p.date.toLocaleDateString('fr-FR')} - ${['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'][p.date.getDay()]}
                            √† ${p.heure}${enchainementBadge}
                        </div>
                        <div class="menage-detail">
                            üèòÔ∏è <strong>${p.gite}</strong> - Client: ${p.clientName} (d√©part le ${p.departDate.toLocaleDateString('fr-FR')})
                        </div>
                    </div>
                `;
            });
            
            html += `
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-success" onclick="telechargerPlanningMenage()" style="max-width: 400px;">
                        <span>üì•</span> T√©l√©charger le planning Excel
                    </button>
                </div>
            </div>`;
            menageDiv.innerHTML = html;
            
            // Pr√©parer les donn√©es Excel mais ne pas t√©l√©charger automatiquement
            window.planningMenageData = planning.map(p => ({
                'üìÖ Date': p.date.toLocaleDateString('fr-FR', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' }),
                '‚è∞ Heure': p.heure,
                'üè† G√Æte': p.gite,
                'üë§ Client': p.clientName,
                'üö™ D√©part': p.departDate.toLocaleDateString('fr-FR', { weekday: 'short', day: '2-digit', month: 'short' }),
                '‚ö° Enchainement': p.enchainement ? 'OUI' : 'Non'
            }));
            
            showToast(`‚úì Planning g√©n√©r√© ! ${planning.length} m√©nages planifi√©s`);
        }
        
        function telechargerPlanningMenage() {
            if (!window.planningMenageData || window.planningMenageData.length === 0) {
                showToast('Aucun planning √† t√©l√©charger. G√©n√©rez d\'abord le planning.', 'error');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(window.planningMenageData);
            
            // D√©finir les largeurs de colonnes
            ws['!cols'] = [
                { wch: 35 }, // Date compl√®te
                { wch: 10 }, // Heure
                { wch: 12 }, // G√Æte
                { wch: 20 }, // Client
                { wch: 15 }, // D√©part
                { wch: 15 }  // Enchainement
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'Planning M√©nages');
            const dateToday = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `MenageCalvignac_${dateToday}.xlsx`);
            
            showToast('‚úì Planning Excel t√©l√©charg√©');
        }
        
        // ==========================================
        // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è FIN SECTION PLANNING M√âNAGE - VERROUILL√âE ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
        // ==========================================
        
        async function exportPlanningMenageMois() {
            const monthInput = document.getElementById('menageExportMonth').value;
            if (!monthInput) {
                showToast('S√©lectionnez un mois √† exporter', 'error');
                return;
            }

            const [yearStr, monthStr] = monthInput.split('-');
            const targetYear = parseInt(yearStr, 10);
            const targetMonth = parseInt(monthStr, 10) - 1;

            const reservations = await getAllReservations();
            if (!reservations || reservations.length === 0) {
                showToast('Aucune r√©servation enregistr√©e', 'error');
                return;
            }

            // On calcule un planning global puis on filtre sur le mois demand√©
            const relevant = [...reservations].sort((a, b) => parseLocalDate(a.dateFin) - parseLocalDate(b.dateFin));

            const planning = [];
            const occupiedSlots = {};

            relevant.forEach(r => {
                const departDate = parseLocalDate(r.dateFin);
                if (isNaN(departDate)) return;

                const departDay = departDate.getDay();

                const arriveeMemejour = relevant.find(resa =>
                    resa.gite === r.gite &&
                    parseLocalDate(resa.dateDebut).toDateString() === departDate.toDateString()
                );

                let menageDate = new Date(departDate);
                let heure = '12h00';

                // R√àGLE 1: D√©part dimanche
                if (departDay === 0) {
                    if (!arriveeMemejour) {
                        menageDate.setDate(menageDate.getDate() + 1);
                        const arriveeLundi = relevant.find(resa =>
                            resa.gite === r.gite &&
                            parseLocalDate(resa.dateDebut).toDateString() === menageDate.toDateString()
                        );
                        heure = arriveeLundi ? '07h00' : '12h00';
                    } else {
                        heure = '12h00';
                    }
                }
                // R√àGLE 2: Samedi
                else if (departDay === 6) {
                    if (arriveeMemejour) {
                        heure = '12h00';
                    } else {
                        menageDate.setDate(menageDate.getDate() + 2);
                        heure = '12h00';
                    }
                }
                // R√àGLE 3: Lundi-Vendredi
                else {
                    heure = '12h00';
                }

                const dateKey = menageDate.toISOString().split('T')[0];
                const period = heure === '07h00' ? 'matin' : 'apr√®s-midi';

                if (!occupiedSlots[dateKey]) {
                    occupiedSlots[dateKey] = { matin: null, 'apr√®s-midi': null };
                }

                if (!occupiedSlots[dateKey][period]) {
                    occupiedSlots[dateKey][period] = r.gite;
                    planning.push({
                        date: menageDate,
                        heure: heure,
                        period: period,
                        gite: r.gite,
                        clientName: r.nom,
                        departDate: departDate
                    });
                } else {
                    const autreCreneau = period === 'matin' ? 'apr√®s-midi' : 'matin';
                    const autreHeure = period === 'matin' ? '12h00' : '07h00';

                    if (!occupiedSlots[dateKey][autreCreneau]) {
                        occupiedSlots[dateKey][autreCreneau] = r.gite;
                        planning.push({
                            date: menageDate,
                            heure: autreHeure,
                            period: autreCreneau,
                            gite: r.gite,
                            clientName: r.nom,
                            departDate: departDate
                        });
                    }
                }
            });

            const planningForMonth = planning.filter(p =>
                p.date.getFullYear() === targetYear && p.date.getMonth() === targetMonth
            );

            if (planningForMonth.length === 0) {
                showToast('Aucun m√©nage √† planifier pour ce mois', 'error');
                return;
            }

            // Cr√©er le workbook avec style
            const wb = XLSX.utils.book_new();
            
            // Pr√©parer les donn√©es avec formatage
            const data = planningForMonth.map(p => ({
                'üìÖ Date': p.date.toLocaleDateString('fr-FR', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' }),
                '‚è∞ Heure': p.heure,
                'üè† G√Æte': p.gite,
                'üë§ Client': p.clientName,
                'üö™ D√©part': p.departDate.toLocaleDateString('fr-FR'),
                '‚ö° Enchainement': p.period === 'matin' ? 'Oui' : 'Non'
            }));

            // Cr√©er la feuille
            const ws = XLSX.utils.json_to_sheet(data);
            
            // D√©finir les largeurs de colonnes
            ws['!cols'] = [
                { wch: 35 }, // Date
                { wch: 10 }, // Heure
                { wch: 12 }, // G√Æte
                { wch: 20 }, // Client
                { wch: 12 }, // D√©part
                { wch: 15 }  // Enchainement
            ];
            
            const sheetName = `M√©nages ${monthInput}`;
            XLSX.utils.book_append_sheet(wb, ws, sheetName.substring(0, 31));
            const dateToday = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `MenageCalvignac_${dateToday}.xlsx`);

            showToast(`‚úì Export Excel t√©l√©charg√© ! (${planningForMonth.length} m√©nages)`);
        }

        
        
        // ========== GESTION INFOS G√éTES - VOIR SECTION INFOS PRATIQUES ==========
        
        // Fonction de compatibilit√© pour charger les infos du nouveau syst√®me
        function loadInfosGites(gite) {
            const allData = JSON.parse(localStorage.getItem('gites_infos_pratiques_complet') || '{}');
            const data = allData[gite] || {};
            
            // Transformer au format attendu par l'ancien syst√®me (compatibilit√©)
            return {
                wifi: data.wifiPassword || '',
                codeCle: data.codeAcces || '',
                adresse: data.adresse || '',
                instructionsArrivee: data.instructionsCles || '',
                instructionsDepart: data.checklistDepart || '',
                infosComplementaires: ''
            };
        }
        
        // G√©n√©rer page client HTML
        async function genererPageClient(reservationId) {
            const reservations = await getAllReservations();
            const reservation = reservations.find(r => r.id === reservationId);
            
            if (!reservation) {
                showToast('R√©servation introuvable', 'error');
                return;
            }
            
            // V√©rifier si le t√©l√©phone est renseign√©
            if (!reservation.telephone || reservation.telephone.trim() === '') {
                if (confirm('‚ö†Ô∏è Aucun num√©ro de t√©l√©phone renseign√©.\n\nVoulez-vous ajouter un t√©l√©phone maintenant ?')) {
                    openEditModal(reservationId);
                }
                return;
            }
            
            // Cr√©er un modal de choix personnalis√©
            const choixModal = document.createElement('div');
            choixModal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            choixModal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 20px; max-width: 550px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                    <h2 style="margin-bottom: 20px; color: #667eea;">üì± Envoyer les infos au client</h2>
                    <p style="margin-bottom: 10px; font-size: 1.1rem;"><strong>${reservation.nom}</strong></p>
                    <p style="margin-bottom: 25px; color: #666;">üì± ${reservation.telephone}</p>
                    
                    <div style="background: #E8F5E9; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: left; font-size: 0.9rem;">
                        <strong style="color: #25D366;">üí° Conseil WhatsApp Business :</strong><br>
                        <span style="color: #555;">
                        ‚Ä¢ Installez "WhatsApp Business" (app s√©par√©e)<br>
                        ‚Ä¢ Utilisez votre num√©ro professionnel<br>
                        ‚Ä¢ Gardez votre WhatsApp perso s√©par√©
                        </span>
                    </div>
                    
                    <div style="display: grid; gap: 15px; margin-bottom: 20px;">
                        <button onclick="aper√ßuFicheClient(${reservationId})" style="padding: 15px; border: none; border-radius: 12px; background: linear-gradient(135deg, #FF6B6B 0%, #EE5A52 100%); color: white; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 15px rgba(255,107,107,0.3);">
                            <span style="font-size: 1.5rem;">üìã</span> <span>Aper√ßu Fiche Client</span>
                        </button>
                        
                        <button onclick="envoyerViaWhatsApp(${reservationId})" style="padding: 15px; border: none; border-radius: 12px; background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 15px rgba(37,211,102,0.3);">
                            <span style="font-size: 1.5rem;">üíº</span> <span>WhatsApp Business</span>
                        </button>
                        
                        <button onclick="envoyerViaSMS(${reservationId})" style="padding: 15px; border: none; border-radius: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 15px rgba(102,126,234,0.3);">
                            <span style="font-size: 1.5rem;">üí¨</span> <span>SMS</span>
                        </button>
                        
                        <button onclick="telechargerSeulementHTML(${reservationId})" style="padding: 12px; border: none; border-radius: 10px; background: #f0f0f0; color: #666; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                            <span style="font-size: 1.3rem;">üìÑ</span> <span>T√©l√©charger HTML seulement</span>
                        </button>
                    </div>
                    
                    <button onclick="this.closest('div').parentElement.remove()" style="padding: 10px 20px; border: 1px solid #ddd; border-radius: 8px; background: white; color: #666; cursor: pointer; font-size: 0.95rem;">
                        Annuler
                    </button>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #FFF3E0; border-radius: 10px; text-align: left; font-size: 0.85rem;">
                        <strong style="color: #F57C00;">‚ö†Ô∏è Premi√®re utilisation :</strong><br>
                        <span style="color: #666;">
                        1. T√©l√©chargez "WhatsApp Business" depuis Play Store/App Store<br>
                        2. Configurez avec votre num√©ro professionnel des g√Ætes<br>
                        3. Cr√©ez un profil avec nom "G√Ætes Calvignac" + adresse<br>
                        4. Cliquez sur "WhatsApp Business" ci-dessus
                        </span>
                    </div>
                </div>
            `;
            document.body.appendChild(choixModal);
        }
        
        async function envoyerViaWhatsApp(reservationId) {
            // Fermer le modal
            document.querySelectorAll('div[style*="z-index: 10000"]').forEach(el => el.remove());
            
            const reservations = await getAllReservations();
            const reservation = reservations.find(r => r.id === reservationId);
            const infosGite = loadInfosGites(reservation.gite);
            
            // Nettoyer le num√©ro de t√©l√©phone pour WhatsApp
            let telephone = reservation.telephone.replace(/\s/g, '').replace(/\+/g, '');
            
            // Si commence par 0, remplacer par 33
            if (telephone.startsWith('0')) {
                telephone = '33' + telephone.substring(1);
            } else if (!telephone.startsWith('33')) {
                telephone = '33' + telephone;
            }
            
            // Construire le message
            let message = `Bonjour ${reservation.nom},\n\n`;
            message += `Bienvenue au G√Æte de ${reservation.gite} ! üè°\n\n`;
            message += `üìÖ *Votre s√©jour*\n`;
            message += `Arriv√©e: ${formatDate(reservation.dateDebut)}\n`;
            message += `D√©part: ${formatDate(reservation.dateFin)}\n`;
            message += `Dur√©e: ${reservation.nuits} nuit${reservation.nuits > 1 ? 's' : ''}\n\n`;
            
            if (infosGite.adresse) {
                message += `üìç *Adresse*\n${infosGite.adresse}\n\n`;
            }
            
            message += `üîë *Acc√®s au g√Æte*\n`;
            if (infosGite.codeCle) {
                message += `Code bo√Æte √† cl√©s: *${infosGite.codeCle}*\n`;
            }
            if (infosGite.wifi) {
                message += `WiFi: *${infosGite.wifi}*\n`;
            }
            
            message += `\nNous vous souhaitons un excellent s√©jour ! üåü`;
            
            // Ouvrir WhatsApp
            const whatsappLink = `https://wa.me/${telephone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappLink, '_blank');
            
            // Marquer comme envoy√©
            await updateReservation(reservationId, { messageEnvoye: true });
            await updateReservationsList();
            
            // Aussi t√©l√©charger la page HTML
            setTimeout(() => {
                telechargerPageHTML(reservation);
            }, 1000);
            
            showToast(`‚úì WhatsApp ouvert pour ${reservation.nom}`);
        }
        
        async function envoyerViaSMS(reservationId) {
            // Fermer le modal
            document.querySelectorAll('div[style*="z-index: 10000"]').forEach(el => el.remove());
            
            const reservations = await getAllReservations();
            const reservation = reservations.find(r => r.id === reservationId);
            const infosGite = loadInfosGites(reservation.gite);
            
            // Nettoyer le num√©ro de t√©l√©phone
            let telephone = reservation.telephone.replace(/\s/g, '');
            
            // Si le num√©ro ne commence pas par +, ajouter +33
            if (!telephone.startsWith('+')) {
                if (telephone.startsWith('0')) {
                    telephone = '+33' + telephone.substring(1);
                } else if (!telephone.startsWith('33')) {
                    telephone = '+33' + telephone;
                }
            }
            
            // Construire le message SMS
            let message = `Bonjour ${reservation.nom},\n\n`;
            message += `Bienvenue au G√Æte de ${reservation.gite} !\n\n`;
            message += `üìÖ S√©jour du ${formatDate(reservation.dateDebut)} au ${formatDate(reservation.dateFin)}\n\n`;
            
            if (infosGite.adresse) {
                message += `üìç ${infosGite.adresse}\n\n`;
            }
            
            if (infosGite.codeCle) {
                message += `üîë Code: ${infosGite.codeCle}\n`;
            }
            
            if (infosGite.wifi) {
                message += `üì∂ WiFi: ${infosGite.wifi}\n`;
            }
            
            message += `\nBon s√©jour ! üåü`;
            
            // Cr√©er le lien SMS
            const smsLink = `sms:${telephone}?body=${encodeURIComponent(message)}`;
            window.location.href = smsLink;
            
            // Marquer comme envoy√©
            await updateReservation(reservationId, { messageEnvoye: true });
            await updateReservationsList();
            
            // Aussi t√©l√©charger la page HTML
            setTimeout(() => {
                telechargerPageHTML(reservation);
            }, 500);
            
            showToast(`‚úì SMS pr√©par√© pour ${reservation.nom}`);
        }
        
        async function telechargerSeulementHTML(reservationId) {
            // Fermer le modal
            document.querySelectorAll('div[style*="z-index: 10000"]').forEach(el => el.remove());
            
            // Utiliser la nouvelle fonction de g√©n√©ration compl√®te
            await aper√ßuFicheClient(reservationId);
        }
        
        function telechargerPageHTML(reservation) {
            const infosGite = loadInfosGites(reservation.gite);
            
            const htmlContent = `<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bienvenue ${reservation.nom} - G√Æte ${reservation.gite}</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Work+Sans:wght@300;400;600&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Work Sans', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            color: #2C3E50;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            font-family: 'Playfair Display', serif;
            color: #667eea;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .subtitle {
            text-align: center;
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 30px;
            font-weight: 300;
        }
        
        .info-box {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
        }
        
        .info-box h2 {
            color: #667eea;
            font-size: 1.5rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-item {
            margin: 10px 0;
            font-size: 1.1rem;
            line-height: 1.6;
        }
        
        .info-item strong {
            color: #2C3E50;
            display: inline-block;
            min-width: 150px;
        }
        
        .code {
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1.3rem;
            display: inline-block;
            margin-left: 10px;
        }
        
        .section {
            margin: 30px 0;
        }
        
        ul {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        li {
            margin: 8px 0;
            line-height: 1.6;
        }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
            color: #666;
        }
        
        @media print {
            body { background: white; padding: 0; }
            .container { box-shadow: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè° Bienvenue ${reservation.nom} !</h1>
        <div class="subtitle">G√Æte de ${reservation.gite}</div>
        
        <div class="info-box">
            <h2>üìÖ Votre S√©jour</h2>
            <div class="info-item"><strong>Arriv√©e :</strong> ${formatDate(reservation.dateDebut)}</div>
            <div class="info-item"><strong>D√©part :</strong> ${formatDate(reservation.dateFin)}</div>
            <div class="info-item"><strong>Dur√©e :</strong> ${reservation.nuits} nuit${reservation.nuits > 1 ? 's' : ''}</div>
            ${infosGite.adresse ? `<div class="info-item"><strong>üìç Adresse :</strong> ${infosGite.adresse}</div>` : ''}
        </div>
        
        <div class="info-box">
            <h2>üîë Acc√®s au G√Æte</h2>
            ${infosGite.codeCle ? `<div class="info-item"><strong>Code bo√Æte √† cl√©s :</strong><span class="code">${infosGite.codeCle}</span></div>` : '<div class="info-item">Le code vous sera communiqu√© s√©par√©ment.</div>'}
            ${infosGite.wifi ? `<div class="info-item"><strong>üì∂ WiFi :</strong><span class="code">${infosGite.wifi}</span></div>` : ''}
        </div>
        
        ${infosGite.instructionsArrivee ? `
        <div class="section">
            <h2 style="color: #27AE60; margin-bottom: 15px;">‚úÖ Instructions d'Arriv√©e</h2>
            <div style="background: #f0f9f4; padding: 20px; border-radius: 10px; white-space: pre-wrap;">${infosGite.instructionsArrivee}</div>
        </div>
        ` : ''}
        
        ${infosGite.instructionsDepart ? `
        <div class="section">
            <h2 style="color: #E74C3C; margin-bottom: 15px;">üö™ Instructions de D√©part</h2>
            <div style="background: #fef5f5; padding: 20px; border-radius: 10px; white-space: pre-wrap;">${infosGite.instructionsDepart}</div>
        </div>
        ` : ''}
        
        ${infosGite.infosComplementaires ? `
        <div class="section">
            <h2 style="color: #667eea; margin-bottom: 15px;">‚ÑπÔ∏è Informations Compl√©mentaires</h2>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; white-space: pre-wrap;">${infosGite.infosComplementaires}</div>
        </div>
        ` : ''}
        
        ${(() => {
            // Charger les activit√©s selon le g√Æte
            const restaurants = JSON.parse(localStorage.getItem('restaurants') || '{}');
            const activites = JSON.parse(localStorage.getItem('activites') || '{}');
            const restaurantsGite = reservation.gite === 'Tr√©voux' ? restaurants.trevoux : restaurants.couzon;
            const activitesGite = reservation.gite === 'Tr√©voux' ? activites.trevoux : activites.couzon;
            const lyon = localStorage.getItem('activitesLyon') || '';
            const dombes = localStorage.getItem('activitesDombes') || '';
            const parcsZoo = localStorage.getItem('parcsZoo') || '';
            
            let sectionsHTML = '';
            
            // Restaurants
            if (restaurantsGite) {
                sectionsHTML += `
                <div class="section">
                    <h2 style="color: #f5576c; margin-bottom: 15px;">üçΩÔ∏è Nos Restaurants Recommand√©s</h2>
                    <div style="background: #fff5f7; padding: 20px; border-radius: 10px; white-space: pre-wrap; line-height: 1.8;">${restaurantsGite}</div>
                </div>`;
            }
            
            // Activit√©s locales
            if (activitesGite) {
                sectionsHTML += `
                <div class="section">
                    <h2 style="color: #4facfe; margin-bottom: 15px;">üéØ Activit√©s √† Proximit√©</h2>
                    <div style="background: #f0f9ff; padding: 20px; border-radius: 10px; white-space: pre-wrap; line-height: 1.8;">${activitesGite}</div>
                </div>`;
            }
            
            // Lyon
            if (lyon) {
                sectionsHTML += `
                <div class="section">
                    <h2 style="color: #fa709a; margin-bottom: 15px;">üèõÔ∏è D√©couvrir Lyon (30-40 min)</h2>
                    <div style="background: #fff8f0; padding: 20px; border-radius: 10px; white-space: pre-wrap; line-height: 1.8;">${lyon}</div>
                </div>`;
            }
            
            // Dombes
            if (dombes) {
                sectionsHTML += `
                <div class="section">
                    <h2 style="color: #a8edea; margin-bottom: 15px;">ü¶Ü Les Dombes (15-30 min)</h2>
                    <div style="background: #f0fffe; padding: 20px; border-radius: 10px; white-space: pre-wrap; line-height: 1.8;">${dombes}</div>
                </div>`;
            }
            
            // Parcs Zoo
            if (parcsZoo) {
                sectionsHTML += `
                <div class="section">
                    <h2 style="color: #fcb69f; margin-bottom: 15px;">ü¶Å Parcs Animaliers du Secteur</h2>
                    <div style="background: #fff8f0; padding: 20px; border-radius: 10px; white-space: pre-wrap; line-height: 1.8;">${parcsZoo}</div>
                </div>`;
            }
            
            return sectionsHTML;
        })()}
        
        <div class="footer">
            <p>Nous vous souhaitons un excellent s√©jour ! üåü</p>
            <p style="margin-top: 10px; font-size: 0.9rem;">Pour toute question, n'h√©sitez pas √† nous contacter.</p>
        </div>
    </div>
</body>
</html>`;
            
            // T√©l√©charger le fichier HTML
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const dateToday = new Date().toISOString().split('T')[0];
            a.download = `Bienvenue_${reservation.nom.replace(/[^a-zA-Z0-9]/g, '_')}_${dateToday}.html`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast(`‚úì Page client g√©n√©r√©e pour ${reservation.nom}`);
        }
        
        
        // ========== GESTION ACTIVIT√âS & SORTIES ==========
        
        function sauvegarderRestaurants() {
            const data = {
                trevoux: document.getElementById('restaurantsTrevoux').value,
                couzon: document.getElementById('restaurantsCouzon').value
            };
            localStorage.setItem('restaurants', JSON.stringify(data));
            showToast('‚úì Restaurants sauvegard√©s');
        }
        
        function sauvegarderActivites() {
            const data = {
                trevoux: document.getElementById('activitesTrevoux').value,
                couzon: document.getElementById('activitesCouzon').value
            };
            localStorage.setItem('activites', JSON.stringify(data));
            showToast('‚úì Activit√©s sauvegard√©es');
        }
        
        function sauvegarderLyon() {
            localStorage.setItem('activitesLyon', document.getElementById('activitesLyon').value);
            showToast('‚úì Activit√©s Lyon sauvegard√©es');
        }
        
        function sauvegarderDombes() {
            localStorage.setItem('activitesDombes', document.getElementById('activitesDombes').value);
            showToast('‚úì Activit√©s Dombes sauvegard√©es');
        }
        
        function sauvegarderParcsZoo() {
            localStorage.setItem('parcsZoo', document.getElementById('parcsZoo').value);
            showToast('‚úì Parcs Zoo sauvegard√©s');
        }
        
        function chargerActivitesEtSorties() {
            // Restaurants
            const restaurants = localStorage.getItem('restaurants');
            if (restaurants) {
                const data = JSON.parse(restaurants);
                document.getElementById('restaurantsTrevoux').value = data.trevoux || '';
                document.getElementById('restaurantsCouzon').value = data.couzon || '';
            }
            
            // Activit√©s
            const activites = localStorage.getItem('activites');
            if (activites) {
                const data = JSON.parse(activites);
                document.getElementById('activitesTrevoux').value = data.trevoux || '';
                document.getElementById('activitesCouzon').value = data.couzon || '';
            }
            
            // Lyon
            const lyon = localStorage.getItem('activitesLyon');
            if (lyon) document.getElementById('activitesLyon').value = lyon;
            
            // Dombes
            const dombes = localStorage.getItem('activitesDombes');
            if (dombes) document.getElementById('activitesDombes').value = dombes;
            
            // Parcs Zoo
            const parcsZoo = localStorage.getItem('parcsZoo');
            if (parcsZoo) document.getElementById('parcsZoo').value = parcsZoo;
        }
        
        // Recherche d'√©v√©nements saisonniers
        async function rechercherEvenements() {
            const btnRecherche = event.target;
            const resultatsDiv = document.getElementById('evenementsResultats');
            const contentDiv = document.getElementById('evenementsContent');
            
            btnRecherche.disabled = true;
            btnRecherche.innerHTML = '<span>‚è≥</span> Recherche en cours...';
            
            try {
                // Recherche web pour √©v√©nements locaux
                const queries = [
                    '√©v√©nements Tr√©voux agenda',
                    '√©v√©nements Ain sorties ce week-end',
                    'festivals Dombes 2024 2025',
                    'agenda sorties Lyon m√©tropole'
                ];
                
                let htmlContent = '<h3 style="color: #667eea; margin-bottom: 20px;">üéâ √âv√©nements du secteur</h3>';
                htmlContent += '<div style="display: grid; gap: 15px;">';
                
                // On pourrait utiliser web_search ici mais pour l'instant on affiche un guide
                htmlContent += `
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #667eea;">
                        <h4 style="color: #667eea; margin-bottom: 10px;">üìÖ Sources recommand√©es :</h4>
                        <ul style="margin-left: 20px; line-height: 2;">
                            <li><a href="https://www.ain-tourisme.com/agenda/" target="_blank" style="color: #667eea;">Ain Tourisme - Agenda</a></li>
                            <li><a href="https://www.trevoux.fr/agenda/" target="_blank" style="color: #667eea;">Mairie de Tr√©voux - √âv√©nements</a></li>
                            <li><a href="https://www.lyoncitycard.com/agenda/" target="_blank" style="color: #667eea;">Lyon City Card - Agenda</a></li>
                            <li><a href="https://www.dombes-tourisme.com/" target="_blank" style="color: #667eea;">Office de Tourisme Dombes</a></li>
                            <li><a href="https://www.sortiralyon.fr/" target="_blank" style="color: #667eea;">Sortir √† Lyon</a></li>
                        </ul>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 20px; border-radius: 10px; border-left: 4px solid #ffc107;">
                        <h4 style="color: #856404; margin-bottom: 10px;">üí° √âv√©nements saisonniers r√©currents :</h4>
                        <ul style="margin-left: 20px; line-height: 2; color: #856404;">
                            <li><strong>Janvier-F√©vrier :</strong> Carnaval de Lyon, F√™te des Lumi√®res (d√©cembre)</li>
                            <li><strong>Mars-Avril :</strong> Printemps des Dombes, march√©s de printemps</li>
                            <li><strong>Mai-Juin :</strong> F√™te de la Nature, randonn√©es d√©couverte</li>
                            <li><strong>Juillet-Ao√ªt :</strong> Festivals d'√©t√©, Nuits de Fourvi√®re Lyon</li>
                            <li><strong>Septembre-Octobre :</strong> Journ√©es du Patrimoine, vendanges Beaujolais</li>
                            <li><strong>Novembre-D√©cembre :</strong> F√™te des Lumi√®res Lyon (8 d√©c), march√©s de No√´l</li>
                        </ul>
                    </div>
                    
                    <div style="background: #e7f3ff; padding: 20px; border-radius: 10px; border-left: 4px solid #2196f3;">
                        <h4 style="color: #1976d2; margin-bottom: 10px;">üé≠ Lieux culturels permanents :</h4>
                        <ul style="margin-left: 20px; line-height: 2; color: #1976d2;">
                            <li><strong>Op√©ra de Lyon</strong> - Spectacles toute l'ann√©e</li>
                            <li><strong>Th√©√¢tre des C√©lestins</strong> - Lyon</li>
                            <li><strong>Mus√©e des Confluences</strong> - Expositions temporaires</li>
                            <li><strong>Auditorium Maurice Ravel</strong> - Concerts classiques</li>
                            <li><strong>Transbordeur</strong> - Concerts rock/√©lectro</li>
                        </ul>
                    </div>
                `;
                
                htmlContent += '</div>';
                
                contentDiv.innerHTML = htmlContent;
                resultatsDiv.style.display = 'block';
                
                // Sauvegarder la date de derni√®re recherche
                localStorage.setItem('derniereRechercheEvenements', new Date().toISOString());
                
                showToast('‚úì √âv√©nements mis √† jour');
                
            } catch (error) {
                contentDiv.innerHTML = '<div style="color: #e74c3c; padding: 20px;">‚ùå Erreur lors de la recherche. R√©essayez plus tard.</div>';
            } finally {
                btnRecherche.disabled = false;
                btnRecherche.innerHTML = '<span>üîç</span> Rechercher les √©v√©nements actuels';
            }
        }
        
        async function clearAllData() {
            if (!confirm('‚ö†Ô∏è ATTENTION ! Supprimer TOUTES les donn√©es ? Cette action est IRR√âVERSIBLE.')) return;
            if (!confirm('√ätes-vous VRAIMENT s√ªr ? Toutes les r√©servations seront perdues !')) return;
            
            const transaction = db.transaction(['reservations'], 'readwrite');
            transaction.objectStore('reservations').clear();
            
            await updateReservationsList();
            await updateStats();
            await updateArchivesDisplay();
            showToast('‚úì Toutes les donn√©es supprim√©es');
        }
        
        // Click en dehors de la modal pour fermer
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });
        
        // Initialisation
        (async () => {
            await initDB();
            
            // Peupler la liste d√©roulante des ann√©es
            await populateYearFilter();
            
            await updateReservationsList();
            await updateStats();
            chargerActivitesEtSorties(); // Charger les activit√©s
            chargerUrlsIcal(); // Charger les URLs iCal
            
            // Afficher le dernier statut de synchronisation
            const lastSync = localStorage.getItem('lastSyncStatus');
            if (lastSync) {
                const status = JSON.parse(lastSync);
                const syncStatus = document.getElementById('syncStatus');
                const syncStatusIcon = document.getElementById('syncStatusIcon');
                const syncStatusText = document.getElementById('syncStatusText');
                
                if (syncStatus) {
                    const date = new Date(status.date);
                    const dateStr = date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric' });
                    const timeStr = date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                    
                    syncStatus.style.display = 'block';
                    if (status.errors > 0) {
                        syncStatus.style.background = '#fff3cd';
                        syncStatusIcon.textContent = '‚ö†Ô∏è';
                        syncStatusText.textContent = `Derni√®re synchronisation avec ${status.errors} erreur(s) - ${dateStr} √† ${timeStr}`;
                    } else {
                        syncStatus.style.background = '#d4edda';
                        syncStatusIcon.textContent = '‚úì';
                        syncStatusText.textContent = `Derni√®re synchronisation : ${dateStr} √† ${timeStr} (${status.added} r√©servations)`;
                    }
                }
            }
            
            // Synchronisation automatique au chargement
            setTimeout(async () => {
                try {
                    await syncAllCalendars();
                } catch (error) {
                    console.error('Erreur sync auto:', error);
                }
            }, 1000); // Attendre 1 seconde apr√®s le chargement
        })();
        
        // ==========================================
        // üìã GESTION INFOS PRATIQUES ULTRA-COMPLET
        // ==========================================
        
        (function() {
            let currentGiteInfos = 'Tr√©voux';
            const DB_KEY_INFOS = 'gites_infos_pratiques_complet';
            
            // ==========================================
            // üíæ SAUVEGARDE EN BASE DE DONN√âES SUPABASE
            // ==========================================
            
            async function saveInfosGiteToSupabase(gite, formData) {
                try {
                    // V√©rifier si une entr√©e existe d√©j√† pour ce g√Æte
                    const { data: existing, error: checkError } = await supabase
                        .from('infos_gites')
                        .select('id')
                        .eq('gite_nom', gite)
                        .single();
                    
                    const dataToSave = {
                        gite_nom: gite,
                        data: formData,
                        updated_at: new Date().toISOString()
                    };
                    
                    if (existing) {
                        // UPDATE
                        const { error } = await supabase
                            .from('infos_gites')
                            .update(dataToSave)
                            .eq('gite_nom', gite);
                        
                        if (error) throw error;
                    } else {
                        // INSERT
                        const { error } = await supabase
                            .from('infos_gites')
                            .insert([dataToSave]);
                        
                        if (error) throw error;
                    }
                    
                    console.log(`‚úÖ Infos ${gite} sauvegard√©es en base de donn√©es`);
                    return true;
                } catch (error) {
                    console.error('Erreur sauvegarde Supabase:', error);
                    showNotification('‚ö†Ô∏è Sauvegarde locale OK, mais erreur sync cloud', 'warning');
                    return false;
                }
            }
            
            async function loadInfosGiteFromSupabase(gite) {
                try {
                    const { data, error } = await supabase
                        .from('infos_gites')
                        .select('data')
                        .eq('gite_nom', gite)
                        .single();
                    
                    if (error) {
                        if (error.code === 'PGRST116') {
                            // Pas de donn√©es, c'est normal pour la premi√®re fois
                            console.log(`‚ÑπÔ∏è Pas encore de donn√©es pour ${gite} en base`);
                            return null;
                        }
                        throw error;
                    }
                    
                    console.log(`‚úÖ Infos ${gite} charg√©es depuis la base de donn√©es`);
                    return data.data;
                } catch (error) {
                    console.error('Erreur chargement Supabase:', error);
                    showNotification('‚ö†Ô∏è Chargement depuis sauvegarde locale', 'info');
                    return null;
                }
            }
            
            // S√©lection du g√Æte
            window.selectGiteInfos = function(gite) {
                // Sauvegarder les donn√©es actuelles
                sauvegarderDonneesInfos();
                
                // Changer le g√Æte
                currentGiteInfos = gite;
                
                // Mettre √† jour l'UI des boutons
                document.getElementById('btnTrevoux').style.background = gite === 'Tr√©voux' ? 'white' : 'rgba(255,255,255,0.2)';
                document.getElementById('btnTrevoux').style.color = gite === 'Tr√©voux' ? '#667eea' : 'white';
                document.getElementById('btnCouzon').style.background = gite === 'Couzon' ? 'white' : 'rgba(255,255,255,0.2)';
                document.getElementById('btnCouzon').style.color = gite === 'Couzon' ? '#667eea' : 'white';
                
                // Charger les donn√©es du nouveau g√Æte
                chargerDonneesInfos();
                
                showNotification(`G√Æte ${gite} s√©lectionn√©`, 'success');
            };
            
            function sauvegarderDonneesInfos() {
                const formData = {
                    // Section 1: Base
                    adresse: document.getElementById('infos_adresse')?.value || '',
                    telephone: document.getElementById('infos_telephone')?.value || '',
                    gpsLat: document.getElementById('infos_gpsLat')?.value || '',
                    gpsLon: document.getElementById('infos_gpsLon')?.value || '',
                    email: document.getElementById('infos_email')?.value || '',
                    
                    // Section 2: WiFi
                    wifiSSID: document.getElementById('infos_wifiSSID')?.value || '',
                    wifiPassword: document.getElementById('infos_wifiPassword')?.value || '',
                    wifiDebit: document.getElementById('infos_wifiDebit')?.value || '',
                    wifiLocalisation: document.getElementById('infos_wifiLocalisation')?.value || '',
                    wifiZones: document.getElementById('infos_wifiZones')?.value || '',
                    
                    // Section 3: Arriv√©e
                    heureArrivee: document.getElementById('infos_heureArrivee')?.value || '',
                    arriveeTardive: document.getElementById('infos_arriveeTardive')?.value || '',
                    parkingDispo: document.getElementById('infos_parkingDispo')?.value || '',
                    parkingPlaces: document.getElementById('infos_parkingPlaces')?.value || '',
                    parkingDetails: document.getElementById('infos_parkingDetails')?.value || '',
                    typeAcces: document.getElementById('infos_typeAcces')?.value || '',
                    codeAcces: document.getElementById('infos_codeAcces')?.value || '',
                    instructionsCles: document.getElementById('infos_instructionsCles')?.value || '',
                    etage: document.getElementById('infos_etage')?.value || '',
                    ascenseur: document.getElementById('infos_ascenseur')?.value || '',
                    itineraireLogement: document.getElementById('infos_itineraireLogement')?.value || '',
                    premiereVisite: document.getElementById('infos_premiereVisite')?.value || '',
                    
                    // Section 4: Logement
                    typeChauffage: document.getElementById('infos_typeChauffage')?.value || '',
                    climatisation: document.getElementById('infos_climatisation')?.value || '',
                    instructionsChauffage: document.getElementById('infos_instructionsChauffage')?.value || '',
                    equipementsCuisine: document.getElementById('infos_equipementsCuisine')?.value || '',
                    instructionsFour: document.getElementById('infos_instructionsFour')?.value || '',
                    instructionsPlaques: document.getElementById('infos_instructionsPlaques')?.value || '',
                    instructionsLaveVaisselle: document.getElementById('infos_instructionsLaveVaisselle')?.value || '',
                    instructionsLaveLinge: document.getElementById('infos_instructionsLaveLinge')?.value || '',
                    secheLinge: document.getElementById('infos_secheLinge')?.value || '',
                    ferRepasser: document.getElementById('infos_ferRepasser')?.value || '',
                    lingeFourni: document.getElementById('infos_lingeFourni')?.value || '',
                    configurationChambres: document.getElementById('infos_configurationChambres')?.value || '',
                    
                    // Section 5: D√©chets
                    instructionsTri: document.getElementById('infos_instructionsTri')?.value || '',
                    joursCollecte: document.getElementById('infos_joursCollecte')?.value || '',
                    decheterie: document.getElementById('infos_decheterie')?.value || '',
                    
                    // Section 6: S√©curit√©
                    detecteurFumee: document.getElementById('infos_detecteurFumee')?.value || '',
                    extincteur: document.getElementById('infos_extincteur')?.value || '',
                    coupureEau: document.getElementById('infos_coupureEau')?.value || '',
                    disjoncteur: document.getElementById('infos_disjoncteur')?.value || '',
                    consignesUrgence: document.getElementById('infos_consignesUrgence')?.value || '',
                    
                    // Section 7: D√©part
                    heureDepart: document.getElementById('infos_heureDepart')?.value || '',
                    departTardif: document.getElementById('infos_departTardif')?.value || '',
                    checklistDepart: document.getElementById('infos_checklistDepart')?.value || '',
                    restitutionCles: document.getElementById('infos_restitutionCles')?.value || '',
                    
                    // Section 8: R√®glement
                    tabac: document.getElementById('infos_tabac')?.value || '',
                    animaux: document.getElementById('infos_animaux')?.value || '',
                    nbMaxPersonnes: document.getElementById('infos_nbMaxPersonnes')?.value || '',
                    caution: document.getElementById('infos_caution')?.value || '',
                    
                    dateModification: new Date().toISOString()
                };
                
                // Sauvegarder dans localStorage (backup local)
                const allData = JSON.parse(localStorage.getItem(DB_KEY_INFOS) || '{}');
                allData[currentGiteInfos] = formData;
                localStorage.setItem(DB_KEY_INFOS, JSON.stringify(allData));
                
                // Sauvegarder en base de donn√©es Supabase (async)
                saveInfosGiteToSupabase(currentGiteInfos, formData);
                
                updateProgressInfos();
            }
            
            async function chargerDonneesInfos() {
                // Essayer de charger depuis Supabase d'abord
                const dataFromSupabase = await loadInfosGiteFromSupabase(currentGiteInfos);
                
                let data;
                if (dataFromSupabase) {
                    // Donn√©es depuis Supabase
                    data = dataFromSupabase;
                    
                    // Mettre √† jour le localStorage aussi
                    const allData = JSON.parse(localStorage.getItem(DB_KEY_INFOS) || '{}');
                    allData[currentGiteInfos] = data;
                    localStorage.setItem(DB_KEY_INFOS, JSON.stringify(allData));
                } else {
                    // Fallback sur localStorage
                    const allData = JSON.parse(localStorage.getItem(DB_KEY_INFOS) || '{}');
                    data = allData[currentGiteInfos] || {};
                }
                
                // Remplir tous les champs
                Object.keys(data).forEach(key => {
                    const element = document.getElementById('infos_' + key);
                    if (element) {
                        element.value = data[key] || '';
                    }
                });
                
                // Mettre √† jour les champs conditionnels
                toggleParkingInfos();
                updateProgressInfos();
                
                // G√©n√©rer le QR code WiFi si les donn√©es sont pr√©sentes
                setTimeout(() => {
                    if (typeof updateQRCodeWifi === 'function') {
                        updateQRCodeWifi();
                    }
                }, 100);
            }
            
            window.toggleParkingInfos = function() {
                const parking = document.getElementById('infos_parkingDispo')?.value || '';
                const showFields = parking && parking !== 'Non';
                const placesDiv = document.getElementById('parkingPlacesDiv');
                const detailsDiv = document.getElementById('parkingDetailsDiv');
                if (placesDiv) placesDiv.style.display = showFields ? 'block' : 'none';
                if (detailsDiv) detailsDiv.style.display = showFields ? 'block' : 'none';
            };
            
            function updateProgressInfos() {
                constFields = document.querySelectorAll('#infosGiteForm [required]');
                let filled = 0;
               Fields.forEach(field => {
                    if (field.value && field.value.trim()) filled++;
                });
                const percent = (filled /Fields.length) * 100;
                const progressBar = document.getElementById('progressBarInfos');
                const progressText = document.getElementById('progressText');
                if (progressBar) progressBar.style.width = percent + '%';
                if (progressText) progressText.textContent = Math.round(percent) + '%';
            }
            
            window.sauvegarderInfosGiteComplet = function(event) {
                event.preventDefault();
                sauvegarderDonneesInfos();
                showNotification('‚úì Informations sauvegard√©es pour ' + currentGiteInfos, 'success');
            };
            
            // ==========================================
            // üì§ EXPORT / IMPORT DES DONN√âES
            // ==========================================
            
            window.exporterInfosGites = function() {
                const allData = JSON.parse(localStorage.getItem(DB_KEY_INFOS) || '{}');
                const dataStr = JSON.stringify(allData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `infos-gites-backup-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
                showNotification('‚úì Backup t√©l√©charg√© !', 'success');
            };
            
            window.importerInfosGites = function() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'application/json';
                input.onchange = function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = async function(event) {
                        try {
                            const imported = JSON.parse(event.target.result);
                            
                            // Sauvegarder en localStorage
                            localStorage.setItem(DB_KEY_INFOS, JSON.stringify(imported));
                            
                            // Sauvegarder en Supabase pour chaque g√Æte
                            for (const gite in imported) {
                                await saveInfosGiteToSupabase(gite, imported[gite]);
                            }
                            
                            // Recharger les donn√©es affich√©es
                            chargerDonneesInfos();
                            
                            showNotification('‚úì Donn√©es import√©es et synchronis√©es !', 'success');
                        } catch (error) {
                            console.error('Erreur import:', error);
                            showNotification('‚ùå Erreur lors de l\'import', 'error');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            };
            
            // Auto-save toutes les 30 secondes
            setInterval(() => {
                if (document.getElementById('tab-infos-gites')?.classList.contains('active')) {
                    sauvegarderDonneesInfos();
                }
            }, 30000);
            
            // Update progress on input
            setTimeout(() => {
                const form = document.getElementById('infosGiteForm');
                if (form) {
                    form.querySelectorAll('input, textarea, select').forEach(el => {
                        el.addEventListener('input', updateProgressInfos);
                        el.addEventListener('change', updateProgressInfos);
                    });
                }
                
                // Charger les donn√©es au d√©marrage
                chargerDonneesInfos();
            }, 500);
        })();
        
        // ==========================================
        // üì± G√âN√âRATION QR CODE WIFI (100% API)
        // ==========================================
        
        window.updateQRCodeWifi = function() {
            console.log('üîÑ updateQRCodeWifi appel√©e');
            
            const ssid = document.getElementById('infos_wifiSSID')?.value || '';
            const password = document.getElementById('infos_wifiPassword')?.value || '';
            const section = document.getElementById('qrCodeWifiSection');
            const canvas = document.getElementById('qrCodeWifiCanvas');
            
            console.log('SSID:', ssid, 'Password:', password);
            
            if (!section || !canvas) {
                console.error('‚ùå √âl√©ments QR code non trouv√©s');
                return;
            }
            
            // Afficher la section seulement si SSID et password sont remplis
            if (ssid && password) {
                section.style.display = 'block';
                
                // Format du QR code WiFi selon la sp√©cification
                const wifiString = `WIFI:T:WPA;S:${ssid};P:${password};;`;
                console.log('üì∂ G√©n√©ration QR code pour:', wifiString);
                
                // G√©n√©rer directement avec l'API
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.crossOrigin = 'anonymous';
                img.onload = function() {
                    // Effacer le canvas
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    // Dessiner l'image
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    console.log('‚úÖ QR code g√©n√©r√© avec succ√®s');
                };
                
                img.onerror = function(e) {
                    console.error('‚ùå Erreur chargement QR code:', e);
                    // Afficher un message d'erreur
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#ff0000';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('Erreur de', canvas.width/2, canvas.height/2 - 6);
                    ctx.fillText('g√©n√©ration', canvas.width/2, canvas.height/2 + 6);
                };
                
                // Encoder le texte pour l'URL
                const encodedText = encodeURIComponent(wifiString);
                img.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodedText}`;
                
            } else {
                console.log('‚ÑπÔ∏è SSID ou password manquant, masquage de la section');
                section.style.display = 'none';
            }
        };
        
        window.telechargerQRCodeWifi = function() {
            const canvas = document.getElementById('qrCodeWifiCanvas');
            const ssid = document.getElementById('infos_wifiSSID')?.value || 'wifi';
            
            if (!canvas) {
                showNotification('‚ùå Canvas non trouv√©', 'error');
                return;
            }
            
            // Cr√©er un canvas plus grand pour meilleure qualit√©
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = 600;
            tempCanvas.height = 700;
            const ctx = tempCanvas.getContext('2d');
            
            // Fond blanc
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            
            // Titre
            ctx.fillStyle = '#2C5F7D';
            ctx.font = 'bold 40px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('WiFi Gratuit', tempCanvas.width / 2, 60);
            
            // SSID
            ctx.font = '28px Arial';
            ctx.fillStyle = '#555';
            ctx.fillText(`R√©seau: ${ssid}`, tempCanvas.width / 2, 110);
            
            // QR Code (centr√© et agrandi)
            ctx.drawImage(canvas, 50, 140, 500, 500);
            
            // Instructions
            ctx.font = '20px Arial';
            ctx.fillStyle = '#666';
            ctx.fillText('Scannez avec votre smartphone', tempCanvas.width / 2, 670);
            
            // T√©l√©charger
            tempCanvas.toBlob(function(blob) {
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `QR-WiFi-${ssid}.png`;
                link.click();
                URL.revokeObjectURL(url);
                showNotification('‚úì QR Code t√©l√©charg√© !', 'success');
            });
        };
        
        window.imprimerQRCodeWifi = function() {
            const canvas = document.getElementById('qrCodeWifiCanvas');
            const ssid = document.getElementById('infos_wifiSSID')?.value || 'wifi';
            const password = document.getElementById('infos_wifiPassword')?.value || '';
            
            if (!canvas) {
                showNotification('‚ùå Canvas non trouv√©', 'error');
                return;
            }
            
            // Cr√©er une fen√™tre d'impression
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>QR Code WiFi - ${ssid}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 2cm;
                        }
                        body {
                            font-family: Arial, sans-serif;
                            text-align: center;
                            padding: 20px;
                        }
                        .container {
                            max-width: 600px;
                            margin: 0 auto;
                            border: 3px solid #2C5F7D;
                            padding: 30px;
                            border-radius: 20px;
                        }
                        h1 {
                            color: #2C5F7D;
                            font-size: 48px;
                            margin-bottom: 10px;
                        }
                        .ssid {
                            font-size: 32px;
                            color: #555;
                            margin-bottom: 30px;
                            font-weight: bold;
                        }
                        .qr-code {
                            margin: 30px 0;
                        }
                        .instructions {
                            font-size: 24px;
                            color: #666;
                            margin-top: 20px;
                        }
                        .password {
                            font-size: 18px;
                            color: #999;
                            margin-top: 20px;
                            font-style: italic;
                        }
                        @media print {
                            body {
                                print-color-adjust: exact;
                                -webkit-print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <h1>üì∂ WiFi Gratuit</h1>
                        <div class="ssid">R√©seau: ${ssid}</div>
                        <div class="qr-code">
                            <img src="${canvas.toDataURL()}" style="width: 400px; height: 400px;">
                        </div>
                        <div class="instructions">
                            üì± Scannez ce QR code avec votre smartphone<br>
                            pour vous connecter automatiquement
                        </div>
                        <div class="password">
                            Mot de passe (si besoin): ${password}
                        </div>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            setTimeout(() => printWindow.print(), 250);
        };
        // ==========================================
        // üó∫Ô∏è GESTION "√Ä D√âCOUVRIR"
        // ==========================================
        
        // Coordonn√©es GPS des g√Ætes
        const GITES_COORDS = {
            'Tr√©voux': { lat: 45.93638229370117, lng: 4.791853904724121 },
            'Couzon': { lat: 45.84257125854492, lng: 4.831059455871582 }
        };
        
        // Informations compl√®tes des g√Ætes
        const GITES_INFOS = {
            'Tr√©voux': {
                nom: 'G√Æte de Tr√©voux',
                emoji: 'üè∞',
                couleur_principale: '#667eea',
                couleur_secondaire: '#764ba2',
                adresse: '2 Grande Rue, 01600 Tr√©voux',
                code_acces: '1234A',
                wifi_nom: 'Gite_Trevoux',
                wifi_mdp: 'BienvenueTrevoux2024',
                parking: 'Parking gratuit rue de la R√©publique (2min √† pied)',
                contact_email: 'gite.trevoux@example.com',
                contact_telephone: '06 12 34 56 78',
                check_in: '16h00',
                check_out: '10h00',
                infos_pratiques: [
                    {
                        titre: 'üîë Acc√®s au Logement',
                        contenu: `
                            <p><strong>Adresse :</strong> 2 Grande Rue, 01600 Tr√©voux</p>
                            <p><strong>Code d'acc√®s :</strong></p>
                            <div class="highlight">1234A</div>
                            <p>Le bo√Ætier √† code est situ√© √† gauche de la porte d'entr√©e.</p>
                        `
                    },
                    {
                        titre: 'üì∂ WiFi',
                        contenu: `
                            <p><strong>R√©seau :</strong> Gite_Trevoux</p>
                            <div class="highlight">Mot de passe : BienvenueTrevoux2024</div>
                        `
                    },
                    {
                        titre: 'üöó Parking',
                        contenu: `
                            <p>Parking public gratuit rue de la R√©publique (2 minutes √† pied)</p>
                            <p>Places limit√©es, arrivez t√¥t le week-end.</p>
                        `
                    },
                    {
                        titre: 'üïê Horaires',
                        contenu: `
                            <p><strong>Arriv√©e :</strong> √† partir de 16h00</p>
                            <p><strong>D√©part :</strong> avant 10h00</p>
                            <p>Merci de respecter ces horaires pour permettre le m√©nage.</p>
                        `
                    },
                    {
                        titre: '‚ôªÔ∏è Tri des D√©chets',
                        contenu: `
                            <p><strong>Poubelle jaune :</strong> Recyclables (plastique, carton, m√©tal)</p>
                            <p><strong>Poubelle noire :</strong> Ordures m√©nag√®res</p>
                            <p><strong>Poubelle verte :</strong> Verre</p>
                            <p>Conteneurs situ√©s rue de la Mairie (50m)</p>
                        `
                    },
                    {
                        titre: 'üèõÔ∏è √Ä Proximit√© Imm√©diate',
                        contenu: `
                            <p>‚Ä¢ Boulangerie Chazelle (100m)</p>
                            <p>‚Ä¢ Supermarch√© Carrefour City (200m)</p>
                            <p>‚Ä¢ Pharmacie (150m)</p>
                            <p>‚Ä¢ Ch√¢teau-Fort de Tr√©voux (400m)</p>
                        `
                    },
                    {
                        titre: 'üö® Urgences',
                        contenu: `
                            <p><strong>Pompiers :</strong> 18</p>
                            <p><strong>SAMU :</strong> 15</p>
                            <p><strong>Police :</strong> 17</p>
                            <p><strong>H√¥pital le plus proche :</strong> Centre Hospitalier de Tr√©voux (1km)</p>
                        `
                    }
                ]
            },
            'Couzon': {
                nom: 'G√Æte de Couzon-au-Mont-d\'Or',
                emoji: '‚õ∞Ô∏è',
                couleur_principale: '#f093fb',
                couleur_secondaire: '#f5576c',
                adresse: '14 rue de la R√©publique, 69270 Couzon-au-Mont-d\'Or',
                code_acces: '5678B',
                wifi_nom: 'Gite_Couzon',
                wifi_mdp: 'BienvenueCouzon2024',
                parking: 'Parking priv√© derri√®re le g√Æte',
                contact_email: 'gite.couzon@example.com',
                contact_telephone: '06 98 76 54 32',
                check_in: '16h00',
                check_out: '10h00',
                infos_pratiques: [
                    {
                        titre: 'üîë Acc√®s au Logement',
                        contenu: `
                            <p><strong>Adresse :</strong> 14 rue de la R√©publique, 69270 Couzon-au-Mont-d'Or</p>
                            <p><strong>Code d'acc√®s :</strong></p>
                            <div class="highlight">5678B</div>
                            <p>Le bo√Ætier √† code est situ√© √† droite de la porte d'entr√©e.</p>
                        `
                    },
                    {
                        titre: 'üì∂ WiFi',
                        contenu: `
                            <p><strong>R√©seau :</strong> Gite_Couzon</p>
                            <div class="highlight">Mot de passe : BienvenueCouzon2024</div>
                        `
                    },
                    {
                        titre: 'üöó Parking',
                        contenu: `
                            <p><strong>Parking priv√©</strong> derri√®re le g√Æte</p>
                            <p>Acc√®s par le portail, code identique √† l'entr√©e du g√Æte.</p>
                            <p>2 places disponibles.</p>
                        `
                    },
                    {
                        titre: 'üïê Horaires',
                        contenu: `
                            <p><strong>Arriv√©e :</strong> √† partir de 16h00</p>
                            <p><strong>D√©part :</strong> avant 10h00</p>
                            <p>Merci de respecter ces horaires pour permettre le m√©nage.</p>
                        `
                    },
                    {
                        titre: '‚ôªÔ∏è Tri des D√©chets',
                        contenu: `
                            <p><strong>Poubelle jaune :</strong> Recyclables (plastique, carton, m√©tal)</p>
                            <p><strong>Poubelle noire :</strong> Ordures m√©nag√®res</p>
                            <p><strong>Poubelle verte :</strong> Verre</p>
                            <p>Conteneurs au fond de l'impasse</p>
                        `
                    },
                    {
                        titre: 'üèõÔ∏è √Ä Proximit√© Imm√©diate',
                        contenu: `
                            <p>‚Ä¢ Boulangerie (200m)</p>
                            <p>‚Ä¢ Supermarch√© Intermarch√© √† Albigny (2km)</p>
                            <p>‚Ä¢ Pharmacie √† Albigny (2km)</p>
                            <p>‚Ä¢ Sentiers de randonn√©e Mont d'Or (500m)</p>
                        `
                    },
                    {
                        titre: 'üö® Urgences',
                        contenu: `
                            <p><strong>Pompiers :</strong> 18</p>
                            <p><strong>SAMU :</strong> 15</p>
                            <p><strong>Police :</strong> 17</p>
                            <p><strong>H√¥pital le plus proche :</strong> H√¥pital Lyon Nord (8km)</p>
                        `
                    }
                ]
            }
        };
        
        // Stocker les activit√©s par g√Æte
        let activitesParGite = {
            'Tr√©voux': [],
            'Couzon': []
        };
        
        // Charger les activit√©s depuis Supabase
        async function chargerActivites() {
            try {
                const { data, error } = await supabase
                    .from('activites_gites')
                    .select('*')
                    .order('categorie', { ascending: true });
                
                if (error) throw error;
                
                if (data) {
                    activitesParGite = { 'Tr√©voux': [], 'Couzon': [] };
                    data.forEach(act => {
                        if (activitesParGite[act.gite]) {
                            activitesParGite[act.gite].push(act);
                        }
                    });
                }
                
                // Afficher si un g√Æte est s√©lectionn√©
                const giteSelectionne = document.getElementById('decouvrir_gite')?.value;
                if (giteSelectionne) {
                    afficherActivites(giteSelectionne);
                }
            } catch (error) {
                console.error('Erreur chargement activit√©s:', error);
            }
        }
        
        // S√©lectionner un g√Æte pour "√Ä D√©couvrir"
        function selectGiteDecouvrir(gite) {
            document.getElementById('decouvrir_gite').value = gite;
            document.getElementById('selectedGiteDecouvrir').textContent = gite;
            document.getElementById('formDecouvrir').style.display = 'block';
            
            // Charger et afficher les activit√©s
            chargerActivites();
        }
        
        // Rechercher automatiquement via Google Places API (simulation sans cl√© API)
        async function rechercherAutomatique(type) {
            const gite = document.getElementById('decouvrir_gite').value;
            if (!gite) {
                showNotification('‚ö†Ô∏è S√©lectionnez un g√Æte d\'abord', 'warning');
                return;
            }
            
            showNotification('üîç Filtrage en cours...', 'info');
            
            // Mapper les types de recherche vers les cat√©gories
            const typeToCategorie = {
                'restaurants': 'üçΩÔ∏è Restaurant',
                'tourist_attraction': 'üèõÔ∏è Site Touristique',
                'shopping_mall': 'üõçÔ∏è Commerce',
                'park': 'üå≥ Nature & Randonn√©e'
            };
            
            const categorieRecherchee = typeToCategorie[type];
            
            if (!categorieRecherchee) {
                showNotification('‚ö†Ô∏è Type de recherche non reconnu', 'warning');
                return;
            }
            
            // R√©cup√©rer les activit√©s du g√Æte s√©lectionn√©
            const activites = activitesParGite[gite] || [];
            
            // Filtrer par cat√©gorie
            const activitesFiltrees = activites.filter(act => act.categorie === categorieRecherchee);
            
            // Afficher les r√©sultats
            const container = document.getElementById('activitesParCategorie');
            
            if (activitesFiltrees.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: #fff3cd; border-radius: 12px; border-left: 4px solid #f59e0b;">
                        <h3 style="color: #856404; margin-bottom: 10px;">Aucun r√©sultat pour "${categorieRecherchee}"</h3>
                        <p style="color: #666;">Essayez d'ajouter des activit√©s de cette cat√©gorie manuellement ci-dessous.</p>
                    </div>
                `;
                showNotification(`‚ÑπÔ∏è Aucune activit√© de type "${categorieRecherchee}" trouv√©e`, 'info');
                return;
            }
            
            // Afficher uniquement cette cat√©gorie
            let html = `
                <div style="margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: var(--primary); font-size: 1.3rem; border-bottom: 2px solid var(--border); padding-bottom: 10px; flex: 1;">
                            ${categorieRecherchee} (${activitesFiltrees.length})
                        </h3>
                        <button onclick="afficherActivites('${gite}')" class="btn" style="background: #6c757d; color: white; padding: 8px 16px; font-size: 0.9rem;">
                            üîÑ Tout Afficher
                        </button>
                    </div>
                    <div style="display: grid; gap: 15px;">
            `;
            
            activitesFiltrees.forEach(act => {
                const noteStars = act.note ? '‚≠ê'.repeat(Math.round(act.note)) : '';
                const distanceText = act.distance ? `üìç ${act.distance} km` : '';
                const prixText = act.prix || '';
                
                html += `
                    <div style="background: #f8f9fa; border-left: 4px solid var(--primary); padding: 20px; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <h4 style="margin: 0; font-size: 1.1rem; color: #2C5F7D;">${act.nom}</h4>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="modifierActivite(${act.id})" title="Modifier" style="background: transparent; border: none; cursor: pointer; font-size: 1.4rem; padding: 4px 8px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'">
                                    ‚úèÔ∏è
                                </button>
                                <button onclick="supprimerActivite(${act.id})" title="Supprimer" style="background: transparent; border: none; cursor: pointer; font-size: 1.4rem; padding: 4px 8px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                        
                        ${act.description ? `<p style="margin: 10px 0; color: #555;">${act.description}</p>` : ''}
                        
                        <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px; font-size: 0.9rem; color: #666;">
                            ${distanceText ? `<span>${distanceText}</span>` : ''}
                            ${noteStars ? `<span>${noteStars} ${act.note}/5 ${act.avis ? `(${act.avis} avis)` : ''}</span>` : ''}
                            ${prixText ? `<span>üí∞ ${prixText}</span>` : ''}
                        </div>
                        
                        ${act.adresse ? `<p style="margin: 10px 0 5px 0; color: #666; font-size: 0.9rem;">üìç ${act.adresse}</p>` : ''}
                        ${act.telephone ? `<p style="margin: 5px 0; color: #666; font-size: 0.9rem;">üìû ${act.telephone}</p>` : ''}
                        
                        <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                            ${act.google_maps_link ? `
                                <a href="${act.google_maps_link}" target="_blank" title="Itin√©raire Google Maps" style="background: #4285f4; color: white; border-radius: 8px; padding: 10px 16px; text-decoration: none; font-size: 1.2rem; transition: transform 0.2s; display: inline-flex; align-items: center; gap: 6px;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                    üó∫Ô∏è
                                </a>
                            ` : ''}
                            ${act.website ? `
                                <a href="${act.website}" target="_blank" title="Site web" style="background: #10b981; color: white; border-radius: 8px; padding: 10px 16px; text-decoration: none; font-size: 1.2rem; transition: transform 0.2s; display: inline-flex; align-items: center; gap: 6px;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                    üåê
                                </a>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            container.innerHTML = html;
            
            showNotification(`‚úì ${activitesFiltrees.length} activit√©(s) trouv√©e(s) pour "${categorieRecherchee}"`, 'success');
        }
        
        // Rechercher les √©v√©nements de la semaine
        async function rechercherEvenements() {
            const gite = document.getElementById('decouvrir_gite').value;
            if (!gite) {
                showNotification('‚ö†Ô∏è S√©lectionnez un g√Æte d\'abord', 'warning');
                return;
            }
            
            showNotification('üîç Recherche d\'√©v√©nements...', 'info');
            
            const evenementsDiv = document.getElementById('evenementsListe');
            
            // Obtenir la date actuelle
            const today = new Date();
            const dateStr = today.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            // √âv√©nements bas√©s sur le g√Æte s√©lectionn√©
            const evenementsParGite = {
                'Tr√©voux': [
                    {
                        titre: 'March√© de Tr√©voux',
                        date: 'Tous les samedis matin',
                        lieu: 'Place de la Terrasse, Tr√©voux',
                        description: 'March√© hebdomadaire avec produits locaux, fromages, fruits et l√©gumes frais',
                        lien: 'https://www.ville-trevoux.fr',
                        icone: 'üõí'
                    },
                    {
                        titre: 'Visite du Ch√¢teau-Fort',
                        date: 'Du mercredi au dimanche',
                        lieu: 'Mont√©e du Ch√¢teau, Tr√©voux',
                        description: 'Monument Historique class√© en 1913. D√©couvrez l\'histoire du Parlement de Dombes',
                        lien: 'https://www.ain-tourisme.com',
                        icone: 'üè∞'
                    },
                    {
                        titre: 'Festival des Lumi√®res',
                        date: '8-12 D√©cembre 2024',
                        lieu: 'Lyon Centre (24km)',
                        description: 'Festival international de la lumi√®re - Illuminations spectaculaires dans tout Lyon',
                        lien: 'https://www.fetedeslumieres.lyon.fr',
                        icone: 'üí°'
                    },
                    {
                        titre: 'March√© de No√´l',
                        date: 'D√©cembre 2024',
                        lieu: 'Place Bellecour, Lyon (24km)',
                        description: 'L\'un des plus grands march√©s de No√´l de France avec plus de 130 chalets',
                        lien: 'https://www.lyon.fr',
                        icone: 'üéÑ'
                    }
                ],
                'Couzon': [
                    {
                        titre: 'Randonn√©es Mont d\'Or',
                        date: 'Toute l\'ann√©e',
                        lieu: 'Couzon-au-Mont-d\'Or',
                        description: 'Sentiers balis√©s avec vue panoramique sur la vall√©e de la Sa√¥ne',
                        lien: 'https://www.monts-dor.com',
                        icone: 'ü•æ'
                    },
                    {
                        titre: 'March√© de Couzon',
                        date: 'Tous les dimanches matin',
                        lieu: 'Place du village, Couzon',
                        description: 'March√© local avec producteurs de la r√©gion',
                        lien: 'https://www.couzon-au-mont-dor.fr',
                        icone: 'üõí'
                    },
                    {
                        titre: 'Festival des Lumi√®res',
                        date: '8-12 D√©cembre 2024',
                        lieu: 'Lyon Centre (15km)',
                        description: 'Festival international de la lumi√®re - Illuminations spectaculaires dans tout Lyon',
                        lien: 'https://www.fetedeslumieres.lyon.fr',
                        icone: 'üí°'
                    },
                    {
                        titre: 'Croisi√®res sur Sa√¥ne',
                        date: 'Avril √† Octobre',
                        lieu: 'Port de Couzon',
                        description: 'D√©couvrez les Monts d\'Or depuis la Sa√¥ne en bateau',
                        lien: 'https://www.navigation-saone.fr',
                        icone: '‚õµ'
                    }
                ]
            };
            
            const evenements = evenementsParGite[gite] || [];
            
            if (evenements.length === 0) {
                evenementsDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">Aucun √©v√©nement trouv√© pour ce g√Æte</p>';
                showNotification('‚ö†Ô∏è Aucun √©v√©nement trouv√©', 'warning');
                return;
            }
            
            let html = `
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196f3;">
                    <strong>üìÖ √âv√©nements et activit√©s autour de ${gite}</strong><br>
                    <small style="color: #666;">Mis √† jour le ${dateStr}</small>
                </div>
            `;
            
            evenements.forEach(event => {
                html += `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                        <h3 style="margin: 0 0 10px 0; font-size: 1.3rem; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5rem;">${event.icone}</span> ${event.titre}
                        </h3>
                        <p style="margin: 5px 0; opacity: 0.95; font-size: 0.95rem;"><strong>üìç</strong> ${event.lieu}</p>
                        <p style="margin: 5px 0; opacity: 0.95; font-size: 0.95rem;"><strong>üóìÔ∏è</strong> ${event.date}</p>
                        <p style="margin: 15px 0; line-height: 1.5;">${event.description}</p>
                        <a href="${event.lien}" target="_blank" style="background: white; color: #667eea; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 600; display: inline-block; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            üîó Plus d'infos
                        </a>
                    </div>
                `;
            });
            
            evenementsDiv.innerHTML = html;
            showNotification(`‚úì ${evenements.length} √©v√©nement(s) trouv√©(s)`, 'success');
        }
        
        // Rafra√Æchir les √©v√©nements
        function refreshEvenements() {
            rechercherEvenements();
        }
        
        // Toggle du formulaire d'ajout d'activit√©
        function toggleFormAjout() {
            const form = document.getElementById('formAjoutActivite');
            if (form.style.display === 'none' || form.style.display === '') {
                form.style.display = 'block';
                form.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } else {
                form.style.display = 'none';
            }
        }
        
        // Ajouter une activit√© manuellement
        async function ajouterActivite() {
            const gite = document.getElementById('decouvrir_gite').value;
            const nom = document.getElementById('activite_nom').value.trim();
            const categorie = document.getElementById('activite_categorie').value;
            const description = document.getElementById('activite_description').value.trim();
            const adresse = document.getElementById('activite_adresse').value.trim();
            const distance = document.getElementById('activite_distance').value;
            const website = document.getElementById('activite_website').value.trim();
            const telephone = document.getElementById('activite_telephone').value.trim();
            const note = document.getElementById('activite_note').value;
            const avis = document.getElementById('activite_avis').value;
            const prix = document.getElementById('activite_prix').value;
            
            if (!gite || !nom || !categorie || !adresse) {
                showNotification('‚ö†Ô∏è Remplissez les champs obligatoires (nom, cat√©gorie, adresse)', 'warning');
                return;
            }
            
            // Cr√©er le lien Google Maps
            const googleMapsLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(adresse)}`;
            
            const activite = {
                gite,
                nom,
                categorie,
                description,
                adresse,
                distance: distance ? parseFloat(distance) : null,
                website,
                telephone,
                note: note ? parseFloat(note) : null,
                avis: avis ? parseInt(avis) : null,
                prix,
                google_maps_link: googleMapsLink
            };
            
            try {
                // Mode MODIFICATION si un ID est stock√©
                if (window.activiteEnCoursDeModification) {
                    const { data, error } = await supabase
                        .from('activites_gites')
                        .update(activite)
                        .eq('id', window.activiteEnCoursDeModification)
                        .select();
                    
                    if (error) throw error;
                    
                    showNotification('‚úì Activit√© modifi√©e avec succ√®s !', 'success');
                    
                    // R√©initialiser le mode modification
                    delete window.activiteEnCoursDeModification;
                    
                    // Restaurer le bouton original
                    const btnSave = document.querySelector('#formDecouvrir button[onclick="ajouterActivite()"]');
                    if (btnSave) {
                        btnSave.textContent = '‚ûï Ajouter l\'activit√©';
                        btnSave.style.background = 'linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%)';
                    }
                    
                } else {
                    // Mode AJOUT normal
                    activite.created_at = new Date().toISOString();
                    
                    const { data, error } = await supabase
                        .from('activites_gites')
                        .insert([activite])
                        .select();
                    
                    if (error) throw error;
                    
                    showNotification('‚úì Activit√© ajout√©e avec succ√®s !', 'success');
                }
                
                // R√©initialiser le formulaire
                document.getElementById('activite_nom').value = '';
                document.getElementById('activite_categorie').value = '';
                document.getElementById('activite_description').value = '';
                document.getElementById('activite_adresse').value = '';
                document.getElementById('activite_distance').value = '';
                document.getElementById('activite_website').value = '';
                document.getElementById('activite_telephone').value = '';
                document.getElementById('activite_note').value = '';
                document.getElementById('activite_avis').value = '';
                document.getElementById('activite_prix').value = '';
                
                // Recharger et afficher
                await chargerActivites();
                
            } catch (error) {
                console.error('Erreur activit√©:', error);
                showNotification('‚ùå Erreur : ' + error.message, 'error');
            }
        }
        
        // Afficher les activit√©s par cat√©gorie
        function afficherActivites(gite) {
            const activites = activitesParGite[gite] || [];
            const container = document.getElementById('activitesParCategorie');
            
            if (activites.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">Aucune activit√© enregistr√©e pour ce g√Æte</p>';
                return;
            }
            
            // Grouper par cat√©gorie
            const parCategorie = {};
            activites.forEach(act => {
                if (!parCategorie[act.categorie]) {
                    parCategorie[act.categorie] = [];
                }
                parCategorie[act.categorie].push(act);
            });
            
            let html = '';
            
            Object.keys(parCategorie).sort().forEach(cat => {
                html += `
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: var(--primary); margin-bottom: 15px; font-size: 1.3rem; border-bottom: 2px solid var(--border); padding-bottom: 10px;">
                            ${cat}
                        </h3>
                        <div style="display: grid; gap: 15px;">
                `;
                
                parCategorie[cat].forEach(act => {
                    const noteStars = act.note ? '‚≠ê'.repeat(Math.round(act.note)) : '';
                    const distanceText = act.distance ? `üìç ${act.distance} km` : '';
                    const prixText = act.prix || '';
                    
                    html += `
                        <div style="background: #f8f9fa; border-left: 4px solid var(--primary); padding: 20px; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <h4 style="margin: 0; font-size: 1.1rem; color: #2C5F7D;">${act.nom}</h4>
                                <div style="display: flex; gap: 8px;">
                                    <button onclick="modifierActivite(${act.id})" title="Modifier" style="background: transparent; border: none; cursor: pointer; font-size: 1.4rem; padding: 4px 8px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'">
                                        ‚úèÔ∏è
                                    </button>
                                    <button onclick="supprimerActivite(${act.id})" title="Supprimer" style="background: transparent; border: none; cursor: pointer; font-size: 1.4rem; padding: 4px 8px; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>
                            
                            ${act.description ? `<p style="margin: 10px 0; color: #555;">${act.description}</p>` : ''}
                            
                            <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px; font-size: 0.9rem; color: #666;">
                                ${distanceText ? `<span>${distanceText}</span>` : ''}
                                ${noteStars ? `<span>${noteStars} ${act.note}/5 ${act.avis ? `(${act.avis} avis)` : ''}</span>` : ''}
                                ${prixText ? `<span>üí∞ ${prixText}</span>` : ''}
                            </div>
                            
                            ${act.adresse ? `<p style="margin: 10px 0 5px 0; color: #666; font-size: 0.9rem;">üìç ${act.adresse}</p>` : ''}
                            ${act.telephone ? `<p style="margin: 5px 0; color: #666; font-size: 0.9rem;">üìû ${act.telephone}</p>` : ''}
                            
                            <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                                ${act.google_maps_link ? `
                                    <a href="${act.google_maps_link}" target="_blank" title="Itin√©raire Google Maps" style="background: #4285f4; color: white; border-radius: 8px; padding: 10px 16px; text-decoration: none; font-size: 1.2rem; transition: transform 0.2s; display: inline-flex; align-items: center; gap: 6px;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                        üó∫Ô∏è
                                    </a>
                                ` : ''}
                                ${act.website ? `
                                    <a href="${act.website}" target="_blank" title="Site web" style="background: #10b981; color: white; border-radius: 8px; padding: 10px 16px; text-decoration: none; font-size: 1.2rem; transition: transform 0.2s; display: inline-flex; align-items: center; gap: 6px;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                        üåê
                                    </a>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            });
            
            container.innerHTML = html;
        }
        
        // Supprimer une activit√©
        async function supprimerActivite(id) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette activit√© ?')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('activites_gites')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                showNotification('‚úì Activit√© supprim√©e', 'success');
                await chargerActivites();
                
            } catch (error) {
                console.error('Erreur suppression activit√©:', error);
                showNotification('‚ùå Erreur : ' + error.message, 'error');
            }
        }
        
        // Modifier une activit√©
        async function modifierActivite(id) {
            try {
                // R√©cup√©rer l'activit√© √† modifier
                const { data, error } = await supabase
                    .from('activites_gites')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (error) throw error;
                
                // Ouvrir le formulaire s'il est ferm√©
                const form = document.getElementById('formAjoutActivite');
                if (form.style.display === 'none' || form.style.display === '') {
                    form.style.display = 'block';
                }
                
                // Pr√©-remplir le formulaire
                document.getElementById('activite_nom').value = data.nom || '';
                document.getElementById('activite_categorie').value = data.categorie || '';
                document.getElementById('activite_description').value = data.description || '';
                document.getElementById('activite_adresse').value = data.adresse || '';
                document.getElementById('activite_distance').value = data.distance || '';
                document.getElementById('activite_note').value = data.note || '';
                document.getElementById('activite_avis').value = data.avis || '';
                document.getElementById('activite_prix').value = data.prix || '';
                document.getElementById('activite_telephone').value = data.telephone || '';
                document.getElementById('activite_website').value = data.website || '';
                
                // Stocker l'ID en cours de modification
                window.activiteEnCoursDeModification = id;
                
                // Changer le bouton d'ajout en "Modifier"
                const btnSave = document.querySelector('#formAjoutActivite button[onclick="ajouterActivite()"]');
                if (btnSave) {
                    btnSave.textContent = '‚úèÔ∏è Modifier l\'activit√©';
                    btnSave.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
                }
                
                // Scroll vers le formulaire
                form.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                
                showNotification('‚úèÔ∏è Mode modification activ√©', 'info');
                
            } catch (error) {
                console.error('Erreur modification activit√©:', error);
                showNotification('‚ùå Erreur : ' + error.message, 'error');
            }
        }
        
        // G√©n√©rer le guide PDF
        function genererGuideDecouverte() {
            const gite = document.getElementById('decouvrir_gite').value;
            if (!gite) {
                showNotification('‚ö†Ô∏è S√©lectionnez un g√Æte d\'abord', 'warning');
                return;
            }
            
            showNotification('üîÑ G√©n√©ration du guide en cours...', 'info');
            
            // TODO: Impl√©menter la g√©n√©ration PDF avec jsPDF
            setTimeout(() => {
                showNotification('‚úì Guide g√©n√©r√© ! (√Ä impl√©menter)', 'success');
            }, 1000);
        }
        
        // G√©n√©rer la fiche client pour une r√©servation
        async function genererFicheClient(reservation) {
            try {
                showNotification('üîÑ G√©n√©ration de la fiche client...', 'info');
                
                const giteNom = reservation.gite;
                const giteInfo = GITES_INFOS[giteNom];
                
                if (!giteInfo) {
                    showNotification('‚ùå G√Æte non trouv√©', 'error');
                    return;
                }
                
                // R√©cup√©rer les activit√©s du g√Æte
                const activites = activitesParGite[giteNom] || [];
                
                // Calculer le nombre de nuits
                const dateDebut = new Date(reservation.date_debut);
                const dateFin = new Date(reservation.date_fin);
                const nombreNuits = Math.ceil((dateFin - dateDebut) / (1000 * 60 * 60 * 24));
                
                // Formater les dates
                const optionsDate = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const dateArrivee = dateDebut.toLocaleDateString('fr-FR', optionsDate);
                const dateDepart = dateFin.toLocaleDateString('fr-FR', optionsDate);
                const dateGeneration = new Date().toLocaleDateString('fr-FR', optionsDate);
                
                // G√©n√©rer le contenu des infos pratiques
                let infosPratiquesHTML = '';
                giteInfo.infos_pratiques.forEach(info => {
                    infosPratiquesHTML += `
                        <div class="info-pratique">
                            <h3>${info.titre}</h3>
                            ${info.contenu}
                        </div>
                    `;
                });
                
                // G√©n√©rer le contenu des activit√©s group√©es par cat√©gorie
                let activitesHTML = '';
                
                if (activites.length === 0) {
                    activitesHTML = '<p style="text-align: center; padding: 40px; color: #999;">Aucune activit√© enregistr√©e pour le moment.</p>';
                } else {
                    // Grouper par cat√©gorie
                    const parCategorie = {};
                    activites.forEach(act => {
                        if (!parCategorie[act.categorie]) {
                            parCategorie[act.categorie] = [];
                        }
                        parCategorie[act.categorie].push(act);
                    });
                    
                    // G√©n√©rer le HTML par cat√©gorie
                    Object.keys(parCategorie).sort().forEach(categorie => {
                        activitesHTML += `
                            <div class="categorie-activites">
                                <h3>${categorie}</h3>
                        `;
                        
                        parCategorie[categorie].forEach(act => {
                            const noteStars = act.note ? '‚≠ê'.repeat(Math.round(act.note)) : '';
                            
                            activitesHTML += `
                                <div class="activite-card">
                                    <h4>${act.nom}</h4>
                                    ${act.description ? `<p>${act.description}</p>` : ''}
                                    
                                    <div class="meta">
                                        ${act.distance ? `<span>üìç ${act.distance} km du g√Æte</span>` : ''}
                                        ${noteStars ? `<span>${noteStars} ${act.note}/5 ${act.avis ? `(${act.avis} avis)` : ''}</span>` : ''}
                                        ${act.prix ? `<span>üí∞ ${act.prix}</span>` : ''}
                                    </div>
                                    
                                    ${(act.adresse || act.telephone || act.website) ? `
                                        <div class="contact">
                                            ${act.adresse ? `<p>üìç ${act.adresse}</p>` : ''}
                                            ${act.telephone ? `<p>üìû ${act.telephone}</p>` : ''}
                                            ${act.website ? `<p>üåê <a href="${act.website}" target="_blank">${act.website}</a></p>` : ''}
                                            ${act.google_maps_link ? `<p>üó∫Ô∏è <a href="${act.google_maps_link}" target="_blank">Voir sur Google Maps</a></p>` : ''}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        });
                        
                        activitesHTML += '</div>';
                    });
                }
                
                // Template HTML de la fiche
                const ficheHTML = `<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiche Client - ${giteInfo.nom}</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Lato:wght@300;400;700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Lato', sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .fiche-container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 30px rgba(0,0,0,0.1);
        }
        
        .header {
            background: linear-gradient(135deg, ${giteInfo.couleur_principale} 0%, ${giteInfo.couleur_secondaire} 100%);
            color: white;
            padding: 50px 40px;
            text-align: center;
        }
        
        .header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 3rem;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .header .emoji { font-size: 4rem; display: block; margin-bottom: 20px; }
        .header .subtitle { font-size: 1.2rem; opacity: 0.95; font-weight: 300; }
        
        .reservation-info {
            background: #f8f9fa;
            padding: 30px 40px;
            border-bottom: 3px solid ${giteInfo.couleur_principale};
        }
        
        .reservation-info h2 {
            font-size: 1.8rem;
            color: ${giteInfo.couleur_principale};
            margin-bottom: 20px;
            font-family: 'Playfair Display', serif;
        }
        
        .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .info-item { display: flex; align-items: center; gap: 12px; }
        .info-item .icon { font-size: 1.5rem; color: ${giteInfo.couleur_principale}; }
        .info-item .label { font-weight: 700; color: #666; margin-right: 8px; }
        .info-item .value { color: #333; font-weight: 400; }
        
        .section { padding: 40px; }
        
        .section h2 {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            color: ${giteInfo.couleur_principale};
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid ${giteInfo.couleur_principale};
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .section h2 .emoji { font-size: 2.5rem; }
        
        .info-pratique {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid ${giteInfo.couleur_principale};
        }
        
        .info-pratique h3 {
            color: ${giteInfo.couleur_principale};
            font-size: 1.3rem;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-pratique p { margin: 8px 0; padding-left: 30px; }
        
        .info-pratique .highlight {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 700;
            color: ${giteInfo.couleur_principale};
            text-align: center;
            font-size: 1.2rem;
            border: 2px dashed ${giteInfo.couleur_principale};
        }
        
        .categorie-activites { margin-bottom: 35px; }
        
        .categorie-activites h3 {
            color: ${giteInfo.couleur_principale};
            font-size: 1.5rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .activite-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid ${giteInfo.couleur_principale};
            page-break-inside: avoid;
        }
        
        .activite-card h4 { color: #2C5F7D; font-size: 1.2rem; margin-bottom: 10px; }
        .activite-card p { margin: 8px 0; color: #555; }
        
        .activite-card .meta {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 12px;
            font-size: 0.9rem;
            color: #666;
        }
        
        .activite-card .meta span { display: flex; align-items: center; gap: 5px; }
        
        .activite-card .contact {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #ddd;
        }
        
        .activite-card .contact a {
            color: ${giteInfo.couleur_principale};
            text-decoration: none;
            font-weight: 600;
        }
        
        .footer {
            background: #2C3E50;
            color: white;
            padding: 30px 40px;
            text-align: center;
        }
        
        .footer p { margin: 8px 0; opacity: 0.9; }
        
        @media print {
            body { background: white; padding: 0; }
            .fiche-container { box-shadow: none; }
            .section { page-break-inside: avoid; }
            .no-print { display: none; }
        }
        
        .btn-print {
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${giteInfo.couleur_principale};
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .btn-print:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.3);
        }
        
        @media (max-width: 768px) {
            .info-grid { grid-template-columns: 1fr; }
            .header h1 { font-size: 2rem; }
        }
    </style>
</head>
<body>
    <button class="btn-print no-print" onclick="window.print()">üñ®Ô∏è Imprimer / PDF</button>
    
    <div class="fiche-container">
        <div class="header">
            <span class="emoji">${giteInfo.emoji}</span>
            <h1>${giteInfo.nom}</h1>
            <p class="subtitle">Votre s√©jour dans l'Ain</p>
        </div>
        
        <div class="reservation-info">
            <h2>üéØ Votre R√©servation</h2>
            <div class="info-grid">
                <div class="info-item">
                    <span class="icon">üë§</span>
                    <span class="label">Nom :</span>
                    <span class="value">${reservation.nom || 'Non renseign√©'}</span>
                </div>
                <div class="info-item">
                    <span class="icon">üìß</span>
                    <span class="label">Email :</span>
                    <span class="value">${reservation.email || 'Non renseign√©'}</span>
                </div>
                <div class="info-item">
                    <span class="icon">üìÖ</span>
                    <span class="label">Arriv√©e :</span>
                    <span class="value">${dateArrivee}</span>
                </div>
                <div class="info-item">
                    <span class="icon">üìÖ</span>
                    <span class="label">D√©part :</span>
                    <span class="value">${dateDepart}</span>
                </div>
                <div class="info-item">
                    <span class="icon">üåô</span>
                    <span class="label">Dur√©e :</span>
                    <span class="value">${nombreNuits} nuit(s)</span>
                </div>
                <div class="info-item">
                    <span class="icon">üë•</span>
                    <span class="label">Voyageurs :</span>
                    <span class="value">${reservation.nb_voyageurs || 'Non renseign√©'} personne(s)</span>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2><span class="emoji">üìã</span> Informations Pratiques</h2>
            ${infosPratiquesHTML}
        </div>
        
        <div class="section" style="background: #f8f9fa;">
            <h2><span class="emoji">üó∫Ô∏è</span> √Ä D√©couvrir Autour du G√Æte</h2>
            <p style="margin-bottom: 30px; font-size: 1.1rem; color: #666;">
                Nous avons s√©lectionn√© pour vous les meilleures adresses dans un rayon de 25km.
            </p>
            ${activitesHTML}
        </div>
        
        <div class="footer">
            <p style="font-size: 1.2rem; font-weight: 700; margin-bottom: 15px;">
                Nous vous souhaitons un excellent s√©jour ! üåü
            </p>
            <p>Pour toute question : ${giteInfo.contact_email} | ${giteInfo.contact_telephone}</p>
            <p style="font-size: 0.9rem; margin-top: 15px; opacity: 0.7;">
                Document g√©n√©r√© le ${dateGeneration}
            </p>
        </div>
    </div>
</body>
</html>`;
                
                // Ouvrir dans une nouvelle fen√™tre
                const nouvelleFenetre = window.open('', '_blank');
                nouvelleFenetre.document.write(ficheHTML);
                nouvelleFenetre.document.close();
                
                showNotification('‚úì Fiche client g√©n√©r√©e !', 'success');
                
            } catch (error) {
                console.error('Erreur g√©n√©ration fiche client:', error);
                showNotification('‚ùå Erreur : ' + error.message, 'error');
            }
        }
        
        // Aper√ßu fiche client depuis l'ID de r√©servation
        async function aper√ßuFicheClient(reservationId) {
            try {
                const reservations = await getAllReservations();
                const reservation = reservations.find(r => r.id === reservationId);
                
                if (!reservation) {
                    showNotification('‚ùå R√©servation introuvable', 'error');
                    return;
                }
                
                // Fermer le modal
                const modal = document.querySelector('[onclick*="this.closest"]');
                if (modal) modal.closest('div').parentElement.remove();
                
                // G√©n√©rer la fiche
                await genererFicheClient(reservation);
                
            } catch (error) {
                console.error('Erreur aper√ßu fiche client:', error);
                showNotification('‚ùå Erreur : ' + error.message, 'error');
            }
        }
        
        
        // Syst√®me de notifications
        function showNotification(message, type = 'info') {
            // Cr√©er ou r√©cup√©rer le conteneur de notifications
            let container = document.getElementById('notification-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'notification-container';
                container.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 10000;
                    display: flex;
                    flex-direction: column;
                    gap: 10px;
                    max-width: 400px;
                `;
                document.body.appendChild(container);
            }
            
            // Cr√©er la notification
            const notification = document.createElement('div');
            
            // Couleurs selon le type
            const colors = {
                success: '#27AE60',
                error: '#E74C3C',
                warning: '#F39C12',
                info: '#3498DB'
            };
            
            const icons = {
                success: '‚úì',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            notification.style.cssText = `
                background: ${colors[type] || colors.info};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 10px;
                animation: slideIn 0.3s ease;
            `;
            
            notification.innerHTML = `
                <span style="font-size: 1.2rem;">${icons[type] || icons.info}</span>
                <span>${message}</span>
            `;
            
            // Ajouter au conteneur
            container.appendChild(notification);
            
            // Supprimer apr√®s 3 secondes
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    notification.remove();
                    if (container.children.length === 0) {
                        container.remove();
                    }
                }, 300);
            }, 3000);
        }
        
        // Ajouter les animations CSS
        if (!document.getElementById('notification-animations')) {
            const style = document.createElement('style');
            style.id = 'notification-animations';
            style.textContent = `
                @keyframes slideIn {
                    from {
                        transform: translateX(400px);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
                @keyframes slideOut {
                    from {
                        transform: translateX(0);
                        opacity: 1;
                    }
                    to {
                        transform: translateX(400px);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(style);
        }
        
    </script>
</body>
</html>
