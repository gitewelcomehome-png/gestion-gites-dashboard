<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accueil et Planning des Réservations</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background-color: #ffffff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-bottom: 20px; text-align: center; }
        
        /* Styles du Tableau */
        .reservation-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .reservation-table th, .reservation-table td { 
            border: 1px solid #ddd; 
            padding: 10px; 
            text-align: left; 
            font-size: 0.9em;
        }
        .reservation-table th { background-color: #3498db; color: white; text-transform: uppercase; }
        .reservation-table tr:nth-child(even) { background-color: #f2f2f2; }
        .reservation-table tr:hover { background-color: #ddd; }

        /* Styles de Statut (Couleurs) */
        .status-cell { font-weight: bold; }
        .status-valide {
            color: white;
            background-color: #2ecc71; /* Vert */
            padding: 3px 6px;
            border-radius: 3px;
            display: inline-block;
        }
        .status-attente {
            color: white;
            background-color: #e74c3c; /* Rouge */
            padding: 3px 6px;
            border-radius: 3px;
            display: inline-block;
        }
        .loading-message, .error-message, .no-data { text-align: center; padding: 30px; color: #7f8c8d; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Planning des Réservations (Tâches Futures)</h1>
        <p>Ce tableau affiche toutes les réservations dont la date de fin est à partir d'aujourd'hui, avec le statut de validation du ménage.</p>

        <div id="loading" class="loading-message">Chargement des réservations...</div>
        <div id="error-display" class="error-message" style="display: none;"></div>
        
        <table class="reservation-table">
            <thead>
                <tr>
                    <th>Gîte</th>
                    <th>Arrivée</th>
                    <th>Départ (Ménage)</th>
                    <th>Client</th>
                    <th>Statut Ménage</th>
                </tr>
            </thead>
            <tbody id="reservations-body">
                </tbody>
        </table>

        <div id="no-reservations" class="no-data" style="display: none;">
            Aucune réservation future trouvée à partir d'aujourd'hui.
        </div>

        <p style="margin-top: 30px; text-align: center;">
            <a href="/cleaning_form.html?month=2025-12" style="padding: 10px 20px; background-color: #3498db; color: white; text-decoration: none; border-radius: 5px;">
                Aller au Formulaire de Validation Ménage (Décembre 2025)
            </a>
        </p>
    </div>

    <script>
        // ----------------------------------------------------
        // ÉTAPE 1 : Configuration Supabase
        // ----------------------------------------------------
        const SUPABASE_URL = 'https://ivqiisnudabxemcxxyru.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2cWlpc251ZGFieGVtY3h4eXJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzOTk0NjMsImV4cCI6MjA4MDk3NTQ2M30.9FwJPgR8bbaP7bAemuaVbAN019EO5ql7uciQO9FeHK4'; 
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ----------------------------------------------------
        // Fonctions Utilitaires
        // ----------------------------------------------------

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        }

        function getStatusDisplay(menageValide) {
            // Détermine le statut et la classe CSS
            if (menageValide && menageValide.includes('Validé')) {
                return { 
                    text: menageValide, 
                    className: 'status-valide' 
                };
            }
            
            return {
                text: menageValide || 'Non Validé',
                className: 'status-attente' 
            };
        }

        // ----------------------------------------------------
        // ÉTAPE 2 : Rendu des Réservations
        // ----------------------------------------------------

        function renderReservations(reservations) {
            const tbody = document.getElementById('reservations-body');
            tbody.innerHTML = '';
            
            if (reservations.length === 0) {
                document.getElementById('no-reservations').style.display = 'block';
                return;
            }

            reservations.forEach(res => {
                const status = getStatusDisplay(res.menage_valide);
                
                const row = `
                    <tr>
                        <td>${res.gite}</td>
                        <td>${formatDate(res.date_debut)}</td>
                        <td>${formatDate(res.date_fin)}</td>
                        <td>${res.nom_client || 'Inconnu'}</td>
                        <td class="status-cell">
                            <span class="${status.className}">${status.text}</span>
                        </td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }

        // ----------------------------------------------------
        // ÉTAPE 3 : Récupération des Données (Filtre Temporel)
        // ----------------------------------------------------

        async function fetchFutureReservations() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('no-reservations').style.display = 'none';
            document.getElementById('error-display').style.display = 'none';

            // Date d'aujourd'hui pour filtrer les dates passées
            const today = new Date().toISOString().split('T')[0];

            // Requête SELECT qui filtre uniquement les dates futures
            const { data: reservations, error } = await supabase
                .from('reservations')
                .select('id, gite, date_debut, date_fin, nom_client, menage_valide') 
                .gte('date_fin', today)   // FILTRE CLÉ : Date de fin >= Aujourd'hui
                .order('date_fin', { ascending: true });

            document.getElementById('loading').style.display = 'none';

            if (error) {
                console.error('Erreur Supabase lors du SELECT des réservations :', error);
                document.getElementById('error-display').textContent = `Erreur de connexion : ${error.message}. Vérifiez la clé et la RLS.`;
                document.getElementById('error-display').style.display = 'block';
                return;
            }

            renderReservations(reservations);
        }

        // ----------------------------------------------------
        // ÉTAPE 4 : Initialisation
        // ----------------------------------------------------

        document.addEventListener('DOMContentLoaded', fetchFutureReservations);

    </script>
</body>
</html>
