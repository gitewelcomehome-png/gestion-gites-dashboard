<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion G√Ætes - Tableau de Bord V3</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ical.js@1.5.0/build/ical.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style> 
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Work+Sans:wght@300;400;600;700&display=swap');
        
        /* --- DESIGN SYSTEM --- */
        :root {
            --primary: #2C3E50; --secondary: #34495E; --accent: #E67E22;
            --bg-body: #F4F6F8; --card-bg: #FFFFFF;
            --airbnb: #FF5A5F; --abritel: #3498DB; --gites: #27AE60; --other: #9B59B6; 
            --trevoux: #667eea; --couzon: #f093fb; 
            --success: #2ecc71; --warning: #f1c40f; --danger: #e74c3c;
            --text-main: #2c3e50; --text-light: #7f8c8d; --border-radius: 12px;
            --kpi-trevoux: #eaf1ff; --kpi-couzon: #fde8ff; --kpi-pm: #fff8eb; --kpi-duree: #ebf5ff; --kpi-top-month: #e8fff1;
        }
        
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: 'Work Sans', sans-serif; background: var(--bg-body); color: var(--text-main); padding-bottom: 50px; }
        
        /* LOGIN */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2C3E50; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; color: white; }
        .login-box { background: white; padding: 40px; border-radius: 20px; width: 350px; text-align: center; color: #333; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .login-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; }
        .login-btn { width: 100%; padding: 12px; background: var(--trevoux); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; } 

        /* LAYOUT */
        #app-content { display: none; max-width: 1400px; margin: 0 auto; padding: 20px; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #2C3E50; color: white; padding: 15px 30px; border-radius: 50px; }
        .nav-buttons { display: flex; gap: 10px; flex-wrap:wrap; }
        .nav-btn { background: transparent; border: none; color: #bdc3c7; padding: 10px 15px; cursor: pointer; font-weight: 600; font-size: 0.95rem; display: flex; align-items: center; gap: 8px; transition: 0.3s; border-radius: 20px; }
        .nav-btn:hover, .nav-btn.active { background: linear-gradient(90deg, #3498db, #8e44ad); color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .section-content { display: none; animation: fadeIn 0.4s ease-in-out; }
        .section-content.active { display: block; }
        
        /* CARDS */
        .card { background: white; border-radius: var(--border-radius); padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .card-header { font-family: 'Playfair Display', serif; font-size: 1.5rem; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; color: var(--primary); }

        /* STATS GRIDS */
        .stats-grid-top { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card-colored { padding: 20px; border-radius: 12px; color: white; position: relative; overflow: hidden; height: 100px; }
        .stat-card-colored h3 { font-size: 0.9rem; opacity: 0.9; margin-bottom: 5px; }
        .stat-card-colored .value { font-size: 2.2rem; font-weight: bold; }
        .stat-card-colored .icon { position: absolute; right: 15px; bottom: 15px; font-size: 2.5rem; opacity: 0.2; }
        .stats-grid-kpi { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 20px; }
        .kpi-card { background: white; padding: 15px; border-radius: 12px; border-left: 4px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .kpi-card .label { font-size: 0.8rem; color: #7f8c8d; text-transform: uppercase; }
        .kpi-card .val { font-size: 1.4rem; font-weight: bold; color: #2c3e50; margin-top: 5px; }
        .stats-grid-blue { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; }
        .blue-card { background: #2C3E50; color: white; padding: 20px; border-radius: 12px; text-align: center; }
        .blue-card .val { font-size: 2rem; font-weight: bold; }
        .blue-card .lbl { font-size: 0.8rem; opacity: 0.8; text-transform: uppercase; letter-spacing: 1px; margin-top: 5px; }

        /* PLANNING */
        .planning-controls { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .gite-headers { display: flex; margin-bottom: 0; }
        .gite-header { flex: 1; text-align: center; padding: 12px; color: white; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        .week-container { background: white; border-radius: var(--border-radius); overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 25px; }
        .week-title { background: #1a252f; color: white; text-align: center; padding: 10px; font-weight: 600; border-bottom: 1px solid #34495e; }
        .week-grid { display: grid; grid-template-columns: 1fr 1fr; }
        .day-column { padding: 15px; min-height: 100px; border-right: 1px dashed #eee; }
        .res-card { background: white; border: 1px solid #eee; border-radius: 8px; padding: 12px; margin-bottom: 10px; position: relative; transition: transform 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .res-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .res-card.blocked { border-left: 4px solid var(--danger); background: #fff5f5; }
        .platform-badge { position: absolute; bottom: 10px; right: 10px; padding: 3px 8px; border-radius: 4px; color: white; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; }

        /* MENAGE STYLES */
        .week-planning-container { border: 1px solid #ddd; border-radius: 12px; overflow: hidden; margin-bottom: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        .week-title-bar { background: var(--secondary); color: white; padding: 10px 15px; font-weight: 600; }
        .gite-column { padding: 15px; }
        .gite-column:first-child { border-right: 1px solid #eee; background: var(--kpi-trevoux); }
        .gite-column:last-child { background: var(--kpi-couzon); }
        .status-indicator { padding: 3px 8px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; display:inline-block; margin-top:5px; }
        .status-attente { background-color: #e74c3c; color: white; }

        /* ONGLET INFOS */
        .info-selector { display:flex; gap:10px; margin-bottom:20px; }
        .info-btn { flex:1; padding:15px; border:2px solid #ddd; border-radius:12px; background:white; cursor:pointer; font-weight:bold; font-size:1.1rem; transition:0.3s; }
        .info-btn.active { border-color:var(--secondary); background:var(--kpi-pm); color:var(--primary); }
        .info-section-title { font-family:'Playfair Display'; color:var(--primary); border-bottom:2px solid #eee; padding-bottom:10px; margin-bottom:20px; margin-top:30px; }

        /* UTILS */
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: 600; }
        .btn-primary { background: var(--secondary); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 5000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 500px; max-width: 90%; max-height:90vh; overflow-y:auto; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        .toast { position: fixed; bottom: 30px; right: 30px; background: #333; color: white; padding: 15px 25px; border-radius: 8px; display: none; z-index: 10000; }
    </style>
</head>
<body>

    <div style="position:fixed; bottom:5px; right:5px; font-size:10px; color:red; z-index:99999; background:white; padding:2px;">VERSION V3 - CORRECTION TRI</div>

    <div id="login-screen">
        <div class="login-box">
            <h1 style="font-family:'Playfair Display'; margin-bottom:20px;">Gestion G√Ætes</h1>
            <input type="email" id="email" class="login-input" placeholder="Email" value="gite@admin.com">
            <input type="password" id="password" class="login-input" placeholder="Mot de passe">
            <div id="login-msg" style="color:red; font-size:0.8rem; display:none; margin-bottom:10px;">Erreur de connexion</div>
            <button onclick="window.handleLogin()" class="login-btn">Se connecter</button>
        </div>
    </div>

    <div id="app-content">
        <header>
            <div class="nav-buttons">
                <button class="nav-btn active" onclick="window.showTab('reservations', this)"><i class="fas fa-calendar-alt"></i> R√âSERVATIONS</button>
                <button class="nav-btn" onclick="window.showTab('statistiques', this)"><i class="fas fa-chart-pie"></i> STATISTIQUES</button>
                <button class="nav-btn" onclick="window.showTab('charges', this)"><i class="fas fa-euro-sign"></i> CHARGES</button>
                <button class="nav-btn" onclick="window.showTab('menage', this)"><i class="fas fa-broom"></i> PLANNING M√âNAGE</button>
                <button class="nav-btn" onclick="window.showTab('infos', this)"><i class="fas fa-info-circle"></i> INFOS PRATIQUES</button>
            </div>
            <div>
                <button class="btn btn-primary" onclick="window.handleLogout()" style="padding: 5px 15px; font-size: 0.8rem;">D√©connexion</button>
            </div>
        </header>

        <div id="sync-alert" class="alert-banner" style="display:flex;">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="sync-msg">Synchronisation effectu√©e.</span>
        </div>

        <div id="tab-reservations" class="section-content active">
            <div class="planning-controls">
                <h2 style="font-family:'Playfair Display'; font-size:1.8rem;">Planning des r√©servations</h2>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-primary" onclick="window.loadData()"><i class="fas fa-sync"></i> Actualiser</button>
                    <input type="text" class="search-bar" style="padding:10px; border-radius:20px; border:1px solid #ddd;" placeholder="üîç Rechercher client..." onkeyup="window.renderPlanning(this.value)">
                </div>
            </div>
            <div class="gite-headers">
                <div class="gite-header" style="background:var(--trevoux); border-top-left-radius: 12px;">üè† Tr√©voux</div>
                <div class="gite-header" style="background:var(--couzon); border-top-right-radius: 12px;">üè† Couzon</div>
            </div>
            <div id="planning-container">
                <div style="text-align:center; padding:40px; color:#999;">Chargement...</div>
            </div>
        </div>

        <div id="tab-statistiques" class="section-content">
            <div style="background:white; padding:10px; margin-bottom:20px; border-radius:12px;">
                üìÖ Ann√©e : <select id="stats-year" onchange="window.updateDashboard()"></select>
            </div>
            
            <div class="card">
                <div class="card-header">Statistiques Cl√©s</div>
                <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:10px; text-align:center;">
                    <div><h3>Total</h3><span id="total-res" style="font-size:1.5rem; font-weight:bold;">0</span></div>
                    <div><h3>CA</h3><span id="total-ca" style="font-size:1.5rem; font-weight:bold; color:var(--success);">0 ‚Ç¨</span></div>
                    <div><h3>Tr√©voux</h3><span id="total-trevoux">0</span></div>
                    <div><h3>Couzon</h3><span id="total-couzon">0</span></div>
                </div>
            </div>
            
            <div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px;">
                <div class="card" style="height:300px;"><canvas id="monthlyChart"></canvas></div>
                <div class="card" style="height:300px;"><canvas id="platformChart"></canvas></div>
            </div>
        </div>

        <div id="tab-charges" class="section-content">
            <div class="card">
                <div class="card-header">Historique des Charges</div>
                <div id="charges-list"></div>
            </div>
        </div>

        <div id="tab-menage" class="section-content">
            <div class="card">
                <div class="card-header">Planning M√©nage</div>
                <div style="margin-bottom:20px; background:white; padding:15px; border-radius:12px;">
                     Mois : <input type="month" id="cleaning-month-select" onchange="window.renderCleaningView()" style="padding:5px;">
                </div>
                <div id="cleaning-planning-container"></div>
            </div>
        </div>

        <div id="tab-infos" class="section-content">
            <div class="info-selector">
                <button class="info-btn active" onclick="window.switchInfoGite('Tr√©voux')" id="btn-info-trevoux">üè° Tr√©voux</button>
                <button class="info-btn" onclick="window.switchInfoGite('Couzon')" id="btn-info-couzon">‚õ∞Ô∏è Couzon</button>
            </div>

            <div class="card">
                <div class="card-header">
                    <span>üìù Guide Client & Codes (<span id="current-gite-name">Tr√©voux</span>)</span>
                    <button class="btn btn-success" onclick="window.saveInfosCurrentGite()" style="margin-left:auto;">üíæ Enregistrer</button>
                </div>

                <form id="form-infos-gite">
                    <h3 class="info-section-title">üîë Acc√®s & Connexion</h3>
                    <div class="form-row">
                        <div class="form-group"><label>Nom WiFi (SSID)</label><input type="text" id="info_wifi_ssid" placeholder="Ex: Gite_Wifi"></div>
                        <div class="form-group"><label>Mot de passe WiFi</label><input type="text" id="info_wifi_pass" placeholder="Ex: 123456"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Code Bo√Æte √† Cl√©s</label><input type="text" id="info_code_porte"></div>
                        <div class="form-group"><label>Digicode Entr√©e</label><input type="text" id="info_digicode"></div>
                    </div>

                    <h3 class="info-section-title">üìç Pratique</h3>
                    <div class="form-group"><label>Adresse Compl√®te</label><input type="text" id="info_adresse"></div>
                    <div class="form-row">
                        <div class="form-group"><label>Parking</label><input type="text" id="info_parking"></div>
                        <div class="form-group"><label>Poubelles</label><input type="text" id="info_poubelles"></div>
                    </div>

                    <h3 class="info-section-title">üè† √âquipements</h3>
                    <div class="form-group"><label>Chauffage / Clim</label><textarea id="info_chauffage" rows="2"></textarea></div>
                    <div class="form-group"><label>√âlectrom√©nager</label><textarea id="info_electro" rows="2"></textarea></div>
                    
                    <h3 class="info-section-title">üö™ D√©part</h3>
                    <div class="form-group"><label>Consignes Check-out</label><textarea id="info_depart" rows="3"></textarea></div>
                </form>
            </div>
        </div>

    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2>Modifier R√©servation</h2>
            <input type="hidden" id="edit-id">
            <div class="form-group"><label>Nom</label><input type="text" id="edit-name"></div>
            <div class="form-group"><label>Montant (‚Ç¨)</label><input type="number" id="edit-amount"></div>
            <div class="form-group"><label>T√©l</label><input type="text" id="edit-phone"></div>
            <div style="margin-top:20px; text-align:right;">
                <button class="btn btn-danger" onclick="document.getElementById('editModal').style.display='none'">Fermer</button>
                <button class="btn btn-success" onclick="window.saveEdit()">Enregistrer</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">Info</div>

    <script>
        // CONFIG SUPABASE
        const SUPABASE_URL = 'https://ivqiisnudabxemcxxyru.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2cWlpc251ZGFieGVtY3h4eXJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzOTk0NjMsImV4cCI6MjA4MDk3NTQ2M30.9FwJPgR8bbaP7bAemuaVbAN019EO5ql7uciQO9FeHK4';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // VARS GLOBALES
        let DB_RESERVATIONS = [];
        let DB_CHARGES = [];
        let CURRENT_GITE_INFO = 'Tr√©voux';
        let monthlyChartInstance = null;
        let platformChartInstance = null;

        // --- 1. FONCTIONS CRITIQUES (GLOBALES) ---
        window.handleLogin = async function() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const { error } = await supabase.auth.signInWithPassword({ email: email, password: pass });
            if (error) document.getElementById('login-msg').style.display = 'block';
            else location.reload();
        }
        window.handleLogout = async function() { await supabase.auth.signOut(); location.reload(); }

        // --- 2. FONCTIONS INFOS PRATIQUES ---
        window.switchInfoGite = async function(gite) {
            CURRENT_GITE_INFO = gite;
            document.getElementById('current-gite-name').textContent = gite;
            document.getElementById('btn-info-trevoux').classList.toggle('active', gite==='Tr√©voux');
            document.getElementById('btn-info-couzon').classList.toggle('active', gite==='Couzon');
            
            const { data, error } = await supabase.from('infos_gites').select('data').eq('gite_nom', gite).maybeSingle();
            const infos = (data && data.data) ? data.data : {};
            
            document.getElementById('info_wifi_ssid').value = infos.wifi_ssid || '';
            document.getElementById('info_wifi_pass').value = infos.wifi_pass || '';
            document.getElementById('info_code_porte').value = infos.code_porte || '';
            document.getElementById('info_digicode').value = infos.digicode || '';
            document.getElementById('info_adresse').value = infos.adresse || '';
            document.getElementById('info_parking').value = infos.parking || '';
            document.getElementById('info_poubelles').value = infos.poubelles || '';
            document.getElementById('info_chauffage').value = infos.chauffage || '';
            document.getElementById('info_electro').value = infos.electro || '';
            document.getElementById('info_depart').value = infos.depart || '';
        }

        window.saveInfosCurrentGite = async function() {
            const formData = {
                wifi_ssid: document.getElementById('info_wifi_ssid').value,
                wifi_pass: document.getElementById('info_wifi_pass').value,
                code_porte: document.getElementById('info_code_porte').value,
                digicode: document.getElementById('info_digicode').value,
                adresse: document.getElementById('info_adresse').value,
                parking: document.getElementById('info_parking').value,
                poubelles: document.getElementById('info_poubelles').value,
                chauffage: document.getElementById('info_chauffage').value,
                electro: document.getElementById('info_electro').value,
                depart: document.getElementById('info_depart').value
            };
            const { error } = await supabase.from('infos_gites').upsert({ gite_nom: CURRENT_GITE_INFO, data: formData }, { onConflict: 'gite_nom' });
            if(error) window.showToast('Erreur sauvegarde', true);
            else window.showToast('Infos enregistr√©es !');
        }

        // --- 3. FONCTIONS EXISTANTES ---
        window.loadData = async function() {
            let { data: res } = await supabase.from('reservations').select('*');
            DB_RESERVATIONS = (res||[]).map(r => ({...r, montant: parseFloat(r.montant)||0}));
            let { data: chg } = await supabase.from('charges').select('*');
            DB_CHARGES = chg||[];
            
            // Init Ann√©es
            const y = new Date().getFullYear();
            const sel = document.getElementById('stats-year');
            if(sel.options.length === 0) sel.innerHTML = `<option value="${y}">${y}</option><option value="${y-1}">${y-1}</option>`;
            
            // Init Mois M√©nage (force une valeur)
            document.getElementById('cleaning-month-select').value = new Date().toISOString().slice(0,7);

            window.renderPlanning();
            window.renderChargesList();
            window.switchInfoGite('Tr√©voux');
        }

        // --- PLANNING (TRI FIX√â PAR TIMESTAMP) ---
        window.renderPlanning = function(filter='') {
            const container = document.getElementById('planning-container');
            let future = DB_RESERVATIONS.filter(r => new Date(r.date_fin) >= new Date());
            if(filter) future = future.filter(r => r.nom_client.toLowerCase().includes(filter.toLowerCase()));
            
            // Tri simple des r√©servations par date
            future.sort((a,b) => new Date(a.date_debut) - new Date(b.date_debut));
            
            // Utilisation d'une MAP pour regrouper par semaine, avec cl√© de tri TIMESTAMP
            const weeksMap = new Map();
            
            future.forEach(r => {
                const d = new Date(r.date_debut);
                const wNum = getWeekNumber(d);
                const start = getStartOfWeek(d);
                const startTs = start.getTime(); // Cl√© de tri num√©rique absolue
                
                if (!weeksMap.has(startTs)) {
                    const end = new Date(start); end.setDate(end.getDate()+6);
                    weeksMap.set(startTs, { 
                        label: `Semaine ${wNum}`, 
                        dates: `${formatDateShort(start)} - ${formatDateShort(end)}`, 
                        trevoux: [], 
                        couzon: [] 
                    });
                }
                
                weeksMap.get(startTs)[r.gite === 'Tr√©voux' ? 'trevoux' : 'couzon'].push(r);
            });

            // Conversion Map -> Array et tri par Timestamp (absolument chronologique)
            const sortedWeeks = Array.from(weeksMap.entries()).sort((a,b) => a[0] - b[0]);

            let html = '';
            sortedWeeks.forEach(([ts, w]) => {
                html += `<div class="week-container"><div class="week-title">${w.label} <span style="opacity:0.7">${w.dates}</span></div>
                <div class="week-grid">
                    <div class="day-column">${w.trevoux.map(r=>createResCard(r)).join('')}</div>
                    <div class="day-column">${w.couzon.map(r=>createResCard(r)).join('')}</div>
                </div></div>`;
            });
            container.innerHTML = html || '<div style="padding:20px;">Aucune r√©servation.</div>';
        }

        window.updateDashboard = function() {
            const year = parseInt(document.getElementById('stats-year').value);
            const resYear = DB_RESERVATIONS.filter(r => new Date(r.date_debut).getFullYear() === year && !r.nom_client.includes('BLOQU√â'));
            
            document.getElementById('total-res').innerText = resYear.length;
            const ca = resYear.reduce((s,r)=>s+r.montant,0);
            document.getElementById('total-ca').innerText = ca.toFixed(0)+' ‚Ç¨';
            document.getElementById('total-trevoux').innerText = resYear.filter(r=>r.gite==='Tr√©voux').length;
            document.getElementById('total-couzon').innerText = resYear.filter(r=>r.gite==='Couzon').length;

            // Simple Chart rendering
            const months = ['J','F','M','A','M','J','J','A','S','O','N','D'];
            const monthlyCA = new Array(12).fill(0);
            resYear.forEach(r => monthlyCA[new Date(r.date_debut).getMonth()] += r.montant);
            
            // Destruction explicite
            if(monthlyChartInstance) { monthlyChartInstance.destroy(); monthlyChartInstance = null; }
            if(platformChartInstance) { platformChartInstance.destroy(); platformChartInstance = null; }

            // Dessin
            const ctxM = document.getElementById('monthlyChart').getContext('2d');
            monthlyChartInstance = new Chart(ctxM, {
                type: 'bar', 
                data: { labels: months, datasets: [{ label: 'CA', data: monthlyCA, backgroundColor: '#27ae60' }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
            
            const ctxP = document.getElementById('platformChart').getContext('2d');
            const pData = [
                resYear.filter(r=>r.plateforme?.toLowerCase().includes('airbnb')).length,
                resYear.filter(r=>r.plateforme?.toLowerCase().includes('abritel')).length,
                resYear.filter(r=>r.plateforme?.toLowerCase().includes('gite')).length
            ];
            platformChartInstance = new Chart(ctxP, { type:'doughnut', data:{labels:['Airbnb','Abritel','G√Ætes'], datasets:[{data:pData, backgroundColor:['#FF5A5F','#3498DB','#27AE60']}]}, options: { responsive: true, maintainAspectRatio: false } });
        }

        window.renderCleaningView = function() {
            const container = document.getElementById('cleaning-planning-container');
            const mv = document.getElementById('cleaning-month-select').value;
            if(!mv) return;
            const [y, m] = mv.split('-').map(Number);
            const start = new Date(y, m-1, 1); const end = new Date(y, m, 0); const today = new Date(); today.setHours(0,0,0,0);
            
            let tasks = DB_RESERVATIONS.filter(r => { const d = new Date(r.date_fin); return d >= start && d <= end && d >= today; });
            tasks.sort((a,b) => new Date(a.date_fin) - new Date(b.date_fin));
            
            let html = '';
            tasks.forEach(r => {
                html += `<div style="padding:10px; border-bottom:1px solid #eee;">üßπ ${r.gite} - ${formatDate(r.date_fin)} - ${r.nom_client}</div>`;
            });
            container.innerHTML = html || '<div style="padding:20px;">Aucun m√©nage ce mois-ci.</div>';
        }

        window.renderChargesList = function() {
            const list = document.getElementById('charges-list');
            let html = '<table style="width:100%"><tr><th>Date</th><th>G√Æte</th><th>Montant</th></tr>';
            DB_CHARGES.forEach(c => html += `<tr><td>${formatDate(c.date)}</td><td>${c.gite}</td><td>${c.montant}‚Ç¨</td></tr>`);
            list.innerHTML = html + '</table>';
        }

        // --- HELPERS ---
        function createResCard(r) {
            const isBlocked = r.nom_client.includes('BLOQU√â');
            return `<div class="res-card ${isBlocked?'blocked':''}" onclick="window.openEdit(${r.id}, '${r.nom_client.replace(/'/g,"\\'")}', ${r.montant}, '${r.telephone||''}')">
                <b>${r.nom_client}</b><br>${formatDate(r.date_debut)} -> ${formatDate(r.date_fin)}<br>
                <span class="platform-badge" style="background:${r.plateforme.includes('Airbnb')?'#FF5A5F':'#27AE60'}">${r.plateforme}</span>
            </div>`;
        }
        
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        }
        function getStartOfWeek(d) { const date = new Date(d); const day = date.getDay() || 7; if(day !== 1) date.setHours(-24 * (day - 1)); return date; }
        function formatDate(s) { 
            if(!s) return ''; 
            if(typeof s !== 'string') s = new Date(s).toISOString().slice(0,10);
            return new Date(s).toLocaleDateString('fr-FR'); 
        }
        function formatDateShort(d) { return `${d.getDate()}/${d.getMonth()+1}`; }
        function showToast(msg, err=false) { const t=document.getElementById('toast'); t.innerText=msg; t.style.background=err?'red':'#333'; t.style.display='block'; setTimeout(()=>t.style.display='none',3000); }
        
        window.showTab = function(id, btn) {
            document.querySelectorAll('.section-content').forEach(s => s.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if(id==='statistiques') {
                setTimeout(window.updateDashboard, 50); // Fix charts white
            }
            if(id==='menage') window.renderCleaningView();
        }
        
        window.openEdit = function(id, name, amount, phone) {
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-name').value = name;
            document.getElementById('edit-amount').value = amount;
            document.getElementById('edit-phone').value = phone;
            document.getElementById('editModal').style.display='flex';
        }
        window.saveEdit = async function() {
            const id = document.getElementById('edit-id').value;
            const updates = { 
                nom_client: document.getElementById('edit-name').value,
                montant: parseFloat(document.getElementById('edit-amount').value),
                telephone: document.getElementById('edit-phone').value
            };
            await supabase.from('reservations').update(updates).eq('id', id);
            document.getElementById('editModal').style.display='none';
            window.loadData();
        }

        // Init
        async function initAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                window.loadData();
            }
        }
        window.onload = initAuth;
    </script>
</body>
</html>
