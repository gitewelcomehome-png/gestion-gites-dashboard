<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validation Planning Ménage</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Styles simplifiés pour le formulaire */
        body { font-family: Arial, sans-serif; background: #f4f6f8; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h1 { color: #2C3E50; border-bottom: 2px solid #E67E22; padding-bottom: 10px; margin-bottom: 20px; }
        .task-card { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 8px; }
        .task-header { font-weight: bold; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .gite-trevoux { color: #667eea; }
        .gite-couzon { color: #f093fb; }
        .actions { margin-top: 10px; display: flex; gap: 10px; align-items: center; }
        .actions label { font-weight: normal; }
        .actions input[type="date"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: bold; }
        .btn-validate { background: #2ecc71; }
        .btn-propose { background: #f1c40f; }
        .btn:hover { opacity: 0.9; }
        #message { margin-top: 20px; padding: 15px; border-radius: 8px; }
    </style>

    <script>
        const SUPABASE_URL = 'https://ivqiisnudabxemcxxyru.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2cWlpc251ZGFieGVtY3h4eXJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUzOTk0NjMsImV4cCI6MjA4MDk3NTQ2M30.9FwJPgR8bbaP7bAemuaVbAN019EO5ql7uciQO9FeHK4';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Simule les fonctions utilitaires nécessaires (getCleaningTime, isChainingDay, etc. NON inclus ici par souci de concision. Ils devraient être copiés/collés depuis le fichier principal ou mis dans un fichier utils.js partagé).

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const month = urlParams.get('month');
            if (month) {
                document.getElementById('form-title').innerText = `Validation Planning Ménage - ${month}`;
                loadCleaningTasks(month);
            } else {
                document.getElementById('tasks-container').innerHTML = "<p>Paramètre 'month' manquant. Lien invalide.</p>";
            }
        });

        async function loadCleaningTasks(month) {
            // Logique de filtrage par mois similaire à renderCleaning dans le fichier principal
            // ... (Filtrez les réservations pour ce mois) ...
            
            // Simuler le chargement des tâches pour l'exemple
            const { data: reservations, error } = await supabase
                .from('reservations')
                .select('id, gite, nom_client, date_debut, date_fin')
                .gte('date_fin', `${month}-01`)
                .lte('date_fin', `${month}-31`); // Simple approximation pour la fin du mois

            if (error) {
                document.getElementById('tasks-container').innerHTML = `<p style="color:red;">Erreur de chargement : ${error.message}</p>`;
                return;
            }
            
            let html = '';
            reservations.sort((a, b) => new Date(a.date_fin) - new Date(b.date_fin));

            reservations.forEach(r => {
                const finishTime = "12h00"; // Simplification pour le formulaire externe
                const giteClass = r.gite === 'Trévoux' ? 'gite-trevoux' : 'gite-couzon';

                html += `
                <div class="task-card" data-res-id="${r.id}">
                    <div class="task-header">
                        <span class="${giteClass}"><i class="fas fa-broom"></i> ${r.gite} : ${new Date(r.date_fin).toLocaleDateString('fr-FR')}</span>
                        <span>Prêt avant : ${finishTime}</span>
                    </div>
                    <div style="font-size:0.9rem;">
                        Séjour : ${new Date(r.date_debut).toLocaleDateString('fr-FR')} ➝ ${new Date(r.date_fin).toLocaleDateString('fr-FR')} (${r.nom_client})
                    </div>
                    
                    <div class="actions">
                        <button class="btn btn-validate" onclick="submitValidation(${r.id}, '${r.gite}', '${r.date_fin}', 'Validé')">
                            <i class="fas fa-check"></i> OK
                        </button>
                        
                        <label>Proposer autre date :</label>
                        <input type="date" id="date-prop-${r.id}">
                        <button class="btn btn-propose" onclick="submitValidation(${r.id}, '${r.gite}', '${r.date_fin}', 'Proposé')">
                            <i class="fas fa-calendar-alt"></i> Proposer
                        </button>
                    </div>
                </div>`;
            });

            document.getElementById('tasks-container').innerHTML = html;
        }

        async function submitValidation(resId, gite, originalDate, status) {
            const dateInput = document.getElementById(`date-prop-${resId}`);
            let validatedDate = originalDate;

            if (status === 'Proposé' && dateInput.value) {
                validatedDate = dateInput.value;
            } else if (status === 'Proposé' && !dateInput.value) {
                alert("Veuillez saisir une date proposée.");
                return;
            }

            const { data, error } = await supabase
                .from('cleaning_validation') // !!! Assurez-vous que cette table existe !!!
                .upsert([
                    { 
                        reservation_id: resId, 
                        gite: gite,
                        original_date: originalDate,
                        validated_date: validatedDate,
                        status: status
                    }
                ], { onConflict: 'reservation_id' }); 
            
            if (error) {
                console.error(error);
                document.getElementById('message').innerHTML = `<p style="background:#fdd; border:1px solid red;">Erreur de soumission pour la réservation ${resId}.</p>`;
            } else {
                const card = document.querySelector(`[data-res-id="${resId}"]`);
                if (card) {
                    card.style.opacity = '0.5';
                    card.style.border = '2px solid #2ecc71';
                }
                document.getElementById('message').innerHTML = `<p style="background:#dfd; border:1px solid green;">Tâche pour la réservation ${resId} soumise (Statut: ${status}).</p>`;
            }
        }
    </script>
</head>
<body>
    <div class="container">
        <h1 id="form-title">Validation Planning Ménage</h1>
        <p>Veuillez valider les dates de ménage proposées ou proposer une date de remplacement.</p>
        
        <div id="tasks-container">
            Chargement des tâches de ménage...
        </div>

        <div id="message"></div>
    </div>
</body>
</html>