<style>
    /* Styles sp√©cifiques pour le tableau de bord M√©nage */
    .menage-container { padding: 10px; }
    .menage-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    
    .cleaning-list { list-style: none; padding: 0; }
    .cleaning-item {
        border: 1px solid #ddd;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: white;
    }
    
    /* Styles de Statut (Rouge/Vert) */
    .status-indicator {
        padding: 5px 10px;
        border-radius: 4px;
        font-weight: bold;
        font-size: 0.9em;
    }
    /* Correspond √† var(--danger) dans l'index */
    .status-attente { 
        background-color: #e74c3c; 
        color: white;
    }
    /* Correspond √† var(--success) dans l'index */
    .status-valide { 
        background-color: #2ecc71; 
        color: white;
    }
    /* Correspond √† var(--warning) dans l'index */
    .status-propose { 
        background-color: #f1c40f; 
        color: #333;
    }

    .details { flex-grow: 1; }
    .date { font-weight: bold; color: var(--primary); }

    .week-planning-container {
        border: 1px solid #ddd;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 20px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }
    .week-title-bar {
        background: var(--secondary);
        color: white;
        padding: 10px 15px;
        font-weight: 600;
    }
    .week-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
    }
    .gite-column {
        padding: 15px;
    }
    .gite-column:first-child {
        border-right: 1px solid #eee;
        background: var(--kpi-trevoux); 
    }
    .gite-column:last-child {
        background: var(--kpi-couzon); 
    }
    .gite-column h4 { margin-top: 0; padding-bottom: 5px; border-bottom: 1px solid #ccc; }

</style>

<div class="menage-container">
    <div class="menage-header">
        <div style="background:var(--bg-body); padding:5px 15px; border-radius:20px; border:1px solid #ddd;">
            üìÖ **Mois :** <input type="month" id="cleaning-month-select" onchange="renderCleaningView()" style="border:none; font-weight:bold; font-size:1rem; outline:none; background:transparent;">
        </div>
        
        <div style="display:flex; gap:10px;">
            <button class="btn btn-success" onclick="openValidationForm()" style="font-size: 0.9rem;"><i class="fas fa-external-link-alt"></i> Partager Planning</button>
            <button class="btn btn-primary" onclick="exportCleaningCSV()" style="font-size: 0.9rem;"><i class="fas fa-file-csv"></i> Exporter CSV</button>
        </div>
    </div>
    
    <div id="cleaning-planning-container">
        <div style="text-align:center; padding:20px; color: #7f8c8d;">S√©lectionnez un mois ou le planning se chargera apr√®s la connexion.</div>
    </div>

    <p style="font-size:0.8rem; color:#7f8c9d; margin-top:20px; border-top:1px solid #eee; padding-top:10px;">
        **L√©gende :** Les dates ant√©rieures √† aujourd'hui sont masqu√©es. Vert = Valid√©, Rouge = Non Valid√©.
    </p>
</div>

<script>
    // Variables globales accessibles via window.
    let CURRENT_CLEANING_TASKS = []; 

    /**
     * D√©termine le statut et la classe CSS pour l'affichage couleur (Vert/Rouge)
     */
    function getStatusDisplay(menageValide) {
        if (!menageValide) {
            return { text: 'Non Valid√©', className: 'status-attente' }; // Rouge
        }
        if (menageValide.includes('Valid√©')) {
            return { text: menageValide, className: 'status-valide' }; // Vert
        }
        if (menageValide.includes('Propos√©')) {
            return { text: menageValide, className: 'status-propose' }; // Jaune
        }
        return { text: menageValide, className: 'status-propose' };
    }

    /**
     * G√©n√®re la carte d√©taill√©e pour une t√¢che de m√©nage
     */
    function createCleaningCard(r) {
        const departureDate = new Date(r.date_fin);
        // Utilisation des fonctions globales (window.)
        const isChaining = window.isChainingDay(r.date_fin, r.gite);
        const finishTime = window.getCleaningTime(r.date_fin, r.gite, isChaining);
        const dayOfWeek = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'][departureDate.getDay()];
        
        const status = getStatusDisplay(r.menage_valide);
        let cardBg = 'background:white;';
        // Utilisation des variables CSS de l'index
        if (isChaining) cardBg = 'background:var(--kpi-pm); border:2px solid var(--accent);';
        
        return `
        <div style="border-radius:8px; padding:15px; margin-bottom:15px; box-shadow:0 2px 5px rgba(0,0,0,0.1); ${cardBg}">
            <div style="font-weight:700; font-size:1.1rem; color:var(--primary); margin-bottom:8px;">
                üßπ ${dayOfWeek} ${window.formatDate(r.date_fin)}
            </div>
            
            <div style="font-size:0.9rem; color:#7f8c8d; margin-bottom:10px;">
                <i class="fas fa-calendar-alt"></i> S√©jour : ${window.formatDate(r.date_debut)} ‚ûù ${window.formatDate(r.date_fin)}
                <br><i class="fas fa-user-tag"></i> Client : ${r.nom_client}
            </div>

            <div style="font-weight:bold; color:var(--success); font-size:1.2rem; border-top:1px solid #eee; padding-top:8px;">
                <i class="fas fa-clock"></i> Pr√™t avant : ${finishTime}
            </div>
            <div class="status-indicator ${status.className}" style="margin-top:5px;">
                <i class="fas fa-check-circle" style="font-size:0.8rem;"></i> ${status.text}
            </div>
        </div>`;
    }

    /**
     * Fonction principale de rendu du planning m√©nage (appel√©e par l'index)
     */
    window.renderCleaningView = function() {
        if (typeof window.DB_RESERVATIONS === 'undefined' || window.DB_RESERVATIONS.length === 0) {
            document.getElementById('cleaning-planning-container').innerHTML = '<div style="color:#999; padding:10px;">Chargement des donn√©es...</div>';
            return;
        }

        const container = document.getElementById('cleaning-planning-container');
        const monthSelect = document.getElementById('cleaning-month-select');
        
        // --- INITIALISATION DU S√âLECTEUR DE MOIS ---
        if (!monthSelect.value) {
            const today = new Date();
            const currentMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            monthSelect.value = currentMonth;
        }
        
        const monthValue = monthSelect.value;
        const targetYear = parseInt(monthValue.substring(0, 4));
        const targetMonth = parseInt(monthValue.substring(5, 7)) - 1;
        
        const startOfMonth = new Date(targetYear, targetMonth, 1);
        const endOfMonth = new Date(targetYear, targetMonth + 1, 0); 

        // Calcul de la date d'aujourd'hui √† minuit pour le filtre temporel
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayMs = today.getTime();

        let cleaningTasks = window.DB_RESERVATIONS.filter(r => {
            const endDate = new Date(r.date_fin);
            const endDateMs = endDate.getTime();
            
            // Filtre 1 : Dans le mois s√©lectionn√©
            const inMonth = endDate >= startOfMonth && endDate <= endOfMonth;
            
            // Filtre 2 (CL√â) : La date de fin doit √™tre >= Aujourd'hui (pas de dates pass√©es)
            const isFuture = endDateMs >= todayMs; 

            return inMonth && isFuture;
        });
        
        if (cleaningTasks.length === 0) {
            container.innerHTML = '<div style="color:#999; padding:10px;">Aucun m√©nage en attente ou futur pour ce mois.</div>';
            CURRENT_CLEANING_TASKS = [];
            return;
        }

        cleaningTasks.sort((a, b) => new Date(a.date_fin) - new Date(b.date_fin));
        CURRENT_CLEANING_TASKS = cleaningTasks; 
        
        // Regroupe les t√¢ches par semaine
        const weeks = {};
        cleaningTasks.forEach(r => {
            const d = new Date(r.date_fin);
            const wNum = window.getWeekNumber(d);
            const year = d.getFullYear();
            const key = `${year}-W${wNum}`;
            
            if (!weeks[key]) {
                const startW = window.getStartOfWeek(d);
                const endW = new Date(startW); endW.setDate(endW.getDate() + 6);
                weeks[key] = { 
                    wNum, 
                    label: `Semaine ${wNum}`, 
                    dates: `${window.formatDateShort(startW)} - ${window.formatDateShort(endW)}`, 
                    trevoux: [], 
                    couzon: [] 
                };
            }
            
            const giteKey = r.gite === 'Tr√©voux' ? 'trevoux' : 'couzon';
            weeks[key][giteKey].push(r);
        });

        // G√©n√©ration du HTML
        let html = '';
        for (const [k, w] of Object.entries(weeks)) {
            html += `
            <div class="week-planning-container">
                <div class="week-title-bar">
                    ${w.label} <span style="font-weight:400; opacity:0.8; margin-left:10px;">${w.dates}</span>
                </div>
                <div class="week-grid">
                    <div class="gite-column">
                        <h4 style="color:var(--trevoux);">Tr√©voux (${w.trevoux.length} m√©nages)</h4>
                        ${w.trevoux.map(r => createCleaningCard(r)).join('')}
                    </div>
                    <div class="gite-column">
                        <h4 style="color:var(--couzon);">Couzon (${w.couzon.length} m√©nages)</h4>
                        ${w.couzon.map(r => createCleaningCard(r)).join('')}
                    </div>
                </div>
            </div>`;
        }

        container.innerHTML = html;
    }

    /**
     * Fonctions d'exportation et de validation (d√©plac√©es ici pour la propret√©)
     */
    function openValidationForm() {
        const month = document.getElementById('cleaning-month-select').value;
        if (!month) {
            window.showToast("S√©lectionnez un mois avant de g√©n√©rer le lien de partage.");
            return;
        }
        
        const formUrl = `cleaning_form.html?month=${month}`; 
        window.open(formUrl, '_blank');
    }

    function exportCleaningCSV() {
        if (CURRENT_CLEANING_TASKS.length === 0) {
            window.showToast("Aucune t√¢che √† exporter pour le mois s√©lectionn√©.");
            return;
        }

        // Le code d'exportation CSV utilise CURRENT_CLEANING_TASKS et les fonctions globales
        window.showToast("Exportation CSV lanc√©e...");
        // Assurez-vous d'avoir le code complet de l'exportation CSV ici si vous en avez besoin, 
        // ou vous pouvez r√©int√©grer cette logique en utilisant la variable CURRENT_CLEANING_TASKS.
    }

</script>
